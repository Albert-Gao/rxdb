{"version":3,"sources":["../../../../src/plugins/lokijs/rx-storage-instance-loki.ts"],"names":["createLokiStorageInstance","storage","params","databaseSettings","instance","RxStorageInstanceLoki","databaseName","collectionName","schema","internals","options","multiInstance","leaderElector","awaitLeadership","then","closed","localState","createLokiLocalState","databaseState","indices","indexes","forEach","idx","push","primaryKey","lokiCollectionName","version","collectionOptions","Object","assign","unique","LOKIJS_COLLECTION_DEFAULT_OPTIONS","collection","database","addCollection","collections","ret","instanceId","changes$","Subject","lastChangefeedSequence","primaryPath","OPEN_LOKIJS_STORAGE_INSTANCES","add","broadcastChannel","addEventListener","msg","bulkWrite","documentWrites","length","args","success","error","docsInDb","Map","docsInDbWithLokiKey","writeRow","id","document","documentInDb","by","set","categorized","bulkInsertDocs","docId","insert","bulkUpdateDocs","documentInDbWithLokiKey","writeDoc","$loki","update","errors","err","documentId","saveQueue","addWrite","next","eventBulk","findDocumentsById","ids","deleted","_deleted","query","preparedQuery","chain","find","selector","sort","skip","offset","limit","foundDocuments","data","map","lokiDoc","documents","getAttachmentData","_documentId","_attachmentId","Error","getChangedDocumentsSince","checkpoint","sinceLwt","lwt","RX_META_LWT_MINIMUM","$gte","changedDocs","first","_meta","shift","slice","docData","changeStream","asObservable","cleanup","minimumDeletedTime","deleteAmountPerRun","maxDeletionTime","$lt","remove","close","complete","dbState","run","removeCollection","name"],"mappings":";;;;;;;AAAA;;AAIA;;AASA;;AAkBA;;AAiBA;;AACA;;IA4TsBA,yB,YAAAA,yB,CAClBC,O,EACAC,M,EACAC,gB;MACyC;AAAA;AAYzC,UAAMC,QAAQ,GAAG,IAAIC,qBAAJ,CACbJ,OADa,EAEbC,MAAM,CAACI,YAFM,EAGbJ,MAAM,CAACK,cAHM,EAIbL,MAAM,CAACM,MAJM,EAKbC,UALa,EAMbP,MAAM,CAACQ,OANM,EAObP,gBAPa,CAAjB;AAUA;AACJ;AACA;;AACI,UAAID,MAAM,CAACS,aAAX,EAA0B;AACtB,kCAAeF,UAAS,CAACG,aAAzB,EACKC,eADL,GAEKC,IAFL,CAEU,YAAM;AACR,cAAI,CAACV,QAAQ,CAACW,MAAd,EAAsB;AAClB,iDAAkBX,QAAlB;AACH;AACJ,SANL;AAOH;;AAGD,aAAOA,QAAP;AApCyC;;AACzC,QAAMK,UAA+B,GAAG,EAAxC;;AADyC;AAAA,UAGrCP,MAAM,CAACS,aAH8B;AAIrC,YAAMC,aAAa,GAAG,wCAAqBX,OAArB,EAA8BC,MAAM,CAACI,YAArC,CAAtB;AACAG,QAAAA,UAAS,CAACG,aAAV,GAA0BA,aAA1B;AALqC;AAOrC;AACAH,QAAAA,UAAS,CAACO,UAAV,GAAuBC,oBAAoB,CAACf,MAAD,EAASC,gBAAT,CAA3C;AARqC,+BAS/BM,UAAS,CAACO,UATqB;AAAA;AAAA;;AAAA;AAqC5C,G;;;;;;;IAlGqBC,oB,YAAAA,oB,CAClBf,M,EACAC,gB;MAC+B;AAC/B,QAAI,CAACD,MAAM,CAACQ,OAAZ,EAAqB;AACjBR,MAAAA,MAAM,CAACQ,OAAP,GAAiB,EAAjB;AACH;;AAH8B,2BAKH,mCACxBR,MAAM,CAACI,YADiB,EAExBH,gBAFwB,CALG,iBAKzBe,aALyB;AAU/B;AACJ;AACA;AACA;AACI,UAAMC,OAAiB,GAAG,EAA1B;;AACA,UAAIjB,MAAM,CAACM,MAAP,CAAcY,OAAlB,EAA2B;AACvBlB,QAAAA,MAAM,CAACM,MAAP,CAAcY,OAAd,CAAsBC,OAAtB,CAA8B,UAAAC,GAAG,EAAI;AACjC,cAAI,CAAC,gCAAqBA,GAArB,CAAL,EAAgC;AAC5BH,YAAAA,OAAO,CAACI,IAAR,CAAaD,GAAb;AACH;AACJ,SAJD;AAKH;AACD;AACJ;AACA;AACA;;;AACI,UAAME,UAAU,GAAG,iDAA4BtB,MAAM,CAACM,MAAP,CAAcgB,UAA1C,CAAnB;AACAL,MAAAA,OAAO,CAACI,IAAR,CAAaC,UAAb;AAEA,UAAMC,kBAAkB,GAAGvB,MAAM,CAACK,cAAP,GAAwB,GAAxB,GAA8BL,MAAM,CAACM,MAAP,CAAckB,OAAvE;AACA,UAAMC,iBAAwE,GAAGC,MAAM,CAACC,MAAP,CAC7E,EAD6E,EAE7EJ,kBAF6E,EAG7E;AACIN,QAAAA,OAAO,EAAEA,OADb;AAEIW,QAAAA,MAAM,EAAE,CAACN,UAAD;AAFZ,OAH6E,EAO7EO,+CAP6E,CAAjF;AAUA,UAAMC,UAAsB,GAAGd,aAAa,CAACe,QAAd,CAAuBC,aAAvB,CAC3BT,kBAD2B,EAE3BE,iBAF2B,CAA/B;AAIAT,MAAAA,aAAa,CAACiB,WAAd,CAA0BjC,MAAM,CAACK,cAAjC,IAAmDyB,UAAnD;AACA,UAAMI,GAA2B,GAAG;AAChClB,QAAAA,aAAa,EAAbA,aADgC;AAEhCc,QAAAA,UAAU,EAAVA;AAFgC,OAApC;AAKA,aAAOI,GAAP;AAlD+B;AAmDlC,G;;;;;;AAvTD,IAAIC,UAAU,GAAG,gBAAjB;;IAEahC,qB;AAaT,iCACoBJ,OADpB,EAEoBK,YAFpB,EAGoBC,cAHpB,EAIoBC,MAJpB,EAKoBC,SALpB,EAMoBC,OANpB,EAOoBP,gBAPpB,EAQE;AAAA;;AAAA,SAdMmC,QAcN,GAdsF,IAAIC,aAAJ,EActF;AAAA,SAbMC,sBAaN,GAbuC,CAavC;AAAA,SAZcH,UAYd,GAZ2BA,UAAU,EAYrC;AAAA,SAVKtB,MAUL,GAVc,KAUd;AAAA,SAPkBd,OAOlB,GAPkBA,OAOlB;AAAA,SANkBK,YAMlB,GANkBA,YAMlB;AAAA,SALkBC,cAKlB,GALkBA,cAKlB;AAAA,SAJkBC,MAIlB,GAJkBA,MAIlB;AAAA,SAHkBC,SAGlB,GAHkBA,SAGlB;AAAA,SAFkBC,OAElB,GAFkBA,OAElB;AAAA,SADkBP,gBAClB,GADkBA,gBAClB;AACE,SAAKsC,WAAL,GAAmB,iDAA4B,KAAKjC,MAAL,CAAYgB,UAAxC,CAAnB;;AACAkB,gDAA8BC,GAA9B,CAAkC,IAAlC;;AACA,QAAI,KAAKlC,SAAL,CAAeG,aAAnB,EAAkC;AAC9B,WAAKH,SAAL,CAAeG,aAAf,CAA6BC,eAA7B,GAA+CC,IAA/C,CAAoD,YAAM;AACtD;AACA,kCAAe,KAAI,CAACL,SAAL,CAAeG,aAA9B,EAA6CgC,gBAA7C,CACKC,gBADL,CACsB,SADtB,YACwCC,GADxC;AAAA;AAAA,mCACgD,uCAAoB,KAApB,EAA0BA,GAA1B,CADhD;AAAA;AAAA;AAAA;AAAA;AAEH,OAJD;AAKH;AACJ;;;;SAEKC,S,sBAAUC,c;QAA2F;AAAA,mBAQ5D,IAR4D;;AACvG,UAAIA,cAAc,CAACC,MAAf,KAA0B,CAA9B,EAAiC;AAC7B,cAAM,yBAAW,IAAX,EAAiB;AACnBC,UAAAA,IAAI,EAAE;AACFF,YAAAA,cAAc,EAAdA;AADE;AADa,SAAjB,CAAN;AAKH;;AAPsG,6BAQ9E,4CAR8E,iBAQjGhC,UARiG;AASvG,YAAI,CAACA,UAAL,EAAiB;AACb,iBAAO,iDAA4B,WAA5B,EAAyC,CAACgC,cAAD,CAAzC,CAAP;AACH;;AAED,YAAMZ,GAA0C,GAAG;AAC/Ce,UAAAA,OAAO,EAAE,EADsC;AAE/CC,UAAAA,KAAK,EAAE;AAFwC,SAAnD;AAKA,YAAMC,QAAoF,GAAG,IAAIC,GAAJ,EAA7F;AACA,YAAMC,mBAGL,GAAG,IAAID,GAAJ,EAHJ;AAIAN,QAAAA,cAAc,CAAC3B,OAAf,CAAuB,UAAAmC,QAAQ,EAAI;AAC/B,cAAMC,EAAE,GAAGD,QAAQ,CAACE,QAAT,CAAkB,OAAKjB,WAAvB,CAAX;AACA,cAAMkB,YAAY,GAAG3C,UAAU,CAACgB,UAAX,CAAsB4B,EAAtB,CAAyB,OAAKnB,WAA9B,EAA2CgB,EAA3C,CAArB;;AACA,cAAIE,YAAJ,EAAkB;AACdJ,YAAAA,mBAAmB,CAACM,GAApB,CAAwBJ,EAAxB,EAA4BE,YAA5B;AACAN,YAAAA,QAAQ,CAACQ,GAAT,CAAaJ,EAAb,EAAiB,gCAAaE,YAAb,CAAjB;AACH;AACJ,SAPD;AASA,YAAMG,WAAW,GAAG,sDAEhB,OAAKrB,WAFW,EAGhBY,QAHgB,EAIhBL,cAJgB,CAApB;AAOAc,QAAAA,WAAW,CAACC,cAAZ,CAA2B1C,OAA3B,CAAmC,UAAAmC,QAAQ,EAAI;AAC3C,cAAMQ,KAAK,GAAGR,QAAQ,CAACE,QAAT,CAAkB,OAAKjB,WAAvB,CAAd;AACAzB,UAAAA,UAAU,CAACgB,UAAX,CAAsBiC,MAAtB,CAA6B,qBAAUT,QAAQ,CAACE,QAAnB,CAA7B;AACAtB,UAAAA,GAAG,CAACe,OAAJ,CAAYa,KAAZ,IAA4BR,QAAQ,CAACE,QAArC;AACH,SAJD;AAKAI,QAAAA,WAAW,CAACI,cAAZ,CAA2B7C,OAA3B,CAAmC,UAAAmC,QAAQ,EAAI;AAC3C,cAAMQ,KAAK,GAAGR,QAAQ,CAACE,QAAT,CAAkB,OAAKjB,WAAvB,CAAd;AACA,cAAM0B,uBAAuB,GAAG,6BAAkBZ,mBAAlB,EAAuCS,KAAvC,CAAhC;AACA,cAAMI,QAAa,GAAGxC,MAAM,CAACC,MAAP,CAClB,EADkB,EAElB2B,QAAQ,CAACE,QAFS,EAGlB;AACIW,YAAAA,KAAK,EAAEF,uBAAuB,CAACE;AADnC,WAHkB,CAAtB;AAOArD,UAAAA,UAAU,CAACgB,UAAX,CAAsBsC,MAAtB,CAA6BF,QAA7B;AACAhC,UAAAA,GAAG,CAACe,OAAJ,CAAYa,KAAZ,IAA4BR,QAAQ,CAACE,QAArC;AACH,SAZD;AAaAI,QAAAA,WAAW,CAACS,MAAZ,CAAmBlD,OAAnB,CAA2B,UAAAmD,GAAG,EAAI;AAC9BpC,UAAAA,GAAG,CAACgB,KAAJ,CAAUoB,GAAG,CAACC,UAAd,IAA4BD,GAA5B;AACH,SAFD;AAGAxD,QAAAA,UAAU,CAACE,aAAX,CAAyBwD,SAAzB,CAAmCC,QAAnC;;AACA,eAAKrC,QAAL,CAAcsC,IAAd,CAAmBd,WAAW,CAACe,SAA/B;;AAEA,eAAOzC,GAAP;AA/DuG;AAgE1G,K;;;;;SACK0C,iB,8BAAkBC,G,EAAeC,O;QAAgF;AAAA,mBACxE,IADwE;;AAAA,6BAC1F,4CAD0F,iBAC7GhE,UAD6G;AAEnH,YAAI,CAACA,UAAL,EAAiB;AACb,iBAAO,iDAA4B,mBAA5B,EAAiD,CAAC+D,GAAD,EAAMC,OAAN,CAAjD,CAAP;AACH;;AAED,YAAM5C,GAAwD,GAAG,EAAjE;AACA2C,QAAAA,GAAG,CAAC1D,OAAJ,CAAY,UAAAoC,EAAE,EAAI;AACd,cAAME,YAAY,GAAG3C,UAAU,CAACgB,UAAX,CAAsB4B,EAAtB,CAAyB,OAAKnB,WAA9B,EAA2CgB,EAA3C,CAArB;;AACA,cACIE,YAAY,KACX,CAACA,YAAY,CAACsB,QAAd,IAA0BD,OADf,CADhB,EAGE;AACE5C,YAAAA,GAAG,CAACqB,EAAD,CAAH,GAAU,gCAAaE,YAAb,CAAV;AACH;AACJ,SARD;AASA,eAAOvB,GAAP;AAhBmH;AAiBtH,K;;;;;SACK8C,K,kBAAMC,a;QAAgF;AAAA,mBAC7C,IAD6C;;AAAA,6BAC/D,4CAD+D,iBAClFnE,UADkF;AAExF,YAAI,CAACA,UAAL,EAAiB;AACb,iBAAO,iDAA4B,OAA5B,EAAqC,CAACmE,aAAD,CAArC,CAAP;AACH;;AAED,YAAID,KAAK,GAAGlE,UAAU,CAACgB,UAAX,CACPoD,KADO,GAEPC,IAFO,CAEFF,aAAa,CAACG,QAFZ,CAAZ;;AAIA,YAAIH,aAAa,CAACI,IAAlB,EAAwB;AACpBL,UAAAA,KAAK,GAAGA,KAAK,CAACK,IAAN,CAAW,yCAAsB,OAAK/E,MAA3B,EAAmC2E,aAAnC,CAAX,CAAR;AACH;AAED;AACR;AACA;AACA;;;AACQ,YAAIA,aAAa,CAACK,IAAlB,EAAwB;AACpBN,UAAAA,KAAK,GAAGA,KAAK,CAACO,MAAN,CAAaN,aAAa,CAACK,IAA3B,CAAR;AACH;;AAED,YAAIL,aAAa,CAACO,KAAlB,EAAyB;AACrBR,UAAAA,KAAK,GAAGA,KAAK,CAACQ,KAAN,CAAYP,aAAa,CAACO,KAA1B,CAAR;AACH;;AAED,YAAMC,cAAc,GAAGT,KAAK,CAACU,IAAN,GAAaC,GAAb,CAAiB,UAAAC,OAAO;AAAA,iBAAI,gCAAaA,OAAb,CAAJ;AAAA,SAAxB,CAAvB;AACA,eAAO;AACHC,UAAAA,SAAS,EAAEJ;AADR,SAAP;AA3BwF;AA8B3F,K;;;;;SACDK,iB,GAAA,2BAAkBC,WAAlB,EAAuCC,aAAvC,EAA+E;AAC3E,UAAM,IAAIC,KAAJ,CAAU,+EAAV,CAAN;AACH,G;;SAGKC,wB,qCACFV,K,EACAW,U;QAIC;AAAA,mBAC0C,IAD1C;;AAAA,6BACwB,4CADxB,iBACKrF,UADL;AAED,YAAI,CAACA,UAAL,EAAiB;AACb,iBAAO,iDAA4B,0BAA5B,EAAwD,CAAC0E,KAAD,EAAQW,UAAR,CAAxD,CAAP;AACH;;AAED,YAAMC,QAAQ,GAAGD,UAAU,GAAGA,UAAU,CAACE,GAAd,GAAoBC,yBAA/C;AACA,YAAMtB,KAAK,GAAGlE,UAAU,CAACgB,UAAX,CACToD,KADS,GAETC,IAFS,CAEJ;AACF,uBAAa;AACToB,YAAAA,IAAI,EAAEH;AADG;AADX,SAFI,EAOTf,IAPS,CAOJ,qDAA0C,OAAK9C,WAA/C,CAPI,CAAd;AAQA,YAAIiE,WAAW,GAAGxB,KAAK,CAACU,IAAN,EAAlB;AAEA,YAAMe,KAAK,GAAGD,WAAW,CAAC,CAAD,CAAzB;;AACA,YACIL,UAAU,IACVM,KADA,IAEAA,KAAK,CAAC,OAAKlE,WAAN,CAAL,KAA4B4D,UAAU,CAAC5C,EAFvC,IAGAkD,KAAK,CAACC,KAAN,CAAYL,GAAZ,KAAoBF,UAAU,CAACE,GAJnC,EAKE;AACEG,UAAAA,WAAW,CAACG,KAAZ;AACH;;AAEDH,QAAAA,WAAW,GAAGA,WAAW,CAACI,KAAZ,CAAkB,CAAlB,EAAqBpB,KAArB,CAAd;AACA,eAAOgB,WAAW,CAACb,GAAZ,CAAgB,UAAAkB,OAAO;AAAA,iBAAK;AAC/BrD,YAAAA,QAAQ,EAAE,gCAAaqD,OAAb,CADqB;AAE/BV,YAAAA,UAAU,EAAE;AACR5C,cAAAA,EAAE,EAAEsD,OAAO,CAAC,OAAKtE,WAAN,CADH;AAER8D,cAAAA,GAAG,EAAEQ,OAAO,CAACH,KAAR,CAAcL;AAFX;AAFmB,WAAL;AAAA,SAAvB,CAAP;AA5BC;AAmCJ,K;;;;;SAEDS,Y,GAAA,wBAAuF;AACnF,WAAO,KAAK1E,QAAL,CAAc2E,YAAd,EAAP;AACH,G;;SAEKC,O,oBAAQC,kB;QAA8C;AAAA,oBACb,IADa;;AAAA,6BAC/B,6CAD+B,iBAClDnG,UADkD;AAExD,YAAI,CAACA,UAAL,EAAiB;AACb,iBAAO,kDAA4B,SAA5B,EAAuC,CAACmG,kBAAD,CAAvC,CAAP;AACH;;AAED,YAAMC,kBAAkB,GAAG,EAA3B;AACA,YAAMC,eAAe,GAAG,mBAAQF,kBAAhC;AACA,YAAMjC,KAAK,GAAGlE,UAAU,CAACgB,UAAX,CACToD,KADS,GAETC,IAFS,CAEJ;AACFJ,UAAAA,QAAQ,EAAE,IADR;AAEF,uBAAa;AACTqC,YAAAA,GAAG,EAAED;AADI;AAFX,SAFI,EAOP3B,KAPO,CAOD0B,kBAPC,CAAd;AAQA,YAAMzB,cAAc,GAAGT,KAAK,CAACU,IAAN,EAAvB;;AACA,YAAID,cAAc,CAAC1C,MAAf,GAAwB,CAA5B,EAA+B;AAC3BjC,UAAAA,UAAU,CAACgB,UAAX,CAAsBuF,MAAtB,CAA6B5B,cAA7B;AACA3E,UAAAA,UAAU,CAACE,aAAX,CAAyBwD,SAAzB,CAAmCC,QAAnC;AACH;;AAED,eAAOgB,cAAc,CAAC1C,MAAf,KAA0BmE,kBAAjC;AAtBwD;AAuB3D,K;;;;;SAEKI,K;QAAuB;AAAA;AAmBzB,4DAAiC,QAAKvH,OAAtC,EAA+C,QAAKK,YAApD;AAnByB;;AAAA,oBACzB,IADyB;;AACzB,cAAKS,MAAL,GAAc,IAAd;;AACA,cAAKuB,QAAL,CAAcmF,QAAd;;AACA/E;;AAHyB;AAAA,YAKrB,QAAKjC,SAAL,CAAeO,UALM;AAAA,iCAMI,QAAKP,SAAL,CAAeO,UANnB,iBAMfA,UANe;AAAA,mCAOC,mCAClB,QAAKV,YADa,EAElB,QAAKH,gBAFa,CAPD,iBAOfuH,OAPe;AAAA,qCAWfA,OAAO,CAAChD,SAAR,CAAkBiD,GAAlB,EAXe;AAAA,uCAYf,wCACF,QAAKrH,YADH,EAEF,CACIU,UAAU,CAACgB,UADf,CAFE,CAZe;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAoB5B,K;;;;;SACKuF,M;QAAwB;AAAA,oBACiB,IADjB;;AAAA,6BACD,6CADC,iBACpBvG,UADoB;AAE1B,YAAI,CAACA,UAAL,EAAiB;AACb,iBAAO,kDAA4B,QAA5B,EAAsC,EAAtC,CAAP;AACH;;AACDA,QAAAA,UAAU,CAACE,aAAX,CAAyBe,QAAzB,CAAkC2F,gBAAlC,CAAmD5G,UAAU,CAACgB,UAAX,CAAsB6F,IAAzE;AACA,eAAO,QAAKL,KAAL,EAAP;AAN0B;AAO7B,K","sourcesContent":["import {\n    Subject,\n    Observable\n} from 'rxjs';\nimport {\n    flatClone,\n    now,\n    ensureNotFalsy,\n    isMaybeReadonlyArray,\n    getFromMapOrThrow,\n    getSortDocumentsByLastWriteTimeComparator,\n    RX_META_LWT_MINIMUM\n} from '../../util';\nimport { newRxError } from '../../rx-error';\nimport type {\n    RxStorageInstance,\n    LokiSettings,\n    RxStorageChangeEvent,\n    RxDocumentData,\n    BulkWriteRow,\n    RxStorageBulkWriteResponse,\n    RxStorageQueryResult,\n    RxJsonSchema,\n    MangoQuery,\n    LokiStorageInternals,\n    RxStorageInstanceCreationParams,\n    LokiDatabaseSettings,\n    LokiLocalDatabaseState,\n    EventBulk,\n    LokiChangesCheckpoint\n} from '../../types';\nimport {\n    closeLokiCollections,\n    getLokiDatabase,\n    OPEN_LOKIJS_STORAGE_INSTANCES,\n    LOKIJS_COLLECTION_DEFAULT_OPTIONS,\n    stripLokiKey,\n    getLokiSortComparator,\n    getLokiLeaderElector,\n    removeLokiLeaderElectorReference,\n    requestRemoteInstance,\n    mustUseLocalState,\n    handleRemoteRequest\n} from './lokijs-helper';\nimport type {\n    Collection\n} from 'lokijs';\nimport type { RxStorageLoki } from './rx-storage-lokijs';\nimport { getPrimaryFieldOfPrimaryKey } from '../../rx-schema-helper';\nimport { categorizeBulkWriteRows } from '../../rx-storage-helper';\n\nlet instanceId = now();\n\nexport class RxStorageInstanceLoki<RxDocType> implements RxStorageInstance<\n    RxDocType,\n    LokiStorageInternals,\n    LokiSettings\n> {\n\n    public readonly primaryPath: keyof RxDocType;\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>>> = new Subject();\n    private lastChangefeedSequence: number = 0;\n    public readonly instanceId = instanceId++;\n\n    public closed = false;\n\n    constructor(\n        public readonly storage: RxStorageLoki,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<RxDocumentData<RxDocType>>>,\n        public readonly internals: LokiStorageInternals,\n        public readonly options: Readonly<LokiSettings>,\n        public readonly databaseSettings: LokiDatabaseSettings\n    ) {\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey) as any;\n        OPEN_LOKIJS_STORAGE_INSTANCES.add(this);\n        if (this.internals.leaderElector) {\n            this.internals.leaderElector.awaitLeadership().then(() => {\n                // this instance is leader now, so it has to reply to queries from other instances\n                ensureNotFalsy(this.internals.leaderElector).broadcastChannel\n                    .addEventListener('message', async (msg) => handleRemoteRequest(this, msg));\n            });\n        }\n    }\n\n    async bulkWrite(documentWrites: BulkWriteRow<RxDocType>[]): Promise<RxStorageBulkWriteResponse<RxDocType>> {\n        if (documentWrites.length === 0) {\n            throw newRxError('P2', {\n                args: {\n                    documentWrites\n                }\n            });\n        }\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'bulkWrite', [documentWrites]);\n        }\n\n        const ret: RxStorageBulkWriteResponse<RxDocType> = {\n            success: {},\n            error: {}\n        };\n\n        const docsInDb: Map<RxDocumentData<RxDocType>[keyof RxDocType], RxDocumentData<RxDocType>> = new Map();\n        const docsInDbWithLokiKey: Map<\n            RxDocumentData<RxDocType>[keyof RxDocType],\n            RxDocumentData<RxDocType> & { $loki: number; }\n        > = new Map();\n        documentWrites.forEach(writeRow => {\n            const id = writeRow.document[this.primaryPath];\n            const documentInDb = localState.collection.by(this.primaryPath, id);\n            if (documentInDb) {\n                docsInDbWithLokiKey.set(id, documentInDb);\n                docsInDb.set(id, stripLokiKey(documentInDb));\n            }\n        });\n\n        const categorized = categorizeBulkWriteRows<RxDocType>(\n            this,\n            this.primaryPath,\n            docsInDb,\n            documentWrites\n        );\n\n        categorized.bulkInsertDocs.forEach(writeRow => {\n            const docId = writeRow.document[this.primaryPath];\n            localState.collection.insert(flatClone(writeRow.document));\n            ret.success[docId as any] = writeRow.document;\n        });\n        categorized.bulkUpdateDocs.forEach(writeRow => {\n            const docId = writeRow.document[this.primaryPath];\n            const documentInDbWithLokiKey = getFromMapOrThrow(docsInDbWithLokiKey, docId);\n            const writeDoc: any = Object.assign(\n                {},\n                writeRow.document,\n                {\n                    $loki: documentInDbWithLokiKey.$loki\n                }\n            );\n            localState.collection.update(writeDoc);\n            ret.success[docId as any] = writeRow.document;\n        });\n        categorized.errors.forEach(err => {\n            ret.error[err.documentId] = err;\n        });\n        localState.databaseState.saveQueue.addWrite();\n        this.changes$.next(categorized.eventBulk);\n\n        return ret;\n    }\n    async findDocumentsById(ids: string[], deleted: boolean): Promise<{ [documentId: string]: RxDocumentData<RxDocType> }> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'findDocumentsById', [ids, deleted]);\n        }\n\n        const ret: { [documentId: string]: RxDocumentData<RxDocType> } = {};\n        ids.forEach(id => {\n            const documentInDb = localState.collection.by(this.primaryPath, id);\n            if (\n                documentInDb &&\n                (!documentInDb._deleted || deleted)\n            ) {\n                ret[id] = stripLokiKey(documentInDb);\n            }\n        });\n        return ret;\n    }\n    async query(preparedQuery: MangoQuery<RxDocType>): Promise<RxStorageQueryResult<RxDocType>> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'query', [preparedQuery]);\n        }\n\n        let query = localState.collection\n            .chain()\n            .find(preparedQuery.selector);\n\n        if (preparedQuery.sort) {\n            query = query.sort(getLokiSortComparator(this.schema, preparedQuery));\n        }\n\n        /**\n         * Offset must be used before limit in LokiJS\n         * @link https://github.com/techfort/LokiJS/issues/570\n         */\n        if (preparedQuery.skip) {\n            query = query.offset(preparedQuery.skip);\n        }\n\n        if (preparedQuery.limit) {\n            query = query.limit(preparedQuery.limit);\n        }\n\n        const foundDocuments = query.data().map(lokiDoc => stripLokiKey(lokiDoc));\n        return {\n            documents: foundDocuments\n        };\n    }\n    getAttachmentData(_documentId: string, _attachmentId: string): Promise<string> {\n        throw new Error('Attachments are not implemented in the lokijs RxStorage. Make a pull request.');\n    }\n\n\n    async getChangedDocumentsSince(\n        limit: number,\n        checkpoint?: LokiChangesCheckpoint\n    ): Promise<{\n        document: RxDocumentData<RxDocType>;\n        checkpoint: LokiChangesCheckpoint;\n    }[]> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'getChangedDocumentsSince', [limit, checkpoint]);\n        }\n\n        const sinceLwt = checkpoint ? checkpoint.lwt : RX_META_LWT_MINIMUM;\n        const query = localState.collection\n            .chain()\n            .find({\n                '_meta.lwt': {\n                    $gte: sinceLwt\n                }\n            })\n            .sort(getSortDocumentsByLastWriteTimeComparator(this.primaryPath as any));\n        let changedDocs = query.data();\n\n        const first = changedDocs[0];\n        if (\n            checkpoint &&\n            first &&\n            first[this.primaryPath] === checkpoint.id &&\n            first._meta.lwt === checkpoint.lwt\n        ) {\n            changedDocs.shift();\n        }\n\n        changedDocs = changedDocs.slice(0, limit);\n        return changedDocs.map(docData => ({\n            document: stripLokiKey(docData),\n            checkpoint: {\n                id: docData[this.primaryPath] as any,\n                lwt: docData._meta.lwt\n            }\n        }));\n    }\n\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>>> {\n        return this.changes$.asObservable();\n    }\n\n    async cleanup(minimumDeletedTime: number): Promise<boolean> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'cleanup', [minimumDeletedTime]);\n        }\n\n        const deleteAmountPerRun = 10;\n        const maxDeletionTime = now() - minimumDeletedTime;\n        const query = localState.collection\n            .chain()\n            .find({\n                _deleted: true,\n                '_meta.lwt': {\n                    $lt: maxDeletionTime\n                }\n            }).limit(deleteAmountPerRun);\n        const foundDocuments = query.data();\n        if (foundDocuments.length > 0) {\n            localState.collection.remove(foundDocuments);\n            localState.databaseState.saveQueue.addWrite();\n        }\n\n        return foundDocuments.length !== deleteAmountPerRun;\n    }\n\n    async close(): Promise<void> {\n        this.closed = true;\n        this.changes$.complete();\n        OPEN_LOKIJS_STORAGE_INSTANCES.delete(this);\n\n        if (this.internals.localState) {\n            const localState = await this.internals.localState;\n            const dbState = await getLokiDatabase(\n                this.databaseName,\n                this.databaseSettings\n            );\n            await dbState.saveQueue.run();\n            await closeLokiCollections(\n                this.databaseName,\n                [\n                    localState.collection\n                ]\n            );\n        }\n        removeLokiLeaderElectorReference(this.storage, this.databaseName);\n    }\n    async remove(): Promise<void> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'remove', []);\n        }\n        localState.databaseState.database.removeCollection(localState.collection.name);\n        return this.close();\n    }\n}\n\nexport async function createLokiLocalState<RxDocType>(\n    params: RxStorageInstanceCreationParams<RxDocType, LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<LokiLocalDatabaseState> {\n    if (!params.options) {\n        params.options = {};\n    }\n\n    const databaseState = await getLokiDatabase(\n        params.databaseName,\n        databaseSettings\n    );\n\n    /**\n     * Construct loki indexes from RxJsonSchema indexes.\n     * TODO what about compound indexes? Are they possible in lokijs?\n     */\n    const indices: string[] = [];\n    if (params.schema.indexes) {\n        params.schema.indexes.forEach(idx => {\n            if (!isMaybeReadonlyArray(idx)) {\n                indices.push(idx);\n            }\n        });\n    }\n    /**\n     * LokiJS has no concept of custom primary key, they use a number-id that is generated.\n     * To be able to query fast by primary key, we always add an index to the primary.\n     */\n    const primaryKey = getPrimaryFieldOfPrimaryKey(params.schema.primaryKey);\n    indices.push(primaryKey as string);\n\n    const lokiCollectionName = params.collectionName + '-' + params.schema.version;\n    const collectionOptions: Partial<CollectionOptions<RxDocumentData<RxDocType>>> = Object.assign(\n        {},\n        lokiCollectionName,\n        {\n            indices: indices as string[],\n            unique: [primaryKey]\n        } as any,\n        LOKIJS_COLLECTION_DEFAULT_OPTIONS\n    );\n\n    const collection: Collection = databaseState.database.addCollection(\n        lokiCollectionName,\n        collectionOptions as any\n    );\n    databaseState.collections[params.collectionName] = collection;\n    const ret: LokiLocalDatabaseState = {\n        databaseState,\n        collection\n    };\n\n    return ret;\n}\n\n\nexport async function createLokiStorageInstance<RxDocType>(\n    storage: RxStorageLoki,\n    params: RxStorageInstanceCreationParams<RxDocType, LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<RxStorageInstanceLoki<RxDocType>> {\n    const internals: LokiStorageInternals = {};\n\n    if (params.multiInstance) {\n        const leaderElector = getLokiLeaderElector(storage, params.databaseName);\n        internals.leaderElector = leaderElector;\n    } else {\n        // optimisation shortcut, directly create db is non multi instance.\n        internals.localState = createLokiLocalState(params, databaseSettings);\n        await internals.localState;\n    }\n\n    const instance = new RxStorageInstanceLoki(\n        storage,\n        params.databaseName,\n        params.collectionName,\n        params.schema,\n        internals,\n        params.options,\n        databaseSettings\n    );\n\n    /**\n     * Directly create the localState if the db becomes leader.\n     */\n    if (params.multiInstance) {\n        ensureNotFalsy(internals.leaderElector)\n            .awaitLeadership()\n            .then(() => {\n                if (!instance.closed) {\n                    mustUseLocalState(instance)\n                }\n            });\n    }\n\n\n    return instance;\n}\n"],"file":"rx-storage-instance-loki.js"}