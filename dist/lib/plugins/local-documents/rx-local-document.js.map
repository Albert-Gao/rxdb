{"version":3,"sources":["../../../../src/plugins/local-documents/rx-local-document.ts"],"names":["body","recover","result","e","then","pact","state","value","s","v","o","bind","observer","prototype","onFulfilled","onRejected","callback","_this","thenable","test","update","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","RxDocumentParent","RxLocalDocumentClass","id","jsonData","parent","RxLocalDocumentPrototype","isLocal","_handleChangeEvent","changeEvent","documentId","primary","operation","newData","documentData","_dataSync$","next","docCache","_isDeleted$","allAttachments$","document","primaryPath","$","asObservable","$emit","get","objPath","_data","undefined","valueObj","objectPath","overwritable","deepFreezeWhenDevMode","get$","includes","pipe","data","atomicUpdate","mutationFunction","Promise","res","rej","_atomicQueue","done","oldDocData","getValue","newDocData","_saveData","err","atomicPatch","patch","docData","Object","entries","forEach","k","oldData","storageInstance","bulkWrite","previous","docResult","success","error","_rev","remove","writeData","_deleted","_meta","_attachments","INIT_DONE","_init","docBaseProto","basePrototype","props","getOwnPropertyNames","key","exists","getOwnPropertyDescriptor","desc","defineProperty","getThrowingFun","functionName","createRxLocalDocument","newDoc","__proto__","set"],"mappings":"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","sourcesContent":["import objectPath from 'object-path';\nimport { distinctUntilChanged, map } from 'rxjs/operators';\nimport { overwritable } from '../../overwritable';\nimport { basePrototype, createRxDocumentConstructor } from '../../rx-document';\nimport { isPouchdbConflictError, newRxError, newRxTypeError } from '../../rx-error';\nimport { writeSingle } from '../../rx-storage-helper';\nimport type {\n    LocalDocumentAtomicUpdateFunction,\n    LocalDocumentState,\n    RxChangeEvent,\n    RxCollection,\n    RxDatabase,\n    RxDocument,\n    RxDocumentData,\n    RxDocumentWriteData,\n    RxLocalDocument,\n    RxLocalDocumentData\n} from '../../types';\nimport { clone, flatClone, getDefaultRevision, getDefaultRxDocumentMeta, getFromObjectOrThrow } from '../../util';\nimport { getLocalDocStateByParent } from './local-documents-helper';\n\nconst RxDocumentParent = createRxDocumentConstructor() as any;\n\nclass RxLocalDocumentClass<DocData = any> extends RxDocumentParent {\n    constructor(\n        public readonly id: string,\n        jsonData: DocData,\n        public readonly parent: RxCollection | RxDatabase,\n        public readonly state: LocalDocumentState\n    ) {\n        super(null, jsonData);\n    }\n}\n\n\n\nconst RxLocalDocumentPrototype: any = {\n    get isLocal() {\n        return true;\n    },\n\n    //\n    // overwrites\n    //\n\n    _handleChangeEvent(\n        this: any,\n        changeEvent: RxChangeEvent<RxLocalDocumentData>\n    ) {\n        if (changeEvent.documentId !== this.primary) {\n            return;\n        }\n        switch (changeEvent.operation) {\n            case 'UPDATE':\n                const newData = changeEvent.documentData;\n                this._dataSync$.next(newData);\n                break;\n            case 'DELETE':\n                // remove from docCache to assure new upserted RxDocuments will be a new instance\n                const docCache = this.state.docCache;\n                docCache.delete(this.primary);\n                this._isDeleted$.next(true);\n                break;\n        }\n    },\n\n    get allAttachments$() {\n        // this is overwritten here because we cannot re-set getters on the prototype\n        throw newRxError('LD1', {\n            document: this\n        });\n    },\n    get primaryPath() {\n        return 'id';\n    },\n    get primary() {\n        return this.id;\n    },\n    get $() {\n        return (this as RxDocument)._dataSync$.asObservable();\n    },\n    $emit(this: any, changeEvent: RxChangeEvent<RxLocalDocumentData>) {\n        return this.parent.$emit(changeEvent);\n    },\n    get(this: RxDocument, objPath: string) {\n        objPath = 'data.' + objPath;\n\n        if (!this._data) {\n            return undefined;\n        }\n        if (typeof objPath !== 'string') {\n            throw newRxTypeError('LD2', {\n                objPath\n            });\n        }\n\n        let valueObj = objectPath.get(this._data, objPath);\n        valueObj = overwritable.deepFreezeWhenDevMode(valueObj);\n        return valueObj;\n    },\n    get$(this: RxDocument, objPath: string) {\n        objPath = 'data.' + objPath;\n\n        if (objPath.includes('.item.')) {\n            throw newRxError('LD3', {\n                objPath\n            });\n        }\n        if (objPath === this.primaryPath) {\n            throw newRxError('LD4');\n        }\n\n        return this._dataSync$\n            .pipe(\n                map(data => objectPath.get(data, objPath)),\n                distinctUntilChanged()\n            );\n    },\n    atomicUpdate(mutationFunction: LocalDocumentAtomicUpdateFunction<any>) {\n        return new Promise((res, rej) => {\n            this._atomicQueue = this._atomicQueue\n                .then(async () => {\n                    let done = false;\n                    // we need a hacky while loop to stay incide the chain-link of _atomicQueue\n                    // while still having the option to run a retry on conflicts\n                    while (!done) {\n                        const oldDocData = this._dataSync$.getValue();\n                        try {\n                            // always await because mutationFunction might be async\n                            const newData = await mutationFunction(clone(oldDocData.data), this);\n\n                            const newDocData = flatClone(oldDocData);\n                            newDocData.data = newData;\n\n                            await this._saveData(newDocData, oldDocData);\n                            done = true;\n                        } catch (err) {\n                            /**\n                             * conflicts cannot happen by just using RxDB in one process\n                             * There are two ways they still can appear which is\n                             * replication and multi-tab usage\n                             * Because atomicUpdate has a mutation function,\n                             * we can just re-run the mutation until there is no conflict\n                             */\n                            if (isPouchdbConflictError(err as any)) {\n                                // pouchdb conflict error -> retrying\n                            } else {\n                                rej(err);\n                                return;\n                            }\n                        }\n                    }\n                    res(this);\n                });\n        });\n    },\n    atomicPatch(patch: Partial<any>) {\n        return this.atomicUpdate((docData: any) => {\n            Object\n                .entries(patch)\n                .forEach(([k, v]) => {\n                    docData[k] = v;\n                });\n            return docData;\n        });\n    },\n    async _saveData(this: RxLocalDocument<any>, newData: RxDocumentData<RxLocalDocumentData>) {\n        const state = await getLocalDocStateByParent(this.parent);\n        const oldData: RxDocumentData<RxLocalDocumentData> = this._dataSync$.getValue() as any;\n        newData.id = (this as any).id;\n        return state.storageInstance.bulkWrite([{\n            previous: oldData,\n            document: newData\n        }])\n            .then((res) => {\n                const docResult = res.success[newData.id];\n                if (!docResult) {\n                    throw getFromObjectOrThrow(res.error, newData.id);\n                }\n                newData = flatClone(newData);\n                newData._rev = docResult._rev;\n            });\n    },\n\n    async remove(this: any): Promise<void> {\n        const state = await getLocalDocStateByParent(this.parent);\n        const writeData: RxDocumentWriteData<RxLocalDocumentData> = {\n            id: this.id,\n            data: {},\n            _deleted: true,\n            _meta: getDefaultRxDocumentMeta(),\n            _rev: getDefaultRevision(),\n            _attachments: {}\n        };\n        return writeSingle(state.storageInstance, {\n            previous: this._data,\n            document: writeData\n        })\n            .then(() => {\n                this.state.docCache.delete(this.id);\n            });\n    }\n};\n\n\n\nlet INIT_DONE = false;\nconst _init = () => {\n    if (INIT_DONE) return;\n    else INIT_DONE = true;\n\n    // add functions of RxDocument\n    const docBaseProto = basePrototype;\n    const props = Object.getOwnPropertyNames(docBaseProto);\n    props.forEach(key => {\n        const exists = Object.getOwnPropertyDescriptor(RxLocalDocumentPrototype, key);\n        if (exists) return;\n        const desc: any = Object.getOwnPropertyDescriptor(docBaseProto, key);\n        Object.defineProperty(RxLocalDocumentPrototype, key, desc);\n    });\n\n\n    /**\n     * Overwrite things that do not work on local documents\n     * with a throwing function.\n     */\n    const getThrowingFun = (k: string) => () => {\n        throw newRxError('LD6', {\n            functionName: k\n        });\n    };\n    [\n        'populate',\n        'update',\n        'putAttachment',\n        'getAttachment',\n        'allAttachments'\n    ].forEach((k: string) => RxLocalDocumentPrototype[k] = getThrowingFun(k));\n};\n\n\n\nexport function createRxLocalDocument<DocData>(\n    id: string,\n    data: RxDocumentData<RxLocalDocumentData<DocData>>,\n    parent: any,\n    state: LocalDocumentState\n): RxLocalDocument<DocData> {\n    _init();\n    const newDoc = new RxLocalDocumentClass(id, data, parent, state);\n    newDoc.__proto__ = RxLocalDocumentPrototype;\n    state.docCache.set(id, newDoc as any);\n    return newDoc as any;\n}\n"],"file":"rx-local-document.js"}