{"version":3,"sources":["../../src/rx-change-event.ts"],"names":["getDocumentDataOfRxChangeEvent","rxChangeEvent","documentData","previousDocumentData","rxChangeEventToEventReduceChangeEvent","operation","id","documentId","doc","previous","overwritable","deepFreezeWhenDevMode","flattenEvents","input","output","Array","isArray","forEach","inputItem","add","concat","events","ev","push","usedIds","Set","nonDuplicate","has","eventId"],"mappings":";;;;;;;;;AAQA;;AARA;AACA;AACA;AACA;AAaO,SAASA,8BAAT,CACHC,aADG,EAEc;AACjB,MAAKA,aAAD,CAAuBC,YAA3B,EAAyC;AACrC,WAAQD,aAAD,CAAuBC,YAA9B;AACH,GAFD,MAEO;AACH,WAAQD,aAAD,CAAuBE,oBAA9B;AACH;AAEJ;;AAEM,SAASC,qCAAT,CACHH,aADG,EAE4B;AAC/B,UAAQA,aAAa,CAACI,SAAtB;AACI,SAAK,QAAL;AACI,aAAO;AACHA,QAAAA,SAAS,EAAEJ,aAAa,CAACI,SADtB;AAEHC,QAAAA,EAAE,EAAEL,aAAa,CAACM,UAFf;AAGHC,QAAAA,GAAG,EAAEP,aAAa,CAACC,YAHhB;AAIHO,QAAAA,QAAQ,EAAE;AAJP,OAAP;;AAMJ,SAAK,QAAL;AACI,aAAO;AACHJ,QAAAA,SAAS,EAAEJ,aAAa,CAACI,SADtB;AAEHC,QAAAA,EAAE,EAAEL,aAAa,CAACM,UAFf;AAGHC,QAAAA,GAAG,EAAEE,2BAAaC,qBAAb,CAAmCV,aAAa,CAACC,YAAjD,CAHF;AAIHO,QAAAA,QAAQ,EAAER,aAAa,CAACE,oBAAd,GAAqCF,aAAa,CAACE,oBAAnD,GAAiF;AAJxF,OAAP;;AAMJ,SAAK,QAAL;AACI,aAAO;AACHE,QAAAA,SAAS,EAAEJ,aAAa,CAACI,SADtB;AAEHC,QAAAA,EAAE,EAAEL,aAAa,CAACM,UAFf;AAGHC,QAAAA,GAAG,EAAE,IAHF;AAIHC,QAAAA,QAAQ,EAAER,aAAa,CAACE;AAJrB,OAAP;AAhBR;AAuBH;AAED;AACA;AACA;AACA;;;AACO,SAASS,aAAT,CACHC,KADG,EAEQ;AACX,MAAIC,MAAmB,GAAG,EAA1B;;AAEA,MAAIC,KAAK,CAACC,OAAN,CAAcH,KAAd,CAAJ,EAA0B;AACtBA,IAAAA,KAAK,CAACI,OAAN,CAAc,UAAAC,SAAS,EAAI;AACvB,UAAMC,GAAG,GAAGP,aAAa,CAACM,SAAD,CAAzB;AACAJ,MAAAA,MAAM,GAAGA,MAAM,CAACM,MAAP,CAAcD,GAAd,CAAT;AACH,KAHD;AAIH,GALD,MAKO;AACH,QAAKN,KAAD,CAAeP,EAAf,IAAsBO,KAAD,CAAeQ,MAAxC,EAAgD;AAC5C;AACCR,MAAAA,KAAD,CACKQ,MADL,CAEKJ,OAFL,CAEa,UAAAK,EAAE;AAAA,eAAIR,MAAM,CAACS,IAAP,CAAYD,EAAZ,CAAJ;AAAA,OAFf;AAGH,KALD,MAKO;AACHR,MAAAA,MAAM,CAACS,IAAP,CAAYV,KAAZ;AACH;AACJ;;AAED,MAAMW,OAAO,GAAG,IAAIC,GAAJ,EAAhB;AACA,MAAMC,YAAyB,GAAG,EAAlC;AACAZ,EAAAA,MAAM,CAACG,OAAP,CAAe,UAAAK,EAAE,EAAI;AACjB,QAAI,CAACE,OAAO,CAACG,GAAR,CAAaL,EAAD,CAAYM,OAAxB,CAAL,EAAuC;AACnCJ,MAAAA,OAAO,CAACL,GAAR,CAAaG,EAAD,CAAYM,OAAxB;AACAF,MAAAA,YAAY,CAACH,IAAb,CAAkBD,EAAlB;AACH;AACJ,GALD;AAOA,SAAOI,YAAP;AACH","sourcesContent":["/**\n * RxChangeEvents a emitted when something in the database changes\n * they can be grabbed by the observables of database, collection and document\n */\n\nimport {\n    ChangeEvent as EventReduceChangeEvent,\n} from 'event-reduce-js';\nimport { overwritable } from './overwritable';\n\nimport type {\n    EventBulk,\n    RxChangeEvent,\n    RxDocumentData\n} from './types';\n\nexport function getDocumentDataOfRxChangeEvent<T>(\n    rxChangeEvent: RxChangeEvent<T>\n): RxDocumentData<T> {\n    if ((rxChangeEvent as any).documentData) {\n        return (rxChangeEvent as any).documentData;\n    } else {\n        return (rxChangeEvent as any).previousDocumentData;\n    }\n\n}\n\nexport function rxChangeEventToEventReduceChangeEvent<DocType>(\n    rxChangeEvent: RxChangeEvent<DocType>\n): EventReduceChangeEvent<DocType> {\n    switch (rxChangeEvent.operation) {\n        case 'INSERT':\n            return {\n                operation: rxChangeEvent.operation,\n                id: rxChangeEvent.documentId,\n                doc: rxChangeEvent.documentData as any,\n                previous: null\n            };\n        case 'UPDATE':\n            return {\n                operation: rxChangeEvent.operation,\n                id: rxChangeEvent.documentId,\n                doc: overwritable.deepFreezeWhenDevMode(rxChangeEvent.documentData) as any,\n                previous: rxChangeEvent.previousDocumentData ? rxChangeEvent.previousDocumentData as any : 'UNKNOWN'\n            };\n        case 'DELETE':\n            return {\n                operation: rxChangeEvent.operation,\n                id: rxChangeEvent.documentId,\n                doc: null,\n                previous: rxChangeEvent.previousDocumentData as DocType\n            };\n    }\n}\n\n/**\n * Flattens the given events into a single array of events.\n * Used mostly in tests.\n */\nexport function flattenEvents<EventType>(\n    input: EventBulk<EventType> | EventBulk<EventType>[] | EventType | EventType[]\n): EventType[] {\n    let output: EventType[] = [];\n\n    if (Array.isArray(input)) {\n        input.forEach(inputItem => {\n            const add = flattenEvents(inputItem);\n            output = output.concat(add);\n        });\n    } else {\n        if ((input as any).id && (input as any).events) {\n            // is bulk\n            (input as EventBulk<EventType>)\n                .events\n                .forEach(ev => output.push(ev));\n        } else {\n            output.push(input as any);\n        }\n    }\n\n    const usedIds = new Set<string>();\n    const nonDuplicate: EventType[] = [];\n    output.forEach(ev => {\n        if (!usedIds.has((ev as any).eventId)) {\n            usedIds.add((ev as any).eventId);\n            nonDuplicate.push(ev);\n        }\n    });\n\n    return nonDuplicate;\n}\n"],"file":"rx-change-event.js"}