{"version":3,"sources":["../../src/rx-document.ts"],"names":["body","recover","result","e","then","pact","state","value","s","v","o","bind","observer","prototype","onFulfilled","onRejected","callback","_this","thenable","test","update","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","basePrototype","_data","isInstanceOfRxDocument","undefined","_dataSync$","getValue","primaryPath","collection","schema","primary","revision","_rev","deleted$","_isDeleted$","asObservable","deleted","$","pipe","docData","overwritable","deepFreezeWhenDevMode","_handleChangeEvent","changeEvent","documentId","newRevNr","currentRevNr","operation","newData","documentData","next","_docCache","get$","path","includes","finalFields","schemaObj","jsonSchema","data","objectPath","get","populate","PROMISE_RESOLVE_NULL","ref","refCollection","database","collections","type","findByIds","res","valuesIterator","values","Array","from","findOne","exec","objPath","valueObj","isArray","defineGetterSetter","toJSON","withMetaFields","_attachments","_deleted","_meta","toMutableJSON","set","_isTemporary","Object","is","pathEls","split","pop","rootPath","join","childpath","_updateObj","putAttachment","getAttachment","allAttachments","allAttachments$","atomicUpdate","mutationFunction","Promise","rej","_atomicQueue","done","oldData","fillObjectWithDefaults","_saveData","err","atomicPatch","patch","entries","forEach","k","id","document","validateChange","_runHooks","validate","storageInstance","bulkWrite","previous","writeResult","isError","error","success","save","insert","remove","deletedData","destroy","createRxDocumentConstructor","proto","constructor","RxDocumentConstructor","jsonData","BehaviorSubject","PROMISE_RESOLVE_VOID","thisObj","pathProperties","properties","keys","key","fullPath","__defineGetter__","ret","defineProperty","enumerable","configurable","__defineSetter__","val","createWithConstructor","startsWith","doc","isRxDocument","obj"],"mappings":"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","sourcesContent":["import objectPath from 'object-path';\nimport {\n    Observable,\n    BehaviorSubject\n} from 'rxjs';\nimport {\n    distinctUntilChanged,\n    map\n} from 'rxjs/operators';\nimport {\n    clone,\n    trimDots,\n    getHeightOfRevision,\n    pluginMissing,\n    flatClone,\n    PROMISE_RESOLVE_NULL,\n    PROMISE_RESOLVE_VOID,\n    ensureNotFalsy\n} from './util';\nimport {\n    newRxError,\n    newRxTypeError,\n    isPouchdbConflictError\n} from './rx-error';\nimport {\n    runPluginHooks\n} from './hooks';\n\nimport type {\n    RxDocument,\n    RxCollection,\n    RxDocumentData,\n    RxDocumentWriteData,\n    RxChangeEvent\n} from './types';\nimport { getDocumentDataOfRxChangeEvent } from './rx-change-event';\nimport { overwritable } from './overwritable';\nimport { getSchemaByObjectPath } from './rx-schema-helper';\nimport { throwIfIsStorageWriteError } from './rx-storage-helper';\n\nexport const basePrototype = {\n\n    /**\n     * TODO\n     * instead of appliying the _this-hack\n     * we should make these accesors functions instead of getters.\n     */\n    get _data() {\n        const _this: RxDocument = this as any;\n        /**\n         * Might be undefined when vuejs-devtools are used\n         * @link https://github.com/pubkey/rxdb/issues/1126\n         */\n        if (!_this.isInstanceOfRxDocument) {\n            return undefined;\n        }\n\n        return _this._dataSync$.getValue();\n    },\n    get primaryPath() {\n        const _this: RxDocument = this as any;\n        if (!_this.isInstanceOfRxDocument) {\n            return undefined;\n        }\n        return _this.collection.schema.primaryPath;\n    },\n    get primary() {\n        const _this: RxDocument = this as any;\n        if (!_this.isInstanceOfRxDocument) {\n            return undefined;\n        }\n        return (_this._data as any)[_this.primaryPath];\n    },\n    get revision() {\n        const _this: RxDocument = this as any;\n        if (!_this.isInstanceOfRxDocument) {\n            return undefined;\n        }\n        return _this._data._rev;\n    },\n    get deleted$() {\n        const _this: RxDocument = this as any;\n        if (!_this.isInstanceOfRxDocument) {\n            return undefined;\n        }\n        return _this._isDeleted$.asObservable();\n    },\n    get deleted() {\n        const _this: RxDocument = this as any;\n        if (!_this.isInstanceOfRxDocument) {\n            return undefined;\n        }\n        return _this._isDeleted$.getValue();\n    },\n\n    /**\n     * returns the observable which emits the plain-data of this document\n     */\n    get $(): Observable<any> {\n        const _this: RxDocument = this as any;\n        return _this._dataSync$.asObservable().pipe(\n            map(docData => overwritable.deepFreezeWhenDevMode(docData))\n        );\n    },\n\n    _handleChangeEvent(this: RxDocument, changeEvent: RxChangeEvent<any>) {\n        if (changeEvent.documentId !== this.primary) {\n            return;\n        }\n\n        // ensure that new _rev is higher then current\n        const docData = getDocumentDataOfRxChangeEvent(changeEvent);\n        const newRevNr = getHeightOfRevision(docData._rev);\n        const currentRevNr = getHeightOfRevision(this._data._rev);\n        if (currentRevNr > newRevNr) return;\n\n        switch (changeEvent.operation) {\n            case 'INSERT':\n                break;\n            case 'UPDATE':\n                const newData = changeEvent.documentData;\n                this._dataSync$.next(newData);\n                break;\n            case 'DELETE':\n                // remove from docCache to assure new upserted RxDocuments will be a new instance\n                this.collection._docCache.delete(this.primary);\n                this._isDeleted$.next(true);\n                break;\n        }\n    },\n\n    /**\n     * returns observable of the value of the given path\n     */\n    get$(this: RxDocument, path: string): Observable<any> {\n        if (path.includes('.item.')) {\n            throw newRxError('DOC1', {\n                path\n            });\n        }\n\n        if (path === this.primaryPath)\n            throw newRxError('DOC2');\n\n        // final fields cannot be modified and so also not observed\n        if (this.collection.schema.finalFields.includes(path)) {\n            throw newRxError('DOC3', {\n                path\n            });\n        }\n\n        const schemaObj = getSchemaByObjectPath(\n            this.collection.schema.jsonSchema,\n            path\n        );\n        if (!schemaObj) {\n            throw newRxError('DOC4', {\n                path\n            });\n        }\n\n        return this._dataSync$\n            .pipe(\n                map(data => objectPath.get(data, path)),\n                distinctUntilChanged()\n            );\n    },\n\n    /**\n     * populate the given path\n     */\n    populate(this: RxDocument, path: string): Promise<RxDocument | null> {\n        const schemaObj = getSchemaByObjectPath(\n            this.collection.schema.jsonSchema,\n            path\n        );\n        const value = this.get(path);\n        if (!value) {\n            return PROMISE_RESOLVE_NULL;\n        }\n        if (!schemaObj) {\n            throw newRxError('DOC5', {\n                path\n            });\n        }\n        if (!schemaObj.ref) {\n            throw newRxError('DOC6', {\n                path,\n                schemaObj\n            });\n        }\n\n        const refCollection: RxCollection = this.collection.database.collections[schemaObj.ref];\n        if (!refCollection) {\n            throw newRxError('DOC7', {\n                ref: schemaObj.ref,\n                path,\n                schemaObj\n            });\n        }\n\n        if (schemaObj.type === 'array') {\n            return refCollection.findByIds(value).then(res => {\n                const valuesIterator = res.values();\n                return Array.from(valuesIterator) as any;\n            });\n        } else {\n            return refCollection.findOne(value).exec();\n        }\n    },\n\n    /**\n     * get data by objectPath\n     */\n    get(this: RxDocument, objPath: string): any | null {\n        if (!this._data) return undefined;\n        let valueObj = objectPath.get(this._data, objPath);\n\n        // direct return if array or non-object\n        if (\n            typeof valueObj !== 'object' ||\n            Array.isArray(valueObj)\n        ) {\n            return overwritable.deepFreezeWhenDevMode(valueObj);\n        }\n\n        /**\n         * TODO find a way to deep-freeze together with defineGetterSetter\n         * so we do not have to do a deep clone here.\n         */\n        valueObj = clone(valueObj);\n        defineGetterSetter(\n            this.collection.schema,\n            valueObj,\n            objPath,\n            this as any\n        );\n        return valueObj;\n    },\n\n    toJSON(this: RxDocument, withMetaFields = false) {\n        if (!withMetaFields) {\n            const data = flatClone(this._data);\n            delete (data as any)._rev;\n            delete (data as any)._attachments;\n            delete (data as any)._deleted;\n            delete (data as any)._meta;\n            return overwritable.deepFreezeWhenDevMode(data);\n        } else {\n            return overwritable.deepFreezeWhenDevMode(this._data);\n        }\n    },\n    toMutableJSON(this: RxDocument, withMetaFields = false) {\n        return clone(this.toJSON(withMetaFields as any));\n    },\n\n    /**\n     * set data by objectPath\n     * This can only be called on temporary documents\n     */\n    set(this: RxDocument, objPath: string, value: any) {\n\n        // setters can only be used on temporary documents\n        if (!this._isTemporary) {\n            throw newRxTypeError('DOC16', {\n                objPath,\n                value\n            });\n        }\n\n        if (typeof objPath !== 'string') {\n            throw newRxTypeError('DOC15', {\n                objPath,\n                value\n            });\n        }\n\n        // if equal, do nothing\n        if (Object.is(this.get(objPath), value)) return;\n\n        // throw if nested without root-object\n        const pathEls = objPath.split('.');\n        pathEls.pop();\n        const rootPath = pathEls.join('.');\n        if (typeof objectPath.get(this._data, rootPath) === 'undefined') {\n            throw newRxError('DOC10', {\n                childpath: objPath,\n                rootPath\n            });\n        }\n\n        objectPath.set(this._data, objPath, value);\n        return this;\n    },\n\n    /**\n     * updates document\n     * @overwritten by plugin (optinal)\n     * @param updateObj mongodb-like syntax\n     */\n    update(_updateObj: any) {\n        throw pluginMissing('update');\n    },\n    putAttachment() {\n        throw pluginMissing('attachments');\n    },\n    getAttachment() {\n        throw pluginMissing('attachments');\n    },\n    allAttachments() {\n        throw pluginMissing('attachments');\n    },\n    get allAttachments$() {\n        throw pluginMissing('attachments');\n    },\n\n\n    /**\n     * runs an atomic update over the document\n     * @param function that takes the document-data and returns a new data-object\n     */\n    atomicUpdate(this: RxDocument, mutationFunction: Function): Promise<RxDocument> {\n        return new Promise((res, rej) => {\n            this._atomicQueue = this._atomicQueue\n                .then(async () => {\n                    let done = false;\n                    // we need a hacky while loop to stay incide the chain-link of _atomicQueue\n                    // while still having the option to run a retry on conflicts\n                    while (!done) {\n                        const oldData = this._dataSync$.getValue();\n                        try {\n                            // always await because mutationFunction might be async\n                            let newData = await mutationFunction(clone(this._dataSync$.getValue()), this);\n                            if (this.collection) {\n                                newData = this.collection.schema.fillObjectWithDefaults(newData);\n                            }\n\n                            await this._saveData(newData, oldData);\n                            done = true;\n                        } catch (err) {\n                            /**\n                             * conflicts cannot happen by just using RxDB in one process\n                             * There are two ways they still can appear which is\n                             * replication and multi-tab usage\n                             * Because atomicUpdate has a mutation function,\n                             * we can just re-run the mutation until there is no conflict\n                             */\n                            if (isPouchdbConflictError(err as any)) {\n                                // pouchdb conflict error -> retrying\n                            } else {\n                                rej(err);\n                                return;\n                            }\n                        }\n                    }\n                    res(this);\n                });\n        });\n    },\n\n\n    /**\n     * patches the given properties\n     */\n    atomicPatch<RxDocumentType = any>(\n        this: RxDocument<RxDocumentType>,\n        patch: Partial<RxDocumentType>\n    ): Promise<RxDocument<RxDocumentType>> {\n        return this.atomicUpdate((docData: RxDocumentType) => {\n            Object\n                .entries(patch)\n                .forEach(([k, v]) => {\n                    (docData as any)[k] = v;\n                });\n            return docData;\n        });\n    },\n\n    /**\n     * saves the new document-data\n     * and handles the events\n     */\n    async _saveData<RxDocumentType>(\n        this: RxDocument<RxDocumentType>,\n        newData: RxDocumentWriteData<RxDocumentType>,\n        oldData: RxDocumentData<RxDocumentType>\n    ): Promise<void> {\n        newData = newData;\n\n        // deleted documents cannot be changed\n        if (this._isDeleted$.getValue()) {\n            throw newRxError('DOC11', {\n                id: this.primary,\n                document: this\n            });\n        }\n\n        // ensure modifications are ok\n        this.collection.schema.validateChange(oldData, newData);\n        await this.collection._runHooks('pre', 'save', newData, this);\n        this.collection.schema.validate(newData);\n\n        const writeResult = await this.collection.storageInstance.bulkWrite([{\n            previous: oldData,\n            document: newData\n        }]);\n\n        const isError = writeResult.error[this.primary];\n        throwIfIsStorageWriteError(this.collection, this.primary, newData, isError);\n        ensureNotFalsy(writeResult.success[this.primary]);\n\n\n        return this.collection._runHooks('post', 'save', newData, this);\n    },\n\n    /**\n     * saves the temporary document and makes a non-temporary out of it\n     * Saving a temporary doc is basically the same as RxCollection.insert()\n     * @return false if nothing to save\n     */\n    save(this: RxDocument): Promise<boolean> {\n        // .save() cannot be called on non-temporary-documents\n        if (!this._isTemporary) {\n            throw newRxError('DOC17', {\n                id: this.primary,\n                document: this\n            });\n        }\n\n        return this.collection.insert(this)\n            .then(() => {\n                this._isTemporary = false;\n                this.collection._docCache.set(this.primary, this);\n\n                // internal events\n                this._dataSync$.next(this._data);\n\n                return true;\n            });\n    },\n\n    /**\n     * remove the document,\n     * this not not equal to a pouchdb.remove(),\n     * instead we keep the values and only set _deleted: true\n     */\n    remove(this: RxDocument): Promise<RxDocument> {\n        const collection = this.collection;\n        if (this.deleted) {\n            return Promise.reject(newRxError('DOC13', {\n                document: this,\n                id: this.primary\n            }));\n        }\n\n        const deletedData = flatClone(this._data);\n        return collection._runHooks('pre', 'remove', deletedData, this)\n            .then(async () => {\n                deletedData._deleted = true;\n\n                const writeResult = await collection.storageInstance.bulkWrite([{\n                    previous: this._data,\n                    document: deletedData\n                }]);\n                const isError = writeResult.error[this.primary];\n                throwIfIsStorageWriteError(collection, this.primary, deletedData, isError);\n                return ensureNotFalsy(writeResult.success[this.primary]);\n            })\n            .then(() => {\n                return this.collection._runHooks('post', 'remove', deletedData, this);\n            })\n            .then(() => this);\n    },\n    destroy() {\n        throw newRxError('DOC14');\n    }\n};\n\nexport function createRxDocumentConstructor(proto = basePrototype) {\n    const constructor = function RxDocumentConstructor(\n        this: RxDocument,\n        collection: RxCollection,\n        jsonData: any\n    ) {\n        this.collection = collection;\n\n        // if true, this is a temporary document\n        this._isTemporary = false;\n\n        // assume that this is always equal to the doc-data in the database\n        this._dataSync$ = new BehaviorSubject(jsonData);\n        this._isDeleted$ = new BehaviorSubject(false) as any;\n\n        this._atomicQueue = PROMISE_RESOLVE_VOID;\n\n        /**\n         * because of the prototype-merge,\n         * we can not use the native instanceof operator\n         */\n        this.isInstanceOfRxDocument = true;\n    };\n    constructor.prototype = proto;\n    return constructor;\n}\n\nexport function defineGetterSetter(\n    schema: any,\n    valueObj: any,\n    objPath = '',\n    thisObj = false\n) {\n    if (valueObj === null) return;\n\n\n    let pathProperties = getSchemaByObjectPath(\n        schema.jsonSchema,\n        objPath\n    );\n\n    if (typeof pathProperties === 'undefined') return;\n    if (pathProperties.properties) pathProperties = pathProperties.properties;\n\n    Object.keys(pathProperties)\n        .forEach(key => {\n            const fullPath = trimDots(objPath + '.' + key);\n\n            // getter - value\n            valueObj.__defineGetter__(\n                key,\n                function (this: RxDocument) {\n                    const _this: RxDocument = thisObj ? thisObj : (this as any);\n                    if (!_this.get || typeof _this.get !== 'function') {\n                        /**\n                         * When an object gets added to the state of a vuejs-component,\n                         * it happens that this getter is called with another scope.\n                         * To prevent errors, we have to return undefined in this case\n                         */\n                        return undefined;\n                    }\n                    const ret = _this.get(fullPath);\n                    return ret;\n                }\n            );\n            // getter - observable$\n            Object.defineProperty(valueObj, key + '$', {\n                get: function () {\n                    const _this = thisObj ? thisObj : this;\n                    return _this.get$(fullPath);\n                },\n                enumerable: false,\n                configurable: false\n            });\n            // getter - populate_\n            Object.defineProperty(valueObj, key + '_', {\n                get: function () {\n                    const _this = thisObj ? thisObj : this;\n                    return _this.populate(fullPath);\n                },\n                enumerable: false,\n                configurable: false\n            });\n            // setter - value\n            valueObj.__defineSetter__(key, function (\n                this: RxDocument,\n                val: any\n            ) {\n                const _this: any = thisObj ? thisObj : this;\n                return _this.set(fullPath, val);\n            });\n        });\n}\n\nexport function createWithConstructor<RxDocType>(\n    constructor: any,\n    collection: RxCollection<RxDocType>,\n    jsonData: RxDocumentData<RxDocType>\n): RxDocument<RxDocType> | null {\n    const primary: string = jsonData[collection.schema.primaryPath] as any;\n    if (\n        primary &&\n        primary.startsWith('_design')\n    ) {\n        return null;\n    }\n\n    const doc = new constructor(collection, jsonData);\n    runPluginHooks('createRxDocument', doc);\n    return doc;\n}\n\nexport function isRxDocument(obj: any): boolean {\n    if (typeof obj === 'undefined') return false;\n    return !!obj.isInstanceOfRxDocument;\n}\n"],"file":"rx-document.js"}