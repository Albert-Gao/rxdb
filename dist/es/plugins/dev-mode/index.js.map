{"version":3,"sources":["../../../../src/plugins/dev-mode/index.ts"],"names":["ERROR_MESSAGES","checkSchema","checkOrmDocumentMethods","checkOrmMethods","checkMigrationStrategies","ensureCollectionNameValid","ensureDatabaseNameIsValid","checkMangoQuery","checkQuery","newRxError","deepFreeze","deepFreezeWhenDevMode","obj","DEV_MODE_PLUGIN_NAME","RxDBDevModePlugin","name","rxdb","overwritable","isDevMode","tunnelErrorMessage","code","console","error","Error","hooks","preAddRxPlugin","after","args","plugin","plugins","preCreateRxSchema","preCreateRxDatabase","preCreateRxCollection","schema","methods","charAt","preCreateRxQuery","prePrepareQuery","createRxCollection","creator","statics","attachments","migrationStrategies"],"mappings":"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","sourcesContent":["import type {\n    RxPlugin,\n    RxCollectionCreator,\n    RxDatabaseCreator,\n    RxPluginPreAddRxPluginArgs,\n    RxErrorKey\n} from '../../types';\n\nimport {\n    ERROR_MESSAGES\n} from './error-messages';\nimport {\n    checkSchema\n} from './check-schema';\nimport { checkOrmDocumentMethods, checkOrmMethods } from './check-orm';\nimport { checkMigrationStrategies } from './check-migration-strategies';\nimport {\n    ensureCollectionNameValid,\n    ensureDatabaseNameIsValid\n} from './unallowed-properties';\nimport { checkMangoQuery, checkQuery } from './check-query';\nimport { newRxError } from '../../rx-error';\nimport { DeepReadonly } from '../../types/util';\n\nexport * from './check-schema';\nexport * from './unallowed-properties';\n\nimport deepFreeze from 'deep-freeze';\n\n/**\n * Deep freezes and object when in dev-mode.\n * Deep-Freezing has the same performaance as deep-cloning, so we only do that in dev-mode.\n * Also we can ensure the readonly state via typescript\n * @link https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze\n */\nexport function deepFreezeWhenDevMode<T>(obj: T): DeepReadonly<T> {\n    // direct return if not suitable for deepFreeze()\n    if (\n        !obj ||\n        typeof obj === 'string' ||\n        typeof obj === 'number'\n    ) {\n        return obj as any;\n    }\n\n    return deepFreeze(obj);\n}\n\n\nconst DEV_MODE_PLUGIN_NAME = 'dev-mode';\nexport const RxDBDevModePlugin: RxPlugin = {\n    name: DEV_MODE_PLUGIN_NAME,\n    rxdb: true,\n    overwritable: {\n        isDevMode() {\n            return true;\n        },\n        deepFreezeWhenDevMode,\n        tunnelErrorMessage(code: RxErrorKey) {\n            if (!ERROR_MESSAGES[code]) {\n                console.error('RxDB: Error-Code not known: ' + code);\n                throw new Error('Error-Code ' + code + ' not known, contact the maintainer');\n            }\n            return ERROR_MESSAGES[code];\n        }\n    },\n    hooks: {\n        preAddRxPlugin: {\n            after: function (args: RxPluginPreAddRxPluginArgs) {\n                /**\n                 * throw when dev mode is added multiple times\n                 * because there is no way that this was done intentional.\n                 * Likely the developer has mixed core and default usage of RxDB.\n                 */\n                if (args.plugin.name === DEV_MODE_PLUGIN_NAME) {\n                    throw newRxError('DEV1', {\n                        plugins: args.plugins\n                    });\n                }\n            }\n        },\n        preCreateRxSchema: {\n            after: checkSchema\n        },\n        preCreateRxDatabase: {\n            after: function (args: RxDatabaseCreator<any, any>) {\n                ensureDatabaseNameIsValid(args);\n            }\n        },\n        preCreateRxCollection: {\n            after: function (args: RxCollectionCreator & { name: string; }) {\n                ensureCollectionNameValid(args);\n                checkOrmDocumentMethods(args.schema as any, args.methods);\n                if (args.name.charAt(0) === '_') {\n                    throw newRxError('DB2', {\n                        name: args.name\n                    });\n                }\n                if (!args.schema) {\n                    throw newRxError('DB4', {\n                        name: args.name,\n                        args\n                    });\n                }\n            }\n        },\n        preCreateRxQuery: {\n            after: function (args) {\n                checkQuery(args);\n            }\n        },\n        prePrepareQuery: {\n            after: (args) => {\n                checkMangoQuery(args);\n            }\n        },\n        createRxCollection: {\n            after: (args) => {\n                // check ORM-methods\n                checkOrmMethods(args.creator.statics);\n                checkOrmMethods(args.creator.methods);\n                checkOrmMethods(args.creator.attachments);\n\n                // check migration strategies\n                if (args.creator.schema && args.creator.migrationStrategies) {\n                    checkMigrationStrategies(\n                        args.creator.schema,\n                        args.creator.migrationStrategies\n                    );\n                }\n            }\n        }\n    }\n};\n"],"file":"index.js"}