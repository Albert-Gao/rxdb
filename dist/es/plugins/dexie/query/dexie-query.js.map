{"version":3,"sources":["../../../../../src/plugins/dexie/query/dexie-query.ts"],"names":["getPrimaryFieldOfPrimaryKey","clone","ensureNotFalsy","getPouchIndexDesignDocNameByIndex","POUCHDB_DESIGN_PREFIX","pouchSwapIdToPrimaryString","preparePouchDbQuery","DEXIE_DOCS_TABLE_NAME","RxStorageDexieStatics","generateKeyRange","planQuery","dexieQuery","instance","preparedQuery","internals","state","queryMatcher","getQueryMatcher","schema","sortComparator","getSortComparator","skip","limit","Infinity","skipPlusLimit","queryPlan","pouchQueryPlan","keyRange","getDexieKeyRange","Number","NEGATIVE_INFINITY","dexieDb","_maxKey","_options","IDBKeyRange","queryPlanFields","index","def","fields","map","fieldObj","Object","keys","field","primaryPath","sortFields","sort","sortPart","sortFieldsSameAsIndexFields","join","isOneSortDescending","find","values","mustManuallyResort","rows","transaction","dexieTable","dexieTx","tx","idbtrans","store","objectStore","length","indexName","cursorReq","openCursor","Promise","res","onsuccess","e","cursor","target","result","docData","value","push","slice","documents","getPouchQueryPlan","query","primaryKey","pouchCompatibleIndexes","ddoc","name","type","indexes","forEach","Array","isArray","pouchIndex","indexPart","useKey","pouchdbCompatibleQuery","entries","fieldName","low","height","window","Error","queryOpts"],"mappings":"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","sourcesContent":["import { getPrimaryFieldOfPrimaryKey } from '../../../rx-schema-helper';\nimport type { MangoQuery, PreparedQuery, RxDocumentData, RxJsonSchema, RxStorageQueryResult } from '../../../types';\nimport { clone, ensureNotFalsy } from '../../../util';\nimport { getPouchIndexDesignDocNameByIndex, POUCHDB_DESIGN_PREFIX, pouchSwapIdToPrimaryString } from '../../pouchdb';\nimport { preparePouchDbQuery } from '../../pouchdb/pouch-statics';\nimport { DEXIE_DOCS_TABLE_NAME } from '../dexie-helper';\nimport { RxStorageDexieStatics } from '../rx-storage-dexie';\nimport type { RxStorageInstanceDexie } from '../rx-storage-instance-dexie';\nimport { generateKeyRange } from './pouchdb-find-query-planer/indexeddb-find';\nimport { planQuery } from './pouchdb-find-query-planer/query-planner';\n\n\n/**\n * Use the pouchdb query planner to determine which index\n * must be used to get the correct documents.\n * @link https://www.bennadel.com/blog/3258-understanding-the-query-plan-explained-by-the-find-plugin-in-pouchdb-6-2-0.htm\n * \n * \n * TODO use batched cursor\n * @link https://nolanlawson.com/2021/08/22/speeding-up-indexeddb-reads-and-writes/\n */\nexport function getPouchQueryPlan<RxDocType>(\n    schema: RxJsonSchema<RxDocumentData<RxDocType>>,\n    query: MangoQuery<RxDocType>\n) {\n    const primaryKey = getPrimaryFieldOfPrimaryKey(schema.primaryKey);\n\n    /**\n     * Store the query plan together with the prepared query\n     * to improve performance\n     * We use the query planner of pouchdb-find.\n     */\n    const pouchCompatibleIndexes = [\n        // the primary key is always a free index\n        {\n            ddoc: null as any,\n            name: '_all_docs',\n            type: 'special',\n            def: {\n                fields: [\n                    {\n                        '_id': 'asc'\n                    }\n                ] as any[]\n            }\n        }\n    ];\n    if (schema.indexes) {\n        schema.indexes.forEach(index => {\n            index = Array.isArray(index) ? index : [index];\n            const pouchIndex = index.map(indexPart => {\n                if (indexPart === primaryKey) {\n                    return '_id';\n                } else {\n                    return indexPart;\n                }\n            });\n            const indexName = getPouchIndexDesignDocNameByIndex(pouchIndex);\n            pouchCompatibleIndexes.push({\n                ddoc: POUCHDB_DESIGN_PREFIX + indexName,\n                name: indexName,\n                type: 'json',\n                def: {\n                    fields: index.map(indexPart => {\n                        const useKey = indexPart === primaryKey ? '_id' : indexPart;\n                        return { [useKey]: 'asc' };\n                    })\n                }\n            });\n        })\n    }\n\n    /**\n     * Because pouchdb-find is buggy AF,\n     * we have to apply the same hacks to the query\n     * as we do with the PouchDB RxStorage.\n     * Only then we can use that monkeypatched\n     * query with the query planner.\n     */\n    const pouchdbCompatibleQuery = preparePouchDbQuery(\n        schema,\n        clone(query)\n    );\n\n    const pouchQueryPlan = planQuery(\n        pouchdbCompatibleQuery,\n        pouchCompatibleIndexes\n    );\n\n    // transform back _id to primaryKey\n    pouchQueryPlan.index.def.fields = pouchQueryPlan.index.def.fields.map((field: any) => {\n        const [fieldName, value] = Object.entries(field)[0];\n        if (fieldName === '_id') {\n            return { [primaryKey]: value };\n        } else {\n            return { [fieldName]: value };\n        }\n    });\n\n    return pouchQueryPlan;\n}\n\n\nexport function getDexieKeyRange(\n    queryPlan: any,\n    low: any,\n    height: any,\n    /**\n     * The window.IDBKeyRange object.\n     * Can be swapped out in other environments\n     */\n    IDBKeyRange?: any\n): any {\n\n    if (!IDBKeyRange) {\n        if (typeof window === 'undefined') {\n            throw new Error('IDBKeyRange missing');\n        } else {\n            IDBKeyRange = window.IDBKeyRange;\n        }\n    }\n\n    return generateKeyRange(queryPlan.queryOpts, IDBKeyRange, low, height);\n}\n\n\n/**\n * Runs mango queries over the Dexie.js database.\n */\nexport async function dexieQuery<RxDocType>(\n    instance: RxStorageInstanceDexie<RxDocType>,\n    preparedQuery: PreparedQuery<RxDocType>\n): Promise<RxStorageQueryResult<RxDocType>> {\n    const state = await instance.internals;\n    const queryMatcher = RxStorageDexieStatics.getQueryMatcher(\n        instance.schema,\n        preparedQuery\n    );\n    const sortComparator = RxStorageDexieStatics.getSortComparator(instance.schema, preparedQuery);\n\n    const skip = preparedQuery.skip ? preparedQuery.skip : 0;\n    const limit = preparedQuery.limit ? preparedQuery.limit : Infinity;\n    const skipPlusLimit = skip + limit;\n    const queryPlan = (preparedQuery as any).pouchQueryPlan;\n\n    const keyRange = getDexieKeyRange(\n        queryPlan,\n        Number.NEGATIVE_INFINITY,\n        (state.dexieDb as any)._maxKey,\n        (state.dexieDb as any)._options.IDBKeyRange\n    );\n\n    const queryPlanFields: string[] = queryPlan.index.def.fields\n        .map((fieldObj: any) => Object.keys(fieldObj)[0])\n        .map((field: any) => pouchSwapIdToPrimaryString(instance.primaryPath, field));\n\n    const sortFields = ensureNotFalsy((preparedQuery as MangoQuery<RxDocType>).sort)\n        .map(sortPart => Object.keys(sortPart)[0]);\n\n    /**\n     * If the cursor iterated over the same index that\n     * would be used for sorting, we do not have to sort the results.\n     */\n    const sortFieldsSameAsIndexFields = queryPlanFields.join(',') === sortFields.join(',');\n    /**\n     * Also manually sort if one part of the sort is in descending order\n     * because all our indexes are ascending.\n     * TODO should we be able to define descending indexes?\n     */\n    const isOneSortDescending = preparedQuery.sort.find((sortPart: any) => Object.values(sortPart)[0] === 'desc');\n    const mustManuallyResort = isOneSortDescending || !sortFieldsSameAsIndexFields;\n\n\n    let rows: any[] = [];\n    await state.dexieDb.transaction(\n        'r',\n        state.dexieTable,\n        async (dexieTx) => {\n            /**\n             * TODO here we use the native IndexedDB transaction\n             * to get the cursor.\n             * Instead we should not leave Dexie.js API and find\n             * a way to create the cursor with Dexie.js.\n             */\n            const tx = (dexieTx as any).idbtrans;\n\n            // const nativeIndexedDB = state.dexieDb.backendDB();\n            // const trans = nativeIndexedDB.transaction([DEXIE_DOCS_TABLE_NAME], 'readonly');\n\n            const store = tx.objectStore(DEXIE_DOCS_TABLE_NAME);\n            let index: any;\n            if (\n                queryPlanFields.length === 1 &&\n                queryPlanFields[0] === instance.primaryPath\n            ) {\n                index = store;\n            } else {\n                let indexName: string;\n                if (queryPlanFields.length === 1) {\n                    indexName = queryPlanFields[0];\n                } else {\n                    indexName = '[' + queryPlanFields.join('+') + ']';\n                }\n                index = store.index(indexName);\n            }\n\n            const cursorReq = index.openCursor(keyRange);\n            await new Promise<void>(res => {\n                cursorReq.onsuccess = function (e: any) {\n                    const cursor = e.target.result;\n                    if (cursor) {\n                        // We have a record in cursor.value\n                        const docData = cursor.value;\n                        if (\n                            queryMatcher(docData)\n                        ) {\n                            rows.push(cursor.value);\n                        }\n\n                        /**\n                         * If we do not have to manually sort\n                         * and have enough documents,\n                         * we can abort iterating over the cursor\n                         * because we already have every relevant document.\n                         */\n                        if (\n                            !mustManuallyResort &&\n                            rows.length === skipPlusLimit\n                        ) {\n                            res();\n                        } else {\n                            cursor.continue();\n                        }\n                    } else {\n                        // Iteration complete\n                        res();\n                    }\n                };\n            });\n\n\n        }\n    );\n\n    if (mustManuallyResort) {\n        rows = rows.sort(sortComparator);\n    }\n\n    // apply skip and limit boundaries.\n    rows = rows.slice(skip, skipPlusLimit);\n\n    /**\n     * Comment this in for debugging to check all fields in the database.\n     */\n    // const docsInDb = await state.dexieTable.filter(queryMatcher).toArray();\n    // let documents = docsInDb\n    //     .map(docData => stripDexieKey(docData))\n    //     .sort(sortComparator);\n    // if (preparedQuery.skip) {\n    //     documents = documents.slice(preparedQuery.skip);\n    // }\n    // if (preparedQuery.limit && documents.length > preparedQuery.limit) {\n    //     documents = documents.slice(0, preparedQuery.limit);\n    // }\n\n\n    return {\n        documents: rows\n    };\n}\n"],"file":"dexie-query.js"}