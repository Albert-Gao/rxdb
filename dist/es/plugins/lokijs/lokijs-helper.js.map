{"version":3,"sources":["../../../../src/plugins/lokijs/lokijs-helper.ts"],"names":["createLokiLocalState","lokijs","add","unloadAdd","ensureNotFalsy","flatClone","promiseWait","randomCouchString","LokiSaveQueue","newRxError","BroadcastChannel","createLeaderElection","body","recover","result","e","then","pact","state","value","s","v","o","bind","observer","prototype","onFulfilled","onRejected","callback","_this","thenable","test","update","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","mustUseLocalState","instance","closed","args","instanceClosed","databaseName","collectionName","internals","localState","leaderElector","waitUntilHasLeader","isLeader","options","schema","multiInstance","databaseSettings","hasLeader","applyOnce","handleRemoteRequest","msg","type","LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE","requestId","response","isError","broadcastChannel","postMessage","operation","params","err","requestRemoteInstance","isRxStorageInstanceLoki","query","messageType","LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE","whenDeathListener","leaderDeadPromise","Promise","res","context","action","retry","addEventListener","responseListener","responsePromise","_rej","error","race","firstResolved","removeEventListener","closeLokiCollections","collections","LOKI_DATABASE_STATE_BY_NAME","get","databaseState","saveQueue","run","forEach","collection","name","Object","keys","length","unloads","u","remove","rej","database","close","CHANGES_COLLECTION_SUFFIX","stripLokiKey","docData","$loki","cloned","$lastWriteAt","_meta","lwt","OPEN_LOKIJS_STORAGE_INSTANCES","Set","LOKIJS_COLLECTION_DEFAULT_OPTIONS","disableChangesApi","disableMeta","disableDeltaChangesApi","disableFreeze","cloneMethod","clone","transactional","autoupdate","Map","getLokiDatabase","hasPersistence","adapter","push","lokiSaveQueue","useSettings","persistenceMethod","assign","autoload","verbose","autosave","throttledSaves","loadDatabasePromise","loadDatabase","autoloadCallback","set","getLokiSortComparator","_schema","sort","sortOptions","fun","a","b","compareResult","find","sortPart","fieldName","direction","values","directionMultiplier","valueA","valueB","getLokiLeaderElector","storage","electorState","leaderElectorByLokiDbName","channelName","channel","elector","intancesCount","removeLokiLeaderElectorReference"],"mappings":"AAAA,SAASA,oBAAT,QAA4D,4BAA5D;AACA,OAAOC,MAAP,MAAmC,QAAnC;AAYA,SACIC,GAAG,IAAIC,SADX,QAEO,QAFP;AAGA,SAASC,cAAT,EAAyBC,SAAzB,EAAoCC,WAApC,EAAiDC,iBAAjD,QAA0E,YAA1E;AACA,SAASC,aAAT,QAA8B,mBAA9B;AAEA,SAASC,UAAT,QAA2B,gBAA3B;AACA,SACIC,gBADJ,EAEIC,oBAFJ,QAKO,mBALP;;AAkZA;AACA;AACA;AACA;AAyIO,gBAAgBC,IAAhB,EAAsBC,OAAtB,EAA+B;AACrC,MAAI;AACH,QAAIC,MAAM,GAAGF,IAAI,EAAjB;AACA,GAFD,CAEE,OAAMG,CAAN,EAAS;AACV,WAAOF,OAAO,CAACE,CAAD,CAAd;AACA;;AACD,MAAID,MAAM,IAAIA,MAAM,CAACE,IAArB,EAA2B;AAC1B,WAAOF,MAAM,CAACE,IAAP,CAAY,KAAK,CAAjB,EAAoBH,OAApB,CAAP;AACA;;AACD,SAAOC,MAAP;AACA;;AArhBM,iBAAiBG,IAAjB,EAAuBC,KAAvB,EAA8BC,KAA9B,EAAqC;AAC3C,MAAI,CAACF,IAAI,CAACG,CAAV,EAAa;AACZ,QAAID,KAAK,iBAAT,EAA4B;AAC3B,UAAIA,KAAK,CAACC,CAAV,EAAa;AACZ,YAAIF,KAAK,GAAG,CAAZ,EAAe;AACdA,UAAAA,KAAK,GAAGC,KAAK,CAACC,CAAd;AACA;;AACDD,QAAAA,KAAK,GAAGA,KAAK,CAACE,CAAd;AACA,OALD,MAKO;AACNF,QAAAA,KAAK,CAACG,CAAN,GAAU,QAAQC,IAAR,CAAa,IAAb,EAAmBN,IAAnB,EAAyBC,KAAzB,CAAV;AACA;AACA;AACD;;AACD,QAAIC,KAAK,IAAIA,KAAK,CAACH,IAAnB,EAAyB;AACxBG,MAAAA,KAAK,CAACH,IAAN,CAAW,QAAQO,IAAR,CAAa,IAAb,EAAmBN,IAAnB,EAAyBC,KAAzB,CAAX,EAA4C,QAAQK,IAAR,CAAa,IAAb,EAAmBN,IAAnB,EAAyB,CAAzB,CAA5C;AACA;AACA;;AACDA,IAAAA,IAAI,CAACG,CAAL,GAASF,KAAT;AACAD,IAAAA,IAAI,CAACI,CAAL,GAASF,KAAT;AACA,QAAMK,QAAQ,GAAGP,IAAI,CAACK,CAAtB;;AACA,QAAIE,QAAJ,EAAc;AACbA,MAAAA,QAAQ,CAACP,IAAD,CAAR;AACA;AACD;AACD;;AA9DM,IAAM,QAAQ,aAAc,YAAW;AAC7C,mBAAiB,CAAE;;AACnB,QAAMQ,SAAN,CAAgBT,IAAhB,GAAuB,UAASU,WAAT,EAAsBC,UAAtB,EAAkC;AACxD,QAAMb,MAAM,GAAG,WAAf;AACA,QAAMI,KAAK,GAAG,KAAKE,CAAnB;;AACA,QAAIF,KAAJ,EAAW;AACV,UAAMU,QAAQ,GAAGV,KAAK,GAAG,CAAR,GAAYQ,WAAZ,GAA0BC,UAA3C;;AACA,UAAIC,QAAJ,EAAc;AACb,YAAI;AACH,kBAAQd,MAAR,EAAgB,CAAhB,EAAmBc,QAAQ,CAAC,KAAKP,CAAN,CAA3B;AACA,SAFD,CAEE,OAAON,CAAP,EAAU;AACX,kBAAQD,MAAR,EAAgB,CAAhB,EAAmBC,CAAnB;AACA;;AACD,eAAOD,MAAP;AACA,OAPD,MAOO;AACN,eAAO,IAAP;AACA;AACD;;AACD,SAAKQ,CAAL,GAAS,UAASO,KAAT,EAAgB;AACxB,UAAI;AACH,YAAMV,KAAK,GAAGU,KAAK,CAACR,CAApB;;AACA,YAAIQ,KAAK,CAACT,CAAN,GAAU,CAAd,EAAiB;AAChB,kBAAQN,MAAR,EAAgB,CAAhB,EAAmBY,WAAW,GAAGA,WAAW,CAACP,KAAD,CAAd,GAAwBA,KAAtD;AACA,SAFD,MAEO,IAAIQ,UAAJ,EAAgB;AACtB,kBAAQb,MAAR,EAAgB,CAAhB,EAAmBa,UAAU,CAACR,KAAD,CAA7B;AACA,SAFM,MAEA;AACN,kBAAQL,MAAR,EAAgB,CAAhB,EAAmBK,KAAnB;AACA;AACD,OATD,CASE,OAAOJ,CAAP,EAAU;AACX,gBAAQD,MAAR,EAAgB,CAAhB,EAAmBC,CAAnB;AACA;AACD,KAbD;;AAcA,WAAOD,MAAP;AACA,GA/BD;;AAgCA;AACA,CAnCiC,EAA3B;;AAgEA,wBAAwBgB,QAAxB,EAAkC;AACxC,SAAOA,QAAQ,iBAAR,IAA6BA,QAAQ,CAACV,CAAT,GAAa,CAAjD;AACA;;AA4LM,cAAcW,IAAd,EAAoBC,MAApB,EAA4BpB,IAA5B,EAAkC;AACxC,MAAIqB,KAAJ;;AACA,WAAS;AACR,QAAIC,cAAc,GAAGH,IAAI,EAAzB;;AACA,QAAI,eAAeG,cAAf,CAAJ,EAAoC;AACnCA,MAAAA,cAAc,GAAGA,cAAc,CAACb,CAAhC;AACA;;AACD,QAAI,CAACa,cAAL,EAAqB;AACpB,aAAOpB,MAAP;AACA;;AACD,QAAIoB,cAAc,CAAClB,IAAnB,EAAyB;AACxBiB,MAAAA,KAAK,GAAG,CAAR;AACA;AACA;;AACD,QAAInB,MAAM,GAAGF,IAAI,EAAjB;;AACA,QAAIE,MAAM,IAAIA,MAAM,CAACE,IAArB,EAA2B;AAC1B,UAAI,eAAeF,MAAf,CAAJ,EAA4B;AAC3BA,QAAAA,MAAM,GAAGA,MAAM,CAACM,CAAhB;AACA,OAFD,MAEO;AACNa,QAAAA,KAAK,GAAG,CAAR;AACA;AACA;AACD;;AACD,QAAID,MAAJ,EAAY;AACX,UAAIG,WAAW,GAAGH,MAAM,EAAxB;;AACA,UAAIG,WAAW,IAAIA,WAAW,CAACnB,IAA3B,IAAmC,CAAC,eAAemB,WAAf,CAAxC,EAAqE;AACpEF,QAAAA,KAAK,GAAG,CAAR;AACA;AACA;AACD;AACD;;AACD,MAAIhB,IAAI,GAAG,WAAX;;AACA,MAAImB,MAAM,GAAG,QAAQb,IAAR,CAAa,IAAb,EAAmBN,IAAnB,EAAyB,CAAzB,CAAb;;AACA,GAACgB,KAAK,KAAK,CAAV,GAAcC,cAAc,CAAClB,IAAf,CAAoBqB,gBAApB,CAAd,GAAsDJ,KAAK,KAAK,CAAV,GAAcnB,MAAM,CAACE,IAAP,CAAYsB,gBAAZ,CAAd,GAA8CH,WAAW,CAACnB,IAAZ,CAAiBuB,kBAAjB,CAArG,EAA2IvB,IAA3I,CAAgJ,KAAK,CAArJ,EAAwJoB,MAAxJ;AACA,SAAOnB,IAAP;;AACA,WAASqB,gBAAT,CAA0BnB,KAA1B,EAAiC;AAChCL,IAAAA,MAAM,GAAGK,KAAT;;AACA,OAAG;AACF,UAAIa,MAAJ,EAAY;AACXG,QAAAA,WAAW,GAAGH,MAAM,EAApB;;AACA,YAAIG,WAAW,IAAIA,WAAW,CAACnB,IAA3B,IAAmC,CAAC,eAAemB,WAAf,CAAxC,EAAqE;AACpEA,UAAAA,WAAW,CAACnB,IAAZ,CAAiBuB,kBAAjB,EAAqCvB,IAArC,CAA0C,KAAK,CAA/C,EAAkDoB,MAAlD;AACA;AACA;AACD;;AACDF,MAAAA,cAAc,GAAGH,IAAI,EAArB;;AACA,UAAI,CAACG,cAAD,IAAoB,eAAeA,cAAf,KAAkC,CAACA,cAAc,CAACb,CAA1E,EAA8E;AAC7E,gBAAQJ,IAAR,EAAc,CAAd,EAAiBH,MAAjB;;AACA;AACA;;AACD,UAAIoB,cAAc,CAAClB,IAAnB,EAAyB;AACxBkB,QAAAA,cAAc,CAAClB,IAAf,CAAoBqB,gBAApB,EAAsCrB,IAAtC,CAA2C,KAAK,CAAhD,EAAmDoB,MAAnD;AACA;AACA;;AACDtB,MAAAA,MAAM,GAAGF,IAAI,EAAb;;AACA,UAAI,eAAeE,MAAf,CAAJ,EAA4B;AAC3BA,QAAAA,MAAM,GAAGA,MAAM,CAACO,CAAhB;AACA;AACD,KArBD,QAqBS,CAACP,MAAD,IAAW,CAACA,MAAM,CAACE,IArB5B;;AAsBAF,IAAAA,MAAM,CAACE,IAAP,CAAYsB,gBAAZ,EAA8BtB,IAA9B,CAAmC,KAAK,CAAxC,EAA2CoB,MAA3C;AACA;;AACD,WAASC,gBAAT,CAA0BH,cAA1B,EAA0C;AACzC,QAAIA,cAAJ,EAAoB;AACnBpB,MAAAA,MAAM,GAAGF,IAAI,EAAb;;AACA,UAAIE,MAAM,IAAIA,MAAM,CAACE,IAArB,EAA2B;AAC1BF,QAAAA,MAAM,CAACE,IAAP,CAAYsB,gBAAZ,EAA8BtB,IAA9B,CAAmC,KAAK,CAAxC,EAA2CoB,MAA3C;AACA,OAFD,MAEO;AACNE,QAAAA,gBAAgB,CAACxB,MAAD,CAAhB;AACA;AACD,KAPD,MAOO;AACN,cAAQG,IAAR,EAAc,CAAd,EAAiBH,MAAjB;AACA;AACD;;AACD,WAASyB,kBAAT,GAA8B;AAC7B,QAAIL,cAAc,GAAGH,IAAI,EAAzB,EAA6B;AAC5B,UAAIG,cAAc,CAAClB,IAAnB,EAAyB;AACxBkB,QAAAA,cAAc,CAAClB,IAAf,CAAoBqB,gBAApB,EAAsCrB,IAAtC,CAA2C,KAAK,CAAhD,EAAmDoB,MAAnD;AACA,OAFD,MAEO;AACNC,QAAAA,gBAAgB,CAACH,cAAD,CAAhB;AACA;AACD,KAND,MAMO;AACN,cAAQjB,IAAR,EAAc,CAAd,EAAiBH,MAAjB;AACA;AACD;AACD;;AAuFD,WAAsB0B,iBAAtB,YAAsBA,iBAAtB,CACIC,QADJ;AAAA,MAE2C;AACvC,QAAIA,QAAQ,CAACC,MAAb,EAAqB;AACjB;AACR;AACA;AACA;AACA;AACQ,YAAMjC,UAAU,CAAC,KAAD,EAAQ;AACpBkC,QAAAA,IAAI,EAAE;AACFC,UAAAA,cAAc,EAAEH,QAAQ,CAACC,MADvB;AAEFG,UAAAA,YAAY,EAAEJ,QAAQ,CAACI,YAFrB;AAGFC,UAAAA,cAAc,EAAEL,QAAQ,CAACK;AAHvB;AADc,OAAR,CAAhB;AAOH;;AAGD,QAAIL,QAAQ,CAACM,SAAT,CAAmBC,UAAvB,EAAmC;AAC/B,6BAAOP,QAAQ,CAACM,SAAT,CAAmBC,UAA1B;AACH;;AACD,QAAMC,aAAa,GAAG7C,cAAc,CAACqC,QAAQ,CAACM,SAAT,CAAmBE,aAApB,CAApC;AApBuC,2BAqBjCC,kBAAkB,CAACD,aAAD,CArBe;AAuBvC;AACJ;AACA;AACA;AACI,UAAIR,QAAQ,CAACM,SAAT,CAAmBC,UAAvB,EAAmC;AAC/B,eAAOP,QAAQ,CAACM,SAAT,CAAmBC,UAA1B;AACH;;AA7BsC,UAgCnCC,aAAa,CAACE,QAAd,IACA,CAACV,QAAQ,CAACM,SAAT,CAAmBC,UAjCe;AAmCnC;AACAP,QAAAA,QAAQ,CAACM,SAAT,CAAmBC,UAAnB,GAAgChD,oBAAoB,CAAM;AACtD6C,UAAAA,YAAY,EAAEJ,QAAQ,CAACI,YAD+B;AAEtDC,UAAAA,cAAc,EAAEL,QAAQ,CAACK,cAF6B;AAGtDM,UAAAA,OAAO,EAAEX,QAAQ,CAACW,OAHoC;AAItDC,UAAAA,MAAM,EAAGZ,QAAD,CAAyCY,MAJK;AAKtDC,UAAAA,aAAa,EAAEb,QAAQ,CAACM,SAAT,CAAmBE,aAAnB,GAAmC,IAAnC,GAA0C;AALH,SAAN,EAMjDR,QAAQ,CAACc,gBANwC,CAApD;AAOA,eAAOnD,cAAc,CAACqC,QAAQ,CAACM,SAAT,CAAmBC,UAApB,CAArB;AA3CmC;AA6CnC;AACA,eAAO,KAAP;AA9CmC;AAAA;AAgD1C,GAlDD;AAAA;AAAA;AAAA;AAbA,WAAsBE,kBAAtB,YAAsBA,kBAAtB,CAAyCD,aAAzC;AAAA,MAAuE;AAAA;AAAA,aAE/D,CAACA,aAAa,CAACO,SAFgD;AAAA,2BAGjE;AAAA,6BACQP,aAAa,CAACQ,SAAd,EADR;AAAA,+BAEQnD,WAAW,CAAC,CAAD,CAFnB;AAAA;AAGD,KANkE;;AAAA;AAOtE,GAPD;AAAA;AAAA;AAAA;;AAvCA;AACA;AACA;AACA;AACA,WAAsBoD,mBAAtB,YAAsBA,mBAAtB,CACIjB,QADJ,EAEIkB,GAFJ;AAAA,MAGE;AAAA;AAAA,UAEMA,GAAG,CAACC,IAAJ,KAAaC,mCAAb,IACAF,GAAG,CAACG,SADJ,IAEAH,GAAG,CAACd,YAAJ,KAAqBJ,QAAQ,CAACI,YAF9B,IAGAc,GAAG,CAACb,cAAJ,KAAuBL,QAAQ,CAACK,cAHhC,IAIA,CAACa,GAAG,CAACI,QANX;AAAA;AAkBM,cAAMA,QAA4C,GAAG;AACjDA,YAAAA,QAAQ,EAAE,IADuC;AAEjDD,YAAAA,SAAS,EAAEH,GAAG,CAACG,SAFkC;AAGjDjB,YAAAA,YAAY,EAAEJ,QAAQ,CAACI,YAH0B;AAIjDC,YAAAA,cAAc,EAAEL,QAAQ,CAACK,cAJwB;AAKjDhC,YAAAA,MAAM,EAANA,OALiD;AAMjDkD,YAAAA,OAAO,EAAPA,QANiD;AAOjDJ,YAAAA,IAAI,EAAED,GAAG,CAACC;AAPuC,WAArD;AASAxD,UAAAA,cAAc,CAACqC,QAAQ,CAACM,SAAT,CAAmBE,aAApB,CAAd,CAAiDgB,gBAAjD,CAAkEC,WAAlE,CAA8EH,QAA9E;AA3BN;;AAQM,YAAMI,SAAS,GAAIR,GAAD,CAAaQ,SAA/B;AACA,YAAMC,MAAM,GAAIT,GAAD,CAAaS,MAA5B;;AACA,YAAItD,OAAJ;;AACA,YAAIkD,QAAO,GAAG,KAAd;;AAXN,yCAYU;AAAA;;AAAA,iCACe,SAACvB,QAAD,EAAkB0B,SAAlB,eAAgCC,MAAhC,CADf;AACAtD,YAAAA,OAAM,aAAN;AADA;AAEH,SAdP,YAceuD,GAdf,EAcoB;AACVL,UAAAA,QAAO,GAAG,IAAV;AACAlD,UAAAA,OAAM,GAAGuD,GAAT;AACH,SAjBP;;AAAA;AAAA;AAAA;;AAAA;AA6BD,GAhCD;AAAA;AAAA;AAAA;;AAtGA;AACA;AACA;AACA;AACA,WAAsBC,qBAAtB,YAAsBA,qBAAtB,CACI7B,QADJ,EAEI0B,SAFJ,EAGIC,MAHJ;AAAA,MAIwB;AACpB,QAAMG,uBAAuB,GAAG,OAAQ9B,QAAD,CAAkB+B,KAAzB,KAAmC,UAAnE;AACA,QAAMC,WAAW,GAAGF,uBAAuB,GAAGV,mCAAH,GAAyCa,8CAApF;AAEA,QAAMzB,aAAa,GAAG7C,cAAc,CAACqC,QAAQ,CAACM,SAAT,CAAmBE,aAApB,CAApC;AAJoB,2BAKdC,kBAAkB,CAACD,aAAD,CALJ;AAMpB,UAAMgB,gBAAgB,GAAGhB,aAAa,CAACgB,gBAAvC;AAQA,UAAIU,iBAAJ;AACA,UAAMC,iBAAiB,GAAG,IAAIC,OAAJ,CAA4B,UAAAC,GAAG,EAAI;AACzDH,QAAAA,iBAAiB,GAAG,2BAAChB,GAAD,EAAc;AAC9B,cAAIA,GAAG,CAACoB,OAAJ,KAAgB,QAAhB,IAA4BpB,GAAG,CAACqB,MAAJ,KAAe,OAA/C,EAAwD;AACpDF,YAAAA,GAAG,CAAC;AACAG,cAAAA,KAAK,EAAE;AADP,aAAD,CAAH;AAGH;AACJ,SAND;;AAOAhB,QAAAA,gBAAgB,CAACiB,gBAAjB,CAAkC,UAAlC,EAA8CP,iBAA9C;AACH,OATyB,CAA1B;AAUA,UAAMb,SAAS,GAAGvD,iBAAiB,CAAC,EAAD,CAAnC;AACA,UAAI4E,gBAAJ;AACA,UAAMC,eAAe,GAAG,IAAIP,OAAJ,CAA4B,UAACC,GAAD,EAAMO,IAAN,EAAe;AAC/DF,QAAAA,gBAAgB,GAAG,0BAACxB,GAAD,EAAc;AAC7B,cACIA,GAAG,CAACC,IAAJ,KAAaa,WAAb,IACAd,GAAG,CAACI,QAAJ,KAAiB,IADjB,IAEAJ,GAAG,CAACG,SAAJ,KAAkBA,SAHtB,EAIE;AACE,gBAAIH,GAAG,CAACK,OAAR,EAAiB;AACbc,cAAAA,GAAG,CAAC;AACAG,gBAAAA,KAAK,EAAE,KADP;AAEAK,gBAAAA,KAAK,EAAE3B,GAAG,CAAC7C;AAFX,eAAD,CAAH;AAIH,aALD,MAKO;AACHgE,cAAAA,GAAG,CAAC;AACAG,gBAAAA,KAAK,EAAE,KADP;AAEAnE,gBAAAA,MAAM,EAAE6C,GAAG,CAAC7C;AAFZ,eAAD,CAAH;AAIH;AACJ;AACJ,SAlBD;;AAmBAmD,QAAAA,gBAAgB,CAACiB,gBAAjB,CAAkC,SAAlC,EAA6CC,gBAA7C;AACH,OArBuB,CAAxB,CA3BoB,CAkDpB;;AACAlB,MAAAA,gBAAgB,CAACC,WAAjB,CAA6B;AACzBH,QAAAA,QAAQ,EAAE,KADe;AAEzBH,QAAAA,IAAI,EAAEa,WAFmB;AAGzBN,QAAAA,SAAS,EAATA,SAHyB;AAIzBC,QAAAA,MAAM,EAANA,MAJyB;AAKzBN,QAAAA,SAAS,EAATA,SALyB;AAMzBjB,QAAAA,YAAY,EAAEJ,QAAQ,CAACI,YANE;AAOzBC,QAAAA,cAAc,EAAEL,QAAQ,CAACK;AAPA,OAA7B;AAWA,aAAO+B,OAAO,CAACU,IAAR,CAAa,CAChBX,iBADgB,EAEhBQ,eAFgB,CAAb,EAGJpE,IAHI,CAGC,UAAAwE,aAAa,EAAI;AAErB;AACAvB,QAAAA,gBAAgB,CAACwB,mBAAjB,CAAqC,SAArC,EAAgDN,gBAAhD;AACAlB,QAAAA,gBAAgB,CAACwB,mBAAjB,CAAqC,UAArC,EAAiDd,iBAAjD;;AAEA,YAAIa,aAAa,CAACP,KAAlB,EAAyB;AAAA;;AACrB;AACZ;AACA;AACA;AACA;AACA;AACA;AACY,iBAAO,QAACxC,QAAD,EAAkB0B,SAAlB,cAAgCC,MAAhC,CAAP;AACH,SATD,MASO;AACH,cAAIoB,aAAa,CAACF,KAAlB,EAAyB;AACrB,kBAAME,aAAa,CAACF,KAApB;AACH,WAFD,MAEO;AACH,mBAAOE,aAAa,CAAC1E,MAArB;AACH;AACJ;AACJ,OAzBM,CAAP;AA9DoB;AAwFvB,GA5FD;AAAA;AAAA;AAAA;AAjHA,WAAsB4E,oBAAtB,YAAsBA,oBAAtB,CACI7C,YADJ,EAEI8C,WAFJ;AAAA,MAGE;AAAA,2BAC8BC,2BAA2B,CAACC,GAA5B,CAAgChD,YAAhC,CAD9B,iBACQiD,aADR;AAEE,UAAI,CAACA,aAAL,EAAoB;AAChB;AACA;AACH;;AALH,6BAMQA,aAAa,CAACC,SAAd,CAAwBC,GAAxB,EANR;AAOEL,QAAAA,WAAW,CAACM,OAAZ,CAAoB,UAAAC,UAAU,EAAI;AAC9B,cAAMpD,cAAc,GAAGoD,UAAU,CAACC,IAAlC;AACA,iBAAOL,aAAa,CAACH,WAAd,CAA0B7C,cAA1B,CAAP;AACH,SAHD;;AAPF;AAAA,cAWMsD,MAAM,CAACC,IAAP,CAAYP,aAAa,CAACH,WAA1B,EAAuCW,MAAvC,KAAkD,CAXxD;AAYM;AACAV,YAAAA,2BAA2B,UAA3B,CAAmC/C,YAAnC;AACAiD,YAAAA,aAAa,CAACS,OAAd,CAAsBN,OAAtB,CAA8B,UAAAO,CAAC;AAAA,qBAAIA,CAAC,CAACC,MAAF,EAAJ;AAAA,aAA/B;AAdN,mCAeY,IAAI5B,OAAJ,CAAkB,UAACC,GAAD,EAAM4B,GAAN,EAAc;AAClCZ,cAAAA,aAAa,CAACa,QAAd,CAAuBC,KAAvB,CAA6B,UAAAvC,GAAG,EAAI;AAChCA,gBAAAA,GAAG,GAAGqC,GAAG,CAACrC,GAAD,CAAN,GAAcS,GAAG,EAApB;AACH,eAFD;AAGH,aAJK,CAfZ;AAAA;AAAA;;AAAA;AAAA;AAAA;AAqBD,GAxBD;AAAA;AAAA;AAAA;AA0BA;AACA;AACA;AACA;;AAxKA,OAAO,IAAM+B,yBAAyB,GAAG,eAAlC;AACP,OAAO,IAAMhD,mCAAmC,GAAG,4BAA5C;AACP,OAAO,IAAMa,8CAA8C,GAAG,uCAAvD;AAGP;AACA;AACA;AACA;;AACA,OAAO,SAASoC,YAAT,CAAyBC,OAAzB,EAA8E;AACjF,MAAI,CAACA,OAAO,CAACC,KAAb,EAAoB;AAChB,WAAOD,OAAP;AACH;;AACD,MAAME,MAAM,GAAG5G,SAAS,CAAC0G,OAAD,CAAxB;AAEA;AACJ;AACA;AACA;AACA;;AACI,MAAKE,MAAD,CAAgBC,YAApB,EAAkC;AAC9BD,IAAAA,MAAM,CAACE,KAAP,GAAe;AACXC,MAAAA,GAAG,EAAGH,MAAD,CAAgBC;AADV,KAAf;AAGA,WAAQD,MAAD,CAAgBC,YAAvB;AACH;;AAED,SAAOD,MAAM,CAACD,KAAd;AACA,SAAOC,MAAP;AACH;AAED;AACA;AACA;;AACA,OAAO,IAAMI,6BAA8D,GAAG,IAAIC,GAAJ,EAAvE;AAGP,OAAO,IAAMC,iCAAkE,GAAG;AAC9EC,EAAAA,iBAAiB,EAAE,IAD2D;AAE9EC,EAAAA,WAAW,EAAE,IAFiE;AAG9EC,EAAAA,sBAAsB,EAAE,IAHsD;AAI9EC,EAAAA,aAAa,EAAE,IAJ+D;AAK9E;AACAC,EAAAA,WAAW,EAAE,gBANiE;AAO9EC,EAAAA,KAAK,EAAE,KAPuE;AAQ9EC,EAAAA,aAAa,EAAE,KAR+D;AAS9EC,EAAAA,UAAU,EAAE;AATkE,CAA3E;AAYP,IAAMnC,2BAAoE,GAAG,IAAIoC,GAAJ,EAA7E;AACA,OAAO,SAASC,eAAT,CACHpF,YADG,EAEHU,gBAFG,EAGuB;AAC1B,MAAIuC,aAAqD,GAAGF,2BAA2B,CAACC,GAA5B,CAAgChD,YAAhC,CAA5D;;AACA,MAAI,CAACiD,aAAL,EAAoB;AAChB;AACR;AACA;AACA;AACQ,QAAMoC,cAAuB,GAAG,CAAC,CAAC3E,gBAAgB,CAAC4E,OAAnD;;AACArC,IAAAA,aAAa,GAAG;AAAA,UAAa;AAAA;AAqDzB;AACZ;AACA;AACY,cAAMS,OAAoB,GAAG,EAA7B;;AACA,cAAI2B,cAAJ,EAAoB;AAChB3B,YAAAA,OAAO,CAAC6B,IAAR,CACIjI,SAAS,CAAC;AAAA,qBAAMkI,aAAa,CAACrC,GAAd,EAAN;AAAA,aAAD,CADb;AAGH;;AAED,cAAM9E,KAAwB,GAAG;AAC7ByF,YAAAA,QAAQ,EAARA,QAD6B;AAE7BpD,YAAAA,gBAAgB,EAAE+E,WAFW;AAG7BvC,YAAAA,SAAS,EAAEsC,aAHkB;AAI7B1C,YAAAA,WAAW,EAAE,EAJgB;AAK7BY,YAAAA,OAAO,EAAPA;AAL6B,WAAjC;AAQA,iBAAOrF,KAAP;AAvEyB;;AAEzB,YAAIqH,iBAAiB,GAAGL,cAAc,GAAG,SAAH,GAAe,QAArD;;AACA,YAAI3E,gBAAgB,CAACgF,iBAArB,EAAwC;AACpCA,UAAAA,iBAAiB,GAAGhF,gBAAgB,CAACgF,iBAArC;AACH;;AACD,YAAMD,WAAW,GAAGlC,MAAM,CAACoC,MAAP,EAChB;AACA;AACIC,UAAAA,QAAQ,EAAEP,cADd;AAEIK,UAAAA,iBAAiB,EAAjBA,iBAFJ;AAGIG,UAAAA,OAAO,EAAE;AAHb,SAFgB,EAOhBnF,gBAPgB,EAQhB;AACA;AACI;AACpB;AACA;AACA;AACoBkF,UAAAA,QAAQ,EAAE,KALd;AAMIE,UAAAA,QAAQ,EAAE,KANd;AAOIC,UAAAA,cAAc,EAAE;AAPpB,SATgB,CAApB;AAmBA,YAAMjC,QAAQ,GAAG,IAAI1G,MAAJ,CACb4C,YAAY,GAAG,KADF,EAEbxC,SAAS,CAACiI,WAAD,CAFI,CAAjB;AAIA,YAAMD,aAAa,GAAG,IAAI7H,aAAJ,CAClBmG,QADkB,EAElB2B,WAFkB,CAAtB;AAKA;AACZ;AACA;AACA;AACA;AACA;;AAvCqC;AAAA,cAwCrBJ,cAxCqB;AAyCrB,gBAAMW,mBAAmB,GAAG,IAAIhE,OAAJ,CAAkB,UAACC,GAAD,EAAM4B,GAAN,EAAc;AACxDC,cAAAA,QAAQ,CAACmC,YAAT,CAAsB,EAAtB,EAA0B,UAACzE,GAAD,EAAS;AAC/B,oBAAIiE,WAAW,CAACS,gBAAhB,EAAkC;AAC9BT,kBAAAA,WAAW,CAACS,gBAAZ,CAA6B1E,GAA7B;AACH;;AACDA,gBAAAA,GAAG,GAAGqC,GAAG,CAACrC,GAAD,CAAN,GAAcS,GAAG,EAApB;AACH,eALD;AAMH,aAP2B,CAA5B;AAQAuD,YAAAA,aAAa,CAACtC,SAAd,GAA0BsC,aAAa,CAACtC,SAAd,CAAwB/E,IAAxB,CAA6B;AAAA,qBAAM6H,mBAAN;AAAA,aAA7B,CAA1B;AAjDqB,mCAkDfA,mBAlDe;AAAA;AAAA;;AAAA;AAwE5B,OAxEe;AAAA;AAAA;AAAA,OAAhB;;AAyEAjD,IAAAA,2BAA2B,CAACoD,GAA5B,CAAgCnG,YAAhC,EAA8CiD,aAA9C;AACH;;AACD,SAAOA,aAAP;AACH;AAgCD,OAAO,SAASmD,qBAAT,CACHC,OADG,EAEH1E,KAFG,EAGmC;AACtC,MAAI,CAACA,KAAK,CAAC2E,IAAX,EAAiB;AACb,UAAM1I,UAAU,CAAC,KAAD,EAAQ;AAAE+D,MAAAA,KAAK,EAALA;AAAF,KAAR,CAAhB;AACH;;AACD,MAAM4E,WAA4C,GAAG5E,KAAK,CAAC2E,IAA3D;;AAEA,MAAME,GAA2C,GAAG,SAA9CA,GAA8C,CAACC,CAAD,EAAeC,CAAf,EAAgC;AAChF,QAAIC,aAAqB,GAAG,CAA5B,CADgF,CACjD;;AAC/BJ,IAAAA,WAAW,CAACK,IAAZ,CAAiB,UAAAC,QAAQ,EAAI;AACzB,UAAMC,SAAiB,GAAGvD,MAAM,CAACC,IAAP,CAAYqD,QAAZ,EAAsB,CAAtB,CAA1B;AACA,UAAME,SAAkC,GAAGxD,MAAM,CAACyD,MAAP,CAAcH,QAAd,EAAwB,CAAxB,CAA3C;AACA,UAAMI,mBAAmB,GAAGF,SAAS,KAAK,KAAd,GAAsB,CAAtB,GAA0B,CAAC,CAAvD;AACA,UAAMG,MAAW,GAAIT,CAAD,CAAWK,SAAX,CAApB;AACA,UAAMK,MAAW,GAAIT,CAAD,CAAWI,SAAX,CAApB;;AACA,UAAII,MAAM,KAAKC,MAAf,EAAuB;AACnB,eAAO,KAAP;AACH,OAFD,MAEO;AACH,YAAID,MAAM,GAAGC,MAAb,EAAqB;AACjBR,UAAAA,aAAa,GAAG,IAAIM,mBAApB;AACA,iBAAO,IAAP;AACH,SAHD,MAGO;AACHN,UAAAA,aAAa,GAAG,CAAC,CAAD,GAAKM,mBAArB;AACA,iBAAO,IAAP;AACH;AACJ;AACJ,KAjBD;AAmBA;AACR;AACA;AACA;AACA;;AACQ,QAAI,CAACN,aAAL,EAAoB;AAChB,YAAM/I,UAAU,CAAC,KAAD,EAAQ;AAAEkC,QAAAA,IAAI,EAAE;AAAE6B,UAAAA,KAAK,EAALA,KAAF;AAAS8E,UAAAA,CAAC,EAADA,CAAT;AAAYC,UAAAA,CAAC,EAADA;AAAZ;AAAR,OAAR,CAAhB;AACH;;AAED,WAAOC,aAAP;AACH,GA/BD;;AAgCA,SAAOH,GAAP;AACH;AAGD,OAAO,SAASY,oBAAT,CACHC,OADG,EAEHrH,YAFG,EAGU;AACb,MAAIsH,YAAY,GAAGD,OAAO,CAACE,yBAAR,CAAkCvE,GAAlC,CAAsChD,YAAtC,CAAnB;;AACA,MAAI,CAACsH,YAAL,EAAmB;AACf,QAAME,WAAW,GAAG,iBAAiBxH,YAArC;AACA,QAAMyH,OAAO,GAAG,IAAI5J,gBAAJ,CAAqB2J,WAArB,CAAhB;AACA,QAAME,OAAO,GAAG5J,oBAAoB,CAAC2J,OAAD,CAApC;AACAH,IAAAA,YAAY,GAAG;AACXlH,MAAAA,aAAa,EAAEsH,OADJ;AAEXC,MAAAA,aAAa,EAAE;AAFJ,KAAf;AAIAN,IAAAA,OAAO,CAACE,yBAAR,CAAkCpB,GAAlC,CAAsCnG,YAAtC,EAAoDsH,YAApD;AACH,GATD,MASO;AACHA,IAAAA,YAAY,CAACK,aAAb,GAA6BL,YAAY,CAACK,aAAb,GAA6B,CAA1D;AACH;;AACD,SAAOL,YAAY,CAAClH,aAApB;AACH;AAED,OAAO,SAASwH,gCAAT,CACHP,OADG,EAEHrH,YAFG,EAGL;AACE,MAAMsH,YAAY,GAAGD,OAAO,CAACE,yBAAR,CAAkCvE,GAAlC,CAAsChD,YAAtC,CAArB;;AACA,MAAIsH,YAAJ,EAAkB;AACdA,IAAAA,YAAY,CAACK,aAAb,GAA6BL,YAAY,CAACK,aAAb,GAA6B,CAA1D;;AACA,QAAIL,YAAY,CAACK,aAAb,KAA+B,CAAnC,EAAsC;AAClCL,MAAAA,YAAY,CAAClH,aAAb,CAA2BgB,gBAA3B,CAA4C2C,KAA5C;AACAsD,MAAAA,OAAO,CAACE,yBAAR,WAAyCvH,YAAzC;AACH;AACJ;AACJ","sourcesContent":["import { createLokiLocalState, RxStorageInstanceLoki } from './rx-storage-instance-loki';\nimport lokijs, { Collection } from 'lokijs';\nimport type {\n    LokiDatabaseSettings,\n    LokiDatabaseState,\n    LokiLocalDatabaseState,\n    LokiRemoteResponseBroadcastMessage,\n    MangoQuery,\n    MangoQuerySortDirection,\n    MangoQuerySortPart,\n    RxDocumentData,\n    RxJsonSchema\n} from '../../types';\nimport {\n    add as unloadAdd, AddReturn\n} from 'unload';\nimport { ensureNotFalsy, flatClone, promiseWait, randomCouchString } from '../../util';\nimport { LokiSaveQueue } from './loki-save-queue';\nimport type { DeterministicSortComparator } from 'event-reduce-js';\nimport { newRxError } from '../../rx-error';\nimport {\n    BroadcastChannel,\n    createLeaderElection,\n    LeaderElector,\n    OnMessageHandler\n} from 'broadcast-channel';\nimport type { RxStorageLoki } from './rx-storage-lokijs';\n\nexport const CHANGES_COLLECTION_SUFFIX = '-rxdb-changes';\nexport const LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE = 'rxdb-lokijs-remote-request';\nexport const LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE = 'rxdb-lokijs-remote-request-key-object';\n\n\n/**\n * Loki attaches a $loki property to all data\n * which must be removed before returning the data back to RxDB.\n */\nexport function stripLokiKey<T>(docData: RxDocumentData<T> & { $loki?: number; }): T {\n    if (!docData.$loki) {\n        return docData;\n    }\n    const cloned = flatClone(docData);\n\n    /**\n     * In RxDB version 12.0.0,\n     * we introduced the _meta field that already contains the last write time.\n     * To be backwards compatible, we have to move the $lastWriteAt to the _meta field.\n     */\n    if ((cloned as any).$lastWriteAt) {\n        cloned._meta = {\n            lwt: (cloned as any).$lastWriteAt\n        };\n        delete (cloned as any).$lastWriteAt;\n    }\n\n    delete cloned.$loki;\n    return cloned;\n}\n\n/**\n * Used to check in tests if all instances have been cleaned up.\n */\nexport const OPEN_LOKIJS_STORAGE_INSTANCES: Set<RxStorageInstanceLoki<any>> = new Set();\n\n\nexport const LOKIJS_COLLECTION_DEFAULT_OPTIONS: Partial<CollectionOptions<any>> = {\n    disableChangesApi: true,\n    disableMeta: true,\n    disableDeltaChangesApi: true,\n    disableFreeze: true,\n    // TODO use 'immutable' like WatermelonDB does it\n    cloneMethod: 'shallow-assign',\n    clone: false,\n    transactional: false,\n    autoupdate: false\n}\n\nconst LOKI_DATABASE_STATE_BY_NAME: Map<string, Promise<LokiDatabaseState>> = new Map();\nexport function getLokiDatabase(\n    databaseName: string,\n    databaseSettings: LokiDatabaseSettings\n): Promise<LokiDatabaseState> {\n    let databaseState: Promise<LokiDatabaseState> | undefined = LOKI_DATABASE_STATE_BY_NAME.get(databaseName);\n    if (!databaseState) {\n        /**\n         * We assume that as soon as an adapter is passed,\n         * the database has to be persistend.\n         */\n        const hasPersistence: boolean = !!databaseSettings.adapter;\n        databaseState = (async () => {\n\n            let persistenceMethod = hasPersistence ? 'adapter' : 'memory';\n            if (databaseSettings.persistenceMethod) {\n                persistenceMethod = databaseSettings.persistenceMethod;\n            }\n            const useSettings = Object.assign(\n                // defaults\n                {\n                    autoload: hasPersistence,\n                    persistenceMethod,\n                    verbose: true\n                },\n                databaseSettings,\n                // overwrites\n                {\n                    /**\n                     * RxDB uses its custom load and save handling\n                     * so we disable the LokiJS save/load handlers.\n                     */\n                    autoload: false,\n                    autosave: false,\n                    throttledSaves: false\n                }\n            );\n            const database = new lokijs(\n                databaseName + '.db',\n                flatClone(useSettings)\n            );\n            const lokiSaveQueue = new LokiSaveQueue(\n                database,\n                useSettings\n            );\n\n            /**\n             * Wait until all data is loaded from persistence adapter.\n             * Wrap the loading into the saveQueue to ensure that when many\n             * collections are created at the same time, the load-calls do not interfere\n             * with each other and cause error logs.\n             */\n            if (hasPersistence) {\n                const loadDatabasePromise = new Promise<void>((res, rej) => {\n                    database.loadDatabase({}, (err) => {\n                        if (useSettings.autoloadCallback) {\n                            useSettings.autoloadCallback(err);\n                        }\n                        err ? rej(err) : res();\n                    });\n                });\n                lokiSaveQueue.saveQueue = lokiSaveQueue.saveQueue.then(() => loadDatabasePromise);\n                await loadDatabasePromise;\n            }\n\n            /**\n             * Autosave database on process end\n             */\n            const unloads: AddReturn[] = [];\n            if (hasPersistence) {\n                unloads.push(\n                    unloadAdd(() => lokiSaveQueue.run())\n                );\n            }\n\n            const state: LokiDatabaseState = {\n                database,\n                databaseSettings: useSettings,\n                saveQueue: lokiSaveQueue,\n                collections: {},\n                unloads\n            };\n\n            return state;\n        })();\n        LOKI_DATABASE_STATE_BY_NAME.set(databaseName, databaseState);\n    }\n    return databaseState;\n}\n\nexport async function closeLokiCollections(\n    databaseName: string,\n    collections: Collection[]\n) {\n    const databaseState = await LOKI_DATABASE_STATE_BY_NAME.get(databaseName);\n    if (!databaseState) {\n        // already closed\n        return;\n    }\n    await databaseState.saveQueue.run();\n    collections.forEach(collection => {\n        const collectionName = collection.name;\n        delete databaseState.collections[collectionName];\n    });\n    if (Object.keys(databaseState.collections).length === 0) {\n        // all collections closed -> also close database\n        LOKI_DATABASE_STATE_BY_NAME.delete(databaseName);\n        databaseState.unloads.forEach(u => u.remove());\n        await new Promise<void>((res, rej) => {\n            databaseState.database.close(err => {\n                err ? rej(err) : res();\n            });\n        });\n    }\n}\n\n/**\n * This function is at lokijs-helper\n * because we need it in multiple places.\n */\nexport function getLokiSortComparator<RxDocType>(\n    _schema: RxJsonSchema<RxDocumentData<RxDocType>>,\n    query: MangoQuery<RxDocType>\n): DeterministicSortComparator<RxDocType> {\n    if (!query.sort) {\n        throw newRxError('SNH', { query });\n    }\n    const sortOptions: MangoQuerySortPart<RxDocType>[] = query.sort;\n\n    const fun: DeterministicSortComparator<RxDocType> = (a: RxDocType, b: RxDocType) => {\n        let compareResult: number = 0; // 1 | -1\n        sortOptions.find(sortPart => {\n            const fieldName: string = Object.keys(sortPart)[0];\n            const direction: MangoQuerySortDirection = Object.values(sortPart)[0];\n            const directionMultiplier = direction === 'asc' ? 1 : -1;\n            const valueA: any = (a as any)[fieldName];\n            const valueB: any = (b as any)[fieldName];\n            if (valueA === valueB) {\n                return false;\n            } else {\n                if (valueA > valueB) {\n                    compareResult = 1 * directionMultiplier;\n                    return true;\n                } else {\n                    compareResult = -1 * directionMultiplier;\n                    return true;\n                }\n            }\n        });\n\n        /**\n         * Two different objects should never have the same sort position.\n         * We ensure this by having the unique primaryKey in the sort params\n         * which is added by RxDB if not existing yet.\n         */\n        if (!compareResult) {\n            throw newRxError('SNH', { args: { query, a, b } });\n        }\n\n        return compareResult as any;\n    }\n    return fun;\n}\n\n\nexport function getLokiLeaderElector(\n    storage: RxStorageLoki,\n    databaseName: string\n): LeaderElector {\n    let electorState = storage.leaderElectorByLokiDbName.get(databaseName);\n    if (!electorState) {\n        const channelName = 'rxdb-lokijs-' + databaseName;\n        const channel = new BroadcastChannel(channelName);\n        const elector = createLeaderElection(channel);\n        electorState = {\n            leaderElector: elector,\n            intancesCount: 1\n        }\n        storage.leaderElectorByLokiDbName.set(databaseName, electorState);\n    } else {\n        electorState.intancesCount = electorState.intancesCount + 1;\n    }\n    return electorState.leaderElector;\n}\n\nexport function removeLokiLeaderElectorReference(\n    storage: RxStorageLoki,\n    databaseName: string\n) {\n    const electorState = storage.leaderElectorByLokiDbName.get(databaseName);\n    if (electorState) {\n        electorState.intancesCount = electorState.intancesCount - 1;\n        if (electorState.intancesCount === 0) {\n            electorState.leaderElector.broadcastChannel.close();\n            storage.leaderElectorByLokiDbName.delete(databaseName);\n        }\n    }\n}\n\n/**\n * For multi-instance usage, we send requests to the RxStorage\n * to the current leading instance over the BroadcastChannel.\n */\nexport async function requestRemoteInstance(\n    instance: RxStorageInstanceLoki<any>,\n    operation: string,\n    params: any[]\n): Promise<any | any[]> {\n    const isRxStorageInstanceLoki = typeof (instance as any).query === 'function';\n    const messageType = isRxStorageInstanceLoki ? LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE : LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE;\n\n    const leaderElector = ensureNotFalsy(instance.internals.leaderElector);\n    await waitUntilHasLeader(leaderElector);\n    const broadcastChannel = leaderElector.broadcastChannel;\n\n    type WinningPromise = {\n        retry: boolean,\n        result?: any;\n        error?: any;\n    }\n\n    let whenDeathListener: OnMessageHandler<any>;\n    const leaderDeadPromise = new Promise<WinningPromise>(res => {\n        whenDeathListener = (msg: any) => {\n            if (msg.context === 'leader' && msg.action === 'death') {\n                res({\n                    retry: true\n                });\n            }\n        };\n        broadcastChannel.addEventListener('internal', whenDeathListener);\n    });\n    const requestId = randomCouchString(12);\n    let responseListener: OnMessageHandler<any>;\n    const responsePromise = new Promise<WinningPromise>((res, _rej) => {\n        responseListener = (msg: any) => {\n            if (\n                msg.type === messageType &&\n                msg.response === true &&\n                msg.requestId === requestId\n            ) {\n                if (msg.isError) {\n                    res({\n                        retry: false,\n                        error: msg.result\n                    });\n                } else {\n                    res({\n                        retry: false,\n                        result: msg.result\n                    });\n                }\n            }\n        };\n        broadcastChannel.addEventListener('message', responseListener);\n    });\n\n    // send out the request to the other instance\n    broadcastChannel.postMessage({\n        response: false,\n        type: messageType,\n        operation,\n        params,\n        requestId,\n        databaseName: instance.databaseName,\n        collectionName: instance.collectionName\n    });\n\n\n    return Promise.race([\n        leaderDeadPromise,\n        responsePromise\n    ]).then(firstResolved => {\n\n        // clean up listeners\n        broadcastChannel.removeEventListener('message', responseListener);\n        broadcastChannel.removeEventListener('internal', whenDeathListener);\n\n        if (firstResolved.retry) {\n            /**\n             * The leader died while a remote request was running\n             * we re-run the whole operation.\n             * We cannot just re-run requestRemoteInstance()\n             * because the current instance might be the new leader now\n             * and then we have to use the local state instead of requesting the remote.\n             */\n            return (instance as any)[operation](...params);\n        } else {\n            if (firstResolved.error) {\n                throw firstResolved.error;\n            } else {\n                return firstResolved.result;\n            }\n        }\n    });\n}\n\n/**\n * Handles a request that came from a remote instance via requestRemoteInstance()\n * Runs the requested operation over the local db instance and sends back the result.\n */\nexport async function handleRemoteRequest(\n    instance: RxStorageInstanceLoki<any>,\n    msg: any\n) {\n    if (\n        msg.type === LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE &&\n        msg.requestId &&\n        msg.databaseName === instance.databaseName &&\n        msg.collectionName === instance.collectionName &&\n        !msg.response\n    ) {\n        const operation = (msg as any).operation;\n        const params = (msg as any).params;\n        let result: any;\n        let isError = false;\n        try {\n            result = await (instance as any)[operation](...params);\n        } catch (err) {\n            isError = true;\n            result = err;\n        }\n        const response: LokiRemoteResponseBroadcastMessage = {\n            response: true,\n            requestId: msg.requestId,\n            databaseName: instance.databaseName,\n            collectionName: instance.collectionName,\n            result,\n            isError,\n            type: msg.type\n        };\n        ensureNotFalsy(instance.internals.leaderElector).broadcastChannel.postMessage(response);\n    }\n}\n\n\nexport async function waitUntilHasLeader(leaderElector: LeaderElector) {\n    while (\n        !leaderElector.hasLeader\n    ) {\n        await leaderElector.applyOnce();\n        await promiseWait(0);\n    }\n}\n\n/**\n * If the local state must be used, that one is returned.\n * Returns false if a remote instance must be used.\n */\nexport async function mustUseLocalState(\n    instance: RxStorageInstanceLoki<any>\n): Promise<LokiLocalDatabaseState | false> {\n    if (instance.closed) {\n        /**\n         * If this happens, it means that RxDB made a call to an already closed storage instance.\n         * This must never happen because when RxDB closes a collection or database,\n         * all tasks must be cleared so that no more calls are made the the storage.\n         */\n        throw newRxError('SNH', {\n            args: {\n                instanceClosed: instance.closed,\n                databaseName: instance.databaseName,\n                collectionName: instance.collectionName\n            }\n        });\n    }\n\n\n    if (instance.internals.localState) {\n        return instance.internals.localState;\n    }\n    const leaderElector = ensureNotFalsy(instance.internals.leaderElector);\n    await waitUntilHasLeader(leaderElector);\n\n    /**\n     * It might already have a localState after the applying\n     * because another subtask also called mustUSeLocalState()\n     */\n    if (instance.internals.localState) {\n        return instance.internals.localState;\n    }\n\n    if (\n        leaderElector.isLeader &&\n        !instance.internals.localState\n    ) {\n        // own is leader, use local instance\n        instance.internals.localState = createLokiLocalState<any>({\n            databaseName: instance.databaseName,\n            collectionName: instance.collectionName,\n            options: instance.options,\n            schema: (instance as RxStorageInstanceLoki<any>).schema,\n            multiInstance: instance.internals.leaderElector ? true : false\n        }, instance.databaseSettings);\n        return ensureNotFalsy(instance.internals.localState);\n    } else {\n        // other is leader, send message to remote leading instance\n        return false;\n    }\n}\n"],"file":"lokijs-helper.js"}