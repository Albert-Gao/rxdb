{"version":3,"sources":["../../src/rx-schema.ts"],"names":["deepEqual","hash","overwriteGetterForCaching","flatClone","isMaybeReadonlyArray","newRxError","runPluginHooks","defineGetterSetter","fillWithDefaultSettings","getComposedPrimaryKeyOfDocumentData","getFinalFields","getPrimaryFieldOfPrimaryKey","normalizeRxJsonSchema","overwritable","fillObjectDataBeforeInsert","RxSchema","jsonSchema","indexes","getIndexes","primaryPath","primaryKey","finalFields","validateChange","dataBefore","dataAfter","forEach","fieldName","schema","validate","obj","schemaPath","validateFullDocumentData","fullDocData","_docData","_schemaPath","fillObjectWithDefaults","Object","entries","defaultValues","filter","k","hasOwnProperty","v","getDocumentPrototype","proto","getPrimaryOfDocumentData","documentData","version","values","properties","encrypted","length","attachments","map","index","getPreviousVersions","c","Array","fill","createRxSchema","runPreCreateHooks","useJsonSchema","deepFreezeWhenDevMode","isInstanceOf","toTypedRxJsonSchema"],"mappings":"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","sourcesContent":["import deepEqual from 'fast-deep-equal';\n\nimport {\n    hash,\n    overwriteGetterForCaching,\n    flatClone,\n    isMaybeReadonlyArray\n} from './util';\nimport {\n    newRxError,\n} from './rx-error';\nimport {\n    runPluginHooks\n} from './hooks';\nimport {\n    defineGetterSetter\n} from './rx-document';\n\nimport type {\n    DeepMutable,\n    DeepReadonly, MaybeReadonly,\n    RxDocumentData,\n    RxJsonSchema\n} from './types';\nimport {\n    fillWithDefaultSettings,\n    getComposedPrimaryKeyOfDocumentData,\n    getFinalFields,\n    getPrimaryFieldOfPrimaryKey,\n    normalizeRxJsonSchema\n} from './rx-schema-helper';\nimport { overwritable } from './overwritable';\nimport { fillObjectDataBeforeInsert } from './rx-collection-helper';\n\nexport class RxSchema<RxDocType = any> {\n    public indexes: MaybeReadonly<string[]>[];\n    public readonly primaryPath: keyof RxDocType;\n    public finalFields: string[];\n\n    constructor(\n        public readonly jsonSchema: RxJsonSchema<RxDocumentData<RxDocType>>\n    ) {\n        this.indexes = getIndexes(this.jsonSchema);\n\n        // primary is always required\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.jsonSchema.primaryKey) as any;\n\n        this.finalFields = getFinalFields(this.jsonSchema);\n    }\n\n    public get version(): number {\n        return this.jsonSchema.version;\n    }\n\n    public get defaultValues(): { [P in keyof RxDocType]: RxDocType[P] } {\n        const values = {} as { [P in keyof RxDocType]: RxDocType[P] };\n        Object\n            .entries(this.jsonSchema.properties)\n            .filter(([, v]) => (v as any).hasOwnProperty('default'))\n            .forEach(([k, v]) => (values as any)[k] = (v as any).default);\n        return overwriteGetterForCaching(\n            this,\n            'defaultValues',\n            values\n        );\n    }\n\n    /**\n        * true if schema contains at least one encrypted path\n        */\n    get crypt(): boolean {\n        if (\n            !!this.jsonSchema.encrypted && this.jsonSchema.encrypted.length > 0 ||\n            this.jsonSchema.attachments && this.jsonSchema.attachments.encrypted\n        ) {\n            return true;\n        } else {\n            return false;\n        }\n    }\n\n    /**\n     * @overrides itself on the first call\n     */\n    public get hash(): string {\n        return overwriteGetterForCaching(\n            this,\n            'hash',\n            hash(this.jsonSchema)\n        );\n    }\n\n    /**\n     * checks if a given change on a document is allowed\n     * Ensures that:\n     * - primary is not modified\n     * - final fields are not modified\n     * @throws {Error} if not valid\n     */\n    validateChange(dataBefore: any, dataAfter: any): void {\n        this.finalFields.forEach(fieldName => {\n            if (!deepEqual(dataBefore[fieldName], dataAfter[fieldName])) {\n                throw newRxError('DOC9', {\n                    dataBefore,\n                    dataAfter,\n                    fieldName,\n                    schema: this.jsonSchema\n                });\n            }\n        });\n    }\n\n    /**\n     * validate if the given document data matches the schema\n     * @param schemaPath if given, validates against deep-path of schema\n     * @throws {Error} if not valid\n     * @param obj equal to input-obj\n     *\n     */\n    public validate(obj: Partial<RxDocType> | any, schemaPath?: string): void {\n        if (!this.validateFullDocumentData) {\n            return;\n        } else {\n            const fullDocData = fillObjectDataBeforeInsert(this, obj);\n            return this.validateFullDocumentData(fullDocData, schemaPath);\n        }\n    }\n\n    /**\n     * @overwritten by the given validation plugin\n     */\n    public validateFullDocumentData(\n        _docData: RxDocumentData<RxDocType>,\n        _schemaPath?: string\n    ) {\n        /**\n         * This method might be overwritten by a validation plugin,\n         * otherwise do nothing, because if not validation plugin\n         * was added to RxDB, we assume all given data is valid.\n         */\n    }\n\n    /**\n     * fills all unset fields with default-values if set\n     */\n    fillObjectWithDefaults(obj: any): any {\n        obj = flatClone(obj);\n        Object\n            .entries(this.defaultValues)\n            .filter(([k]) => !obj.hasOwnProperty(k) || typeof obj[k] === 'undefined')\n            .forEach(([k, v]) => obj[k] = v);\n        return obj;\n    }\n\n    /**\n     * creates the schema-based document-prototype,\n     * see RxCollection.getDocumentPrototype()\n     */\n    public getDocumentPrototype(): any {\n        const proto = {};\n        defineGetterSetter(this, proto, '');\n        overwriteGetterForCaching(\n            this,\n            'getDocumentPrototype',\n            () => proto\n        );\n        return proto;\n    }\n\n\n    getPrimaryOfDocumentData(\n        documentData: Partial<RxDocType>\n    ): string {\n        return getComposedPrimaryKeyOfDocumentData(\n            this.jsonSchema,\n            documentData\n        );\n    }\n}\n\nexport function getIndexes<RxDocType = any>(\n    jsonSchema: RxJsonSchema<RxDocType>\n): MaybeReadonly<string[]>[] {\n    return (jsonSchema.indexes || []).map(index => isMaybeReadonlyArray(index) ? index : [index]);\n}\n\n/**\n * array with previous version-numbers\n */\nexport function getPreviousVersions(schema: RxJsonSchema<any>): number[] {\n    const version = schema.version ? schema.version : 0;\n    let c = 0;\n    return new Array(version)\n        .fill(0)\n        .map(() => c++);\n}\n\nexport function createRxSchema<T>(\n    jsonSchema: RxJsonSchema<T>,\n    runPreCreateHooks = true\n): RxSchema<T> {\n    if (runPreCreateHooks) {\n        runPluginHooks('preCreateRxSchema', jsonSchema);\n    }\n\n    let useJsonSchema = fillWithDefaultSettings(jsonSchema);\n    useJsonSchema = normalizeRxJsonSchema(useJsonSchema);\n    overwritable.deepFreezeWhenDevMode(useJsonSchema);\n\n    const schema = new RxSchema(useJsonSchema);\n    runPluginHooks('createRxSchema', schema);\n    return schema;\n}\n\nexport function isInstanceOf(obj: any): boolean {\n    return obj instanceof RxSchema;\n}\n\n/**\n * Used as helper function the generate the document type out of the schema via typescript.\n * @link https://github.com/pubkey/rxdb/discussions/3467\n */\nexport function toTypedRxJsonSchema<T extends DeepReadonly<RxJsonSchema<any>>>(schema: T): DeepMutable<T> {\n    return schema as any;\n}\n"],"file":"rx-schema.js"}