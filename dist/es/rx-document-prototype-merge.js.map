{"version":3,"sources":["../../src/rx-document-prototype-merge.ts"],"names":["createRxDocumentConstructor","basePrototype","createWithConstructor","createRxDocumentWithConstructor","runPluginHooks","overwritable","protoForCollection","WeakMap","constructorForCollection","getDocumentPrototype","rxCollection","has","schemaProto","schema","ormProto","getDocumentOrmPrototype","baseProto","proto","forEach","obj","props","Object","getOwnPropertyNames","key","desc","getOwnPropertyDescriptor","enumerable","startsWith","endsWith","value","defineProperty","get","bind","configurable","writable","set","getRxDocumentConstructor","ret","createRxDocument","docData","primary","primaryPath","cacheDoc","_docCache","doc","deepFreezeWhenDevMode","_runHooksSync","createRxDocuments","docsJSON","map","json","entries","methods","k","v"],"mappings":"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","sourcesContent":["/**\n * For the ORM capabilities,\n * we have to merge the document prototype\n * with the ORM functions and the data\n * We do this itterating over the properties and\n * adding them to a new object.\n * In the future we should do this by chaining the __proto__ objects\n */\n\nimport type {\n    RxCollection,\n    RxDocument,\n    RxDocumentData\n} from './types';\nimport {\n    createRxDocumentConstructor,\n    basePrototype,\n    createWithConstructor as createRxDocumentWithConstructor\n} from './rx-document';\nimport {\n    runPluginHooks\n} from './hooks';\nimport { overwritable } from './overwritable';\n\n// caches\nconst protoForCollection: WeakMap<RxCollection, any> = new WeakMap();\nconst constructorForCollection: WeakMap<RxCollection, any> = new WeakMap();\n\nexport function getDocumentPrototype(\n    rxCollection: RxCollection\n): any {\n    if (!protoForCollection.has(rxCollection)) {\n        const schemaProto = rxCollection.schema.getDocumentPrototype();\n        const ormProto = getDocumentOrmPrototype(rxCollection);\n        const baseProto = basePrototype;\n        const proto = {};\n        [\n            schemaProto,\n            ormProto,\n            baseProto\n        ].forEach(obj => {\n            const props = Object.getOwnPropertyNames(obj);\n            props.forEach(key => {\n                const desc: any = Object.getOwnPropertyDescriptor(obj, key);\n\n\n                /**\n                 * When enumerable is true, it will show on console.dir(instance)\n                 * To not polute the output, only getters and methods are enumerable\n                 */\n                let enumerable = true;\n                if (\n                    key.startsWith('_') ||\n                    key.endsWith('_') ||\n                    key.startsWith('$') ||\n                    key.endsWith('$')\n                ) enumerable = false;\n\n                if (typeof desc.value === 'function') {\n                    // when getting a function, we automatically do a .bind(this)\n                    Object.defineProperty(proto, key, {\n                        get() {\n                            return desc.value.bind(this);\n                        },\n                        enumerable,\n                        configurable: false\n                    });\n\n                } else {\n                    desc.enumerable = enumerable;\n                    desc.configurable = false;\n                    if (desc.writable)\n                        desc.writable = false;\n                    Object.defineProperty(proto, key, desc);\n                }\n            });\n        });\n        protoForCollection.set(rxCollection, proto);\n\n    }\n    return protoForCollection.get(rxCollection);\n}\n\nexport function getRxDocumentConstructor(\n    rxCollection: RxCollection\n) {\n    if (!constructorForCollection.has(rxCollection)) {\n        const ret = createRxDocumentConstructor(\n            getDocumentPrototype(rxCollection)\n        );\n        constructorForCollection.set(rxCollection, ret);\n    }\n    return constructorForCollection.get(rxCollection);\n}\n\n/**\n * Create a RxDocument-instance from the jsonData\n * and the prototype merge.\n * If the document already exists in the _docCache,\n * return that instead to ensure we have no duplicates.\n */\nexport function createRxDocument<RxDocType, ORM>(\n    rxCollection: RxCollection<RxDocType, ORM>,\n    docData: RxDocumentData<RxDocType>\n): RxDocument<RxDocType, ORM> {\n    const primary: string = docData[rxCollection.schema.primaryPath] as any;\n\n    // return from cache if exists\n    const cacheDoc = rxCollection._docCache.get(primary);\n    if (cacheDoc) {\n        return cacheDoc as any;\n    }\n\n    const doc = createRxDocumentWithConstructor(\n        getRxDocumentConstructor(rxCollection as any),\n        rxCollection as any,\n        overwritable.deepFreezeWhenDevMode(docData as any)\n    );\n\n    rxCollection._docCache.set(primary, doc as any);\n    rxCollection._runHooksSync('post', 'create', docData, doc);\n    runPluginHooks('postCreateRxDocument', doc);\n    return doc as any;\n}\n\n/**\n * create RxDocument from the docs-array\n */\nexport function createRxDocuments<DT, OM>(\n    rxCollection: RxCollection,\n    docsJSON: any[]\n): RxDocument<DT, OM>[] {\n    return docsJSON.map(\n        json => createRxDocument<DT, OM>(rxCollection as any, json)\n    );\n}\n\n/**\n * returns the prototype-object\n * that contains the orm-methods,\n * used in the proto-merge\n */\nexport function getDocumentOrmPrototype(rxCollection: RxCollection): any {\n    const proto: any = {};\n    Object\n        .entries(rxCollection.methods)\n        .forEach(([k, v]) => {\n            proto[k] = v;\n        });\n    return proto;\n}\n"],"file":"rx-document-prototype-merge.js"}