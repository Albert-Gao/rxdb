{"version":3,"file":"lokijs-incremental-indexeddb.worker.js","mappings":"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","sources":["webpack://rxdb/./node_modules/clone/clone.js","webpack://rxdb/./node_modules/detect-node/browser.js","webpack://rxdb/./node_modules/is-electron/index.js","webpack://rxdb/./node_modules/is-observable/index.js","webpack://rxdb/./node_modules/lokijs/src/incremental-indexeddb-adapter.js","webpack://rxdb/./node_modules/lokijs/src/loki-indexed-adapter.js","webpack://rxdb/./node_modules/lokijs/src/lokijs.js","webpack://rxdb/./node_modules/object-path/index.js","webpack://rxdb/./node_modules/pouchdb-md5/node_modules/spark-md5/spark-md5.js","webpack://rxdb/./node_modules/spark-md5/spark-md5.js","webpack://rxdb/./node_modules/threads/dist/common.js","webpack://rxdb/./node_modules/threads/dist/serializers.js","webpack://rxdb/./node_modules/threads/dist/symbols.js","webpack://rxdb/./node_modules/threads/dist/transferable.js","webpack://rxdb/./node_modules/threads/dist/types/messages.js","webpack://rxdb/./node_modules/threads/dist/worker/implementation.browser.js","webpack://rxdb/./node_modules/threads/dist/worker/index.js","webpack://rxdb/webpack/bootstrap","webpack://rxdb/webpack/runtime/compat get default export","webpack://rxdb/webpack/runtime/define property getters","webpack://rxdb/webpack/runtime/global","webpack://rxdb/webpack/runtime/hasOwnProperty shorthand","webpack://rxdb/./src/util.ts","webpack://rxdb/./node_modules/tslib/tslib.es6.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/util/isFunction.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/util/createErrorClass.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/util/UnsubscriptionError.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/util/arrRemove.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/Subscription.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/config.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/scheduler/timeoutProvider.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/util/noop.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/NotificationFactories.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/util/errorContext.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/Subscriber.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/util/reportUnhandledError.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/symbol/observable.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/util/identity.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/util/pipe.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/Observable.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/util/ObjectUnsubscribedError.js","webpack://rxdb/./node_modules/rxjs/dist/esm5/internal/Subject.js","webpack://rxdb/./node_modules/@babel/runtime/helpers/esm/createClass.js","webpack://rxdb/./node_modules/@babel/runtime/helpers/esm/setPrototypeOf.js","webpack://rxdb/./node_modules/@babel/runtime/helpers/esm/inheritsLoose.js","webpack://rxdb/./node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js","webpack://rxdb/./node_modules/@babel/runtime/helpers/esm/isNativeReflectConstruct.js","webpack://rxdb/./node_modules/@babel/runtime/helpers/esm/construct.js","webpack://rxdb/./node_modules/@babel/runtime/helpers/esm/wrapNativeSuper.js","webpack://rxdb/./node_modules/@babel/runtime/helpers/esm/isNativeFunction.js","webpack://rxdb/./src/overwritable.ts","webpack://rxdb/./src/rx-error.ts","webpack://rxdb/./node_modules/unload/dist/es/browser.js","webpack://rxdb/./node_modules/unload/dist/es/index.js","webpack://rxdb/./src/plugins/lokijs/loki-save-queue.ts","webpack://rxdb/./node_modules/broadcast-channel/dist/esbrowser/util.js","webpack://rxdb/./node_modules/broadcast-channel/dist/esbrowser/methods/native.js","webpack://rxdb/./node_modules/oblivious-set/dist/es/index.js","webpack://rxdb/./node_modules/broadcast-channel/dist/esbrowser/options.js","webpack://rxdb/./node_modules/broadcast-channel/dist/esbrowser/methods/indexed-db.js","webpack://rxdb/./node_modules/broadcast-channel/dist/esbrowser/methods/localstorage.js","webpack://rxdb/./node_modules/broadcast-channel/dist/esbrowser/methods/simulate.js","webpack://rxdb/./node_modules/broadcast-channel/dist/esbrowser/method-chooser.js","webpack://rxdb/./node_modules/broadcast-channel/dist/esbrowser/broadcast-channel.js","webpack://rxdb/./node_modules/broadcast-channel/dist/esbrowser/leader-election.js","webpack://rxdb/./src/plugins/lokijs/lokijs-helper.ts","webpack://rxdb/./src/rx-schema-helper.ts","webpack://rxdb/./src/rx-storage-helper.ts","webpack://rxdb/./src/plugins/lokijs/rx-storage-instance-loki.ts","webpack://rxdb/./node_modules/pouchdb-binary-utils/lib/index-browser.es.js","webpack://rxdb/./node_modules/pouchdb-md5/lib/index-browser.es.js","webpack://rxdb/./src/plugins/lokijs/rx-storage-lokijs.ts","webpack://rxdb/./node_modules/threads/worker.mjs","webpack://rxdb/./src/plugins/worker/workers/lokijs-incremental-indexeddb.worker.ts","webpack://rxdb/./src/plugins/worker/in-worker.ts"],"sourcesContent":["var clone = (function() {\n'use strict';\n\nfunction _instanceof(obj, type) {\n  return type != null && obj instanceof type;\n}\n\nvar nativeMap;\ntry {\n  nativeMap = Map;\n} catch(_) {\n  // maybe a reference error because no `Map`. Give it a dummy value that no\n  // value will ever be an instanceof.\n  nativeMap = function() {};\n}\n\nvar nativeSet;\ntry {\n  nativeSet = Set;\n} catch(_) {\n  nativeSet = function() {};\n}\n\nvar nativePromise;\ntry {\n  nativePromise = Promise;\n} catch(_) {\n  nativePromise = function() {};\n}\n\n/**\n * Clones (copies) an Object using deep copying.\n *\n * This function supports circular references by default, but if you are certain\n * there are no circular references in your object, you can save some CPU time\n * by calling clone(obj, false).\n *\n * Caution: if `circular` is false and `parent` contains circular references,\n * your program may enter an infinite loop and crash.\n *\n * @param `parent` - the object to be cloned\n * @param `circular` - set to true if the object to be cloned may contain\n *    circular references. (optional - true by default)\n * @param `depth` - set to a number if the object is only to be cloned to\n *    a particular depth. (optional - defaults to Infinity)\n * @param `prototype` - sets the prototype to be used when cloning an object.\n *    (optional - defaults to parent prototype).\n * @param `includeNonEnumerable` - set to true if the non-enumerable properties\n *    should be cloned as well. Non-enumerable properties on the prototype\n *    chain will be ignored. (optional - false by default)\n*/\nfunction clone(parent, circular, depth, prototype, includeNonEnumerable) {\n  if (typeof circular === 'object') {\n    depth = circular.depth;\n    prototype = circular.prototype;\n    includeNonEnumerable = circular.includeNonEnumerable;\n    circular = circular.circular;\n  }\n  // maintain two arrays for circular references, where corresponding parents\n  // and children have the same index\n  var allParents = [];\n  var allChildren = [];\n\n  var useBuffer = typeof Buffer != 'undefined';\n\n  if (typeof circular == 'undefined')\n    circular = true;\n\n  if (typeof depth == 'undefined')\n    depth = Infinity;\n\n  // recurse this function so we don't reset allParents and allChildren\n  function _clone(parent, depth) {\n    // cloning null always returns null\n    if (parent === null)\n      return null;\n\n    if (depth === 0)\n      return parent;\n\n    var child;\n    var proto;\n    if (typeof parent != 'object') {\n      return parent;\n    }\n\n    if (_instanceof(parent, nativeMap)) {\n      child = new nativeMap();\n    } else if (_instanceof(parent, nativeSet)) {\n      child = new nativeSet();\n    } else if (_instanceof(parent, nativePromise)) {\n      child = new nativePromise(function (resolve, reject) {\n        parent.then(function(value) {\n          resolve(_clone(value, depth - 1));\n        }, function(err) {\n          reject(_clone(err, depth - 1));\n        });\n      });\n    } else if (clone.__isArray(parent)) {\n      child = [];\n    } else if (clone.__isRegExp(parent)) {\n      child = new RegExp(parent.source, __getRegExpFlags(parent));\n      if (parent.lastIndex) child.lastIndex = parent.lastIndex;\n    } else if (clone.__isDate(parent)) {\n      child = new Date(parent.getTime());\n    } else if (useBuffer && Buffer.isBuffer(parent)) {\n      if (Buffer.allocUnsafe) {\n        // Node.js >= 4.5.0\n        child = Buffer.allocUnsafe(parent.length);\n      } else {\n        // Older Node.js versions\n        child = new Buffer(parent.length);\n      }\n      parent.copy(child);\n      return child;\n    } else if (_instanceof(parent, Error)) {\n      child = Object.create(parent);\n    } else {\n      if (typeof prototype == 'undefined') {\n        proto = Object.getPrototypeOf(parent);\n        child = Object.create(proto);\n      }\n      else {\n        child = Object.create(prototype);\n        proto = prototype;\n      }\n    }\n\n    if (circular) {\n      var index = allParents.indexOf(parent);\n\n      if (index != -1) {\n        return allChildren[index];\n      }\n      allParents.push(parent);\n      allChildren.push(child);\n    }\n\n    if (_instanceof(parent, nativeMap)) {\n      parent.forEach(function(value, key) {\n        var keyChild = _clone(key, depth - 1);\n        var valueChild = _clone(value, depth - 1);\n        child.set(keyChild, valueChild);\n      });\n    }\n    if (_instanceof(parent, nativeSet)) {\n      parent.forEach(function(value) {\n        var entryChild = _clone(value, depth - 1);\n        child.add(entryChild);\n      });\n    }\n\n    for (var i in parent) {\n      var attrs;\n      if (proto) {\n        attrs = Object.getOwnPropertyDescriptor(proto, i);\n      }\n\n      if (attrs && attrs.set == null) {\n        continue;\n      }\n      child[i] = _clone(parent[i], depth - 1);\n    }\n\n    if (Object.getOwnPropertySymbols) {\n      var symbols = Object.getOwnPropertySymbols(parent);\n      for (var i = 0; i < symbols.length; i++) {\n        // Don't need to worry about cloning a symbol because it is a primitive,\n        // like a number or string.\n        var symbol = symbols[i];\n        var descriptor = Object.getOwnPropertyDescriptor(parent, symbol);\n        if (descriptor && !descriptor.enumerable && !includeNonEnumerable) {\n          continue;\n        }\n        child[symbol] = _clone(parent[symbol], depth - 1);\n        if (!descriptor.enumerable) {\n          Object.defineProperty(child, symbol, {\n            enumerable: false\n          });\n        }\n      }\n    }\n\n    if (includeNonEnumerable) {\n      var allPropertyNames = Object.getOwnPropertyNames(parent);\n      for (var i = 0; i < allPropertyNames.length; i++) {\n        var propertyName = allPropertyNames[i];\n        var descriptor = Object.getOwnPropertyDescriptor(parent, propertyName);\n        if (descriptor && descriptor.enumerable) {\n          continue;\n        }\n        child[propertyName] = _clone(parent[propertyName], depth - 1);\n        Object.defineProperty(child, propertyName, {\n          enumerable: false\n        });\n      }\n    }\n\n    return child;\n  }\n\n  return _clone(parent, depth);\n}\n\n/**\n * Simple flat clone using prototype, accepts only objects, usefull for property\n * override on FLAT configuration object (no nested props).\n *\n * USE WITH CAUTION! This may not behave as you wish if you do not know how this\n * works.\n */\nclone.clonePrototype = function clonePrototype(parent) {\n  if (parent === null)\n    return null;\n\n  var c = function () {};\n  c.prototype = parent;\n  return new c();\n};\n\n// private utility functions\n\nfunction __objToStr(o) {\n  return Object.prototype.toString.call(o);\n}\nclone.__objToStr = __objToStr;\n\nfunction __isDate(o) {\n  return typeof o === 'object' && __objToStr(o) === '[object Date]';\n}\nclone.__isDate = __isDate;\n\nfunction __isArray(o) {\n  return typeof o === 'object' && __objToStr(o) === '[object Array]';\n}\nclone.__isArray = __isArray;\n\nfunction __isRegExp(o) {\n  return typeof o === 'object' && __objToStr(o) === '[object RegExp]';\n}\nclone.__isRegExp = __isRegExp;\n\nfunction __getRegExpFlags(re) {\n  var flags = '';\n  if (re.global) flags += 'g';\n  if (re.ignoreCase) flags += 'i';\n  if (re.multiline) flags += 'm';\n  return flags;\n}\nclone.__getRegExpFlags = __getRegExpFlags;\n\nreturn clone;\n})();\n\nif (typeof module === 'object' && module.exports) {\n  module.exports = clone;\n}\n","module.exports = false;\n\n","// https://github.com/electron/electron/issues/2288\nfunction isElectron() {\n    // Renderer process\n    if (typeof window !== 'undefined' && typeof window.process === 'object' && window.process.type === 'renderer') {\n        return true;\n    }\n\n    // Main process\n    if (typeof process !== 'undefined' && typeof process.versions === 'object' && !!process.versions.electron) {\n        return true;\n    }\n\n    // Detect the user agent when the `nodeIntegration` option is set to true\n    if (typeof navigator === 'object' && typeof navigator.userAgent === 'string' && navigator.userAgent.indexOf('Electron') >= 0) {\n        return true;\n    }\n\n    return false;\n}\n\nmodule.exports = isElectron;\n","'use strict';\n\nmodule.exports = value => {\n\tif (!value) {\n\t\treturn false;\n\t}\n\n\t// eslint-disable-next-line no-use-extend-native/no-use-extend-native\n\tif (typeof Symbol.observable === 'symbol' && typeof value[Symbol.observable] === 'function') {\n\t\t// eslint-disable-next-line no-use-extend-native/no-use-extend-native\n\t\treturn value === value[Symbol.observable]();\n\t}\n\n\tif (typeof value['@@observable'] === 'function') {\n\t\treturn value === value['@@observable']();\n\t}\n\n\treturn false;\n};\n","(function(root, factory) {\n  if (typeof define === \"function\" && define.amd) {\n    // AMD\n    define([], factory);\n  } else if (typeof exports === \"object\") {\n    // CommonJS\n    module.exports = factory();\n  } else {\n    // Browser globals\n    root.IncrementalIndexedDBAdapter = factory();\n  }\n})(this, function() {\n  return (function() {\n    \"use strict\";\n\n    /* jshint -W030 */\n    var DEBUG = typeof window !== 'undefined' && !!window.__loki_incremental_idb_debug;\n\n    /**\n     * An improved Loki persistence adapter for IndexedDB (not compatible with LokiIndexedAdapter)\n     *     Unlike LokiIndexedAdapter, the database is saved not as one big JSON blob, but split into\n     *     small chunks with individual collection documents. When saving, only the chunks with changed\n     *     documents (and database metadata) is saved to IndexedDB. This speeds up small incremental\n     *     saves by an order of magnitude on large (tens of thousands of records) databases. It also\n     *     avoids Safari 13 bug that would cause the database to balloon in size to gigabytes\n     *\n     *     The `appname` argument is not provided - to distinguish between multiple app on the same\n     *     domain, simply use a different Loki database name\n     *\n     * @example\n     * var adapter = new IncrementalIndexedDBAdapter();\n     *\n     * @constructor IncrementalIndexedDBAdapter\n     *\n     * @param {object=} options Configuration options for the adapter\n     * @param {function} options.onversionchange Function to call on `IDBDatabase.onversionchange` event\n     *     (most likely database deleted from another browser tab)\n     * @param {function} options.onFetchStart Function to call once IDB load has begun.\n     *     Use this as an opportunity to execute code concurrently while IDB does work on a separate thread\n     * @param {function} options.onDidOverwrite Called when this adapter is forced to overwrite contents\n     *     of IndexedDB. This happens if there's another open tab of the same app that's making changes.\n     *     You might use it as an opportunity to alert user to the potential loss of data\n     * @param {function} options.serializeChunk Called with a chunk (array of Loki documents) before\n     *     it's saved to IndexedDB. You can use it to manually compress on-disk representation\n     *     for faster database loads. Hint: Hand-written conversion of objects to arrays is very\n     *     profitable for performance. If you use this, you must also pass options.deserializeChunk.\n     * @param {function} options.deserializeChunk Called with a chunk serialized with options.serializeChunk\n     *     Expects an array of Loki documents as the return value\n     * @param {number} options.megachunkCount Number of parallel requests for data when loading database.\n     *     Can be tuned for a specific application\n     */\n    function IncrementalIndexedDBAdapter(options) {\n      this.mode = \"incremental\";\n      this.options = options || {};\n      this.chunkSize = 100;\n      this.megachunkCount = this.options.megachunkCount || 20;\n      this.idb = null; // will be lazily loaded on first operation that needs it\n      this._prevLokiVersionId = null;\n      this._prevCollectionVersionIds = {};\n\n      if (!(this.megachunkCount >= 4 && this.megachunkCount % 2 === 0)) {\n        throw new Error('megachunkCount must be >=4 and divisible by 2');\n      }\n    }\n\n    // chunkId - index of the data chunk - e.g. chunk 0 will be lokiIds 0-99\n    IncrementalIndexedDBAdapter.prototype._getChunk = function(collection, chunkId) {\n      // 0-99, 100-199, etc.\n      var minId = chunkId * this.chunkSize;\n      var maxId = minId + this.chunkSize - 1;\n\n      // use idIndex to find first collection.data position within the $loki range\n      collection.ensureId();\n      var idIndex = collection.idIndex;\n\n      var firstDataPosition = null;\n\n      var max = idIndex.length - 1,\n        min = 0,\n        mid;\n\n      while (idIndex[min] < idIndex[max]) {\n        mid = (min + max) >> 1;\n\n        if (idIndex[mid] < minId) {\n          min = mid + 1;\n        } else {\n          max = mid;\n        }\n      }\n\n      if (max === min && idIndex[min] >= minId && idIndex[min] <= maxId) {\n        firstDataPosition = min;\n      }\n\n      if (firstDataPosition === null) {\n        // no elements in this chunk\n        return [];\n      }\n\n      // find last position\n      // if loki IDs are contiguous (no removed elements), last position will be first + chunk - 1\n      // (and we look back in case there are missing pieces)\n      // TODO: Binary search (not as important as first position, worst case scanario is only chunkSize steps)\n      var lastDataPosition = null;\n      for (var i = firstDataPosition + this.chunkSize - 1; i >= firstDataPosition; i--) {\n        if (idIndex[i] <= maxId) {\n          lastDataPosition = i;\n          break;\n        }\n      }\n\n      // verify\n      var firstElement = collection.data[firstDataPosition];\n      if (!(firstElement && firstElement.$loki >= minId && firstElement.$loki <= maxId)) {\n        throw new Error(\"broken invariant firstelement\");\n      }\n\n      var lastElement = collection.data[lastDataPosition];\n      if (!(lastElement && lastElement.$loki >= minId && lastElement.$loki <= maxId)) {\n        throw new Error(\"broken invariant lastElement\");\n      }\n\n      // this will have *up to* 'this.chunkSize' elements (might have less, because $loki ids\n      // will have holes when data is deleted)\n      var chunkData = collection.data.slice(firstDataPosition, lastDataPosition + 1);\n\n      if (chunkData.length > this.chunkSize) {\n        throw new Error(\"broken invariant - chunk size\");\n      }\n\n      return chunkData;\n    };\n\n    /**\n     * Incrementally saves the database to IndexedDB\n     *\n     * @example\n     * var idbAdapter = new IncrementalIndexedDBAdapter();\n     * var db = new loki('test', { adapter: idbAdapter });\n     * var coll = db.addCollection('testColl');\n     * coll.insert({test: 'val'});\n     * db.saveDatabase();\n     *\n     * @param {string} dbname - the name to give the serialized database\n     * @param {function} getLokiCopy - returns copy of the Loki database\n     * @param {function} callback - (Optional) callback passed obj.success with true or false\n     * @memberof IncrementalIndexedDBAdapter\n     */\n    IncrementalIndexedDBAdapter.prototype.saveDatabase = function(dbname, getLokiCopy, callback) {\n      var that = this;\n\n      if (!this.idb) {\n        this._initializeIDB(dbname, callback, function() {\n          that.saveDatabase(dbname, getLokiCopy, callback);\n        });\n        return;\n      }\n\n      if (this.operationInProgress) {\n        throw new Error(\"Error while saving to database - another operation is already in progress. Please use throttledSaves=true option on Loki object\");\n      }\n      this.operationInProgress = true;\n\n      DEBUG && console.log(\"saveDatabase - begin\");\n      DEBUG && console.time(\"saveDatabase\");\n      function finish(e) {\n        DEBUG && e && console.error(e);\n        DEBUG && console.timeEnd(\"saveDatabase\");\n        that.operationInProgress = false;\n        callback(e);\n      }\n\n      // try..catch is required, e.g.:\n      // InvalidStateError: Failed to execute 'transaction' on 'IDBDatabase': The database connection is closing.\n      // (this may happen if another tab has called deleteDatabase)\n      try {\n        var updatePrevVersionIds = function () {\n          console.error('Unexpected successful tx - cannot update previous version ids');\n        };\n        var didOverwrite = false;\n\n        var tx = this.idb.transaction(['LokiIncrementalData'], \"readwrite\");\n        tx.oncomplete = function() {\n          updatePrevVersionIds();\n          finish();\n          if (didOverwrite && that.options.onDidOverwrite) {\n            that.options.onDidOverwrite();\n          }\n        };\n\n        tx.onerror = function(e) {\n          finish(e);\n        };\n\n        tx.onabort = function(e) {\n          finish(e);\n        };\n\n        var store = tx.objectStore('LokiIncrementalData');\n\n        var performSave = function (maxChunkIds) {\n          try {\n            var incremental = !maxChunkIds;\n            var chunkInfo = that._putInChunks(store, getLokiCopy(), incremental, maxChunkIds);\n            // Update last seen version IDs, but only after the transaction is successful\n            updatePrevVersionIds = function() {\n              that._prevLokiVersionId = chunkInfo.lokiVersionId;\n              chunkInfo.collectionVersionIds.forEach(function (collectionInfo) {\n                that._prevCollectionVersionIds[collectionInfo.name] = collectionInfo.versionId;\n              });\n            };\n            tx.commit && tx.commit();\n          } catch (error) {\n            console.error('idb performSave failed: ', error);\n            tx.abort();\n          }\n        };\n\n        // Incrementally saving changed chunks breaks down if there is more than one writer to IDB\n        // (multiple tabs of the same web app), leading to data corruption. To fix that, we save all\n        // metadata chunks (loki + collections) with a unique ID on each save and remember it. Before\n        // the subsequent save, we read loki from IDB to check if its version ID changed. If not, we're\n        // guaranteed that persisted DB is consistent with our diff. Otherwise, we fall back to the slow\n        // path and overwrite *all* database chunks with our version. Both reading and writing must\n        // happen in the same IDB transaction for this to work.\n        // TODO: We can optimize the slow path by fetching collection metadata chunks and comparing their\n        // version IDs with those last seen by us. Since any change in collection data requires a metadata\n        // chunk save, we're guaranteed that if the IDs match, we don't need to overwrite chukns of this collection\n        var getAllKeysThenSave = function() {\n          // NOTE: We must fetch all keys to protect against a case where another tab has wrote more\n          // chunks whan we did -- if so, we must delete them.\n          idbReq(store.getAllKeys(), function(e) {\n            var maxChunkIds = getMaxChunkIds(e.target.result);\n            performSave(maxChunkIds);\n          }, function(e) {\n            console.error('Getting all keys failed: ', e);\n            tx.abort();\n          });\n        };\n\n        var getLokiThenSave = function() {\n          idbReq(store.get('loki'), function(e) {\n            if (lokiChunkVersionId(e.target.result) === that._prevLokiVersionId) {\n              performSave();\n            } else {\n              DEBUG && console.warn('Another writer changed Loki IDB, using slow path...');\n              didOverwrite = true;\n              getAllKeysThenSave();\n            }\n          }, function(e) {\n            console.error('Getting loki chunk failed: ', e);\n            tx.abort();\n          });\n        };\n\n        getLokiThenSave();\n      } catch (error) {\n        finish(error);\n      }\n    };\n\n    // gets current largest chunk ID for each collection\n    function getMaxChunkIds(allKeys) {\n      var maxChunkIds = {};\n\n      allKeys.forEach(function (key) {\n        var keySegments = key.split(\".\");\n        // table.chunk.2317\n        if (keySegments.length === 3 && keySegments[1] === \"chunk\") {\n          var collection = keySegments[0];\n          var chunkId = parseInt(keySegments[2]) || 0;\n          var currentMax = maxChunkIds[collection];\n\n          if (!currentMax || chunkId > currentMax) {\n            maxChunkIds[collection] = chunkId;\n          }\n        }\n      });\n      return maxChunkIds;\n    }\n\n    function lokiChunkVersionId(chunk) {\n      try {\n        if (chunk) {\n          var loki = JSON.parse(chunk.value);\n          return loki.idbVersionId || null;\n        } else {\n          return null;\n        }\n      } catch (e) {\n        console.error('Error while parsing loki chunk', e);\n        return null;\n      }\n    }\n\n    IncrementalIndexedDBAdapter.prototype._putInChunks = function(idbStore, loki, incremental, maxChunkIds) {\n      var that = this;\n      var collectionVersionIds = [];\n      var savedSize = 0;\n\n      var prepareCollection = function (collection, i) {\n        // Find dirty chunk ids\n        var dirtyChunks = new Set();\n        incremental && collection.dirtyIds.forEach(function(lokiId) {\n          var chunkId = (lokiId / that.chunkSize) | 0;\n          dirtyChunks.add(chunkId);\n        });\n        collection.dirtyIds = [];\n\n        // Serialize chunks to save\n        var prepareChunk = function (chunkId) {\n          var chunkData = that._getChunk(collection, chunkId);\n          if (that.options.serializeChunk) {\n            chunkData = that.options.serializeChunk(collection.name, chunkData);\n          }\n          // we must stringify now, because IDB is asynchronous, and underlying objects are mutable\n          // In general, it's also faster to stringify, because we need serialization anyway, and\n          // JSON.stringify is much better optimized than IDB's structured clone\n          chunkData = JSON.stringify(chunkData);\n          savedSize += chunkData.length;\n          DEBUG && incremental && console.log('Saving: ' + collection.name + \".chunk.\" + chunkId);\n          idbStore.put({\n            key: collection.name + \".chunk.\" + chunkId,\n            value: chunkData,\n          });\n        };\n        if (incremental) {\n          dirtyChunks.forEach(prepareChunk);\n        } else {\n          // add all chunks\n          var maxChunkId = (collection.maxId / that.chunkSize) | 0;\n          for (var j = 0; j <= maxChunkId; j += 1) {\n            prepareChunk(j);\n          }\n\n          // delete chunks with larger ids than what we have\n          // NOTE: we don't have to delete metadata chunks as they will be absent from loki anyway\n          // NOTE: failures are silently ignored, so we don't have to worry about holes\n          var persistedMaxChunkId = maxChunkIds[collection.name] || 0;\n          for (var k = maxChunkId + 1; k <= persistedMaxChunkId; k += 1) {\n            var deletedChunkName = collection.name + \".chunk.\" + k;\n            idbStore.delete(deletedChunkName);\n            DEBUG && console.warn('Deleted chunk: ' + deletedChunkName);\n          }\n        }\n\n        // save collection metadata as separate chunk (but only if changed)\n        if (collection.dirty || dirtyChunks.size || !incremental) {\n          collection.idIndex = []; // this is recreated lazily\n          collection.data = [];\n          collection.idbVersionId = randomVersionId();\n          collectionVersionIds.push({ name: collection.name, versionId: collection.idbVersionId });\n\n          var metadataChunk = JSON.stringify(collection);\n          savedSize += metadataChunk.length;\n          DEBUG && incremental && console.log('Saving: ' + collection.name + \".metadata\");\n          idbStore.put({\n            key: collection.name + \".metadata\",\n            value: metadataChunk,\n          });\n        }\n\n        // leave only names in the loki chunk\n        loki.collections[i] = { name: collection.name };\n      };\n      loki.collections.forEach(prepareCollection);\n\n      loki.idbVersionId = randomVersionId();\n      var serializedMetadata = JSON.stringify(loki);\n      savedSize += serializedMetadata.length;\n\n      DEBUG && incremental && console.log('Saving: loki');\n      idbStore.put({ key: \"loki\", value: serializedMetadata });\n\n      DEBUG && console.log(\"saved size: \" + savedSize);\n      return {\n        lokiVersionId: loki.idbVersionId,\n        collectionVersionIds: collectionVersionIds,\n      };\n    };\n\n    /**\n     * Retrieves a serialized db string from the catalog.\n     *\n     * @example\n     * // LOAD\n     * var idbAdapter = new IncrementalIndexedDBAdapter();\n     * var db = new loki('test', { adapter: idbAdapter });\n     * db.loadDatabase(function(result) {\n     *   console.log('done');\n     * });\n     *\n     * @param {string} dbname - the name of the database to retrieve.\n     * @param {function} callback - callback should accept string param containing serialized db string.\n     * @memberof IncrementalIndexedDBAdapter\n     */\n    IncrementalIndexedDBAdapter.prototype.loadDatabase = function(dbname, callback) {\n      var that = this;\n\n      if (this.operationInProgress) {\n        throw new Error(\"Error while loading database - another operation is already in progress. Please use throttledSaves=true option on Loki object\");\n      }\n\n      this.operationInProgress = true;\n\n      DEBUG && console.log(\"loadDatabase - begin\");\n      DEBUG && console.time(\"loadDatabase\");\n\n      var finish = function (value) {\n        DEBUG && console.timeEnd(\"loadDatabase\");\n        that.operationInProgress = false;\n        callback(value);\n      };\n\n      this._getAllChunks(dbname, function(chunks) {\n        try {\n          if (!Array.isArray(chunks)) {\n            throw chunks; // we have an error\n          }\n\n          if (!chunks.length) {\n            return finish(null);\n          }\n\n          DEBUG && console.log(\"Found chunks:\", chunks.length);\n\n          // repack chunks into a map\n          chunks = chunksToMap(chunks);\n          var loki = chunks.loki;\n          chunks.loki = null; // gc\n\n          // populate collections with data\n          populateLoki(loki, chunks.chunkMap);\n          chunks = null; // gc\n\n          // remember previous version IDs\n          that._prevLokiVersionId = loki.idbVersionId || null;\n          that._prevCollectionVersionIds = {};\n          loki.collections.forEach(function (collection) {\n            that._prevCollectionVersionIds[collection.name] = collection.idbVersionId || null;\n          });\n\n          return finish(loki);\n        } catch (error) {\n          that._prevLokiVersionId = null;\n          that._prevCollectionVersionIds = {};\n          return finish(error);\n        }\n      });\n    };\n\n    function chunksToMap(chunks) {\n      var loki;\n      var chunkMap = {};\n\n      sortChunksInPlace(chunks);\n\n      chunks.forEach(function(object) {\n        var key = object.key;\n        var value = object.value;\n        if (key === \"loki\") {\n          loki = value;\n          return;\n        } else if (key.includes(\".\")) {\n          var keySegments = key.split(\".\");\n          if (keySegments.length === 3 && keySegments[1] === \"chunk\") {\n            var colName = keySegments[0];\n            if (chunkMap[colName]) {\n              chunkMap[colName].dataChunks.push(value);\n            } else {\n              chunkMap[colName] = {\n                metadata: null,\n                dataChunks: [value],\n              };\n            }\n            return;\n          } else if (keySegments.length === 2 && keySegments[1] === \"metadata\") {\n            var name = keySegments[0];\n            if (chunkMap[name]) {\n              chunkMap[name].metadata = value;\n            } else {\n              chunkMap[name] = { metadata: value, dataChunks: [] };\n            }\n            return;\n          }\n        }\n\n        console.error(\"Unknown chunk \" + key);\n        throw new Error(\"Corrupted database - unknown chunk found\");\n      });\n\n      if (!loki) {\n        throw new Error(\"Corrupted database - missing database metadata\");\n      }\n\n      return { loki: loki, chunkMap: chunkMap };\n    }\n\n    function populateLoki(loki, chunkMap) {\n      loki.collections.forEach(function populateCollection(collectionStub, i) {\n        var chunkCollection = chunkMap[collectionStub.name];\n        if (chunkCollection) {\n          if (!chunkCollection.metadata) {\n            throw new Error(\"Corrupted database - missing metadata chunk for \" + collectionStub.name);\n          }\n          var collection = chunkCollection.metadata;\n          chunkCollection.metadata = null;\n\n          loki.collections[i] = collection;\n\n          var dataChunks = chunkCollection.dataChunks;\n          dataChunks.forEach(function populateChunk(chunk, i) {\n            chunk.forEach(function(doc) {\n              collection.data.push(doc);\n            });\n            dataChunks[i] = null;\n          });\n        }\n      });\n    }\n\n    IncrementalIndexedDBAdapter.prototype._initializeIDB = function(dbname, onError, onSuccess) {\n      var that = this;\n      DEBUG && console.log(\"initializing idb\");\n\n      if (this.idbInitInProgress) {\n        throw new Error(\"Cannot open IndexedDB because open is already in progress\");\n      }\n      this.idbInitInProgress = true;\n\n      var openRequest = indexedDB.open(dbname, 1);\n\n      openRequest.onupgradeneeded = function(e) {\n        var db = e.target.result;\n        DEBUG && console.log('onupgradeneeded, old version: ' + e.oldVersion);\n\n        if (e.oldVersion < 1) {\n          // Version 1 - Initial - Create database\n          db.createObjectStore('LokiIncrementalData', { keyPath: \"key\" });\n        } else {\n          // Unknown version\n          throw new Error(\"Invalid old version \" + e.oldVersion + \" for IndexedDB upgrade\");\n        }\n      };\n\n      openRequest.onsuccess = function(e) {\n        that.idbInitInProgress = false;\n        var db = e.target.result;\n        that.idb = db;\n\n        if (!db.objectStoreNames.contains('LokiIncrementalData')) {\n          onError(new Error(\"Missing LokiIncrementalData\"));\n          // Attempt to recover (after reload) by deleting database, since it's damaged anyway\n          that.deleteDatabase(dbname);\n          return;\n        }\n\n        DEBUG && console.log(\"init success\");\n\n        db.onversionchange = function(versionChangeEvent) {\n          // Ignore if database was deleted and recreated in the meantime\n          if (that.idb !== db) {\n            return;\n          }\n\n          DEBUG && console.log('IDB version change', versionChangeEvent);\n          // This function will be called if another connection changed DB version\n          // (Most likely database was deleted from another browser tab, unless there's a new version\n          // of this adapter, or someone makes a connection to IDB outside of this adapter)\n          // We must close the database to avoid blocking concurrent deletes.\n          // The database will be unusable after this. Be sure to supply `onversionchange` option\n          // to force logout\n          that.idb.close();\n          that.idb = null;\n          if (that.options.onversionchange) {\n            that.options.onversionchange(versionChangeEvent);\n          }\n        };\n\n        onSuccess();\n      };\n\n      openRequest.onblocked = function(e) {\n        console.error(\"IndexedDB open is blocked\", e);\n        onError(new Error(\"IndexedDB open is blocked by open connection\"));\n      };\n\n      openRequest.onerror = function(e) {\n        that.idbInitInProgress = false;\n        console.error(\"IndexedDB open error\", e);\n        onError(e);\n      };\n    };\n\n    IncrementalIndexedDBAdapter.prototype._getAllChunks = function(dbname, callback) {\n      var that = this;\n      if (!this.idb) {\n        this._initializeIDB(dbname, callback, function() {\n          that._getAllChunks(dbname, callback);\n        });\n        return;\n      }\n\n      var tx = this.idb.transaction(['LokiIncrementalData'], \"readonly\");\n      var store = tx.objectStore('LokiIncrementalData');\n\n      var deserializeChunk = this.options.deserializeChunk;\n\n      // If there are a lot of chunks (>100), don't request them all in one go, but in multiple\n      // \"megachunks\" (chunks of chunks). This improves concurrency, as main thread is already busy\n      // while IDB process is still fetching data. Details: https://github.com/techfort/LokiJS/pull/874\n      function getMegachunks(keys) {\n        var megachunkCount = that.megachunkCount;\n        var keyRanges = createKeyRanges(keys, megachunkCount);\n\n        var allChunks = [];\n        var megachunksReceived = 0;\n\n        function processMegachunk(e, megachunkIndex, keyRange) {\n          // var debugMsg = 'processing chunk ' + megachunkIndex + ' (' + keyRange.lower + ' -- ' + keyRange.upper + ')'\n          // DEBUG && console.time(debugMsg);\n          var megachunk = e.target.result;\n          megachunk.forEach(function (chunk, i) {\n            parseChunk(chunk, deserializeChunk);\n            allChunks.push(chunk);\n            megachunk[i] = null; // gc\n          });\n          // DEBUG && console.timeEnd(debugMsg);\n\n          megachunksReceived += 1;\n          if (megachunksReceived === megachunkCount) {\n            callback(allChunks);\n          }\n        }\n\n        // Stagger megachunk requests - first one half, then request the second when first one comes\n        // back. This further improves concurrency.\n        function requestMegachunk(index) {\n          var keyRange = keyRanges[index];\n          idbReq(store.getAll(keyRange), function(e) {\n            if (index < megachunkCount / 2) {\n              requestMegachunk(index + megachunkCount / 2);\n            }\n\n            processMegachunk(e, index, keyRange);\n          }, function(e) {\n            callback(e);\n          });\n        }\n\n        for (var i = 0; i < megachunkCount / 2; i += 1) {\n          requestMegachunk(i);\n        }\n      }\n\n      function getAllChunks() {\n        idbReq(store.getAll(), function(e) {\n          var allChunks = e.target.result;\n          allChunks.forEach(function (chunk) {\n            parseChunk(chunk, deserializeChunk);\n          });\n          callback(allChunks);\n        }, function(e) {\n          callback(e);\n        });\n      }\n\n      function getAllKeys() {\n        idbReq(store.getAllKeys(), function(e) {\n          var keys = e.target.result.sort();\n          if (keys.length > 100) {\n            getMegachunks(keys);\n          } else {\n            getAllChunks();\n          }\n        }, function(e) {\n          callback(e);\n        });\n\n        if (that.options.onFetchStart) {\n          that.options.onFetchStart();\n        }\n      }\n\n      getAllKeys();\n    };\n\n    function parseChunk(chunk, deserializeChunk) {\n      chunk.value = JSON.parse(chunk.value);\n      if (deserializeChunk) {\n        var segments = chunk.key.split('.');\n        if (segments.length === 3 && segments[1] === 'chunk') {\n          var collectionName = segments[0];\n          chunk.value = deserializeChunk(collectionName, chunk.value);\n        }\n      }\n    }\n\n    /**\n     * Deletes a database from IndexedDB\n     *\n     * @example\n     * // DELETE DATABASE\n     * // delete 'finance'/'test' value from catalog\n     * idbAdapter.deleteDatabase('test', function {\n     *   // database deleted\n     * });\n     *\n     * @param {string} dbname - the name of the database to delete from IDB\n     * @param {function=} callback - (Optional) executed on database delete\n     * @memberof IncrementalIndexedDBAdapter\n     */\n    IncrementalIndexedDBAdapter.prototype.deleteDatabase = function(dbname, callback) {\n      if (this.operationInProgress) {\n        throw new Error(\"Error while deleting database - another operation is already in progress. Please use throttledSaves=true option on Loki object\");\n      }\n\n      this.operationInProgress = true;\n\n      var that = this;\n      DEBUG && console.log(\"deleteDatabase - begin\");\n      DEBUG && console.time(\"deleteDatabase\");\n\n      this._prevLokiVersionId = null;\n      this._prevCollectionVersionIds = {};\n\n      if (this.idb) {\n        this.idb.close();\n        this.idb = null;\n      }\n\n      var request = indexedDB.deleteDatabase(dbname);\n\n      request.onsuccess = function() {\n        that.operationInProgress = false;\n        DEBUG && console.timeEnd(\"deleteDatabase\");\n        callback({ success: true });\n      };\n\n      request.onerror = function(e) {\n        that.operationInProgress = false;\n        console.error(\"Error while deleting database\", e);\n        callback({ success: false });\n      };\n\n      request.onblocked = function(e) {\n        // We can't call callback with failure status, because this will be called even if we\n        // succeed in just a moment\n        console.error(\"Deleting database failed because it's blocked by another connection\", e);\n      };\n    };\n\n    function randomVersionId() {\n      // Appears to have enough entropy for chunk version IDs\n      // (Only has to be different than enough of its own previous versions that there's no writer\n      // that thinks a new version is the same as an earlier one, not globally unique)\n      return Math.random().toString(36).substring(2);\n    }\n\n    function _getSortKey(object) {\n      var key = object.key;\n      if (key.includes(\".\")) {\n        var segments = key.split(\".\");\n        if (segments.length === 3 && segments[1] === \"chunk\") {\n          return parseInt(segments[2], 10);\n        }\n      }\n\n      return -1; // consistent type must be returned\n    }\n\n    function sortChunksInPlace(chunks) {\n      // sort chunks in place to load data in the right order (ascending loki ids)\n      // on both Safari and Chrome, we'll get chunks in order like this: 0, 1, 10, 100...\n      chunks.sort(function(a, b) {\n        var aKey = _getSortKey(a),\n          bKey = _getSortKey(b);\n        if (aKey < bKey) return -1;\n        if (aKey > bKey) return 1;\n        return 0;\n      });\n    }\n\n    function createKeyRanges(keys, count) {\n      var countPerRange = Math.floor(keys.length / count);\n      var keyRanges = [];\n      var minKey, maxKey;\n      for (var i = 0; i < count; i += 1) {\n        minKey = keys[countPerRange * i];\n        maxKey = keys[countPerRange * (i + 1)];\n        if (i === 0) {\n          // ... < maxKey\n          keyRanges.push(IDBKeyRange.upperBound(maxKey, true));\n        } else if (i === count - 1) {\n          // >= minKey\n          keyRanges.push(IDBKeyRange.lowerBound(minKey));\n        } else {\n          // >= minKey && < maxKey\n          keyRanges.push(IDBKeyRange.bound(minKey, maxKey, false, true));\n        }\n      }\n      return keyRanges;\n    }\n\n    function idbReq(request, onsuccess, onerror) {\n      request.onsuccess = function (e) {\n        try {\n          return onsuccess(e);\n        } catch (error) {\n          onerror(error);\n        }\n      };\n      request.onerror = onerror;\n      return request;\n    }\n\n    return IncrementalIndexedDBAdapter;\n  })();\n});\n","/*\n  Loki IndexedDb Adapter (need to include this script to use it)\n\n  Console Usage can be used for management/diagnostic, here are a few examples :\n  adapter.getDatabaseList(); // with no callback passed, this method will log results to console\n  adapter.saveDatabase('UserDatabase', JSON.stringify(myDb));\n  adapter.loadDatabase('UserDatabase'); // will log the serialized db to console\n  adapter.deleteDatabase('UserDatabase');\n*/\n\n(function (root, factory) {\n    if (typeof define === 'function' && define.amd) {\n        // AMD\n        define([], factory);\n    } else if (typeof exports === 'object') {\n        // Node, CommonJS-like\n        module.exports = factory();\n    } else {\n        // Browser globals (root is window)\n        root.LokiIndexedAdapter = factory();\n    }\n}(this, function () {\n  return (function() {\n\n    /**\n     * Loki persistence adapter class for indexedDb.\n     *     This class fulfills abstract adapter interface which can be applied to other storage methods.\n     *     Utilizes the included LokiCatalog app/key/value database for actual database persistence.\n     *     Indexeddb is highly async, but this adapter has been made 'console-friendly' as well.\n     *     Anywhere a callback is omitted, it should return results (if applicable) to console.\n     *     IndexedDb storage is provided per-domain, so we implement app/key/value database to\n     *     allow separate contexts for separate apps within a domain.\n     *\n     * @example\n     * var idbAdapter = new LokiIndexedAdapter('finance');\n     *\n     * @constructor LokiIndexedAdapter\n     *\n     * @param {string} appname - (Optional) Application name context can be used to distinguish subdomains, 'loki' by default\n     * @param {object=} options Configuration options for the adapter\n     * @param {boolean} options.closeAfterSave Whether the indexedDB database should be closed after saving.\n     */\n    function LokiIndexedAdapter(appname, options)\n    {\n      this.app = 'loki';\n      this.options = options || {};\n\n      if (typeof (appname) !== 'undefined')\n      {\n        this.app = appname;\n      }\n\n      // keep reference to catalog class for base AKV operations\n      this.catalog = null;\n\n      if (!this.checkAvailability()) {\n        throw new Error('indexedDB does not seem to be supported for your environment');\n      }\n    }\n\n    /**\n     * Used for closing the indexeddb database.\n     */\n    LokiIndexedAdapter.prototype.closeDatabase = function ()\n    {\n      if (this.catalog && this.catalog.db) {\n        this.catalog.db.close();\n        this.catalog.db = null;\n      }\n    };\n\n    /**\n     * Used to check if adapter is available\n     *\n     * @returns {boolean} true if indexeddb is available, false if not.\n     * @memberof LokiIndexedAdapter\n     */\n    LokiIndexedAdapter.prototype.checkAvailability = function()\n    {\n      if (typeof indexedDB !== 'undefined' && indexedDB) return true;\n\n      return false;\n    };\n\n    /**\n     * Retrieves a serialized db string from the catalog.\n     *\n     * @example\n     * // LOAD\n     * var idbAdapter = new LokiIndexedAdapter('finance');\n     * var db = new loki('test', { adapter: idbAdapter });\n     *   db.loadDatabase(function(result) {\n     *   console.log('done');\n     * });\n     *\n     * @param {string} dbname - the name of the database to retrieve.\n     * @param {function} callback - callback should accept string param containing serialized db string.\n     * @memberof LokiIndexedAdapter\n     */\n    LokiIndexedAdapter.prototype.loadDatabase = function(dbname, callback)\n    {\n      var appName = this.app;\n      var adapter = this;\n\n      // lazy open/create db reference so dont -need- callback in constructor\n      if (this.catalog === null || this.catalog.db === null) {\n        this.catalog = new LokiCatalog(function(cat) {\n          adapter.catalog = cat;\n\n          adapter.loadDatabase(dbname, callback);\n        });\n\n        return;\n      }\n\n      // lookup up db string in AKV db\n      this.catalog.getAppKey(appName, dbname, function(result) {\n        if (typeof (callback) === 'function') {\n          if (result.id === 0) {\n            callback(null);\n            return;\n          }\n          callback(result.val);\n        }\n        else {\n          // support console use of api\n          console.log(result.val);\n        }\n      });\n    };\n\n    // alias\n    LokiIndexedAdapter.prototype.loadKey = LokiIndexedAdapter.prototype.loadDatabase;\n\n    /**\n     * Saves a serialized db to the catalog.\n     *\n     * @example\n     * // SAVE : will save App/Key/Val as 'finance'/'test'/{serializedDb}\n     * var idbAdapter = new LokiIndexedAdapter('finance');\n     * var db = new loki('test', { adapter: idbAdapter });\n     * var coll = db.addCollection('testColl');\n     * coll.insert({test: 'val'});\n     * db.saveDatabase();  // could pass callback if needed for async complete\n     *\n     * @param {string} dbname - the name to give the serialized database within the catalog.\n     * @param {string} dbstring - the serialized db string to save.\n     * @param {function} callback - (Optional) callback passed obj.success with true or false\n     * @memberof LokiIndexedAdapter\n     */\n    LokiIndexedAdapter.prototype.saveDatabase = function(dbname, dbstring, callback)\n    {\n      var appName = this.app;\n      var adapter = this;\n\n      function saveCallback(result) {\n        if (result && result.success === true) {\n          callback(null);\n        }\n        else {\n          callback(new Error(\"Error saving database\"));\n        }\n\n        if (adapter.options.closeAfterSave) {\n          adapter.closeDatabase();\n        }\n      }\n\n      // lazy open/create db reference so dont -need- callback in constructor\n      if (this.catalog === null || this.catalog.db === null) {\n        this.catalog = new LokiCatalog(function(cat) {\n          adapter.saveDatabase(dbname, dbstring, saveCallback);\n        });\n\n        return;\n      }\n\n      // set (add/update) entry to AKV database\n      this.catalog.setAppKey(appName, dbname, dbstring, saveCallback);\n    };\n\n    // alias\n    LokiIndexedAdapter.prototype.saveKey = LokiIndexedAdapter.prototype.saveDatabase;\n\n    /**\n     * Deletes a serialized db from the catalog.\n     *\n     * @example\n     * // DELETE DATABASE\n     * // delete 'finance'/'test' value from catalog\n     * idbAdapter.deleteDatabase('test', function {\n     *   // database deleted\n     * });\n     *\n     * @param {string} dbname - the name of the database to delete from the catalog.\n     * @param {function=} callback - (Optional) executed on database delete\n     * @memberof LokiIndexedAdapter\n     */\n    LokiIndexedAdapter.prototype.deleteDatabase = function(dbname, callback)\n    {\n      var appName = this.app;\n      var adapter = this;\n\n      // lazy open/create db reference and pass callback ahead\n      if (this.catalog === null || this.catalog.db === null) {\n        this.catalog = new LokiCatalog(function(cat) {\n          adapter.catalog = cat;\n\n          adapter.deleteDatabase(dbname, callback);\n        });\n\n        return;\n      }\n\n      // catalog was already initialized, so just lookup object and delete by id\n      this.catalog.getAppKey(appName, dbname, function(result) {\n        var id = result.id;\n\n        if (id !== 0) {\n          adapter.catalog.deleteAppKey(id, callback);\n        } else if (typeof (callback) === 'function') {\n          callback({ success: true });\n        }\n      });\n    };\n\n    // alias\n    LokiIndexedAdapter.prototype.deleteKey = LokiIndexedAdapter.prototype.deleteDatabase;\n\n    /**\n     * Removes all database partitions and pages with the base filename passed in.\n     * This utility method does not (yet) guarantee async deletions will be completed before returning\n     *\n     * @param {string} dbname - the base filename which container, partitions, or pages are derived\n     * @memberof LokiIndexedAdapter\n     */\n    LokiIndexedAdapter.prototype.deleteDatabasePartitions = function(dbname) {\n      var self=this;\n      this.getDatabaseList(function(result) {\n        result.forEach(function(str) {\n          if (str.startsWith(dbname)) {\n            self.deleteDatabase(str);\n          }\n        });\n      });\n    };\n\n    /**\n     * Retrieves object array of catalog entries for current app.\n     *\n     * @example\n     * idbAdapter.getDatabaseList(function(result) {\n     *   // result is array of string names for that appcontext ('finance')\n     *   result.forEach(function(str) {\n     *     console.log(str);\n     *   });\n     * });\n     *\n     * @param {function} callback - should accept array of database names in the catalog for current app.\n     * @memberof LokiIndexedAdapter\n     */\n    LokiIndexedAdapter.prototype.getDatabaseList = function(callback)\n    {\n      var appName = this.app;\n      var adapter = this;\n\n      // lazy open/create db reference so dont -need- callback in constructor\n      if (this.catalog === null || this.catalog.db === null) {\n        this.catalog = new LokiCatalog(function(cat) {\n          adapter.catalog = cat;\n\n          adapter.getDatabaseList(callback);\n        });\n\n        return;\n      }\n\n      // catalog already initialized\n      // get all keys for current appName, and transpose results so just string array\n      this.catalog.getAppKeys(appName, function(results) {\n        var names = [];\n\n        for(var idx = 0; idx < results.length; idx++) {\n          names.push(results[idx].key);\n        }\n\n        if (typeof (callback) === 'function') {\n          callback(names);\n        }\n        else {\n          names.forEach(function(obj) {\n            console.log(obj);\n          });\n        }\n      });\n    };\n\n    // alias\n    LokiIndexedAdapter.prototype.getKeyList = LokiIndexedAdapter.prototype.getDatabaseList;\n\n    /**\n     * Allows retrieval of list of all keys in catalog along with size\n     *\n     * @param {function} callback - (Optional) callback to accept result array.\n     * @memberof LokiIndexedAdapter\n     */\n    LokiIndexedAdapter.prototype.getCatalogSummary = function(callback)\n    {\n      var appName = this.app;\n      var adapter = this;\n\n      // lazy open/create db reference\n      if (this.catalog === null || this.catalog.db === null) {\n        this.catalog = new LokiCatalog(function(cat) {\n          adapter.catalog = cat;\n\n          adapter.getCatalogSummary(callback);\n        });\n\n        return;\n      }\n\n      // catalog already initialized\n      // get all keys for current appName, and transpose results so just string array\n      this.catalog.getAllKeys(function(results) {\n        var entries = [];\n        var obj,\n          size,\n          oapp,\n          okey,\n          oval;\n\n        for(var idx = 0; idx < results.length; idx++) {\n          obj = results[idx];\n          oapp = obj.app || '';\n          okey = obj.key || '';\n          oval = obj.val || '';\n\n          // app and key are composited into an appkey column so we will mult by 2\n          size = oapp.length * 2 + okey.length * 2 + oval.length + 1;\n\n          entries.push({ \"app\": obj.app, \"key\": obj.key, \"size\": size });\n        }\n\n        if (typeof (callback) === 'function') {\n          callback(entries);\n        }\n        else {\n          entries.forEach(function(obj) {\n            console.log(obj);\n          });\n        }\n      });\n    };\n\n    /**\n     * LokiCatalog - underlying App/Key/Value catalog persistence\n     *    This non-interface class implements the actual persistence.\n     *    Used by the IndexedAdapter class.\n     */\n    function LokiCatalog(callback)\n    {\n      this.db = null;\n      this.initializeLokiCatalog(callback);\n    }\n\n    LokiCatalog.prototype.initializeLokiCatalog = function(callback) {\n      var openRequest = indexedDB.open('LokiCatalog', 1);\n      var cat = this;\n\n      // If database doesn't exist yet or its version is lower than our version specified above (2nd param in line above)\n      openRequest.onupgradeneeded = function(e) {\n        var thisDB = e.target.result;\n        if (thisDB.objectStoreNames.contains('LokiAKV')) {\n          thisDB.deleteObjectStore('LokiAKV');\n        }\n\n        if(!thisDB.objectStoreNames.contains('LokiAKV')) {\n          var objectStore = thisDB.createObjectStore('LokiAKV', { keyPath: 'id', autoIncrement:true });\n          objectStore.createIndex('app', 'app', {unique:false});\n          objectStore.createIndex('key', 'key', {unique:false});\n          // hack to simulate composite key since overhead is low (main size should be in val field)\n          // user (me) required to duplicate the app and key into comma delimited appkey field off object\n          // This will allow retrieving single record with that composite key as well as\n          // still supporting opening cursors on app or key alone\n          objectStore.createIndex('appkey', 'appkey', {unique:true});\n        }\n      };\n\n      openRequest.onsuccess = function(e) {\n        cat.db = e.target.result;\n\n        if (typeof (callback) === 'function') callback(cat);\n      };\n\n      openRequest.onerror = function(e) {\n        throw e;\n      };\n    };\n\n    LokiCatalog.prototype.getAppKey = function(app, key, callback) {\n      var transaction = this.db.transaction(['LokiAKV'], 'readonly');\n      var store = transaction.objectStore('LokiAKV');\n      var index = store.index('appkey');\n      var appkey = app + \",\" + key;\n      var request = index.get(appkey);\n\n      request.onsuccess = (function(usercallback) {\n        return function(e) {\n          var lres = e.target.result;\n\n          if (lres === null || typeof(lres) === 'undefined') {\n            lres = {\n              id: 0,\n              success: false\n            };\n          }\n\n          if (typeof(usercallback) === 'function') {\n            usercallback(lres);\n          }\n          else {\n            console.log(lres);\n          }\n        };\n      })(callback);\n\n      request.onerror = (function(usercallback) {\n        return function(e) {\n          if (typeof(usercallback) === 'function') {\n            usercallback({ id: 0, success: false });\n          }\n          else {\n            throw e;\n          }\n        };\n      })(callback);\n    };\n\n    LokiCatalog.prototype.getAppKeyById = function (id, callback, data) {\n      var transaction = this.db.transaction(['LokiAKV'], 'readonly');\n      var store = transaction.objectStore('LokiAKV');\n      var request = store.get(id);\n\n      request.onsuccess = (function(data, usercallback){\n        return function(e) {\n          if (typeof(usercallback) === 'function') {\n            usercallback(e.target.result, data);\n          }\n          else {\n            console.log(e.target.result);\n          }\n        };\n      })(data, callback);\n    };\n\n    LokiCatalog.prototype.setAppKey = function (app, key, val, callback) {\n      var transaction = this.db.transaction(['LokiAKV'], 'readwrite');\n      var store = transaction.objectStore('LokiAKV');\n      var index = store.index('appkey');\n      var appkey = app + \",\" + key;\n      var request = index.get(appkey);\n\n      // first try to retrieve an existing object by that key\n      // need to do this because to update an object you need to have id in object, otherwise it will append id with new autocounter and clash the unique index appkey\n      request.onsuccess = function(e) {\n        var res = e.target.result;\n\n        if (res === null || res === undefined) {\n          res = {\n            app:app,\n            key:key,\n            appkey: app + ',' + key,\n            val:val\n          };\n        }\n        else {\n          res.val = val;\n        }\n\n        var requestPut = store.put(res);\n\n        requestPut.onerror = (function(usercallback) {\n          return function(e) {\n            if (typeof(usercallback) === 'function') {\n              usercallback({ success: false });\n            }\n            else {\n              console.error('LokiCatalog.setAppKey (set) onerror');\n              console.error(request.error);\n            }\n          };\n\n        })(callback);\n\n        requestPut.onsuccess = (function(usercallback) {\n          return function(e) {\n            if (typeof(usercallback) === 'function') {\n              usercallback({ success: true });\n            }\n          };\n        })(callback);\n      };\n\n      request.onerror = (function(usercallback) {\n        return function(e) {\n          if (typeof(usercallback) === 'function') {\n            usercallback({ success: false });\n          }\n          else {\n            console.error('LokiCatalog.setAppKey (get) onerror');\n            console.error(request.error);\n          }\n        };\n      })(callback);\n    };\n\n    LokiCatalog.prototype.deleteAppKey = function (id, callback) {\n      var transaction = this.db.transaction(['LokiAKV'], 'readwrite');\n      var store = transaction.objectStore('LokiAKV');\n      var request = store.delete(id);\n\n      request.onsuccess = (function(usercallback) {\n        return function(evt) {\n          if (typeof(usercallback) === 'function') usercallback({ success: true });\n        };\n      })(callback);\n\n      request.onerror = (function(usercallback) {\n        return function(evt) {\n          if (typeof(usercallback) === 'function') {\n            usercallback({ success: false });\n          }\n          else {\n            console.error('LokiCatalog.deleteAppKey raised onerror');\n            console.error(request.error);\n          }\n        };\n      })(callback);\n    };\n\n    LokiCatalog.prototype.getAppKeys = function(app, callback) {\n      var transaction = this.db.transaction(['LokiAKV'], 'readonly');\n      var store = transaction.objectStore('LokiAKV');\n      var index = store.index('app');\n\n      // We want cursor to all values matching our (single) app param\n      var singleKeyRange = IDBKeyRange.only(app);\n\n      // To use one of the key ranges, pass it in as the first argument of openCursor()/openKeyCursor()\n      var cursor = index.openCursor(singleKeyRange);\n\n      // cursor internally, pushing results into this.data[] and return\n      // this.data[] when done (similar to service)\n      var localdata = [];\n\n      cursor.onsuccess = (function(data, callback) {\n        return function(e) {\n          var cursor = e.target.result;\n          if (cursor) {\n            var currObject = cursor.value;\n\n            data.push(currObject);\n\n            cursor.continue();\n          }\n          else {\n            if (typeof(callback) === 'function') {\n              callback(data);\n            }\n            else {\n              console.log(data);\n            }\n          }\n        };\n      })(localdata, callback);\n\n      cursor.onerror = (function(usercallback) {\n        return function(e) {\n          if (typeof(usercallback) === 'function') {\n            usercallback(null);\n          }\n          else {\n            console.error('LokiCatalog.getAppKeys raised onerror');\n            console.error(e);\n          }\n        };\n      })(callback);\n\n    };\n\n    // Hide 'cursoring' and return array of { id: id, key: key }\n    LokiCatalog.prototype.getAllKeys = function (callback) {\n      var transaction = this.db.transaction(['LokiAKV'], 'readonly');\n      var store = transaction.objectStore('LokiAKV');\n      var cursor = store.openCursor();\n\n      var localdata = [];\n\n      cursor.onsuccess = (function(data, callback) {\n        return function(e) {\n          var cursor = e.target.result;\n          if (cursor) {\n            var currObject = cursor.value;\n\n            data.push(currObject);\n\n            cursor.continue();\n          }\n          else {\n            if (typeof(callback) === 'function') {\n              callback(data);\n            }\n            else {\n              console.log(data);\n            }\n          }\n        };\n      })(localdata, callback);\n\n      cursor.onerror = (function(usercallback) {\n        return function(e) {\n          if (typeof(usercallback) === 'function') usercallback(null);\n        };\n      })(callback);\n\n    };\n\n    return LokiIndexedAdapter;\n\n  }());\n}));\n","/**\n * LokiJS\n * @author Joe Minichino <joe.minichino@gmail.com>\n *\n * A lightweight document oriented javascript database\n */\n(function (root, factory) {\n  if (typeof define === 'function' && define.amd) {\n    // AMD\n    define([], factory);\n  } else if (typeof exports === 'object') {\n    // CommonJS\n    module.exports = factory();\n  } else {\n    // Browser globals\n    root.loki = factory();\n  }\n}(this, function () {\n\n  return (function () {\n    'use strict';\n\n    var hasOwnProperty = Object.prototype.hasOwnProperty;\n\n    function deepFreeze(obj) {\n      var prop, i;\n      if (Array.isArray(obj)) {\n        for (i = 0; i < obj.length; i++) {\n          deepFreeze(obj[i]);\n        }\n        freeze(obj);\n      } else if (obj !== null && (typeof obj === 'object')) {\n        for (prop in obj) {\n          if (obj.hasOwnProperty(prop)) {\n            deepFreeze(obj[prop]);\n          }\n        }\n        freeze(obj);\n      }\n    }\n\n    function freeze(obj) {\n      if (!Object.isFrozen(obj)) {\n        Object.freeze(obj);\n      }\n    }\n\n    function unFreeze(obj) {\n      if (!Object.isFrozen(obj)) {\n        return obj;\n      }\n      return clone(obj, 'shallow');\n    }\n\n    var Utils = {\n      copyProperties: function (src, dest) {\n        var prop;\n        for (prop in src) {\n          dest[prop] = src[prop];\n        }\n      },\n      // used to recursively scan hierarchical transform step object for param substitution\n      resolveTransformObject: function (subObj, params, depth) {\n        var prop,\n          pname;\n\n        if (typeof depth !== 'number') {\n          depth = 0;\n        }\n\n        if (++depth >= 10) return subObj;\n\n        for (prop in subObj) {\n          if (typeof subObj[prop] === 'string' && subObj[prop].indexOf(\"[%lktxp]\") === 0) {\n            pname = subObj[prop].substring(8);\n            if (params.hasOwnProperty(pname)) {\n              subObj[prop] = params[pname];\n            }\n          } else if (typeof subObj[prop] === \"object\") {\n            subObj[prop] = Utils.resolveTransformObject(subObj[prop], params, depth);\n          }\n        }\n\n        return subObj;\n      },\n      // top level utility to resolve an entire (single) transform (array of steps) for parameter substitution\n      resolveTransformParams: function (transform, params) {\n        var idx,\n          clonedStep,\n          resolvedTransform = [];\n\n        if (typeof params === 'undefined') return transform;\n\n        // iterate all steps in the transform array\n        for (idx = 0; idx < transform.length; idx++) {\n          // clone transform so our scan/replace can operate directly on cloned transform\n          clonedStep = clone(transform[idx], \"shallow-recurse-objects\");\n          resolvedTransform.push(Utils.resolveTransformObject(clonedStep, params));\n        }\n\n        return resolvedTransform;\n      },\n\n      // By default (if usingDotNotation is false), looks up path in\n      // object via `object[path]`\n      //\n      // If `usingDotNotation` is true, then the path is assumed to\n      // represent a nested path. It can be in the form of an array of\n      // field names, or a period delimited string. The function will\n      // look up the value of object[path[0]], and then call\n      // result[path[1]] on the result, etc etc.\n      //\n      // If `usingDotNotation` is true, this function still supports\n      // non nested fields.\n      //\n      // `usingDotNotation` is a performance optimization. The caller\n      // may know that a path is *not* nested. In which case, this\n      // function avoids a costly string.split('.')\n      //\n      // examples:\n      // getIn({a: 1}, \"a\") => 1\n      // getIn({a: 1}, \"a\", true) => 1\n      // getIn({a: {b: 1}}, [\"a\", \"b\"], true) => 1\n      // getIn({a: {b: 1}}, \"a.b\", true) => 1\n      getIn: function (object, path, usingDotNotation) {\n        if (object == null) {\n          return undefined;\n        }\n        if (!usingDotNotation) {\n          return object[path];\n        }\n\n        if (typeof (path) === \"string\") {\n          path = path.split(\".\");\n        }\n\n        if (!Array.isArray(path)) {\n          throw new Error(\"path must be a string or array. Found \" + typeof (path));\n        }\n\n        var index = 0,\n          length = path.length;\n\n        while (object != null && index < length) {\n          object = object[path[index++]];\n        }\n        return (index && index == length) ? object : undefined;\n      }\n    };\n\n    // wrapping in object to expose to default export for potential user override.\n    // warning: overriding these methods will override behavior for all loki db instances in memory.\n    // warning: if you use binary indices these comparators should be the same for all inserts/updates/removes.\n    var Comparators = {\n      aeq: aeqHelper,\n      lt: ltHelper,\n      gt: gtHelper\n    };\n\n    /** Helper function for determining 'loki' abstract equality which is a little more abstract than ==\n     *     aeqHelper(5, '5') === true\n     *     aeqHelper(5.0, '5') === true\n     *     aeqHelper(new Date(\"1/1/2011\"), new Date(\"1/1/2011\")) === true\n     *     aeqHelper({a:1}, {z:4}) === true (all objects sorted equally)\n     *     aeqHelper([1, 2, 3], [1, 3]) === false\n     *     aeqHelper([1, 2, 3], [1, 2, 3]) === true\n     *     aeqHelper(undefined, null) === true\n     */\n    function aeqHelper(prop1, prop2) {\n      var cv1, cv2, t1, t2;\n\n      if (prop1 === prop2) return true;\n\n      // 'falsy' and Boolean handling\n      if (!prop1 || !prop2 || prop1 === true || prop2 === true || prop1 !== prop1 || prop2 !== prop2) {\n        // dates and NaN conditions (typed dates before serialization)\n        switch (prop1) {\n          case undefined: t1 = 1; break;\n          case null: t1 = 1; break;\n          case false: t1 = 3; break;\n          case true: t1 = 4; break;\n          case \"\": t1 = 5; break;\n          default: t1 = (prop1 === prop1) ? 9 : 0; break;\n        }\n\n        switch (prop2) {\n          case undefined: t2 = 1; break;\n          case null: t2 = 1; break;\n          case false: t2 = 3; break;\n          case true: t2 = 4; break;\n          case \"\": t2 = 5; break;\n          default: t2 = (prop2 === prop2) ? 9 : 0; break;\n        }\n\n        // one or both is edge case\n        if (t1 !== 9 || t2 !== 9) {\n          return (t1 === t2);\n        }\n      }\n\n      // Handle 'Number-like' comparisons\n      cv1 = Number(prop1);\n      cv2 = Number(prop2);\n\n      // if one or both are 'number-like'...\n      if (cv1 === cv1 || cv2 === cv2) {\n        return (cv1 === cv2);\n      }\n\n      // not strict equal nor less than nor gt so must be mixed types, convert to string and use that to compare\n      cv1 = prop1.toString();\n      cv2 = prop2.toString();\n\n      return (cv1 == cv2);\n    }\n\n    /** Helper function for determining 'less-than' conditions for ops, sorting, and binary indices.\n     *     In the future we might want $lt and $gt ops to use their own functionality/helper.\n     *     Since binary indices on a property might need to index [12, NaN, new Date(), Infinity], we\n     *     need this function (as well as gtHelper) to always ensure one value is LT, GT, or EQ to another.\n     */\n    function ltHelper(prop1, prop2, equal) {\n      var cv1, cv2, t1, t2;\n\n      // if one of the params is falsy or strictly true or not equal to itself\n      // 0, 0.0, \"\", NaN, null, undefined, not defined, false, true\n      if (!prop1 || !prop2 || prop1 === true || prop2 === true || prop1 !== prop1 || prop2 !== prop2) {\n        switch (prop1) {\n          case undefined: t1 = 1; break;\n          case null: t1 = 1; break;\n          case false: t1 = 3; break;\n          case true: t1 = 4; break;\n          case \"\": t1 = 5; break;\n          // if strict equal probably 0 so sort higher, otherwise probably NaN so sort lower than even null\n          default: t1 = (prop1 === prop1) ? 9 : 0; break;\n        }\n\n        switch (prop2) {\n          case undefined: t2 = 1; break;\n          case null: t2 = 1; break;\n          case false: t2 = 3; break;\n          case true: t2 = 4; break;\n          case \"\": t2 = 5; break;\n          default: t2 = (prop2 === prop2) ? 9 : 0; break;\n        }\n\n        // one or both is edge case\n        if (t1 !== 9 || t2 !== 9) {\n          return (t1 === t2) ? equal : (t1 < t2);\n        }\n      }\n\n      // if both are numbers (string encoded or not), compare as numbers\n      cv1 = Number(prop1);\n      cv2 = Number(prop2);\n\n      if (cv1 === cv1 && cv2 === cv2) {\n        if (cv1 < cv2) return true;\n        if (cv1 > cv2) return false;\n        return equal;\n      }\n\n      if (cv1 === cv1 && cv2 !== cv2) {\n        return true;\n      }\n\n      if (cv2 === cv2 && cv1 !== cv1) {\n        return false;\n      }\n\n      if (prop1 < prop2) return true;\n      if (prop1 > prop2) return false;\n      if (prop1 == prop2) return equal;\n\n      // not strict equal nor less than nor gt so must be mixed types, convert to string and use that to compare\n      cv1 = prop1.toString();\n      cv2 = prop2.toString();\n\n      if (cv1 < cv2) {\n        return true;\n      }\n\n      if (cv1 == cv2) {\n        return equal;\n      }\n\n      return false;\n    }\n\n    function gtHelper(prop1, prop2, equal) {\n      var cv1, cv2, t1, t2;\n\n      // 'falsy' and Boolean handling\n      if (!prop1 || !prop2 || prop1 === true || prop2 === true || prop1 !== prop1 || prop2 !== prop2) {\n        switch (prop1) {\n          case undefined: t1 = 1; break;\n          case null: t1 = 1; break;\n          case false: t1 = 3; break;\n          case true: t1 = 4; break;\n          case \"\": t1 = 5; break;\n          // NaN 0\n          default: t1 = (prop1 === prop1) ? 9 : 0; break;\n        }\n\n        switch (prop2) {\n          case undefined: t2 = 1; break;\n          case null: t2 = 1; break;\n          case false: t2 = 3; break;\n          case true: t2 = 4; break;\n          case \"\": t2 = 5; break;\n          default: t2 = (prop2 === prop2) ? 9 : 0; break;\n        }\n\n        // one or both is edge case\n        if (t1 !== 9 || t2 !== 9) {\n          return (t1 === t2) ? equal : (t1 > t2);\n        }\n      }\n\n      // if both are numbers (string encoded or not), compare as numbers\n      cv1 = Number(prop1);\n      cv2 = Number(prop2);\n      if (cv1 === cv1 && cv2 === cv2) {\n        if (cv1 > cv2) return true;\n        if (cv1 < cv2) return false;\n        return equal;\n      }\n\n      if (cv1 === cv1 && cv2 !== cv2) {\n        return false;\n      }\n\n      if (cv2 === cv2 && cv1 !== cv1) {\n        return true;\n      }\n\n      if (prop1 > prop2) return true;\n      if (prop1 < prop2) return false;\n      if (prop1 == prop2) return equal;\n\n      // not strict equal nor less than nor gt so must be dates or mixed types\n      // convert to string and use that to compare\n      cv1 = prop1.toString();\n      cv2 = prop2.toString();\n\n      if (cv1 > cv2) {\n        return true;\n      }\n\n      if (cv1 == cv2) {\n        return equal;\n      }\n\n      return false;\n    }\n\n    function sortHelper(prop1, prop2, desc) {\n      if (Comparators.aeq(prop1, prop2)) return 0;\n\n      if (Comparators.lt(prop1, prop2, false)) {\n        return (desc) ? (1) : (-1);\n      }\n\n      if (Comparators.gt(prop1, prop2, false)) {\n        return (desc) ? (-1) : (1);\n      }\n\n      // not lt, not gt so implied equality-- date compatible\n      return 0;\n    }\n\n    /**\n     * compoundeval() - helper function for compoundsort(), performing individual object comparisons\n     *\n     * @param {array} properties - array of property names, in order, by which to evaluate sort order\n     * @param {object} obj1 - first object to compare\n     * @param {object} obj2 - second object to compare\n     * @returns {integer} 0, -1, or 1 to designate if identical (sortwise) or which should be first\n     */\n    function compoundeval(properties, obj1, obj2) {\n      var res = 0;\n      var prop, field, val1, val2, arr, path;\n      for (var i = 0, len = properties.length; i < len; i++) {\n        prop = properties[i];\n        field = prop[0];\n        if (~field.indexOf('.')) {\n          arr = field.split('.');\n          val1 = Utils.getIn(obj1, arr, true);\n          val2 = Utils.getIn(obj2, arr, true);\n        } else {\n          val1 = obj1[field];\n          val2 = obj2[field];\n        }\n        res = sortHelper(val1, val2, prop[1]);\n        if (res !== 0) {\n          return res;\n        }\n      }\n      return 0;\n    }\n\n    /**\n     * dotSubScan - helper function used for dot notation queries.\n     *\n     * @param {object} root - object to traverse\n     * @param {array} paths - array of properties to drill into\n     * @param {function} fun - evaluation function to test with\n     * @param {any} value - comparative value to also pass to (compare) fun\n     * @param {any} extra - extra arg to also pass to compare fun\n     * @param {number} poffset - index of the item in 'paths' to start the sub-scan from\n     */\n    function dotSubScan(root, paths, fun, value, extra, poffset) {\n      var pathOffset = poffset || 0;\n      var path = paths[pathOffset];\n\n      var valueFound = false;\n      var element;\n      if (typeof root === 'object' && path in root) {\n        element = root[path];\n      }\n      if (pathOffset + 1 >= paths.length) {\n        // if we have already expanded out the dot notation,\n        // then just evaluate the test function and value on the element\n        valueFound = fun(element, value, extra);\n      } else if (Array.isArray(element)) {\n        for (var index = 0, len = element.length; index < len; index += 1) {\n          valueFound = dotSubScan(element[index], paths, fun, value, extra, pathOffset + 1);\n          if (valueFound === true) {\n            break;\n          }\n        }\n      } else {\n        valueFound = dotSubScan(element, paths, fun, value, extra, pathOffset + 1);\n      }\n\n      return valueFound;\n    }\n\n    function containsCheckFn(a) {\n      if (typeof a === 'string' || Array.isArray(a)) {\n        return function (b) {\n          return a.indexOf(b) !== -1;\n        };\n      } else if (typeof a === 'object' && a !== null) {\n        return function (b) {\n          return hasOwnProperty.call(a, b);\n        };\n      }\n      return null;\n    }\n\n    function doQueryOp(val, op, record) {\n      for (var p in op) {\n        if (hasOwnProperty.call(op, p)) {\n          return LokiOps[p](val, op[p], record);\n        }\n      }\n      return false;\n    }\n\n    var LokiOps = {\n      // comparison operators\n      // a is the value in the collection\n      // b is the query value\n      $eq: function (a, b) {\n        return a === b;\n      },\n\n      // abstract/loose equality\n      $aeq: function (a, b) {\n        return a == b;\n      },\n\n      $ne: function (a, b) {\n        // ecma 5 safe test for NaN\n        if (b !== b) {\n          // ecma 5 test value is not NaN\n          return (a === a);\n        }\n\n        return a !== b;\n      },\n      // date equality / loki abstract equality test\n      $dteq: function (a, b) {\n        return Comparators.aeq(a, b);\n      },\n\n      // loki comparisons: return identical unindexed results as indexed comparisons\n      $gt: function (a, b) {\n        return Comparators.gt(a, b, false);\n      },\n\n      $gte: function (a, b) {\n        return Comparators.gt(a, b, true);\n      },\n\n      $lt: function (a, b) {\n        return Comparators.lt(a, b, false);\n      },\n\n      $lte: function (a, b) {\n        return Comparators.lt(a, b, true);\n      },\n\n      // lightweight javascript comparisons\n      $jgt: function (a, b) {\n        return a > b;\n      },\n\n      $jgte: function (a, b) {\n        return a >= b;\n      },\n\n      $jlt: function (a, b) {\n        return a < b;\n      },\n\n      $jlte: function (a, b) {\n        return a <= b;\n      },\n\n      // ex : coll.find({'orderCount': {$between: [10, 50]}});\n      $between: function (a, vals) {\n        if (a === undefined || a === null) return false;\n        return (Comparators.gt(a, vals[0], true) && Comparators.lt(a, vals[1], true));\n      },\n\n      $jbetween: function (a, vals) {\n        if (a === undefined || a === null) return false;\n        return (a >= vals[0] && a <= vals[1]);\n      },\n\n      $in: function (a, b) {\n        return b.indexOf(a) !== -1;\n      },\n\n      $inSet: function(a, b) {\n        return b.has(a);\n      },\n\n      $nin: function (a, b) {\n        return b.indexOf(a) === -1;\n      },\n\n      $keyin: function (a, b) {\n        return a in b;\n      },\n\n      $nkeyin: function (a, b) {\n        return !(a in b);\n      },\n\n      $definedin: function (a, b) {\n        return b[a] !== undefined;\n      },\n\n      $undefinedin: function (a, b) {\n        return b[a] === undefined;\n      },\n\n      $regex: function (a, b) {\n        return b.test(a);\n      },\n\n      $containsString: function (a, b) {\n        return (typeof a === 'string') && (a.indexOf(b) !== -1);\n      },\n\n      $containsNone: function (a, b) {\n        return !LokiOps.$containsAny(a, b);\n      },\n\n      $containsAny: function (a, b) {\n        var checkFn = containsCheckFn(a);\n        if (checkFn !== null) {\n          return (Array.isArray(b)) ? (b.some(checkFn)) : (checkFn(b));\n        }\n        return false;\n      },\n\n      $contains: function (a, b) {\n        var checkFn = containsCheckFn(a);\n        if (checkFn !== null) {\n          return (Array.isArray(b)) ? (b.every(checkFn)) : (checkFn(b));\n        }\n        return false;\n      },\n\n      $elemMatch: function (a, b) {\n        if (Array.isArray(a)) {\n          return a.some(function (item) {\n            return Object.keys(b).every(function (property) {\n              var filter = b[property];\n              if (!(typeof filter === 'object' && filter)) {\n                filter = { $eq: filter };\n              }\n\n              if (property.indexOf('.') !== -1) {\n                return dotSubScan(item, property.split('.'), doQueryOp, b[property], item);\n              }\n              return doQueryOp(item[property], filter, item);\n            });\n          });\n        }\n        return false;\n      },\n\n      $type: function (a, b, record) {\n        var type = typeof a;\n        if (type === 'object') {\n          if (Array.isArray(a)) {\n            type = 'array';\n          } else if (a instanceof Date) {\n            type = 'date';\n          }\n        }\n        return (typeof b !== 'object') ? (type === b) : doQueryOp(type, b, record);\n      },\n\n      $finite: function (a, b) {\n        return (b === isFinite(a));\n      },\n\n      $size: function (a, b, record) {\n        if (Array.isArray(a)) {\n          return (typeof b !== 'object') ? (a.length === b) : doQueryOp(a.length, b, record);\n        }\n        return false;\n      },\n\n      $len: function (a, b, record) {\n        if (typeof a === 'string') {\n          return (typeof b !== 'object') ? (a.length === b) : doQueryOp(a.length, b, record);\n        }\n        return false;\n      },\n\n      $where: function (a, b) {\n        return b(a) === true;\n      },\n\n      // field-level logical operators\n      // a is the value in the collection\n      // b is the nested query operation (for '$not')\n      //   or an array of nested query operations (for '$and' and '$or')\n      $not: function (a, b, record) {\n        return !doQueryOp(a, b, record);\n      },\n\n      $and: function (a, b, record) {\n        for (var idx = 0, len = b.length; idx < len; idx += 1) {\n          if (!doQueryOp(a, b[idx], record)) {\n            return false;\n          }\n        }\n        return true;\n      },\n\n      $or: function (a, b, record) {\n        for (var idx = 0, len = b.length; idx < len; idx += 1) {\n          if (doQueryOp(a, b[idx], record)) {\n            return true;\n          }\n        }\n        return false;\n      },\n\n      $exists: function (a, b) {\n        if (b) {\n          return a !== undefined;\n        } else {\n          return a === undefined;\n        }\n      }\n    };\n\n    // ops that can be used with { $$op: 'column-name' } syntax\n    var valueLevelOps = ['$eq', '$aeq', '$ne', '$dteq', '$gt', '$gte', '$lt', '$lte', '$jgt', '$jgte', '$jlt', '$jlte', '$type'];\n    valueLevelOps.forEach(function (op) {\n      var fun = LokiOps[op];\n      LokiOps['$' + op] = function (a, spec, record) {\n        if (typeof spec === 'string') {\n          return fun(a, record[spec]);\n        } else if (typeof spec === 'function') {\n          return fun(a, spec(record));\n        } else {\n          throw new Error('Invalid argument to $$ matcher');\n        }\n      };\n    });\n\n    // if an op is registered in this object, our 'calculateRange' can use it with our binary indices.\n    // if the op is registered to a function, we will run that function/op as a 2nd pass filter on results.\n    // those 2nd pass filter functions should be similar to LokiOps functions, accepting 2 vals to compare.\n    var indexedOps = {\n      $eq: LokiOps.$eq,\n      $aeq: true,\n      $dteq: true,\n      $gt: true,\n      $gte: true,\n      $lt: true,\n      $lte: true,\n      $in: true,\n      $between: true\n    };\n\n    function clone(data, method) {\n      if (data === null || data === undefined) {\n        return null;\n      }\n\n      var cloneMethod = method || 'parse-stringify',\n        cloned;\n\n      switch (cloneMethod) {\n        case \"parse-stringify\":\n          cloned = JSON.parse(JSON.stringify(data));\n          break;\n        case \"jquery-extend-deep\":\n          cloned = jQuery.extend(true, {}, data);\n          break;\n        case \"shallow\":\n          // more compatible method for older browsers\n          cloned = Object.create(data.constructor.prototype);\n          Object.keys(data).map(function (i) {\n            cloned[i] = data[i];\n          });\n          break;\n        case \"shallow-assign\":\n          // should be supported by newer environments/browsers\n          cloned = Object.create(data.constructor.prototype);\n          Object.assign(cloned, data);\n          break;\n        case \"shallow-recurse-objects\":\n          // shallow clone top level properties\n          cloned = clone(data, \"shallow\");\n          var keys = Object.keys(data);\n          // for each of the top level properties which are object literals, recursively shallow copy\n          keys.forEach(function (key) {\n            if (typeof data[key] === \"object\" && data[key].constructor.name === \"Object\") {\n              cloned[key] = clone(data[key], \"shallow-recurse-objects\");\n            } else if (Array.isArray(data[key])) {\n              cloned[key] = cloneObjectArray(data[key], \"shallow-recurse-objects\");\n            }\n          });\n          break;\n        default:\n          break;\n      }\n\n      return cloned;\n    }\n\n    function cloneObjectArray(objarray, method) {\n      if (method == \"parse-stringify\") {\n        return clone(objarray, method);\n      }\n      var result = [];\n      for (var i = 0, len = objarray.length; i < len; i++) {\n        result[i] = clone(objarray[i], method);\n      }\n      return result;\n    }\n\n    function localStorageAvailable() {\n      try {\n        return (window && window.localStorage !== undefined && window.localStorage !== null);\n      } catch (e) {\n        return false;\n      }\n    }\n\n\n    /**\n     * LokiEventEmitter is a minimalist version of EventEmitter. It enables any\n     * constructor that inherits EventEmitter to emit events and trigger\n     * listeners that have been added to the event through the on(event, callback) method\n     *\n     * @constructor LokiEventEmitter\n     */\n    function LokiEventEmitter() { }\n\n    /**\n     * @prop {hashmap} events - a hashmap, with each property being an array of callbacks\n     * @memberof LokiEventEmitter\n     */\n    LokiEventEmitter.prototype.events = {};\n\n    /**\n     * @prop {boolean} asyncListeners - boolean determines whether or not the callbacks associated with each event\n     * should happen in an async fashion or not\n     * Default is false, which means events are synchronous\n     * @memberof LokiEventEmitter\n     */\n    LokiEventEmitter.prototype.asyncListeners = false;\n\n    /**\n     * on(eventName, listener) - adds a listener to the queue of callbacks associated to an event\n     * @param {string|string[]} eventName - the name(s) of the event(s) to listen to\n     * @param {function} listener - callback function of listener to attach\n     * @returns {int} the index of the callback in the array of listeners for a particular event\n     * @memberof LokiEventEmitter\n     */\n    LokiEventEmitter.prototype.on = function (eventName, listener) {\n      var event;\n      var self = this;\n\n      if (Array.isArray(eventName)) {\n        eventName.forEach(function (currentEventName) {\n          self.on(currentEventName, listener);\n        });\n        return listener;\n      }\n\n      event = this.events[eventName];\n      if (!event) {\n        event = this.events[eventName] = [];\n      }\n      event.push(listener);\n      return listener;\n    };\n\n    /**\n     * emit(eventName, data) - emits a particular event\n     * with the option of passing optional parameters which are going to be processed by the callback\n     * provided signatures match (i.e. if passing emit(event, arg0, arg1) the listener should take two parameters)\n     * @param {string} eventName - the name of the event\n     * @param {object=} data - optional object passed with the event\n     * @memberof LokiEventEmitter\n     */\n    LokiEventEmitter.prototype.emit = function (eventName) {\n      var self = this;\n      var selfArgs;\n      if (eventName && this.events[eventName]) {\n        if (this.events[eventName].length) {\n          selfArgs = Array.prototype.slice.call(arguments, 1);\n          this.events[eventName].forEach(function (listener) {\n            if (self.asyncListeners) {\n              setTimeout(function () {\n                listener.apply(self, selfArgs);\n              }, 1);\n            } else {\n              listener.apply(self, selfArgs);\n            }\n          });\n        }\n      } else {\n        throw new Error('No event ' + eventName + ' defined');\n      }\n    };\n\n    /**\n     * Alias of LokiEventEmitter.prototype.on\n     * addListener(eventName, listener) - adds a listener to the queue of callbacks associated to an event\n     * @param {string|string[]} eventName - the name(s) of the event(s) to listen to\n     * @param {function} listener - callback function of listener to attach\n     * @returns {int} the index of the callback in the array of listeners for a particular event\n     * @memberof LokiEventEmitter\n     */\n    LokiEventEmitter.prototype.addListener = LokiEventEmitter.prototype.on;\n\n    /**\n     * removeListener() - removes the listener at position 'index' from the event 'eventName'\n     * @param {string|string[]} eventName - the name(s) of the event(s) which the listener is attached to\n     * @param {function} listener - the listener callback function to remove from emitter\n     * @memberof LokiEventEmitter\n     */\n    LokiEventEmitter.prototype.removeListener = function (eventName, listener) {\n      var self = this;\n\n      if (Array.isArray(eventName)) {\n        eventName.forEach(function (currentEventName) {\n          self.removeListener(currentEventName, listener);\n        });\n\n        return;\n      }\n\n      if (this.events[eventName]) {\n        var listeners = this.events[eventName];\n        listeners.splice(listeners.indexOf(listener), 1);\n      }\n    };\n\n    /**\n     * Loki: The main database class\n     * @constructor Loki\n     * @implements LokiEventEmitter\n     * @param {string} filename - name of the file to be saved to\n     * @param {object=} options - (Optional) config options object\n     * @param {string} options.env - override environment detection as 'NODEJS', 'BROWSER', 'CORDOVA'\n     * @param {boolean} [options.verbose=false] - enable console output\n     * @param {boolean} [options.autosave=false] - enables autosave\n     * @param {int} [options.autosaveInterval=5000] - time interval (in milliseconds) between saves (if dirty)\n     * @param {boolean} [options.autoload=false] - enables autoload on loki instantiation\n     * @param {function} options.autoloadCallback - user callback called after database load\n     * @param {adapter} options.adapter - an instance of a loki persistence adapter\n     * @param {string} [options.serializationMethod='normal'] - ['normal', 'pretty', 'destructured']\n     * @param {string} options.destructureDelimiter - string delimiter used for destructured serialization\n     * @param {boolean} [options.throttledSaves=true] - debounces multiple calls to to saveDatabase reducing number of disk I/O operations\n                                                and guaranteeing proper serialization of the calls.\n     */\n    function Loki(filename, options) {\n      this.filename = filename || 'loki.db';\n      this.collections = [];\n\n      // persist version of code which created the database to the database.\n      // could use for upgrade scenarios\n      this.databaseVersion = 1.5;\n      this.engineVersion = 1.5;\n\n      // autosave support (disabled by default)\n      // pass autosave: true, autosaveInterval: 6000 in options to set 6 second autosave\n      this.autosave = false;\n      this.autosaveInterval = 5000;\n      this.autosaveHandle = null;\n      this.throttledSaves = true;\n\n      this.options = {};\n\n      // currently keeping persistenceMethod and persistenceAdapter as loki level properties that\n      // will not or cannot be deserialized.  You are required to configure persistence every time\n      // you instantiate a loki object (or use default environment detection) in order to load the database anyways.\n\n      // persistenceMethod could be 'fs', 'localStorage', or 'adapter'\n      // this is optional option param, otherwise environment detection will be used\n      // if user passes their own adapter we will force this method to 'adapter' later, so no need to pass method option.\n      this.persistenceMethod = null;\n\n      // retain reference to optional (non-serializable) persistenceAdapter 'instance'\n      this.persistenceAdapter = null;\n\n      // flags used to throttle saves\n      this.throttledSavePending = false;\n      this.throttledCallbacks = [];\n\n      // enable console output if verbose flag is set (disabled by default)\n      this.verbose = options && options.hasOwnProperty('verbose') ? options.verbose : false;\n\n      this.events = {\n        'init': [],\n        'loaded': [],\n        'flushChanges': [],\n        'close': [],\n        'changes': [],\n        'warning': []\n      };\n\n      var getENV = function () {\n        if (typeof global !== 'undefined' && (global.android || global.NSObject)) {\n          // If no adapter assume nativescript which needs adapter to be passed manually\n          return 'NATIVESCRIPT'; //nativescript\n        }\n\n        if (typeof window === 'undefined') {\n          return 'NODEJS';\n        }\n\n        if (typeof global !== 'undefined' && global.window && typeof process !== 'undefined') {\n          return 'NODEJS'; //node-webkit\n        }\n\n        if (typeof document !== 'undefined') {\n          if (document.URL.indexOf('http://') === -1 && document.URL.indexOf('https://') === -1) {\n            return 'CORDOVA';\n          }\n          return 'BROWSER';\n        }\n        return 'CORDOVA';\n      };\n\n      // refactored environment detection due to invalid detection for browser environments.\n      // if they do not specify an options.env we want to detect env rather than default to nodejs.\n      // currently keeping two properties for similar thing (options.env and options.persistenceMethod)\n      //   might want to review whether we can consolidate.\n      if (options && options.hasOwnProperty('env')) {\n        this.ENV = options.env;\n      } else {\n        this.ENV = getENV();\n      }\n\n      // not sure if this is necessary now that i have refactored the line above\n      if (this.ENV === 'undefined') {\n        this.ENV = 'NODEJS';\n      }\n\n      this.configureOptions(options, true);\n\n      this.on('init', this.clearChanges);\n\n    }\n\n    // db class is an EventEmitter\n    Loki.prototype = new LokiEventEmitter();\n    Loki.prototype.constructor = Loki;\n\n    // experimental support for browserify's abstract syntax scan to pick up dependency of indexed adapter.\n    // Hopefully, once this hits npm a browserify require of lokijs should scan the main file and detect this indexed adapter reference.\n    Loki.prototype.getIndexedAdapter = function () {\n      var adapter;\n\n      if (typeof require === 'function') {\n        adapter = require(\"./loki-indexed-adapter.js\");\n      }\n\n      return adapter;\n    };\n\n\n    /**\n     * Allows reconfiguring database options\n     *\n     * @param {object} options - configuration options to apply to loki db object\n     * @param {string} options.env - override environment detection as 'NODEJS', 'BROWSER', 'CORDOVA'\n     * @param {boolean} options.verbose - enable console output (default is 'false')\n     * @param {boolean} options.autosave - enables autosave\n     * @param {int} options.autosaveInterval - time interval (in milliseconds) between saves (if dirty)\n     * @param {boolean} options.autoload - enables autoload on loki instantiation\n     * @param {function} options.autoloadCallback - user callback called after database load\n     * @param {adapter} options.adapter - an instance of a loki persistence adapter\n     * @param {string} options.serializationMethod - ['normal', 'pretty', 'destructured']\n     * @param {string} options.destructureDelimiter - string delimiter used for destructured serialization\n     * @param {boolean} initialConfig - (internal) true is passed when loki ctor is invoking\n     * @memberof Loki\n     */\n    Loki.prototype.configureOptions = function (options, initialConfig) {\n      var defaultPersistence = {\n        'NODEJS': 'fs',\n        'BROWSER': 'localStorage',\n        'CORDOVA': 'localStorage',\n        'MEMORY': 'memory'\n      },\n        persistenceMethods = {\n          'fs': LokiFsAdapter,\n          'localStorage': LokiLocalStorageAdapter,\n          'memory': LokiMemoryAdapter\n        };\n\n      this.options = {};\n\n      this.persistenceMethod = null;\n      // retain reference to optional persistence adapter 'instance'\n      // currently keeping outside options because it can't be serialized\n      this.persistenceAdapter = null;\n\n      // process the options\n      if (typeof (options) !== 'undefined') {\n        this.options = options;\n\n        if (this.options.hasOwnProperty('persistenceMethod')) {\n          // check if the specified persistence method is known\n          if (typeof (persistenceMethods[options.persistenceMethod]) == 'function') {\n            this.persistenceMethod = options.persistenceMethod;\n            this.persistenceAdapter = new persistenceMethods[options.persistenceMethod]();\n          }\n          // should be throw an error here, or just fall back to defaults ??\n        }\n\n        // if user passes adapter, set persistence mode to adapter and retain persistence adapter instance\n        if (this.options.hasOwnProperty('adapter')) {\n          this.persistenceMethod = 'adapter';\n          this.persistenceAdapter = options.adapter;\n          this.options.adapter = null;\n\n          // if true, will keep track of dirty ids\n          this.isIncremental = this.persistenceAdapter.mode === 'incremental';\n        }\n\n\n        // if they want to load database on loki instantiation, now is a good time to load... after adapter set and before possible autosave initiation\n        if (options.autoload && initialConfig) {\n          // for autoload, let the constructor complete before firing callback\n          var self = this;\n          setTimeout(function () {\n            self.loadDatabase(options, options.autoloadCallback);\n          }, 1);\n        }\n\n        if (this.options.hasOwnProperty('autosaveInterval')) {\n          this.autosaveDisable();\n          this.autosaveInterval = parseInt(this.options.autosaveInterval, 10);\n        }\n\n        if (this.options.hasOwnProperty('autosave') && this.options.autosave) {\n          this.autosaveDisable();\n          this.autosave = true;\n\n          if (this.options.hasOwnProperty('autosaveCallback')) {\n            this.autosaveEnable(options, options.autosaveCallback);\n          } else {\n            this.autosaveEnable();\n          }\n        }\n\n        if (this.options.hasOwnProperty('throttledSaves')) {\n          this.throttledSaves = this.options.throttledSaves;\n        }\n      } // end of options processing\n\n      // ensure defaults exists for options which were not set\n      if (!this.options.hasOwnProperty('serializationMethod')) {\n        this.options.serializationMethod = 'normal';\n      }\n\n      // ensure passed or default option exists\n      if (!this.options.hasOwnProperty('destructureDelimiter')) {\n        this.options.destructureDelimiter = '$<\\n';\n      }\n\n      // if by now there is no adapter specified by user nor derived from persistenceMethod: use sensible defaults\n      if (this.persistenceAdapter === null) {\n        this.persistenceMethod = defaultPersistence[this.ENV];\n        if (this.persistenceMethod) {\n          this.persistenceAdapter = new persistenceMethods[this.persistenceMethod]();\n        }\n      }\n\n    };\n\n    /**\n     * Copies 'this' database into a new Loki instance. Object references are shared to make lightweight.\n     *\n     * @param {object} options - apply or override collection level settings\n     * @param {bool} options.removeNonSerializable - nulls properties not safe for serialization.\n     * @memberof Loki\n     */\n    Loki.prototype.copy = function (options) {\n      // in case running in an environment without accurate environment detection, pass 'NA'\n      var databaseCopy = new Loki(this.filename, { env: \"NA\" });\n      var clen, idx;\n\n      options = options || {};\n\n      // currently inverting and letting loadJSONObject do most of the work\n      databaseCopy.loadJSONObject(this, { retainDirtyFlags: true });\n\n      // since our JSON serializeReplacer is not invoked for reference database adapters, this will let us mimic\n      if (options.hasOwnProperty(\"removeNonSerializable\") && options.removeNonSerializable === true) {\n        databaseCopy.autosaveHandle = null;\n        databaseCopy.persistenceAdapter = null;\n\n        clen = databaseCopy.collections.length;\n        for (idx = 0; idx < clen; idx++) {\n          databaseCopy.collections[idx].constraints = null;\n          databaseCopy.collections[idx].ttl = null;\n        }\n      }\n\n      return databaseCopy;\n    };\n\n    /**\n     * Adds a collection to the database.\n     * @param {string} name - name of collection to add\n     * @param {object=} options - (optional) options to configure collection with.\n     * @param {array=} [options.unique=[]] - array of property names to define unique constraints for\n     * @param {array=} [options.exact=[]] - array of property names to define exact constraints for\n     * @param {array=} [options.indices=[]] - array property names to define binary indexes for\n     * @param {boolean} [options.asyncListeners=false] - whether listeners are called asynchronously\n     * @param {boolean} [options.disableMeta=false] - set to true to disable meta property on documents\n     * @param {boolean} [options.disableChangesApi=true] - set to false to enable Changes Api\n     * @param {boolean} [options.disableDeltaChangesApi=true] - set to false to enable Delta Changes API (requires Changes API, forces cloning)\n     * @param {boolean} [options.autoupdate=false] - use Object.observe to update objects automatically\n     * @param {boolean} [options.clone=false] - specify whether inserts and queries clone to/from user\n     * @param {string} [options.cloneMethod='parse-stringify'] - 'parse-stringify', 'jquery-extend-deep', 'shallow, 'shallow-assign'\n     * @param {int=} options.ttl - age of document (in ms.) before document is considered aged/stale.\n     * @param {int=} options.ttlInterval - time interval for clearing out 'aged' documents; not set by default.\n     * @returns {Collection} a reference to the collection which was just added\n     * @memberof Loki\n     */\n    Loki.prototype.addCollection = function (name, options) {\n      var i,\n        len = this.collections.length;\n\n      if (options && options.disableMeta === true) {\n        if (options.disableChangesApi === false) {\n          throw new Error(\"disableMeta option cannot be passed as true when disableChangesApi is passed as false\");\n        }\n        if (options.disableDeltaChangesApi === false) {\n          throw new Error(\"disableMeta option cannot be passed as true when disableDeltaChangesApi is passed as false\");\n        }\n        if (typeof options.ttl === \"number\" && options.ttl > 0) {\n          throw new Error(\"disableMeta option cannot be passed as true when ttl is enabled\");\n        }\n      }\n\n      for (i = 0; i < len; i += 1) {\n        if (this.collections[i].name === name) {\n          return this.collections[i];\n        }\n      }\n\n      var collection = new Collection(name, options);\n      collection.isIncremental = this.isIncremental;\n      this.collections.push(collection);\n\n      if (this.verbose)\n        collection.lokiConsoleWrapper = console;\n\n      return collection;\n    };\n\n    Loki.prototype.loadCollection = function (collection) {\n      if (!collection.name) {\n        throw new Error('Collection must have a name property to be loaded');\n      }\n      this.collections.push(collection);\n    };\n\n    /**\n     * Retrieves reference to a collection by name.\n     * @param {string} collectionName - name of collection to look up\n     * @returns {Collection} Reference to collection in database by that name, or null if not found\n     * @memberof Loki\n     */\n    Loki.prototype.getCollection = function (collectionName) {\n      var i,\n        len = this.collections.length;\n\n      for (i = 0; i < len; i += 1) {\n        if (this.collections[i].name === collectionName) {\n          return this.collections[i];\n        }\n      }\n\n      // no such collection\n      this.emit('warning', 'collection ' + collectionName + ' not found');\n      return null;\n    };\n\n    /**\n     * Renames an existing loki collection\n     * @param {string} oldName - name of collection to rename\n     * @param {string} newName - new name of collection\n     * @returns {Collection} reference to the newly renamed collection\n     * @memberof Loki\n     */\n    Loki.prototype.renameCollection = function (oldName, newName) {\n      var c = this.getCollection(oldName);\n\n      if (c) {\n        c.name = newName;\n      }\n\n      return c;\n    };\n\n    /**\n     * Returns a list of collections in the database.\n     * @returns {object[]} array of objects containing 'name', 'type', and 'count' properties.\n     * @memberof Loki\n     */\n    Loki.prototype.listCollections = function () {\n\n      var i = this.collections.length,\n        colls = [];\n\n      while (i--) {\n        colls.push({\n          name: this.collections[i].name,\n          type: this.collections[i].objType,\n          count: this.collections[i].data.length\n        });\n      }\n      return colls;\n    };\n\n    /**\n     * Removes a collection from the database.\n     * @param {string} collectionName - name of collection to remove\n     * @memberof Loki\n     */\n    Loki.prototype.removeCollection = function (collectionName) {\n      var i,\n        len = this.collections.length;\n\n      for (i = 0; i < len; i += 1) {\n        if (this.collections[i].name === collectionName) {\n          var tmpcol = new Collection(collectionName, {});\n          var curcol = this.collections[i];\n          for (var prop in curcol) {\n            if (curcol.hasOwnProperty(prop) && tmpcol.hasOwnProperty(prop)) {\n              curcol[prop] = tmpcol[prop];\n            }\n          }\n          this.collections.splice(i, 1);\n          return;\n        }\n      }\n    };\n\n    Loki.prototype.getName = function () {\n      return this.name;\n    };\n\n    /**\n     * serializeReplacer - used to prevent certain properties from being serialized\n     *\n     */\n    Loki.prototype.serializeReplacer = function (key, value) {\n      switch (key) {\n        case 'autosaveHandle':\n        case 'persistenceAdapter':\n        case 'constraints':\n        case 'ttl':\n          return null;\n        case 'throttledSavePending':\n        case 'throttledCallbacks':\n          return undefined;\n        case 'lokiConsoleWrapper':\n          return null;\n        default:\n          return value;\n      }\n    };\n\n    /**\n     * Serialize database to a string which can be loaded via {@link Loki#loadJSON}\n     *\n     * @returns {string} Stringified representation of the loki database.\n     * @memberof Loki\n     */\n    Loki.prototype.serialize = function (options) {\n      options = options || {};\n\n      if (!options.hasOwnProperty(\"serializationMethod\")) {\n        options.serializationMethod = this.options.serializationMethod;\n      }\n\n      switch (options.serializationMethod) {\n        case \"normal\": return JSON.stringify(this, this.serializeReplacer);\n        case \"pretty\": return JSON.stringify(this, this.serializeReplacer, 2);\n        case \"destructured\": return this.serializeDestructured(); // use default options\n        default: return JSON.stringify(this, this.serializeReplacer);\n      }\n    };\n\n    // alias of serialize\n    Loki.prototype.toJson = Loki.prototype.serialize;\n\n    /**\n     * Database level destructured JSON serialization routine to allow alternate serialization methods.\n     * Internally, Loki supports destructuring via loki \"serializationMethod' option and\n     * the optional LokiPartitioningAdapter class. It is also available if you wish to do\n     * your own structured persistence or data exchange.\n     *\n     * @param {object=} options - output format options for use externally to loki\n     * @param {bool=} options.partitioned - (default: false) whether db and each collection are separate\n     * @param {int=} options.partition - can be used to only output an individual collection or db (-1)\n     * @param {bool=} options.delimited - (default: true) whether subitems are delimited or subarrays\n     * @param {string=} options.delimiter - override default delimiter\n     *\n     * @returns {string|array} A custom, restructured aggregation of independent serializations.\n     * @memberof Loki\n     */\n    Loki.prototype.serializeDestructured = function (options) {\n      var idx, sidx, result, resultlen;\n      var reconstruct = [];\n      var dbcopy;\n\n      options = options || {};\n\n      if (!options.hasOwnProperty(\"partitioned\")) {\n        options.partitioned = false;\n      }\n\n      if (!options.hasOwnProperty(\"delimited\")) {\n        options.delimited = true;\n      }\n\n      if (!options.hasOwnProperty(\"delimiter\")) {\n        options.delimiter = this.options.destructureDelimiter;\n      }\n\n      // 'partitioned' along with 'partition' of 0 or greater is a request for single collection serialization\n      if (options.partitioned === true && options.hasOwnProperty(\"partition\") && options.partition >= 0) {\n        return this.serializeCollection({\n          delimited: options.delimited,\n          delimiter: options.delimiter,\n          collectionIndex: options.partition\n        });\n      }\n\n      // not just an individual collection, so we will need to serialize db container via shallow copy\n      dbcopy = new Loki(this.filename);\n      dbcopy.loadJSONObject(this);\n\n      for (idx = 0; idx < dbcopy.collections.length; idx++) {\n        dbcopy.collections[idx].data = [];\n      }\n\n      // if we -only- wanted the db container portion, return it now\n      if (options.partitioned === true && options.partition === -1) {\n        // since we are deconstructing, override serializationMethod to normal for here\n        return dbcopy.serialize({\n          serializationMethod: \"normal\"\n        });\n      }\n\n      // at this point we must be deconstructing the entire database\n      // start by pushing db serialization into first array element\n      reconstruct.push(dbcopy.serialize({\n        serializationMethod: \"normal\"\n      }));\n\n      dbcopy = null;\n\n      // push collection data into subsequent elements\n      for (idx = 0; idx < this.collections.length; idx++) {\n        result = this.serializeCollection({\n          delimited: options.delimited,\n          delimiter: options.delimiter,\n          collectionIndex: idx\n        });\n\n        // NDA : Non-Delimited Array : one iterable concatenated array with empty string collection partitions\n        if (options.partitioned === false && options.delimited === false) {\n          if (!Array.isArray(result)) {\n            throw new Error(\"a nondelimited, non partitioned collection serialization did not return an expected array\");\n          }\n\n          // Array.concat would probably duplicate memory overhead for copying strings.\n          // Instead copy each individually, and clear old value after each copy.\n          // Hopefully this will allow g.c. to reduce memory pressure, if needed.\n          resultlen = result.length;\n\n          for (sidx = 0; sidx < resultlen; sidx++) {\n            reconstruct.push(result[sidx]);\n            result[sidx] = null;\n          }\n\n          reconstruct.push(\"\");\n        }\n        else {\n          reconstruct.push(result);\n        }\n      }\n\n      // Reconstruct / present results according to four combinations : D, DA, NDA, NDAA\n      if (options.partitioned) {\n        // DA : Delimited Array of strings [0] db [1] collection [n] collection { partitioned: true, delimited: true }\n        // useful for simple future adaptations of existing persistence adapters to save collections separately\n        if (options.delimited) {\n          return reconstruct;\n        }\n        // NDAA : Non-Delimited Array with subArrays. db at [0] and collection subarrays at [n] { partitioned: true, delimited : false }\n        // This format might be the most versatile for 'rolling your own' partitioned sync or save.\n        // Memory overhead can be reduced by specifying a specific partition, but at this code path they did not, so its all.\n        else {\n          return reconstruct;\n        }\n      }\n      else {\n        // D : one big Delimited string { partitioned: false, delimited : true }\n        // This is the method Loki will use internally if 'destructured'.\n        // Little memory overhead improvements but does not require multiple asynchronous adapter call scheduling\n        if (options.delimited) {\n          // indicate no more collections\n          reconstruct.push(\"\");\n\n          return reconstruct.join(options.delimiter);\n        }\n        // NDA : Non-Delimited Array : one iterable array with empty string collection partitions { partitioned: false, delimited: false }\n        // This format might be best candidate for custom synchronous syncs or saves\n        else {\n          // indicate no more collections\n          reconstruct.push(\"\");\n\n          return reconstruct;\n        }\n      }\n\n      reconstruct.push(\"\");\n\n      return reconstruct.join(delim);\n    };\n\n    /**\n     * Collection level utility method to serialize a collection in a 'destructured' format\n     *\n     * @param {object=} options - used to determine output of method\n     * @param {int} options.delimited - whether to return single delimited string or an array\n     * @param {string} options.delimiter - (optional) if delimited, this is delimiter to use\n     * @param {int} options.collectionIndex -  specify which collection to serialize data for\n     *\n     * @returns {string|array} A custom, restructured aggregation of independent serializations for a single collection.\n     * @memberof Loki\n     */\n    Loki.prototype.serializeCollection = function (options) {\n      var doccount,\n        docidx,\n        resultlines = [];\n\n      options = options || {};\n\n      if (!options.hasOwnProperty(\"delimited\")) {\n        options.delimited = true;\n      }\n\n      if (!options.hasOwnProperty(\"collectionIndex\")) {\n        throw new Error(\"serializeCollection called without 'collectionIndex' option\");\n      }\n\n      doccount = this.collections[options.collectionIndex].data.length;\n\n      resultlines = [];\n\n      for (docidx = 0; docidx < doccount; docidx++) {\n        resultlines.push(JSON.stringify(this.collections[options.collectionIndex].data[docidx]));\n      }\n\n      // D and DA\n      if (options.delimited) {\n        // indicate no more documents in collection (via empty delimited string)\n        resultlines.push(\"\");\n\n        return resultlines.join(options.delimiter);\n      }\n      else {\n        // NDAA and NDA\n        return resultlines;\n      }\n    };\n\n    /**\n     * Database level destructured JSON deserialization routine to minimize memory overhead.\n     * Internally, Loki supports destructuring via loki \"serializationMethod' option and\n     * the optional LokiPartitioningAdapter class. It is also available if you wish to do\n     * your own structured persistence or data exchange.\n     *\n     * @param {string|array} destructuredSource - destructured json or array to deserialize from\n     * @param {object=} options - source format options\n     * @param {bool=} [options.partitioned=false] - whether db and each collection are separate\n     * @param {int=} options.partition - can be used to deserialize only a single partition\n     * @param {bool=} [options.delimited=true] - whether subitems are delimited or subarrays\n     * @param {string=} options.delimiter - override default delimiter\n     *\n     * @returns {object|array} An object representation of the deserialized database, not yet applied to 'this' db or document array\n     * @memberof Loki\n     */\n    Loki.prototype.deserializeDestructured = function (destructuredSource, options) {\n      var workarray = [];\n      var len, cdb;\n      var idx, collIndex = 0, collCount, lineIndex = 1, done = false;\n      var currLine, currObject;\n\n      options = options || {};\n\n      if (!options.hasOwnProperty(\"partitioned\")) {\n        options.partitioned = false;\n      }\n\n      if (!options.hasOwnProperty(\"delimited\")) {\n        options.delimited = true;\n      }\n\n      if (!options.hasOwnProperty(\"delimiter\")) {\n        options.delimiter = this.options.destructureDelimiter;\n      }\n\n      // Partitioned\n      // DA : Delimited Array of strings [0] db [1] collection [n] collection { partitioned: true, delimited: true }\n      // NDAA : Non-Delimited Array with subArrays. db at [0] and collection subarrays at [n] { partitioned: true, delimited : false }\n      // -or- single partition\n      if (options.partitioned) {\n        // handle single partition\n        if (options.hasOwnProperty('partition')) {\n          // db only\n          if (options.partition === -1) {\n            cdb = JSON.parse(destructuredSource[0]);\n\n            return cdb;\n          }\n\n          // single collection, return doc array\n          return this.deserializeCollection(destructuredSource[options.partition + 1], options);\n        }\n\n        // Otherwise we are restoring an entire partitioned db\n        cdb = JSON.parse(destructuredSource[0]);\n        collCount = cdb.collections.length;\n        for (collIndex = 0; collIndex < collCount; collIndex++) {\n          // attach each collection docarray to container collection data, add 1 to collection array index since db is at 0\n          cdb.collections[collIndex].data = this.deserializeCollection(destructuredSource[collIndex + 1], options);\n        }\n\n        return cdb;\n      }\n\n      // Non-Partitioned\n      // D : one big Delimited string { partitioned: false, delimited : true }\n      // NDA : Non-Delimited Array : one iterable array with empty string collection partitions { partitioned: false, delimited: false }\n\n      // D\n      if (options.delimited) {\n        workarray = destructuredSource.split(options.delimiter);\n        destructuredSource = null; // lower memory pressure\n        len = workarray.length;\n\n        if (len === 0) {\n          return null;\n        }\n      }\n      // NDA\n      else {\n        workarray = destructuredSource;\n      }\n\n      // first line is database and collection shells\n      cdb = JSON.parse(workarray[0]);\n      collCount = cdb.collections.length;\n      workarray[0] = null;\n\n      while (!done) {\n        currLine = workarray[lineIndex];\n\n        // empty string indicates either end of collection or end of file\n        if (workarray[lineIndex] === \"\") {\n          // if no more collections to load into, we are done\n          if (++collIndex > collCount) {\n            done = true;\n          }\n        }\n        else {\n          currObject = JSON.parse(workarray[lineIndex]);\n          cdb.collections[collIndex].data.push(currObject);\n        }\n\n        // lower memory pressure and advance iterator\n        workarray[lineIndex++] = null;\n      }\n\n      return cdb;\n    };\n\n    /**\n     * Collection level utility function to deserializes a destructured collection.\n     *\n     * @param {string|array} destructuredSource - destructured representation of collection to inflate\n     * @param {object=} options - used to describe format of destructuredSource input\n     * @param {int=} [options.delimited=false] - whether source is delimited string or an array\n     * @param {string=} options.delimiter - if delimited, this is delimiter to use (if other than default)\n     *\n     * @returns {array} an array of documents to attach to collection.data.\n     * @memberof Loki\n     */\n    Loki.prototype.deserializeCollection = function (destructuredSource, options) {\n      var workarray = [];\n      var idx, len;\n\n      options = options || {};\n\n      if (!options.hasOwnProperty(\"partitioned\")) {\n        options.partitioned = false;\n      }\n\n      if (!options.hasOwnProperty(\"delimited\")) {\n        options.delimited = true;\n      }\n\n      if (!options.hasOwnProperty(\"delimiter\")) {\n        options.delimiter = this.options.destructureDelimiter;\n      }\n\n      if (options.delimited) {\n        workarray = destructuredSource.split(options.delimiter);\n        workarray.pop();\n      }\n      else {\n        workarray = destructuredSource;\n      }\n\n      len = workarray.length;\n      for (idx = 0; idx < len; idx++) {\n        workarray[idx] = JSON.parse(workarray[idx]);\n      }\n\n      return workarray;\n    };\n\n    /**\n     * Inflates a loki database from a serialized JSON string\n     *\n     * @param {string} serializedDb - a serialized loki database string\n     * @param {object=} options - apply or override collection level settings\n     * @param {bool} options.retainDirtyFlags - whether collection dirty flags will be preserved\n     * @memberof Loki\n     */\n    Loki.prototype.loadJSON = function (serializedDb, options) {\n      var dbObject;\n      if (serializedDb.length === 0) {\n        dbObject = {};\n      } else {\n\n        // using option defined in instantiated db not what was in serialized db\n        switch (this.options.serializationMethod) {\n          case \"normal\":\n          case \"pretty\": dbObject = JSON.parse(serializedDb); break;\n          case \"destructured\": dbObject = this.deserializeDestructured(serializedDb); break;\n          default: dbObject = JSON.parse(serializedDb); break;\n        }\n      }\n\n      this.loadJSONObject(dbObject, options);\n    };\n\n    /**\n     * Inflates a loki database from a JS object\n     *\n     * @param {object} dbObject - a serialized loki database string\n     * @param {object=} options - apply or override collection level settings\n     * @param {bool} options.retainDirtyFlags - whether collection dirty flags will be preserved\n     * @memberof Loki\n     */\n    Loki.prototype.loadJSONObject = function (dbObject, options) {\n      var i = 0,\n        len = dbObject.collections ? dbObject.collections.length : 0,\n        coll,\n        copyColl,\n        clen,\n        j,\n        loader,\n        collObj;\n\n      this.name = dbObject.name;\n\n      // restore save throttled boolean only if not defined in options\n      if (dbObject.hasOwnProperty('throttledSaves') && options && !options.hasOwnProperty('throttledSaves')) {\n        this.throttledSaves = dbObject.throttledSaves;\n      }\n\n      this.collections = [];\n\n      function makeLoader(coll) {\n        var collOptions = options[coll.name];\n        var inflater;\n\n        if (collOptions.proto) {\n          inflater = collOptions.inflate || Utils.copyProperties;\n\n          return function (data) {\n            var collObj = new (collOptions.proto)();\n            inflater(data, collObj);\n            return collObj;\n          };\n        }\n\n        return collOptions.inflate;\n      }\n\n      for (i; i < len; i += 1) {\n        coll = dbObject.collections[i];\n\n        copyColl = this.addCollection(coll.name, {\n          disableChangesApi: coll.disableChangesApi,\n          disableDeltaChangesApi: coll.disableDeltaChangesApi,\n          disableMeta: coll.disableMeta,\n          disableFreeze: coll.hasOwnProperty('disableFreeze') ? coll.disableFreeze : true\n        });\n\n        copyColl.adaptiveBinaryIndices = coll.hasOwnProperty('adaptiveBinaryIndices') ? (coll.adaptiveBinaryIndices === true) : false;\n        copyColl.transactional = coll.transactional;\n        copyColl.asyncListeners = coll.asyncListeners;\n        copyColl.cloneObjects = coll.cloneObjects;\n        copyColl.cloneMethod = coll.cloneMethod || \"parse-stringify\";\n        copyColl.autoupdate = coll.autoupdate;\n        copyColl.changes = coll.changes;\n        copyColl.dirtyIds = coll.dirtyIds || [];\n\n        if (options && options.retainDirtyFlags === true) {\n          copyColl.dirty = coll.dirty;\n        }\n        else {\n          copyColl.dirty = false;\n        }\n\n        // load each element individually\n        clen = coll.data.length;\n        j = 0;\n        if (options && options.hasOwnProperty(coll.name)) {\n          loader = makeLoader(coll);\n\n          for (j; j < clen; j++) {\n            collObj = loader(coll.data[j]);\n            copyColl.data[j] = collObj;\n            copyColl.addAutoUpdateObserver(collObj);\n            if (!copyColl.disableFreeze) {\n              deepFreeze(copyColl.data[j]);\n            }\n          }\n        } else {\n\n          for (j; j < clen; j++) {\n            copyColl.data[j] = coll.data[j];\n            copyColl.addAutoUpdateObserver(copyColl.data[j]);\n            if (!copyColl.disableFreeze) {\n              deepFreeze(copyColl.data[j]);\n            }\n          }\n        }\n\n        copyColl.maxId = (typeof coll.maxId === 'undefined') ? 0 : coll.maxId;\n        if (typeof (coll.binaryIndices) !== 'undefined') {\n          copyColl.binaryIndices = coll.binaryIndices;\n        }\n        if (typeof coll.transforms !== 'undefined') {\n          copyColl.transforms = coll.transforms;\n        }\n\n        // regenerate unique indexes\n        copyColl.uniqueNames = [];\n        if (coll.hasOwnProperty(\"uniqueNames\")) {\n          copyColl.uniqueNames = coll.uniqueNames;\n        }\n\n        // in case they are loading a database created before we added dynamic views, handle undefined\n        if (typeof (coll.DynamicViews) === 'undefined') continue;\n\n        // reinflate DynamicViews and attached Resultsets\n        for (var idx = 0; idx < coll.DynamicViews.length; idx++) {\n          var colldv = coll.DynamicViews[idx];\n\n          var dv = copyColl.addDynamicView(colldv.name, colldv.options);\n          dv.resultdata = colldv.resultdata;\n          dv.resultsdirty = colldv.resultsdirty;\n          dv.filterPipeline = colldv.filterPipeline;\n          dv.sortCriteriaSimple = colldv.sortCriteriaSimple;\n          dv.sortCriteria = colldv.sortCriteria;\n          dv.sortFunction = null;\n          dv.sortDirty = colldv.sortDirty;\n          if (!copyColl.disableFreeze) {\n            deepFreeze(dv.filterPipeline);\n            if (dv.sortCriteriaSimple) {\n              deepFreeze(dv.sortCriteriaSimple);\n            } else if (dv.sortCriteria) {\n              deepFreeze(dv.sortCriteria);\n            }\n          }\n          dv.resultset.filteredrows = colldv.resultset.filteredrows;\n          dv.resultset.filterInitialized = colldv.resultset.filterInitialized;\n\n          dv.rematerialize({\n            removeWhereFilters: true\n          });\n        }\n\n        // Upgrade Logic for binary index refactoring at version 1.5\n        if (dbObject.databaseVersion < 1.5) {\n          // rebuild all indices\n          copyColl.ensureAllIndexes(true);\n          copyColl.dirty = true;\n        }\n      }\n    };\n\n    /**\n     * Emits the close event. In autosave scenarios, if the database is dirty, this will save and disable timer.\n     * Does not actually destroy the db.\n     *\n     * @param {function=} callback - (Optional) if supplied will be registered with close event before emitting.\n     * @memberof Loki\n     */\n    Loki.prototype.close = function (callback) {\n      // for autosave scenarios, we will let close perform final save (if dirty)\n      // For web use, you might call from window.onbeforeunload to shutdown database, saving pending changes\n      if (this.autosave) {\n        this.autosaveDisable();\n        if (this.autosaveDirty()) {\n          this.saveDatabase(callback);\n          callback = undefined;\n        }\n      }\n\n      if (callback) {\n        this.on('close', callback);\n      }\n      this.emit('close');\n    };\n\n    /**-------------------------+\n    | Changes API               |\n    +--------------------------*/\n\n    /**\n     * The Changes API enables the tracking the changes occurred in the collections since the beginning of the session,\n     * so it's possible to create a differential dataset for synchronization purposes (possibly to a remote db)\n     */\n\n    /**\n     * (Changes API) : takes all the changes stored in each\n     * collection and creates a single array for the entire database. If an array of names\n     * of collections is passed then only the included collections will be tracked.\n     *\n     * @param {array=} optional array of collection names. No arg means all collections are processed.\n     * @returns {array} array of changes\n     * @see private method createChange() in Collection\n     * @memberof Loki\n     */\n    Loki.prototype.generateChangesNotification = function (arrayOfCollectionNames) {\n      function getCollName(coll) {\n        return coll.name;\n      }\n      var changes = [],\n        selectedCollections = arrayOfCollectionNames || this.collections.map(getCollName);\n\n      this.collections.forEach(function (coll) {\n        if (selectedCollections.indexOf(getCollName(coll)) !== -1) {\n          changes = changes.concat(coll.getChanges());\n        }\n      });\n      return changes;\n    };\n\n    /**\n     * (Changes API) - stringify changes for network transmission\n     * @returns {string} string representation of the changes\n     * @memberof Loki\n     */\n    Loki.prototype.serializeChanges = function (collectionNamesArray) {\n      return JSON.stringify(this.generateChangesNotification(collectionNamesArray));\n    };\n\n    /**\n     * (Changes API) : clears all the changes in all collections.\n     * @memberof Loki\n     */\n    Loki.prototype.clearChanges = function () {\n      this.collections.forEach(function (coll) {\n        if (coll.flushChanges) {\n          coll.flushChanges();\n        }\n      });\n    };\n\n    /*------------------+\n    | PERSISTENCE       |\n    -------------------*/\n\n    /** there are two build in persistence adapters for internal use\n     * fs             for use in Nodejs type environments\n     * localStorage   for use in browser environment\n     * defined as helper classes here so its easy and clean to use\n     */\n\n    /**\n     * In in-memory persistence adapter for an in-memory database.\n     * This simple 'key/value' adapter is intended for unit testing and diagnostics.\n     *\n     * @param {object=} options - memory adapter options\n     * @param {boolean} [options.asyncResponses=false] - whether callbacks are invoked asynchronously\n     * @param {int} [options.asyncTimeout=50] - timeout in ms to queue callbacks\n     * @constructor LokiMemoryAdapter\n     */\n    function LokiMemoryAdapter(options) {\n      this.hashStore = {};\n      this.options = options || {};\n\n      if (!this.options.hasOwnProperty('asyncResponses')) {\n        this.options.asyncResponses = false;\n      }\n\n      if (!this.options.hasOwnProperty('asyncTimeout')) {\n        this.options.asyncTimeout = 50; // 50 ms default\n      }\n    }\n\n    /**\n     * Loads a serialized database from its in-memory store.\n     * (Loki persistence adapter interface function)\n     *\n     * @param {string} dbname - name of the database (filename/keyname)\n     * @param {function} callback - adapter callback to return load result to caller\n     * @memberof LokiMemoryAdapter\n     */\n    LokiMemoryAdapter.prototype.loadDatabase = function (dbname, callback) {\n      var self = this;\n\n      if (this.options.asyncResponses) {\n        setTimeout(function () {\n          if (self.hashStore.hasOwnProperty(dbname)) {\n            callback(self.hashStore[dbname].value);\n          }\n          else {\n            // database doesn't exist, return falsy\n            callback(null);\n          }\n        }, this.options.asyncTimeout);\n      }\n      else {\n        if (this.hashStore.hasOwnProperty(dbname)) {\n          // database doesn't exist, return falsy\n          callback(this.hashStore[dbname].value);\n        }\n        else {\n          callback(null);\n        }\n      }\n    };\n\n    /**\n     * Saves a serialized database to its in-memory store.\n     * (Loki persistence adapter interface function)\n     *\n     * @param {string} dbname - name of the database (filename/keyname)\n     * @param {function} callback - adapter callback to return load result to caller\n     * @memberof LokiMemoryAdapter\n     */\n    LokiMemoryAdapter.prototype.saveDatabase = function (dbname, dbstring, callback) {\n      var self = this;\n      var saveCount;\n\n      if (this.options.asyncResponses) {\n        setTimeout(function () {\n          saveCount = (self.hashStore.hasOwnProperty(dbname) ? self.hashStore[dbname].savecount : 0);\n\n          self.hashStore[dbname] = {\n            savecount: saveCount + 1,\n            lastsave: new Date(),\n            value: dbstring\n          };\n\n          callback();\n        }, this.options.asyncTimeout);\n      }\n      else {\n        saveCount = (this.hashStore.hasOwnProperty(dbname) ? this.hashStore[dbname].savecount : 0);\n\n        this.hashStore[dbname] = {\n          savecount: saveCount + 1,\n          lastsave: new Date(),\n          value: dbstring\n        };\n\n        callback();\n      }\n    };\n\n    /**\n     * Deletes a database from its in-memory store.\n     *\n     * @param {string} dbname - name of the database (filename/keyname)\n     * @param {function} callback - function to call when done\n     * @memberof LokiMemoryAdapter\n     */\n    LokiMemoryAdapter.prototype.deleteDatabase = function (dbname, callback) {\n      if (this.hashStore.hasOwnProperty(dbname)) {\n        delete this.hashStore[dbname];\n      }\n\n      if (typeof callback === \"function\") {\n        callback();\n      }\n    };\n\n    /**\n     * An adapter for adapters.  Converts a non reference mode adapter into a reference mode adapter\n     * which can perform destructuring and partioning.  Each collection will be stored in its own key/save and\n     * only dirty collections will be saved.  If you  turn on paging with default page size of 25megs and save\n     * a 75 meg collection it should use up roughly 3 save slots (key/value pairs sent to inner adapter).\n     * A dirty collection that spans three pages will save all three pages again\n     * Paging mode was added mainly because Chrome has issues saving 'too large' of a string within a\n     * single indexeddb row.  If a single document update causes the collection to be flagged as dirty, all\n     * of that collection's pages will be written on next save.\n     *\n     * @param {object} adapter - reference to a 'non-reference' mode loki adapter instance.\n     * @param {object=} options - configuration options for partitioning and paging\n     * @param {bool} options.paging - (default: false) set to true to enable paging collection data.\n     * @param {int} options.pageSize - (default : 25MB) you can use this to limit size of strings passed to inner adapter.\n     * @param {string} options.delimiter - allows you to override the default delimeter\n     * @constructor LokiPartitioningAdapter\n     */\n    function LokiPartitioningAdapter(adapter, options) {\n      this.mode = \"reference\";\n      this.adapter = null;\n      this.options = options || {};\n      this.dbref = null;\n      this.dbname = \"\";\n      this.pageIterator = {};\n\n      // verify user passed an appropriate adapter\n      if (adapter) {\n        if (adapter.mode === \"reference\") {\n          throw new Error(\"LokiPartitioningAdapter cannot be instantiated with a reference mode adapter\");\n        }\n        else {\n          this.adapter = adapter;\n        }\n      }\n      else {\n        throw new Error(\"LokiPartitioningAdapter requires a (non-reference mode) adapter on construction\");\n      }\n\n      // set collection paging defaults\n      if (!this.options.hasOwnProperty(\"paging\")) {\n        this.options.paging = false;\n      }\n\n      // default to page size of 25 megs (can be up to your largest serialized object size larger than this)\n      if (!this.options.hasOwnProperty(\"pageSize\")) {\n        this.options.pageSize = 25 * 1024 * 1024;\n      }\n\n      if (!this.options.hasOwnProperty(\"delimiter\")) {\n        this.options.delimiter = '$<\\n';\n      }\n    }\n\n    /**\n     * Loads a database which was partitioned into several key/value saves.\n     * (Loki persistence adapter interface function)\n     *\n     * @param {string} dbname - name of the database (filename/keyname)\n     * @param {function} callback - adapter callback to return load result to caller\n     * @memberof LokiPartitioningAdapter\n     */\n    LokiPartitioningAdapter.prototype.loadDatabase = function (dbname, callback) {\n      var self = this;\n      this.dbname = dbname;\n      this.dbref = new Loki(dbname);\n\n      // load the db container (without data)\n      this.adapter.loadDatabase(dbname, function (result) {\n        // empty database condition is for inner adapter return null/undefined/falsy\n        if (!result) {\n          // partition 0 not found so new database, no need to try to load other partitions.\n          // return same falsy result to loadDatabase to signify no database exists (yet)\n          callback(result);\n          return;\n        }\n\n        if (typeof result !== \"string\") {\n          callback(new Error(\"LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()\"));\n        }\n\n        // I will want to use loki destructuring helper methods so i will inflate into typed instance\n        var db = JSON.parse(result);\n        self.dbref.loadJSONObject(db);\n        db = null;\n\n        var clen = self.dbref.collections.length;\n\n        if (self.dbref.collections.length === 0) {\n          callback(self.dbref);\n          return;\n        }\n\n        self.pageIterator = {\n          collection: 0,\n          pageIndex: 0\n        };\n\n        self.loadNextPartition(0, function () {\n          callback(self.dbref);\n        });\n      });\n    };\n\n    /**\n     * Used to sequentially load each collection partition, one at a time.\n     *\n     * @param {int} partition - ordinal collection position to load next\n     * @param {function} callback - adapter callback to return load result to caller\n     */\n    LokiPartitioningAdapter.prototype.loadNextPartition = function (partition, callback) {\n      var keyname = this.dbname + \".\" + partition;\n      var self = this;\n\n      if (this.options.paging === true) {\n        this.pageIterator.pageIndex = 0;\n        this.loadNextPage(callback);\n        return;\n      }\n\n      this.adapter.loadDatabase(keyname, function (result) {\n        var data = self.dbref.deserializeCollection(result, { delimited: true, collectionIndex: partition });\n        self.dbref.collections[partition].data = data;\n\n        if (++partition < self.dbref.collections.length) {\n          self.loadNextPartition(partition, callback);\n        }\n        else {\n          callback();\n        }\n      });\n    };\n\n    /**\n     * Used to sequentially load the next page of collection partition, one at a time.\n     *\n     * @param {function} callback - adapter callback to return load result to caller\n     */\n    LokiPartitioningAdapter.prototype.loadNextPage = function (callback) {\n      // calculate name for next saved page in sequence\n      var keyname = this.dbname + \".\" + this.pageIterator.collection + \".\" + this.pageIterator.pageIndex;\n      var self = this;\n\n      // load whatever page is next in sequence\n      this.adapter.loadDatabase(keyname, function (result) {\n        var data = result.split(self.options.delimiter);\n        result = \"\"; // free up memory now that we have split it into array\n        var dlen = data.length;\n        var idx;\n\n        // detect if last page by presence of final empty string element and remove it if so\n        var isLastPage = (data[dlen - 1] === \"\");\n        if (isLastPage) {\n          data.pop();\n          dlen = data.length;\n          // empty collections are just a delimiter meaning two blank items\n          if (data[dlen - 1] === \"\" && dlen === 1) {\n            data.pop();\n            dlen = data.length;\n          }\n        }\n\n        // convert stringified array elements to object instances and push to collection data\n        for (idx = 0; idx < dlen; idx++) {\n          self.dbref.collections[self.pageIterator.collection].data.push(JSON.parse(data[idx]));\n          data[idx] = null;\n        }\n        data = [];\n\n        // if last page, we are done with this partition\n        if (isLastPage) {\n\n          // if there are more partitions, kick off next partition load\n          if (++self.pageIterator.collection < self.dbref.collections.length) {\n            self.loadNextPartition(self.pageIterator.collection, callback);\n          }\n          else {\n            callback();\n          }\n        }\n        else {\n          self.pageIterator.pageIndex++;\n          self.loadNextPage(callback);\n        }\n      });\n    };\n\n    /**\n     * Saves a database by partioning into separate key/value saves.\n     * (Loki 'reference mode' persistence adapter interface function)\n     *\n     * @param {string} dbname - name of the database (filename/keyname)\n     * @param {object} dbref - reference to database which we will partition and save.\n     * @param {function} callback - adapter callback to return load result to caller\n     *\n     * @memberof LokiPartitioningAdapter\n     */\n    LokiPartitioningAdapter.prototype.exportDatabase = function (dbname, dbref, callback) {\n      var self = this;\n      var idx, clen = dbref.collections.length;\n\n      this.dbref = dbref;\n      this.dbname = dbname;\n\n      // queue up dirty partitions to be saved\n      this.dirtyPartitions = [-1];\n      for (idx = 0; idx < clen; idx++) {\n        if (dbref.collections[idx].dirty) {\n          this.dirtyPartitions.push(idx);\n        }\n      }\n\n      this.saveNextPartition(function (err) {\n        callback(err);\n      });\n    };\n\n    /**\n     * Helper method used internally to save each dirty collection, one at a time.\n     *\n     * @param {function} callback - adapter callback to return load result to caller\n     */\n    LokiPartitioningAdapter.prototype.saveNextPartition = function (callback) {\n      var self = this;\n      var partition = this.dirtyPartitions.shift();\n      var keyname = this.dbname + ((partition === -1) ? \"\" : (\".\" + partition));\n\n      // if we are doing paging and this is collection partition\n      if (this.options.paging && partition !== -1) {\n        this.pageIterator = {\n          collection: partition,\n          docIndex: 0,\n          pageIndex: 0\n        };\n\n        // since saveNextPage recursively calls itself until done, our callback means this whole paged partition is finished\n        this.saveNextPage(function (err) {\n          if (self.dirtyPartitions.length === 0) {\n            callback(err);\n          }\n          else {\n            self.saveNextPartition(callback);\n          }\n        });\n        return;\n      }\n\n      // otherwise this is 'non-paged' partioning...\n      var result = this.dbref.serializeDestructured({\n        partitioned: true,\n        delimited: true,\n        partition: partition\n      });\n\n      this.adapter.saveDatabase(keyname, result, function (err) {\n        if (err) {\n          callback(err);\n          return;\n        }\n\n        if (self.dirtyPartitions.length === 0) {\n          callback(null);\n        }\n        else {\n          self.saveNextPartition(callback);\n        }\n      });\n    };\n\n    /**\n     * Helper method used internally to generate and save the next page of the current (dirty) partition.\n     *\n     * @param {function} callback - adapter callback to return load result to caller\n     */\n    LokiPartitioningAdapter.prototype.saveNextPage = function (callback) {\n      var self = this;\n      var coll = this.dbref.collections[this.pageIterator.collection];\n      var keyname = this.dbname + \".\" + this.pageIterator.collection + \".\" + this.pageIterator.pageIndex;\n      var pageLen = 0,\n        cdlen = coll.data.length,\n        delimlen = this.options.delimiter.length;\n      var serializedObject = \"\",\n        pageBuilder = \"\";\n      var doneWithPartition = false,\n        doneWithPage = false;\n\n      var pageSaveCallback = function (err) {\n        pageBuilder = \"\";\n\n        if (err) {\n          callback(err);\n        }\n\n        // update meta properties then continue process by invoking callback\n        if (doneWithPartition) {\n          callback(null);\n        }\n        else {\n          self.pageIterator.pageIndex++;\n          self.saveNextPage(callback);\n        }\n      };\n\n      if (coll.data.length === 0) {\n        doneWithPartition = true;\n      }\n\n      while (true) {\n        if (!doneWithPartition) {\n          // serialize object\n          serializedObject = JSON.stringify(coll.data[this.pageIterator.docIndex]);\n          pageBuilder += serializedObject;\n          pageLen += serializedObject.length;\n\n          // if no more documents in collection to add, we are done with partition\n          if (++this.pageIterator.docIndex >= cdlen) doneWithPartition = true;\n        }\n        // if our current page is bigger than defined pageSize, we are done with page\n        if (pageLen >= this.options.pageSize) doneWithPage = true;\n\n        // if not done with current page, need delimiter before next item\n        // if done with partition we also want a delmiter to indicate 'end of pages' final empty row\n        if (!doneWithPage || doneWithPartition) {\n          pageBuilder += this.options.delimiter;\n          pageLen += delimlen;\n        }\n\n        // if we are done with page save it and pass off to next recursive call or callback\n        if (doneWithPartition || doneWithPage) {\n          this.adapter.saveDatabase(keyname, pageBuilder, pageSaveCallback);\n          return;\n        }\n      }\n    };\n\n    /**\n     * A loki persistence adapter which persists using node fs module\n     * @constructor LokiFsAdapter\n     */\n    function LokiFsAdapter() {\n      try {\n        this.fs = require('fs');\n      } catch (e) {\n        this.fs = null;\n      }\n    }\n\n    /**\n     * loadDatabase() - Load data from file, will throw an error if the file does not exist\n     * @param {string} dbname - the filename of the database to load\n     * @param {function} callback - the callback to handle the result\n     * @memberof LokiFsAdapter\n     */\n    LokiFsAdapter.prototype.loadDatabase = function loadDatabase(dbname, callback) {\n      var self = this;\n\n      this.fs.stat(dbname, function (err, stats) {\n        if (!err && stats.isFile()) {\n          self.fs.readFile(dbname, {\n            encoding: 'utf8'\n          }, function readFileCallback(err, data) {\n            if (err) {\n              callback(new Error(err));\n            } else {\n              callback(data);\n            }\n          });\n        }\n        else {\n          callback(null);\n        }\n      });\n    };\n\n    /**\n     * saveDatabase() - save data to file, will throw an error if the file can't be saved\n     * might want to expand this to avoid dataloss on partial save\n     * @param {string} dbname - the filename of the database to load\n     * @param {function} callback - the callback to handle the result\n     * @memberof LokiFsAdapter\n     */\n    LokiFsAdapter.prototype.saveDatabase = function saveDatabase(dbname, dbstring, callback) {\n      var self = this;\n      var tmpdbname = dbname + '~';\n      this.fs.writeFile(tmpdbname, dbstring, function writeFileCallback(err) {\n        if (err) {\n          callback(new Error(err));\n        } else {\n          self.fs.rename(tmpdbname, dbname, callback);\n        }\n      });\n    };\n\n    /**\n     * deleteDatabase() - delete the database file, will throw an error if the\n     * file can't be deleted\n     * @param {string} dbname - the filename of the database to delete\n     * @param {function} callback - the callback to handle the result\n     * @memberof LokiFsAdapter\n     */\n    LokiFsAdapter.prototype.deleteDatabase = function deleteDatabase(dbname, callback) {\n      this.fs.unlink(dbname, function deleteDatabaseCallback(err) {\n        if (err) {\n          callback(new Error(err));\n        } else {\n          callback();\n        }\n      });\n    };\n\n\n    /**\n     * A loki persistence adapter which persists to web browser's local storage object\n     * @constructor LokiLocalStorageAdapter\n     */\n    function LokiLocalStorageAdapter() { }\n\n    /**\n     * loadDatabase() - Load data from localstorage\n     * @param {string} dbname - the name of the database to load\n     * @param {function} callback - the callback to handle the result\n     * @memberof LokiLocalStorageAdapter\n     */\n    LokiLocalStorageAdapter.prototype.loadDatabase = function loadDatabase(dbname, callback) {\n      if (localStorageAvailable()) {\n        callback(localStorage.getItem(dbname));\n      } else {\n        callback(new Error('localStorage is not available'));\n      }\n    };\n\n    /**\n     * saveDatabase() - save data to localstorage, will throw an error if the file can't be saved\n     * might want to expand this to avoid dataloss on partial save\n     * @param {string} dbname - the filename of the database to load\n     * @param {function} callback - the callback to handle the result\n     * @memberof LokiLocalStorageAdapter\n     */\n    LokiLocalStorageAdapter.prototype.saveDatabase = function saveDatabase(dbname, dbstring, callback) {\n      if (localStorageAvailable()) {\n        localStorage.setItem(dbname, dbstring);\n        callback(null);\n      } else {\n        callback(new Error('localStorage is not available'));\n      }\n    };\n\n    /**\n     * deleteDatabase() - delete the database from localstorage, will throw an error if it\n     * can't be deleted\n     * @param {string} dbname - the filename of the database to delete\n     * @param {function} callback - the callback to handle the result\n     * @memberof LokiLocalStorageAdapter\n     */\n    LokiLocalStorageAdapter.prototype.deleteDatabase = function deleteDatabase(dbname, callback) {\n      if (localStorageAvailable()) {\n        localStorage.removeItem(dbname);\n        callback(null);\n      } else {\n        callback(new Error('localStorage is not available'));\n      }\n    };\n\n    /**\n     * Wait for throttledSaves to complete and invoke your callback when drained or duration is met.\n     *\n     * @param {function} callback - callback to fire when save queue is drained, it is passed a sucess parameter value\n     * @param {object=} options - configuration options\n     * @param {boolean} options.recursiveWait - (default: true) if after queue is drained, another save was kicked off, wait for it\n     * @param {bool} options.recursiveWaitLimit - (default: false) limit our recursive waiting to a duration\n     * @param {int} options.recursiveWaitLimitDelay - (default: 2000) cutoff in ms to stop recursively re-draining\n     * @memberof Loki\n     */\n    Loki.prototype.throttledSaveDrain = function (callback, options) {\n      var self = this;\n      var now = (new Date()).getTime();\n\n      if (!this.throttledSaves) {\n        callback(true);\n      }\n\n      options = options || {};\n      if (!options.hasOwnProperty('recursiveWait')) {\n        options.recursiveWait = true;\n      }\n      if (!options.hasOwnProperty('recursiveWaitLimit')) {\n        options.recursiveWaitLimit = false;\n      }\n      if (!options.hasOwnProperty('recursiveWaitLimitDuration')) {\n        options.recursiveWaitLimitDuration = 2000;\n      }\n      if (!options.hasOwnProperty('started')) {\n        options.started = (new Date()).getTime();\n      }\n\n      // if save is pending\n      if (this.throttledSaves && this.throttledSavePending) {\n        // if we want to wait until we are in a state where there are no pending saves at all\n        if (options.recursiveWait) {\n          // queue the following meta callback for when it completes\n          this.throttledCallbacks.push(function () {\n            // if there is now another save pending...\n            if (self.throttledSavePending) {\n              // if we wish to wait only so long and we have exceeded limit of our waiting, callback with false success value\n              if (options.recursiveWaitLimit && (now - options.started > options.recursiveWaitLimitDuration)) {\n                callback(false);\n                return;\n              }\n              // it must be ok to wait on next queue drain\n              self.throttledSaveDrain(callback, options);\n              return;\n            }\n            // no pending saves so callback with true success\n            else {\n              callback(true);\n              return;\n            }\n          });\n        }\n        // just notify when current queue is depleted\n        else {\n          this.throttledCallbacks.push(callback);\n          return;\n        }\n      }\n      // no save pending, just callback\n      else {\n        callback(true);\n      }\n    };\n\n    /**\n     * Internal load logic, decoupled from throttling/contention logic\n     *\n     * @param {object} options - not currently used (remove or allow overrides?)\n     * @param {function=} callback - (Optional) user supplied async callback / error handler\n     */\n    Loki.prototype.loadDatabaseInternal = function (options, callback) {\n      var cFun = callback || function (err, data) {\n        if (err) {\n          throw err;\n        }\n      },\n        self = this;\n\n      // the persistenceAdapter should be present if all is ok, but check to be sure.\n      if (this.persistenceAdapter !== null) {\n\n        this.persistenceAdapter.loadDatabase(this.filename, function loadDatabaseCallback(dbString) {\n          if (typeof (dbString) === 'string') {\n            var parseSuccess = false;\n            try {\n              self.loadJSON(dbString, options || {});\n              parseSuccess = true;\n            } catch (err) {\n              cFun(err);\n            }\n            if (parseSuccess) {\n              cFun(null);\n              self.emit('loaded', 'database ' + self.filename + ' loaded');\n            }\n          } else {\n            // falsy result means new database\n            if (!dbString) {\n              cFun(null);\n              self.emit('loaded', 'empty database ' + self.filename + ' loaded');\n              return;\n            }\n\n            // instanceof error means load faulted\n            if (dbString instanceof Error) {\n              cFun(dbString);\n              return;\n            }\n\n            // if adapter has returned an js object (other than null or error) attempt to load from JSON object\n            if (typeof (dbString) === \"object\") {\n              self.loadJSONObject(dbString, options || {});\n              cFun(null); // return null on success\n              self.emit('loaded', 'database ' + self.filename + ' loaded');\n              return;\n            }\n\n            cFun(\"unexpected adapter response : \" + dbString);\n          }\n        });\n\n      } else {\n        cFun(new Error('persistenceAdapter not configured'));\n      }\n    };\n\n    /**\n     * Handles manually loading from file system, local storage, or adapter (such as indexeddb)\n     *    This method utilizes loki configuration options (if provided) to determine which\n     *    persistence method to use, or environment detection (if configuration was not provided).\n     *    To avoid contention with any throttledSaves, we will drain the save queue first.\n     *\n     * If you are configured with autosave, you do not need to call this method yourself.\n     *\n     * @param {object} options - if throttling saves and loads, this controls how we drain save queue before loading\n     * @param {boolean} options.recursiveWait - (default: true) wait recursively until no saves are queued\n     * @param {bool} options.recursiveWaitLimit - (default: false) limit our recursive waiting to a duration\n     * @param {int} options.recursiveWaitLimitDelay - (default: 2000) cutoff in ms to stop recursively re-draining\n     * @param {function=} callback - (Optional) user supplied async callback / error handler\n     * @memberof Loki\n     * @example\n     * db.loadDatabase({}, function(err) {\n     *   if (err) {\n     *     console.log(\"error : \" + err);\n     *   }\n     *   else {\n     *     console.log(\"database loaded.\");\n     *   }\n     * });\n     */\n    Loki.prototype.loadDatabase = function (options, callback) {\n      var self = this;\n\n      // if throttling disabled, just call internal\n      if (!this.throttledSaves) {\n        this.loadDatabaseInternal(options, callback);\n        return;\n      }\n\n      // try to drain any pending saves in the queue to lock it for loading\n      this.throttledSaveDrain(function (success) {\n        if (success) {\n          // pause/throttle saving until loading is done\n          self.throttledSavePending = true;\n\n          self.loadDatabaseInternal(options, function (err) {\n            // now that we are finished loading, if no saves were throttled, disable flag\n            if (self.throttledCallbacks.length === 0) {\n              self.throttledSavePending = false;\n            }\n            // if saves requests came in while loading, kick off new save to kick off resume saves\n            else {\n              self.saveDatabase();\n            }\n\n            if (typeof callback === 'function') {\n              callback(err);\n            }\n          });\n          return;\n        }\n        else {\n          if (typeof callback === 'function') {\n            callback(new Error(\"Unable to pause save throttling long enough to read database\"));\n          }\n        }\n      }, options);\n    };\n\n    /**\n     * Internal save logic, decoupled from save throttling logic\n     */\n    Loki.prototype.saveDatabaseInternal = function (callback) {\n      var cFun = callback || function (err) {\n        if (err) {\n          throw err;\n        }\n        return;\n      };\n      var self = this;\n\n      // the persistenceAdapter should be present if all is ok, but check to be sure.\n      if (!this.persistenceAdapter) {\n        cFun(new Error('persistenceAdapter not configured'));\n        return;\n      }\n\n      // run incremental, reference, or normal mode adapters, depending on what's available\n      if (this.persistenceAdapter.mode === \"incremental\") {\n        var cachedDirty;\n        // ignore autosave until we copy loki (only then we can clear dirty flags,\n        // but if we don't do it now, autosave will be triggered a lot unnecessarily)\n        this.ignoreAutosave = true;\n        this.persistenceAdapter.saveDatabase(\n          this.filename,\n          function getLokiCopy() {\n            self.ignoreAutosave = false;\n            if (cachedDirty) {\n              cFun(new Error('adapter error - getLokiCopy called more than once'));\n              return;\n            }\n            var lokiCopy = self.copy({ removeNonSerializable: true });\n\n            // remember and clear dirty ids -- we must do it before the save so that if\n            // and update occurs between here and callback, it will get saved later\n            cachedDirty = self.collections.map(function (collection) {\n              return [collection.dirty, collection.dirtyIds];\n            });\n            self.collections.forEach(function (col) {\n              col.dirty = false;\n              col.dirtyIds = [];\n            });\n            return lokiCopy;\n          },\n          function exportDatabaseCallback(err) {\n            self.ignoreAutosave = false;\n            if (err && cachedDirty) {\n              // roll back dirty IDs to be saved later\n              self.collections.forEach(function (col, i) {\n                var cached = cachedDirty[i];\n                col.dirty = col.dirty || cached[0];\n                col.dirtyIds = col.dirtyIds.concat(cached[1]);\n              });\n            }\n            cFun(err);\n          });\n      } else if (this.persistenceAdapter.mode === \"reference\" && typeof this.persistenceAdapter.exportDatabase === \"function\") {\n        // TODO: dirty should be cleared here\n        // filename may seem redundant but loadDatabase will need to expect this same filename\n        this.persistenceAdapter.exportDatabase(this.filename, this.copy({ removeNonSerializable: true }), function exportDatabaseCallback(err) {\n          self.autosaveClearFlags();\n          cFun(err);\n        });\n      }\n      // otherwise just pass the serialized database to adapter\n      else {\n        // persistenceAdapter might be asynchronous, so we must clear `dirty` immediately\n        // or autosave won't work if an update occurs between here and the callback\n        // TODO: This should be stored and rolled back in case of DB save failure\n        this.autosaveClearFlags();\n        this.persistenceAdapter.saveDatabase(this.filename, this.serialize(), function saveDatabasecallback(err) {\n          cFun(err);\n        });\n      }\n    };\n\n    /**\n     * Handles manually saving to file system, local storage, or adapter (such as indexeddb)\n     *    This method utilizes loki configuration options (if provided) to determine which\n     *    persistence method to use, or environment detection (if configuration was not provided).\n     *\n     * If you are configured with autosave, you do not need to call this method yourself.\n     *\n     * @param {function=} callback - (Optional) user supplied async callback / error handler\n     * @memberof Loki\n     * @example\n     * db.saveDatabase(function(err) {\n     *   if (err) {\n     *     console.log(\"error : \" + err);\n     *   }\n     *   else {\n     *     console.log(\"database saved.\");\n     *   }\n     * });\n     */\n    Loki.prototype.saveDatabase = function (callback) {\n      if (!this.throttledSaves) {\n        this.saveDatabaseInternal(callback);\n        return;\n      }\n\n      if (this.throttledSavePending) {\n        this.throttledCallbacks.push(callback);\n        return;\n      }\n\n      var localCallbacks = this.throttledCallbacks;\n      this.throttledCallbacks = [];\n      localCallbacks.unshift(callback);\n      this.throttledSavePending = true;\n\n      var self = this;\n      this.saveDatabaseInternal(function (err) {\n        self.throttledSavePending = false;\n        localCallbacks.forEach(function (pcb) {\n          if (typeof pcb === 'function') {\n            // Queue the callbacks so we first finish this method execution\n            setTimeout(function () {\n              pcb(err);\n            }, 1);\n          }\n        });\n\n        // since this is called async, future requests may have come in, if so.. kick off next save\n        if (self.throttledCallbacks.length > 0) {\n          self.saveDatabase();\n        }\n      });\n    };\n\n    // alias\n    Loki.prototype.save = Loki.prototype.saveDatabase;\n\n    /**\n     * Handles deleting a database from file system, local\n     *    storage, or adapter (indexeddb)\n     *    This method utilizes loki configuration options (if provided) to determine which\n     *    persistence method to use, or environment detection (if configuration was not provided).\n     *\n     * @param {function=} callback - (Optional) user supplied async callback / error handler\n     * @memberof Loki\n     */\n    Loki.prototype.deleteDatabase = function (options, callback) {\n      var cFun = callback || function (err, data) {\n        if (err) {\n          throw err;\n        }\n      };\n\n      // we aren't even using options, so we will support syntax where\n      // callback is passed as first and only argument\n      if (typeof options === 'function' && !callback) {\n        cFun = options;\n      }\n\n      // the persistenceAdapter should be present if all is ok, but check to be sure.\n      if (this.persistenceAdapter !== null) {\n        this.persistenceAdapter.deleteDatabase(this.filename, function deleteDatabaseCallback(err) {\n          cFun(err);\n        });\n      } else {\n        cFun(new Error('persistenceAdapter not configured'));\n      }\n    };\n\n    /**\n     * autosaveDirty - check whether any collections are 'dirty' meaning we need to save (entire) database\n     *\n     * @returns {boolean} - true if database has changed since last autosave, false if not.\n     */\n    Loki.prototype.autosaveDirty = function () {\n      for (var idx = 0; idx < this.collections.length; idx++) {\n        if (this.collections[idx].dirty) {\n          return true;\n        }\n      }\n\n      return false;\n    };\n\n    /**\n     * autosaveClearFlags - resets dirty flags on all collections.\n     *    Called from saveDatabase() after db is saved.\n     *\n     */\n    Loki.prototype.autosaveClearFlags = function () {\n      for (var idx = 0; idx < this.collections.length; idx++) {\n        this.collections[idx].dirty = false;\n      }\n    };\n\n    /**\n     * autosaveEnable - begin a javascript interval to periodically save the database.\n     *\n     * @param {object} options - not currently used (remove or allow overrides?)\n     * @param {function=} callback - (Optional) user supplied async callback\n     */\n    Loki.prototype.autosaveEnable = function (options, callback) {\n      this.autosave = true;\n\n      var delay = 5000,\n        self = this;\n\n      if (typeof (this.autosaveInterval) !== 'undefined' && this.autosaveInterval !== null) {\n        delay = this.autosaveInterval;\n      }\n\n      this.autosaveHandle = setInterval(function autosaveHandleInterval() {\n        // use of dirty flag will need to be hierarchical since mods are done at collection level with no visibility of 'db'\n        // so next step will be to implement collection level dirty flags set on insert/update/remove\n        // along with loki level isdirty() function which iterates all collections to see if any are dirty\n\n        if (self.autosaveDirty() && !self.ignoreAutosave) {\n          self.saveDatabase(callback);\n        }\n      }, delay);\n    };\n\n    /**\n     * autosaveDisable - stop the autosave interval timer.\n     *\n     */\n    Loki.prototype.autosaveDisable = function () {\n      if (typeof (this.autosaveHandle) !== 'undefined' && this.autosaveHandle !== null) {\n        clearInterval(this.autosaveHandle);\n        this.autosaveHandle = null;\n      }\n    };\n\n\n    /**\n     * Resultset class allowing chainable queries.  Intended to be instanced internally.\n     *    Collection.find(), Collection.where(), and Collection.chain() instantiate this.\n     *\n     * @example\n     *    mycollection.chain()\n     *      .find({ 'doors' : 4 })\n     *      .where(function(obj) { return obj.name === 'Toyota' })\n     *      .data();\n     *\n     * @constructor Resultset\n     * @param {Collection} collection - The collection which this Resultset will query against.\n     */\n    function Resultset(collection, options) {\n      options = options || {};\n\n      // retain reference to collection we are querying against\n      this.collection = collection;\n      this.filteredrows = [];\n      this.filterInitialized = false;\n\n      return this;\n    }\n\n    /**\n     * reset() - Reset the resultset to its initial state.\n     *\n     * @returns {Resultset} Reference to this resultset, for future chain operations.\n     */\n    Resultset.prototype.reset = function () {\n      if (this.filteredrows.length > 0) {\n        this.filteredrows = [];\n      }\n      this.filterInitialized = false;\n      return this;\n    };\n\n    /**\n     * toJSON() - Override of toJSON to avoid circular references\n     *\n     */\n    Resultset.prototype.toJSON = function () {\n      var copy = this.copy();\n      copy.collection = null;\n      return copy;\n    };\n\n    /**\n     * Allows you to limit the number of documents passed to next chain operation.\n     *    A resultset copy() is made to avoid altering original resultset.\n     *\n     * @param {int} qty - The number of documents to return.\n     * @returns {Resultset} Returns a copy of the resultset, limited by qty, for subsequent chain ops.\n     * @memberof Resultset\n     * // find the two oldest users\n     * var result = users.chain().simplesort(\"age\", true).limit(2).data();\n     */\n    Resultset.prototype.limit = function (qty) {\n      // if this has no filters applied, we need to populate filteredrows first\n      if (!this.filterInitialized && this.filteredrows.length === 0) {\n        this.filteredrows = this.collection.prepareFullDocIndex();\n      }\n\n      var rscopy = new Resultset(this.collection);\n      rscopy.filteredrows = this.filteredrows.slice(0, qty);\n      rscopy.filterInitialized = true;\n      return rscopy;\n    };\n\n    /**\n     * Used for skipping 'pos' number of documents in the resultset.\n     *\n     * @param {int} pos - Number of documents to skip; all preceding documents are filtered out.\n     * @returns {Resultset} Returns a copy of the resultset, containing docs starting at 'pos' for subsequent chain ops.\n     * @memberof Resultset\n     * // find everyone but the two oldest users\n     * var result = users.chain().simplesort(\"age\", true).offset(2).data();\n     */\n    Resultset.prototype.offset = function (pos) {\n      // if this has no filters applied, we need to populate filteredrows first\n      if (!this.filterInitialized && this.filteredrows.length === 0) {\n        this.filteredrows = this.collection.prepareFullDocIndex();\n      }\n\n      var rscopy = new Resultset(this.collection);\n      rscopy.filteredrows = this.filteredrows.slice(pos);\n      rscopy.filterInitialized = true;\n      return rscopy;\n    };\n\n    /**\n     * copy() - To support reuse of resultset in branched query situations.\n     *\n     * @returns {Resultset} Returns a copy of the resultset (set) but the underlying document references will be the same.\n     * @memberof Resultset\n     */\n    Resultset.prototype.copy = function () {\n      var result = new Resultset(this.collection);\n\n      if (this.filteredrows.length > 0) {\n        result.filteredrows = this.filteredrows.slice();\n      }\n      result.filterInitialized = this.filterInitialized;\n\n      return result;\n    };\n\n    /**\n     * Alias of copy()\n     * @memberof Resultset\n     */\n    Resultset.prototype.branch = Resultset.prototype.copy;\n\n    /**\n     * transform() - executes a named collection transform or raw array of transform steps against the resultset.\n     *\n     * @param transform {(string|array)} - name of collection transform or raw transform array\n     * @param parameters {object=} - (Optional) object property hash of parameters, if the transform requires them.\n     * @returns {Resultset} either (this) resultset or a clone of of this resultset (depending on steps)\n     * @memberof Resultset\n     * @example\n     * users.addTransform('CountryFilter', [\n     *   {\n     *     type: 'find',\n     *     value: {\n     *       'country': { $eq: '[%lktxp]Country' }\n     *     }\n     *   },\n     *   {\n     *     type: 'simplesort',\n     *     property: 'age',\n     *     options: { desc: false}\n     *   }\n     * ]);\n     * var results = users.chain().transform(\"CountryFilter\", { Country: 'fr' }).data();\n     */\n    Resultset.prototype.transform = function (transform, parameters) {\n      var idx,\n        step,\n        rs = this;\n\n      // if transform is name, then do lookup first\n      if (typeof transform === 'string') {\n        if (this.collection.transforms.hasOwnProperty(transform)) {\n          transform = this.collection.transforms[transform];\n        }\n      }\n\n      // either they passed in raw transform array or we looked it up, so process\n      if (typeof transform !== 'object' || !Array.isArray(transform)) {\n        throw new Error(\"Invalid transform\");\n      }\n\n      if (typeof parameters !== 'undefined') {\n        transform = Utils.resolveTransformParams(transform, parameters);\n      }\n\n      for (idx = 0; idx < transform.length; idx++) {\n        step = transform[idx];\n\n        switch (step.type) {\n          case \"find\":\n            rs.find(step.value);\n            break;\n          case \"where\":\n            rs.where(step.value);\n            break;\n          case \"simplesort\":\n            rs.simplesort(step.property, step.desc || step.options);\n            break;\n          case \"compoundsort\":\n            rs.compoundsort(step.value);\n            break;\n          case \"sort\":\n            rs.sort(step.value);\n            break;\n          case \"limit\":\n            rs = rs.limit(step.value);\n            break; // limit makes copy so update reference\n          case \"offset\":\n            rs = rs.offset(step.value);\n            break; // offset makes copy so update reference\n          case \"map\":\n            rs = rs.map(step.value, step.dataOptions);\n            break;\n          case \"eqJoin\":\n            rs = rs.eqJoin(step.joinData, step.leftJoinKey, step.rightJoinKey, step.mapFun, step.dataOptions);\n            break;\n          // following cases break chain by returning array data so make any of these last in transform steps\n          case \"mapReduce\":\n            rs = rs.mapReduce(step.mapFunction, step.reduceFunction);\n            break;\n          // following cases update documents in current filtered resultset (use carefully)\n          case \"update\":\n            rs.update(step.value);\n            break;\n          case \"remove\":\n            rs.remove();\n            break;\n          default:\n            break;\n        }\n      }\n\n      return rs;\n    };\n\n    /**\n     * User supplied compare function is provided two documents to compare. (chainable)\n     * @example\n     *    rslt.sort(function(obj1, obj2) {\n     *      if (obj1.name === obj2.name) return 0;\n     *      if (obj1.name > obj2.name) return 1;\n     *      if (obj1.name < obj2.name) return -1;\n     *    });\n     *\n     * @param {function} comparefun - A javascript compare function used for sorting.\n     * @returns {Resultset} Reference to this resultset, sorted, for future chain operations.\n     * @memberof Resultset\n     */\n    Resultset.prototype.sort = function (comparefun) {\n      // if this has no filters applied, just we need to populate filteredrows first\n      if (!this.filterInitialized && this.filteredrows.length === 0) {\n        this.filteredrows = this.collection.prepareFullDocIndex();\n      }\n\n      var wrappedComparer =\n        (function (userComparer, data) {\n          return function (a, b) {\n            return userComparer(data[a], data[b]);\n          };\n        })(comparefun, this.collection.data);\n\n      this.filteredrows.sort(wrappedComparer);\n\n      return this;\n    };\n\n    /**\n     * Simpler, loose evaluation for user to sort based on a property name. (chainable).\n     *    Sorting based on the same lt/gt helper functions used for binary indices.\n     *\n     * @param {string} propname - name of property to sort by.\n     * @param {object|bool=} options - boolean to specify if isdescending, or options object\n     * @param {boolean} [options.desc=false] - whether to sort descending\n     * @param {boolean} [options.disableIndexIntersect=false] - whether we should explicity not use array intersection.\n     * @param {boolean} [options.forceIndexIntersect=false] - force array intersection (if binary index exists).\n     * @param {boolean} [options.useJavascriptSorting=false] - whether results are sorted via basic javascript sort.\n     * @returns {Resultset} Reference to this resultset, sorted, for future chain operations.\n     * @memberof Resultset\n     * @example\n     * var results = users.chain().simplesort('age').data();\n     */\n    Resultset.prototype.simplesort = function (propname, options) {\n      var eff,\n        targetEff = 10,\n        dc = this.collection.data.length,\n        frl = this.filteredrows.length,\n        hasBinaryIndex = this.collection.binaryIndices.hasOwnProperty(propname);\n\n      if (typeof (options) === 'undefined' || options === false) {\n        options = { desc: false };\n      }\n      if (options === true) {\n        options = { desc: true };\n      }\n\n      // if nothing in filtered rows array...\n      if (frl === 0) {\n        // if the filter is initialized to be empty resultset, do nothing\n        if (this.filterInitialized) {\n          return this;\n        }\n\n        // otherwise no filters applied implies all documents, so we need to populate filteredrows first\n\n        // if we have a binary index, we can just use that instead of sorting (again)\n        if (this.collection.binaryIndices.hasOwnProperty(propname)) {\n          // make sure index is up-to-date\n          this.collection.ensureIndex(propname);\n          // copy index values into filteredrows\n          this.filteredrows = this.collection.binaryIndices[propname].values.slice(0);\n\n          if (options.desc) {\n            this.filteredrows.reverse();\n          }\n\n          // we are done, return this (resultset) for further chain ops\n          return this;\n        }\n        // otherwise initialize array for sort below\n        else {\n          // build full document index (to be sorted subsequently)\n          this.filteredrows = this.collection.prepareFullDocIndex();\n        }\n      }\n      // otherwise we had results to begin with, see if we qualify for index intercept optimization\n      else {\n\n        // If already filtered, but we want to leverage binary index on sort.\n        // This will use custom array intection algorithm.\n        if (!options.disableIndexIntersect && hasBinaryIndex) {\n\n          // calculate filter efficiency\n          eff = dc / frl;\n\n          // when javascript sort fallback is enabled, you generally need more than ~17% of total docs in resultset\n          // before array intersect is determined to be the faster algorithm, otherwise leave at 10% for loki sort.\n          if (options.useJavascriptSorting) {\n            targetEff = 6;\n          }\n\n          // anything more than ratio of 10:1 (total documents/current results) should use old sort code path\n          // So we will only use array intersection if you have more than 10% of total docs in your current resultset.\n          if (eff <= targetEff || options.forceIndexIntersect) {\n            var idx, fr = this.filteredrows;\n            var io = {};\n            // set up hashobject for simple 'inclusion test' with existing (filtered) results\n            for (idx = 0; idx < frl; idx++) {\n              io[fr[idx]] = true;\n            }\n            // grab full sorted binary index array\n            var pv = this.collection.binaryIndices[propname].values;\n\n            // filter by existing results\n            this.filteredrows = pv.filter(function (n) { return io[n]; });\n\n            if (options.desc) {\n              this.filteredrows.reverse();\n            }\n\n            return this;\n          }\n        }\n      }\n\n      // at this point, we will not be able to leverage binary index so we will have to do an array sort\n\n      // if we have opted to use simplified javascript comparison function...\n      if (options.useJavascriptSorting) {\n        return this.sort(function (obj1, obj2) {\n          if (obj1[propname] === obj2[propname]) return 0;\n          if (obj1[propname] > obj2[propname]) return 1;\n          if (obj1[propname] < obj2[propname]) return -1;\n        });\n      }\n\n      // otherwise use loki sort which will return same results if column is indexed or not\n      var wrappedComparer =\n        (function (prop, desc, data) {\n          var val1, val2, arr;\n          return function (a, b) {\n            if (~prop.indexOf('.')) {\n              arr = prop.split('.');\n              val1 = Utils.getIn(data[a], arr, true);\n              val2 = Utils.getIn(data[b], arr, true);\n            } else {\n              val1 = data[a][prop];\n              val2 = data[b][prop];\n            }\n            return sortHelper(val1, val2, desc);\n          };\n        })(propname, options.desc, this.collection.data);\n\n      this.filteredrows.sort(wrappedComparer);\n\n      return this;\n    };\n\n    /**\n     * Allows sorting a resultset based on multiple columns.\n     * @example\n     * // to sort by age and then name (both ascending)\n     * rs.compoundsort(['age', 'name']);\n     * // to sort by age (ascending) and then by name (descending)\n     * rs.compoundsort(['age', ['name', true]]);\n     *\n     * @param {array} properties - array of property names or subarray of [propertyname, isdesc] used evaluate sort order\n     * @returns {Resultset} Reference to this resultset, sorted, for future chain operations.\n     * @memberof Resultset\n     */\n    Resultset.prototype.compoundsort = function (properties) {\n      if (properties.length === 0) {\n        throw new Error(\"Invalid call to compoundsort, need at least one property\");\n      }\n\n      var prop;\n      if (properties.length === 1) {\n        prop = properties[0];\n        if (Array.isArray(prop)) {\n          return this.simplesort(prop[0], prop[1]);\n        }\n        return this.simplesort(prop, false);\n      }\n\n      // unify the structure of 'properties' to avoid checking it repeatedly while sorting\n      for (var i = 0, len = properties.length; i < len; i += 1) {\n        prop = properties[i];\n        if (!Array.isArray(prop)) {\n          properties[i] = [prop, false];\n        }\n      }\n\n      // if this has no filters applied, just we need to populate filteredrows first\n      if (!this.filterInitialized && this.filteredrows.length === 0) {\n        this.filteredrows = this.collection.prepareFullDocIndex();\n      }\n\n      var wrappedComparer =\n        (function (props, data) {\n          return function (a, b) {\n            return compoundeval(props, data[a], data[b]);\n          };\n        })(properties, this.collection.data);\n\n      this.filteredrows.sort(wrappedComparer);\n\n      return this;\n    };\n\n    /**\n     * findOr() - oversee the operation of OR'ed query expressions.\n     *    OR'ed expression evaluation runs each expression individually against the full collection,\n     *    and finally does a set OR on each expression's results.\n     *    Each evaluation can utilize a binary index to prevent multiple linear array scans.\n     *\n     * @param {array} expressionArray - array of expressions\n     * @returns {Resultset} this resultset for further chain ops.\n     */\n    Resultset.prototype.findOr = function (expressionArray) {\n      var fr = null,\n        fri = 0,\n        frlen = 0,\n        docset = [],\n        idxset = [],\n        idx = 0,\n        origCount = this.count();\n\n      // If filter is already initialized, then we query against only those items already in filter.\n      // This means no index utilization for fields, so hopefully its filtered to a smallish filteredrows.\n      for (var ei = 0, elen = expressionArray.length; ei < elen; ei++) {\n        // we need to branch existing query to run each filter separately and combine results\n        fr = this.branch().find(expressionArray[ei]).filteredrows;\n        frlen = fr.length;\n\n        // add any document 'hits'\n        for (fri = 0; fri < frlen; fri++) {\n          idx = fr[fri];\n          if (idxset[idx] === undefined) {\n            idxset[idx] = true;\n            docset.push(idx);\n          }\n        }\n      }\n\n      this.filteredrows = docset;\n      this.filterInitialized = true;\n\n      return this;\n    };\n    Resultset.prototype.$or = Resultset.prototype.findOr;\n\n    // precompile recursively\n    function precompileQuery(operator, value) {\n      // for regex ops, precompile\n      if (operator === '$regex') {\n        if (Array.isArray(value)) {\n          value = new RegExp(value[0], value[1]);\n        } else if (!(value instanceof RegExp)) {\n          value = new RegExp(value);\n        }\n      }\n      else if (typeof value === 'object') {\n        for (var key in value) {\n          if (key === '$regex' || typeof value[key] === 'object') {\n            value[key] = precompileQuery(key, value[key]);\n          }\n        }\n      }\n\n      return value;\n    }\n\n    /**\n     * findAnd() - oversee the operation of AND'ed query expressions.\n     *    AND'ed expression evaluation runs each expression progressively against the full collection,\n     *    internally utilizing existing chained resultset functionality.\n     *    Only the first filter can utilize a binary index.\n     *\n     * @param {array} expressionArray - array of expressions\n     * @returns {Resultset} this resultset for further chain ops.\n     */\n    Resultset.prototype.findAnd = function (expressionArray) {\n      // we have already implementing method chaining in this (our Resultset class)\n      // so lets just progressively apply user supplied and filters\n      for (var i = 0, len = expressionArray.length; i < len; i++) {\n        if (this.count() === 0) {\n          return this;\n        }\n        this.find(expressionArray[i]);\n      }\n      return this;\n    };\n    Resultset.prototype.$and = Resultset.prototype.findAnd;\n\n    /**\n     * Used for querying via a mongo-style query object.\n     *\n     * @param {object} query - A mongo-style query object used for filtering current results.\n     * @param {boolean=} firstOnly - (Optional) Used by collection.findOne()\n     * @returns {Resultset} this resultset for further chain ops.\n     * @memberof Resultset\n     * @example\n     * var over30 = users.chain().find({ age: { $gte: 30 } }).data();\n     */\n    Resultset.prototype.find = function (query, firstOnly) {\n      if (this.collection.data.length === 0) {\n        this.filteredrows = [];\n        this.filterInitialized = true;\n        return this;\n      }\n\n      var queryObject = query || 'getAll',\n        p,\n        property,\n        queryObjectOp,\n        obj,\n        operator,\n        value,\n        key,\n        searchByIndex = false,\n        result = [],\n        filters = [],\n        index = null;\n\n      // flag if this was invoked via findOne()\n      firstOnly = firstOnly || false;\n\n      if (typeof queryObject === 'object') {\n        for (p in queryObject) {\n          obj = {};\n          obj[p] = queryObject[p];\n          filters.push(obj);\n\n          if (hasOwnProperty.call(queryObject, p)) {\n            property = p;\n            queryObjectOp = queryObject[p];\n          }\n        }\n        // if more than one expression in single query object,\n        // convert implicit $and to explicit $and\n        if (filters.length > 1) {\n          return this.find({ '$and': filters }, firstOnly);\n        }\n      }\n\n      // apply no filters if they want all\n      if (!property || queryObject === 'getAll') {\n        if (firstOnly) {\n          if (this.filterInitialized) {\n            this.filteredrows = this.filteredrows.slice(0, 1);\n          } else {\n            this.filteredrows = (this.collection.data.length > 0) ? [0] : [];\n            this.filterInitialized = true;\n          }\n        }\n\n        return this;\n      }\n\n      // injecting $and and $or expression tree evaluation here.\n      if (property === '$and' || property === '$or') {\n        this[property](queryObjectOp);\n\n        // for chained find with firstonly,\n        if (firstOnly && this.filteredrows.length > 1) {\n          this.filteredrows = this.filteredrows.slice(0, 1);\n        }\n\n        return this;\n      }\n\n      // see if query object is in shorthand mode (assuming eq operator)\n      if (queryObjectOp === null || (typeof queryObjectOp !== 'object' || queryObjectOp instanceof Date)) {\n        operator = '$eq';\n        value = queryObjectOp;\n      } else if (typeof queryObjectOp === 'object') {\n        for (key in queryObjectOp) {\n          if (hasOwnProperty.call(queryObjectOp, key)) {\n            operator = key;\n            value = queryObjectOp[key];\n            break;\n          }\n        }\n      } else {\n        throw new Error('Do not know what you want to do.');\n      }\n\n      if (operator === '$regex' || typeof value === 'object') {\n        value = precompileQuery(operator, value);\n      }\n\n      // if user is deep querying the object such as find('name.first': 'odin')\n      var usingDotNotation = (property.indexOf('.') !== -1);\n\n      // if an index exists for the property being queried against, use it\n      // for now only enabling where it is the first filter applied and prop is indexed\n      var doIndexCheck = !this.filterInitialized;\n\n      if (doIndexCheck && this.collection.binaryIndices[property] && indexedOps[operator]) {\n        // this is where our lazy index rebuilding will take place\n        // basically we will leave all indexes dirty until we need them\n        // so here we will rebuild only the index tied to this property\n        // ensureIndex() will only rebuild if flagged as dirty since we are not passing force=true param\n        if (this.collection.adaptiveBinaryIndices !== true) {\n          this.collection.ensureIndex(property);\n        }\n\n        searchByIndex = true;\n        index = this.collection.binaryIndices[property];\n      }\n\n      // opportunistically speed up $in searches from O(n*m) to O(n*log m)\n      if (!searchByIndex && operator === '$in' && Array.isArray(value) && typeof Set !== 'undefined') {\n        value = new Set(value);\n        operator = '$inSet';\n      }\n\n      // the comparison function\n      var fun = LokiOps[operator];\n\n      // \"shortcut\" for collection data\n      var t = this.collection.data;\n      // filter data length\n      var i = 0,\n        len = 0;\n\n      // Query executed differently depending on :\n      //    - whether the property being queried has an index defined\n      //    - if chained, we handle first pass differently for initial filteredrows[] population\n      //\n      // For performance reasons, each case has its own if block to minimize in-loop calculations\n\n      var filter, rowIdx = 0, record;\n\n      // If the filteredrows[] is already initialized, use it\n      if (this.filterInitialized) {\n        filter = this.filteredrows;\n        len = filter.length;\n\n        // currently supporting dot notation for non-indexed conditions only\n        if (usingDotNotation) {\n          property = property.split('.');\n          for (i = 0; i < len; i++) {\n            rowIdx = filter[i];\n            record = t[rowIdx];\n            if (dotSubScan(record, property, fun, value, record)) {\n              result.push(rowIdx);\n              if (firstOnly) {\n                this.filteredrows = result;\n                return this;\n              }\n            }\n          }\n        } else {\n          for (i = 0; i < len; i++) {\n            rowIdx = filter[i];\n            record = t[rowIdx];\n            if (fun(record[property], value, record)) {\n              result.push(rowIdx);\n              if (firstOnly) {\n                this.filteredrows = result;\n                return this;\n              }\n            }\n          }\n        }\n      }\n      // first chained query so work against data[] but put results in filteredrows\n      else {\n        // if not searching by index\n        if (!searchByIndex) {\n          len = t.length;\n\n          if (usingDotNotation) {\n            property = property.split('.');\n            for (i = 0; i < len; i++) {\n              record = t[i];\n              if (dotSubScan(record, property, fun, value, record)) {\n                result.push(i);\n                if (firstOnly) {\n                  this.filteredrows = result;\n                  this.filterInitialized = true;\n                  return this;\n                }\n              }\n            }\n          } else {\n            for (i = 0; i < len; i++) {\n              record = t[i];\n              if (fun(record[property], value, record)) {\n                result.push(i);\n                if (firstOnly) {\n                  this.filteredrows = result;\n                  this.filterInitialized = true;\n                  return this;\n                }\n              }\n            }\n          }\n        } else {\n          // search by index\n          var segm = this.collection.calculateRange(operator, property, value);\n\n          if (operator !== '$in') {\n            for (i = segm[0]; i <= segm[1]; i++) {\n              if (indexedOps[operator] !== true) {\n                // must be a function, implying 2nd phase filtering of results from calculateRange\n                if (indexedOps[operator](Utils.getIn(t[index.values[i]], property, usingDotNotation), value)) {\n                  result.push(index.values[i]);\n                  if (firstOnly) {\n                    this.filteredrows = result;\n                    this.filterInitialized = true;\n                    return this;\n                  }\n                }\n              }\n              else {\n                result.push(index.values[i]);\n                if (firstOnly) {\n                  this.filteredrows = result;\n                  this.filterInitialized = true;\n                  return this;\n                }\n              }\n            }\n          } else {\n            for (i = 0, len = segm.length; i < len; i++) {\n              result.push(index.values[segm[i]]);\n              if (firstOnly) {\n                this.filteredrows = result;\n                this.filterInitialized = true;\n                return this;\n              }\n            }\n          }\n        }\n\n      }\n\n      this.filteredrows = result;\n      this.filterInitialized = true; // next time work against filteredrows[]\n      return this;\n    };\n\n\n    /**\n     * where() - Used for filtering via a javascript filter function.\n     *\n     * @param {function} fun - A javascript function used for filtering current results by.\n     * @returns {Resultset} this resultset for further chain ops.\n     * @memberof Resultset\n     * @example\n     * var over30 = users.chain().where(function(obj) { return obj.age >= 30; }.data();\n     */\n    Resultset.prototype.where = function (fun) {\n      var viewFunction,\n        result = [];\n\n      if ('function' === typeof fun) {\n        viewFunction = fun;\n      } else {\n        throw new TypeError('Argument is not a stored view or a function');\n      }\n      try {\n        // If the filteredrows[] is already initialized, use it\n        if (this.filterInitialized) {\n          var j = this.filteredrows.length;\n\n          while (j--) {\n            if (viewFunction(this.collection.data[this.filteredrows[j]]) === true) {\n              result.push(this.filteredrows[j]);\n            }\n          }\n\n          this.filteredrows = result;\n\n          return this;\n        }\n        // otherwise this is initial chained op, work against data, push into filteredrows[]\n        else {\n          var k = this.collection.data.length;\n\n          while (k--) {\n            if (viewFunction(this.collection.data[k]) === true) {\n              result.push(k);\n            }\n          }\n\n          this.filteredrows = result;\n          this.filterInitialized = true;\n\n          return this;\n        }\n      } catch (err) {\n        throw err;\n      }\n    };\n\n    /**\n     * count() - returns the number of documents in the resultset.\n     *\n     * @returns {number} The number of documents in the resultset.\n     * @memberof Resultset\n     * @example\n     * var over30Count = users.chain().find({ age: { $gte: 30 } }).count();\n     */\n    Resultset.prototype.count = function () {\n      if (this.filterInitialized) {\n        return this.filteredrows.length;\n      }\n      return this.collection.count();\n    };\n\n    /**\n     * Terminates the chain and returns array of filtered documents\n     *\n     * @param {object=} options - allows specifying 'forceClones' and 'forceCloneMethod' options.\n     * @param {boolean} options.forceClones - Allows forcing the return of cloned objects even when\n     *        the collection is not configured for clone object.\n     * @param {string} options.forceCloneMethod - Allows overriding the default or collection specified cloning method.\n     *        Possible values include 'parse-stringify', 'jquery-extend-deep', 'shallow', 'shallow-assign'\n     * @param {bool} options.removeMeta - Will force clones and strip $loki and meta properties from documents\n     *\n     * @returns {array} Array of documents in the resultset\n     * @memberof Resultset\n     * @example\n     * var resutls = users.chain().find({ age: 34 }).data();\n     */\n    Resultset.prototype.data = function (options) {\n      var result = [],\n        data = this.collection.data,\n        obj,\n        len,\n        i,\n        method;\n\n      options = options || {};\n\n      // if user opts to strip meta, then force clones and use 'shallow' if 'force' options are not present\n      if (options.removeMeta && !options.forceClones) {\n        options.forceClones = true;\n        options.forceCloneMethod = options.forceCloneMethod || 'shallow';\n      }\n\n      // if collection has delta changes active, then force clones and use 'parse-stringify' for effective change tracking of nested objects\n      // if collection is immutable freeze and unFreeze takes care of cloning\n      if (!this.collection.disableDeltaChangesApi && this.collection.disableFreeze) {\n        options.forceClones = true;\n        options.forceCloneMethod = 'parse-stringify';\n      }\n\n      // if this has no filters applied, just return collection.data\n      if (!this.filterInitialized) {\n        if (this.filteredrows.length === 0) {\n          // determine whether we need to clone objects or not\n          if (this.collection.cloneObjects || options.forceClones) {\n            len = data.length;\n            method = options.forceCloneMethod || this.collection.cloneMethod;\n            for (i = 0; i < len; i++) {\n              obj = clone(data[i], method);\n              if (options.removeMeta) {\n                delete obj.$loki;\n                delete obj.meta;\n              }\n              result.push(obj);\n            }\n            return result;\n          }\n          // otherwise we are not cloning so return sliced array with same object references\n          else {\n            return data.slice();\n          }\n        } else {\n          // filteredrows must have been set manually, so use it\n          this.filterInitialized = true;\n        }\n      }\n\n      var fr = this.filteredrows;\n      len = fr.length;\n\n      if (this.collection.cloneObjects || options.forceClones) {\n        method = options.forceCloneMethod || this.collection.cloneMethod;\n        for (i = 0; i < len; i++) {\n          obj = clone(data[fr[i]], method);\n          if (options.removeMeta) {\n            delete obj.$loki;\n            delete obj.meta;\n          }\n          result.push(obj);\n        }\n      } else {\n        for (i = 0; i < len; i++) {\n          result.push(data[fr[i]]);\n        }\n      }\n      return result;\n    };\n\n    /**\n     * Used to run an update operation on all documents currently in the resultset.\n     *\n     * @param {function} updateFunction - User supplied updateFunction(obj) will be executed for each document object.\n     * @returns {Resultset} this resultset for further chain ops.\n     * @memberof Resultset\n     * @example\n     * users.chain().find({ country: 'de' }).update(function(user) {\n     *   user.phoneFormat = \"+49 AAAA BBBBBB\";\n     * });\n     */\n    Resultset.prototype.update = function (updateFunction) {\n\n      if (typeof (updateFunction) !== \"function\") {\n        throw new TypeError('Argument is not a function');\n      }\n\n      // if this has no filters applied, we need to populate filteredrows first\n      if (!this.filterInitialized && this.filteredrows.length === 0) {\n        this.filteredrows = this.collection.prepareFullDocIndex();\n      }\n\n      var obj, len = this.filteredrows.length,\n        rcd = this.collection.data;\n\n      // pass in each document object currently in resultset to user supplied updateFunction\n      for (var idx = 0; idx < len; idx++) {\n        // if we have cloning option specified or are doing differential delta changes, clone object first\n        if (!this.disableFreeze || this.collection.cloneObjects || !this.collection.disableDeltaChangesApi) {\n          obj = clone(rcd[this.filteredrows[idx]], this.collection.cloneMethod);\n          updateFunction(obj);\n          this.collection.update(obj);\n        }\n        else {\n          // no need to clone, so just perform update on collection data object instance\n          updateFunction(rcd[this.filteredrows[idx]]);\n          this.collection.update(rcd[this.filteredrows[idx]]);\n        }\n      }\n\n      return this;\n    };\n\n    /**\n     * Removes all document objects which are currently in resultset from collection (as well as resultset)\n     *\n     * @returns {Resultset} this (empty) resultset for further chain ops.\n     * @memberof Resultset\n     * @example\n     * // remove users inactive since 1/1/2001\n     * users.chain().find({ lastActive: { $lte: new Date(\"1/1/2001\").getTime() } }).remove();\n     */\n    Resultset.prototype.remove = function () {\n\n      // if this has no filters applied, we need to populate filteredrows first\n      if (!this.filterInitialized && this.filteredrows.length === 0) {\n        this.filteredrows = this.collection.prepareFullDocIndex();\n      }\n\n      this.collection.removeBatchByPositions(this.filteredrows);\n\n      this.filteredrows = [];\n\n      return this;\n    };\n\n    /**\n     * data transformation via user supplied functions\n     *\n     * @param {function} mapFunction - this function accepts a single document for you to transform and return\n     * @param {function} reduceFunction - this function accepts many (array of map outputs) and returns single value\n     * @returns {value} The output of your reduceFunction\n     * @memberof Resultset\n     * @example\n     * var db = new loki(\"order.db\");\n     * var orders = db.addCollection(\"orders\");\n     * orders.insert([{ qty: 4, unitCost: 100.00 }, { qty: 10, unitCost: 999.99 }, { qty: 2, unitCost: 49.99 }]);\n     *\n     * function mapfun (obj) { return obj.qty*obj.unitCost };\n     * function reducefun(array) {\n     *   var grandTotal=0;\n     *   array.forEach(function(orderTotal) { grandTotal += orderTotal; });\n     *   return grandTotal;\n     * }\n     * var grandOrderTotal = orders.chain().mapReduce(mapfun, reducefun);\n     * console.log(grandOrderTotal);\n     */\n    Resultset.prototype.mapReduce = function (mapFunction, reduceFunction) {\n      try {\n        return reduceFunction(this.data().map(mapFunction));\n      } catch (err) {\n        throw err;\n      }\n    };\n\n    /**\n     * eqJoin() - Left joining two sets of data. Join keys can be defined or calculated properties\n     * eqJoin expects the right join key values to be unique.  Otherwise left data will be joined on the last joinData object with that key\n     * @param {Array|Resultset|Collection} joinData - Data array to join to.\n     * @param {(string|function)} leftJoinKey - Property name in this result set to join on or a function to produce a value to join on\n     * @param {(string|function)} rightJoinKey - Property name in the joinData to join on or a function to produce a value to join on\n     * @param {function=} mapFun - (Optional) A function that receives each matching pair and maps them into output objects - function(left,right){return joinedObject}\n     * @param {object=} dataOptions - options to data() before input to your map function\n     * @param {bool} dataOptions.removeMeta - allows removing meta before calling mapFun\n     * @param {boolean} dataOptions.forceClones - forcing the return of cloned objects to your map object\n     * @param {string} dataOptions.forceCloneMethod - Allows overriding the default or collection specified cloning method.\n     * @returns {Resultset} A resultset with data in the format [{left: leftObj, right: rightObj}]\n     * @memberof Resultset\n     * @example\n     * var db = new loki('sandbox.db');\n     *\n     * var products = db.addCollection('products');\n     * var orders = db.addCollection('orders');\n     *\n     * products.insert({ productId: \"100234\", name: \"flywheel energy storage\", unitCost: 19999.99 });\n     * products.insert({ productId: \"140491\", name: \"300F super capacitor\", unitCost: 129.99 });\n     * products.insert({ productId: \"271941\", name: \"fuel cell\", unitCost: 3999.99 });\n     * products.insert({ productId: \"174592\", name: \"390V 3AH lithium bank\", unitCost: 4999.99 });\n     *\n     * orders.insert({ orderDate : new Date(\"12/1/2017\").getTime(), prodId: \"174592\", qty: 2, customerId: 2 });\n     * orders.insert({ orderDate : new Date(\"4/15/2016\").getTime(), prodId: \"271941\", qty: 1, customerId: 1 });\n     * orders.insert({ orderDate : new Date(\"3/12/2017\").getTime(), prodId: \"140491\", qty: 4, customerId: 4 });\n     * orders.insert({ orderDate : new Date(\"7/31/2017\").getTime(), prodId: \"100234\", qty: 7, customerId: 3 });\n     * orders.insert({ orderDate : new Date(\"8/3/2016\").getTime(), prodId: \"174592\", qty: 3, customerId: 5 });\n     *\n     * var mapfun = function(left, right) {\n     *   return {\n     *     orderId: left.$loki,\n     *     orderDate: new Date(left.orderDate) + '',\n     *     customerId: left.customerId,\n     *     qty: left.qty,\n     *     productId: left.prodId,\n     *     prodName: right.name,\n     *     prodCost: right.unitCost,\n     *     orderTotal: +((right.unitCost * left.qty).toFixed(2))\n     *   };\n     * };\n     *\n     * // join orders with relevant product info via eqJoin\n     * var orderSummary = orders.chain().eqJoin(products, \"prodId\", \"productId\", mapfun).data();\n     *\n     * console.log(orderSummary);\n     */\n    Resultset.prototype.eqJoin = function (joinData, leftJoinKey, rightJoinKey, mapFun, dataOptions) {\n\n      var leftData = [],\n        leftDataLength,\n        rightData = [],\n        rightDataLength,\n        key,\n        result = [],\n        leftKeyisFunction = typeof leftJoinKey === 'function',\n        rightKeyisFunction = typeof rightJoinKey === 'function',\n        joinMap = {};\n\n      //get the left data\n      leftData = this.data(dataOptions);\n      leftDataLength = leftData.length;\n\n      //get the right data\n      if (joinData instanceof Collection) {\n        rightData = joinData.chain().data(dataOptions);\n      } else if (joinData instanceof Resultset) {\n        rightData = joinData.data(dataOptions);\n      } else if (Array.isArray(joinData)) {\n        rightData = joinData;\n      } else {\n        throw new TypeError('joinData needs to be an array or result set');\n      }\n      rightDataLength = rightData.length;\n\n      //construct a lookup table\n\n      for (var i = 0; i < rightDataLength; i++) {\n        key = rightKeyisFunction ? rightJoinKey(rightData[i]) : rightData[i][rightJoinKey];\n        joinMap[key] = rightData[i];\n      }\n\n      if (!mapFun) {\n        mapFun = function (left, right) {\n          return {\n            left: left,\n            right: right\n          };\n        };\n      }\n\n      //Run map function over each object in the resultset\n      for (var j = 0; j < leftDataLength; j++) {\n        key = leftKeyisFunction ? leftJoinKey(leftData[j]) : leftData[j][leftJoinKey];\n        result.push(mapFun(leftData[j], joinMap[key] || {}));\n      }\n\n      //return return a new resultset with no filters\n      this.collection = new Collection('joinData');\n      this.collection.insert(result);\n      this.filteredrows = [];\n      this.filterInitialized = false;\n\n      return this;\n    };\n\n    /**\n     * Applies a map function into a new collection for further chaining.\n     * @param {function} mapFun - javascript map function\n     * @param {object=} dataOptions - options to data() before input to your map function\n     * @param {bool} dataOptions.removeMeta - allows removing meta before calling mapFun\n     * @param {boolean} dataOptions.forceClones - forcing the return of cloned objects to your map object\n     * @param {string} dataOptions.forceCloneMethod - Allows overriding the default or collection specified cloning method.\n     * @memberof Resultset\n     * @example\n     * var orders.chain().find({ productId: 32 }).map(function(obj) {\n     *   return {\n     *     orderId: $loki,\n     *     productId: productId,\n     *     quantity: qty\n     *   };\n     * });\n     */\n    Resultset.prototype.map = function (mapFun, dataOptions) {\n      var data = this.data(dataOptions).map(mapFun);\n      //return return a new resultset with no filters\n      this.collection = new Collection('mappedData');\n      this.collection.insert(data);\n      this.filteredrows = [];\n      this.filterInitialized = false;\n\n      return this;\n    };\n\n    /**\n     * DynamicView class is a versatile 'live' view class which can have filters and sorts applied.\n     *    Collection.addDynamicView(name) instantiates this DynamicView object and notifies it\n     *    whenever documents are add/updated/removed so it can remain up-to-date. (chainable)\n     *\n     * @example\n     * var mydv = mycollection.addDynamicView('test');  // default is non-persistent\n     * mydv.applyFind({ 'doors' : 4 });\n     * mydv.applyWhere(function(obj) { return obj.name === 'Toyota'; });\n     * var results = mydv.data();\n     *\n     * @constructor DynamicView\n     * @implements LokiEventEmitter\n     * @param {Collection} collection - A reference to the collection to work against\n     * @param {string} name - The name of this dynamic view\n     * @param {object=} options - (Optional) Pass in object with 'persistent' and/or 'sortPriority' options.\n     * @param {boolean} [options.persistent=false] - indicates if view is to main internal results array in 'resultdata'\n     * @param {string} [options.sortPriority='passive'] - 'passive' (sorts performed on call to data) or 'active' (after updates)\n     * @param {number} options.minRebuildInterval - minimum rebuild interval (need clarification to docs here)\n     * @see {@link Collection#addDynamicView} to construct instances of DynamicView\n     */\n    function DynamicView(collection, name, options) {\n      this.collection = collection;\n      this.name = name;\n      this.rebuildPending = false;\n      this.options = options || {};\n\n      if (!this.options.hasOwnProperty('persistent')) {\n        this.options.persistent = false;\n      }\n\n      // 'persistentSortPriority':\n      // 'passive' will defer the sort phase until they call data(). (most efficient overall)\n      // 'active' will sort async whenever next idle. (prioritizes read speeds)\n      if (!this.options.hasOwnProperty('sortPriority')) {\n        this.options.sortPriority = 'passive';\n      }\n\n      if (!this.options.hasOwnProperty('minRebuildInterval')) {\n        this.options.minRebuildInterval = 1;\n      }\n\n      this.resultset = new Resultset(collection);\n      this.resultdata = [];\n      this.resultsdirty = false;\n\n      this.cachedresultset = null;\n\n      // keep ordered filter pipeline\n      this.filterPipeline = [];\n      if (!this.collection.disableFreeze) {\n        Object.freeze(this.filterPipeline);\n      }\n\n      // sorting member variables\n      // we only support one active search, applied using applySort() or applySimpleSort()\n      this.sortFunction = null;\n      this.sortCriteria = null;\n      this.sortCriteriaSimple = null;\n      this.sortDirty = false;\n\n      // for now just have 1 event for when we finally rebuilt lazy view\n      // once we refactor transactions, i will tie in certain transactional events\n\n      this.events = {\n        'rebuild': [],\n        'filter': [],\n        'sort': []\n      };\n    }\n\n    DynamicView.prototype = new LokiEventEmitter();\n    DynamicView.prototype.constructor = DynamicView;\n\n    /**\n     * getSort() - used to get the current sort\n     *\n     * @returns function (sortFunction) or array (sortCriteria) or object (sortCriteriaSimple)\n     */\n    DynamicView.prototype.getSort = function () {\n      return this.sortFunction || this.sortCriteria || this.sortCriteriaSimple;\n    };\n\n    /**\n     * rematerialize() - internally used immediately after deserialization (loading)\n     *    This will clear out and reapply filterPipeline ops, recreating the view.\n     *    Since where filters do not persist correctly, this method allows\n     *    restoring the view to state where user can re-apply those where filters.\n     *\n     * @param {Object=} options - (Optional) allows specification of 'removeWhereFilters' option\n     * @returns {DynamicView} This dynamic view for further chained ops.\n     * @memberof DynamicView\n     * @fires DynamicView.rebuild\n     */\n    DynamicView.prototype.rematerialize = function (options) {\n      var fpl,\n        fpi,\n        idx;\n\n      options = options || {};\n\n      this.resultdata = [];\n      this.resultsdirty = true;\n      this.resultset = new Resultset(this.collection);\n\n      if (this.sortFunction || this.sortCriteria || this.sortCriteriaSimple) {\n        this.sortDirty = true;\n      }\n\n      var wasFrozen = Object.isFrozen(this.filterPipeline);\n      if (options.hasOwnProperty('removeWhereFilters')) {\n        // for each view see if it had any where filters applied... since they don't\n        // serialize those functions lets remove those invalid filters\n        if (wasFrozen) {\n          this.filterPipeline = this.filterPipeline.slice();\n        }\n        fpl = this.filterPipeline.length;\n        fpi = fpl;\n        while (fpi--) {\n          if (this.filterPipeline[fpi].type === 'where') {\n            if (fpi !== this.filterPipeline.length - 1) {\n              this.filterPipeline[fpi] = this.filterPipeline[this.filterPipeline.length - 1];\n            }\n            this.filterPipeline.length--;\n          }\n        }\n      }\n\n      // back up old filter pipeline, clear filter pipeline, and reapply pipeline ops\n      var ofp = this.filterPipeline;\n      this.filterPipeline = [];\n\n      // now re-apply 'find' filterPipeline ops\n      fpl = ofp.length;\n      for (idx = 0; idx < fpl; idx++) {\n        this.applyFind(ofp[idx].val, ofp[idx].uid);\n      }\n      if (wasFrozen) {\n        Object.freeze(this.filterPipeline);\n      }\n\n      // during creation of unit tests, i will remove this forced refresh and leave lazy\n      this.data();\n\n      // emit rebuild event in case user wants to be notified\n      this.emit('rebuild', this);\n\n      return this;\n    };\n\n    /**\n     * branchResultset() - Makes a copy of the internal resultset for branched queries.\n     *    Unlike this dynamic view, the branched resultset will not be 'live' updated,\n     *    so your branched query should be immediately resolved and not held for future evaluation.\n     *\n     * @param {(string|array=)} transform - Optional name of collection transform, or an array of transform steps\n     * @param {object=} parameters - optional parameters (if optional transform requires them)\n     * @returns {Resultset} A copy of the internal resultset for branched queries.\n     * @memberof DynamicView\n     * @example\n     * var db = new loki('test');\n     * var coll = db.addCollection('mydocs');\n     * var dv = coll.addDynamicView('myview');\n     * var tx = [\n     *   {\n     *     type: 'offset',\n     *     value: '[%lktxp]pageStart'\n     *   },\n     *   {\n     *     type: 'limit',\n     *     value: '[%lktxp]pageSize'\n     *   }\n     * ];\n     * coll.addTransform('viewPaging', tx);\n     *\n     * // add some records\n     *\n     * var results = dv.branchResultset('viewPaging', { pageStart: 10, pageSize: 10 }).data();\n     */\n    DynamicView.prototype.branchResultset = function (transform, parameters) {\n      var rs = this.resultset.branch();\n\n      if (typeof transform === 'undefined') {\n        return rs;\n      }\n\n      return rs.transform(transform, parameters);\n    };\n\n    /**\n     * toJSON() - Override of toJSON to avoid circular references\n     *\n     */\n    DynamicView.prototype.toJSON = function () {\n      var copy = new DynamicView(this.collection, this.name, this.options);\n      copy.resultset = this.resultset;\n      copy.resultdata = []; // let's not save data (copy) to minimize size\n      copy.resultsdirty = true;\n      copy.filterPipeline = this.filterPipeline;\n      copy.sortFunction = this.sortFunction;\n      copy.sortCriteria = this.sortCriteria;\n      copy.sortCriteriaSimple = this.sortCriteriaSimple || null;\n      copy.sortDirty = this.sortDirty;\n\n      // avoid circular reference, reapply in db.loadJSON()\n      copy.collection = null;\n\n      return copy;\n    };\n\n    /**\n     * removeFilters() - Used to clear pipeline and reset dynamic view to initial state.\n     *     Existing options should be retained.\n     * @param {object=} options - configure removeFilter behavior\n     * @param {boolean=} options.queueSortPhase - (default: false) if true we will async rebuild view (maybe set default to true in future?)\n     * @memberof DynamicView\n     */\n    DynamicView.prototype.removeFilters = function (options) {\n      options = options || {};\n\n      this.rebuildPending = false;\n      this.resultset.reset();\n      this.resultdata = [];\n      this.resultsdirty = true;\n\n      this.cachedresultset = null;\n\n      var wasFrozen = Object.isFrozen(this.filterPipeline);\n      var filterChanged = this.filterPipeline.length > 0;\n      // keep ordered filter pipeline\n      this.filterPipeline = [];\n      if (wasFrozen) {\n        Object.freeze(this.filterPipeline);\n      }\n\n      // sorting member variables\n      // we only support one active search, applied using applySort() or applySimpleSort()\n      this.sortFunction = null;\n      this.sortCriteria = null;\n      this.sortCriteriaSimple = null;\n      this.sortDirty = false;\n\n      if (options.queueSortPhase === true) {\n        this.queueSortPhase();\n      }\n\n      if (filterChanged) {\n        this.emit('filter');\n      }\n    };\n\n    /**\n     * applySort() - Used to apply a sort to the dynamic view\n     * @example\n     * dv.applySort(function(obj1, obj2) {\n     *   if (obj1.name === obj2.name) return 0;\n     *   if (obj1.name > obj2.name) return 1;\n     *   if (obj1.name < obj2.name) return -1;\n     * });\n     *\n     * @param {function} comparefun - a javascript compare function used for sorting\n     * @returns {DynamicView} this DynamicView object, for further chain ops.\n     * @memberof DynamicView\n     */\n    DynamicView.prototype.applySort = function (comparefun) {\n      this.sortFunction = comparefun;\n      this.sortCriteria = null;\n      this.sortCriteriaSimple = null;\n\n      this.queueSortPhase();\n      this.emit('sort');\n\n      return this;\n    };\n\n    /**\n     * applySimpleSort() - Used to specify a property used for view translation.\n     * @example\n     * dv.applySimpleSort(\"name\");\n     *\n     * @param {string} propname - Name of property by which to sort.\n     * @param {object|boolean=} options - boolean for sort descending or options object\n     * @param {boolean} [options.desc=false] - whether we should sort descending.\n     * @param {boolean} [options.disableIndexIntersect=false] - whether we should explicity not use array intersection.\n     * @param {boolean} [options.forceIndexIntersect=false] - force array intersection (if binary index exists).\n     * @param {boolean} [options.useJavascriptSorting=false] - whether results are sorted via basic javascript sort.\n     * @returns {DynamicView} this DynamicView object, for further chain ops.\n     * @memberof DynamicView\n     */\n    DynamicView.prototype.applySimpleSort = function (propname, options) {\n      this.sortCriteriaSimple = { propname: propname, options: options || false };\n      if (!this.collection.disableFreeze) {\n        deepFreeze(this.sortCriteriaSimple);\n      }\n      this.sortCriteria = null;\n      this.sortFunction = null;\n\n      this.queueSortPhase();\n      this.emit('sort');\n\n      return this;\n    };\n\n    /**\n     * applySortCriteria() - Allows sorting a resultset based on multiple columns.\n     * @example\n     * // to sort by age and then name (both ascending)\n     * dv.applySortCriteria(['age', 'name']);\n     * // to sort by age (ascending) and then by name (descending)\n     * dv.applySortCriteria(['age', ['name', true]);\n     * // to sort by age (descending) and then by name (descending)\n     * dv.applySortCriteria(['age', true], ['name', true]);\n     *\n     * @param {array} properties - array of property names or subarray of [propertyname, isdesc] used evaluate sort order\n     * @returns {DynamicView} Reference to this DynamicView, sorted, for future chain operations.\n     * @memberof DynamicView\n     */\n    DynamicView.prototype.applySortCriteria = function (criteria) {\n      this.sortCriteria = criteria;\n      if (!this.collection.disableFreeze) {\n        deepFreeze(this.sortCriteria);\n      }\n      this.sortCriteriaSimple = null;\n      this.sortFunction = null;\n\n      this.queueSortPhase();\n      this.emit('sort');\n      return this;\n    };\n\n    /**\n     * startTransaction() - marks the beginning of a transaction.\n     *\n     * @returns {DynamicView} this DynamicView object, for further chain ops.\n     */\n    DynamicView.prototype.startTransaction = function () {\n      this.cachedresultset = this.resultset.copy();\n\n      return this;\n    };\n\n    /**\n     * commit() - commits a transaction.\n     *\n     * @returns {DynamicView} this DynamicView object, for further chain ops.\n     */\n    DynamicView.prototype.commit = function () {\n      this.cachedresultset = null;\n\n      return this;\n    };\n\n    /**\n     * rollback() - rolls back a transaction.\n     *\n     * @returns {DynamicView} this DynamicView object, for further chain ops.\n     */\n    DynamicView.prototype.rollback = function () {\n      this.resultset = this.cachedresultset;\n\n      if (this.options.persistent) {\n        // for now just rebuild the persistent dynamic view data in this worst case scenario\n        // (a persistent view utilizing transactions which get rolled back), we already know the filter so not too bad.\n        this.resultdata = this.resultset.data();\n\n        this.emit('rebuild', this);\n      }\n\n      return this;\n    };\n\n\n    /**\n     * Implementation detail.\n     * _indexOfFilterWithId() - Find the index of a filter in the pipeline, by that filter's ID.\n     *\n     * @param {(string|number)} uid - The unique ID of the filter.\n     * @returns {number}: index of the referenced filter in the pipeline; -1 if not found.\n     */\n    DynamicView.prototype._indexOfFilterWithId = function (uid) {\n      if (typeof uid === 'string' || typeof uid === 'number') {\n        for (var idx = 0, len = this.filterPipeline.length; idx < len; idx += 1) {\n          if (uid === this.filterPipeline[idx].uid) {\n            return idx;\n          }\n        }\n      }\n      return -1;\n    };\n\n    /**\n     * Implementation detail.\n     * _addFilter() - Add the filter object to the end of view's filter pipeline and apply the filter to the resultset.\n     *\n     * @param {object} filter - The filter object. Refer to applyFilter() for extra details.\n     */\n    DynamicView.prototype._addFilter = function (filter) {\n      var wasFrozen = Object.isFrozen(this.filterPipeline);\n      if (wasFrozen) {\n        this.filterPipeline = this.filterPipeline.slice();\n      }\n      if (!this.collection.disableFreeze) {\n        deepFreeze(filter);\n      }\n      this.filterPipeline.push(filter);\n      if (wasFrozen) {\n        Object.freeze(this.filterPipeline);\n      }\n      this.resultset[filter.type](filter.val);\n    };\n\n    /**\n     * reapplyFilters() - Reapply all the filters in the current pipeline.\n     *\n     * @returns {DynamicView} this DynamicView object, for further chain ops.\n     */\n    DynamicView.prototype.reapplyFilters = function () {\n      this.resultset.reset();\n\n      this.cachedresultset = null;\n      if (this.options.persistent) {\n        this.resultdata = [];\n        this.resultsdirty = true;\n      }\n\n      var filters = this.filterPipeline;\n      var wasFrozen = Object.isFrozen(filters);\n      this.filterPipeline = [];\n\n      for (var idx = 0, len = filters.length; idx < len; idx += 1) {\n        this._addFilter(filters[idx]);\n      }\n      if (wasFrozen) {\n        Object.freeze(this.filterPipeline);\n      }\n\n      if (this.sortFunction || this.sortCriteria || this.sortCriteriaSimple) {\n        this.queueSortPhase();\n      } else {\n        this.queueRebuildEvent();\n      }\n      this.emit('filter');\n      return this;\n    };\n\n    /**\n     * applyFilter() - Adds or updates a filter in the DynamicView filter pipeline\n     *\n     * @param {object} filter - A filter object to add to the pipeline.\n     *    The object is in the format { 'type': filter_type, 'val', filter_param, 'uid', optional_filter_id }\n     * @returns {DynamicView} this DynamicView object, for further chain ops.\n     * @memberof DynamicView\n     */\n    DynamicView.prototype.applyFilter = function (filter) {\n      var idx = this._indexOfFilterWithId(filter.uid);\n      if (idx >= 0) {\n        var wasFrozen = Object.isFrozen(this.filterPipeline);\n        if (wasFrozen) {\n          this.filterPipeline = this.filterPipeline.slice();\n        }\n        this.filterPipeline[idx] = filter;\n        if (wasFrozen) {\n          freeze(filter);\n          Object.freeze(this.filterPipeline);\n        }\n        return this.reapplyFilters();\n      }\n\n      this.cachedresultset = null;\n      if (this.options.persistent) {\n        this.resultdata = [];\n        this.resultsdirty = true;\n      }\n\n      this._addFilter(filter);\n\n      if (this.sortFunction || this.sortCriteria || this.sortCriteriaSimple) {\n        this.queueSortPhase();\n      } else {\n        this.queueRebuildEvent();\n      }\n\n      this.emit('filter');\n      return this;\n    };\n\n    /**\n     * applyFind() - Adds or updates a mongo-style query option in the DynamicView filter pipeline\n     *\n     * @param {object} query - A mongo-style query object to apply to pipeline\n     * @param {(string|number)=} uid - Optional: The unique ID of this filter, to reference it in the future.\n     * @returns {DynamicView} this DynamicView object, for further chain ops.\n     * @memberof DynamicView\n     */\n    DynamicView.prototype.applyFind = function (query, uid) {\n      this.applyFilter({\n        type: 'find',\n        val: query,\n        uid: uid\n      });\n      return this;\n    };\n\n    /**\n     * applyWhere() - Adds or updates a javascript filter function in the DynamicView filter pipeline\n     *\n     * @param {function} fun - A javascript filter function to apply to pipeline\n     * @param {(string|number)=} uid - Optional: The unique ID of this filter, to reference it in the future.\n     * @returns {DynamicView} this DynamicView object, for further chain ops.\n     * @memberof DynamicView\n     */\n    DynamicView.prototype.applyWhere = function (fun, uid) {\n      this.applyFilter({\n        type: 'where',\n        val: fun,\n        uid: uid\n      });\n      return this;\n    };\n\n    /**\n     * removeFilter() - Remove the specified filter from the DynamicView filter pipeline\n     *\n     * @param {(string|number)} uid - The unique ID of the filter to be removed.\n     * @returns {DynamicView} this DynamicView object, for further chain ops.\n     * @memberof DynamicView\n     */\n    DynamicView.prototype.removeFilter = function (uid) {\n      var idx = this._indexOfFilterWithId(uid);\n      if (idx < 0) {\n        throw new Error(\"Dynamic view does not contain a filter with ID: \" + uid);\n      }\n      var wasFrozen = Object.isFrozen(this.filterPipeline);\n      if (wasFrozen) {\n        this.filterPipeline = this.filterPipeline.slice();\n      }\n      this.filterPipeline.splice(idx, 1);\n      if (wasFrozen) {\n        Object.freeze(this.filterPipeline);\n      }\n      this.reapplyFilters();\n      return this;\n    };\n\n    /**\n     * count() - returns the number of documents representing the current DynamicView contents.\n     *\n     * @returns {number} The number of documents representing the current DynamicView contents.\n     * @memberof DynamicView\n     */\n    DynamicView.prototype.count = function () {\n      // in order to be accurate we will pay the minimum cost (and not alter dv state management)\n      // recurring resultset data resolutions should know internally its already up to date.\n      // for persistent data this will not update resultdata nor fire rebuild event.\n      if (this.resultsdirty) {\n        this.resultdata = this.resultset.data();\n      }\n\n      return this.resultset.count();\n    };\n\n    /**\n     * data() - resolves and pending filtering and sorting, then returns document array as result.\n     *\n     * @param {object=} options - optional parameters to pass to resultset.data() if non-persistent\n     * @param {boolean} options.forceClones - Allows forcing the return of cloned objects even when\n     *        the collection is not configured for clone object.\n     * @param {string} options.forceCloneMethod - Allows overriding the default or collection specified cloning method.\n     *        Possible values include 'parse-stringify', 'jquery-extend-deep', 'shallow', 'shallow-assign'\n     * @param {bool} options.removeMeta - Will force clones and strip $loki and meta properties from documents\n     * @returns {array} An array of documents representing the current DynamicView contents.\n     * @memberof DynamicView\n     */\n    DynamicView.prototype.data = function (options) {\n      // using final sort phase as 'catch all' for a few use cases which require full rebuild\n      if (this.sortDirty || this.resultsdirty) {\n        this.performSortPhase({\n          suppressRebuildEvent: true\n        });\n      }\n      return (this.options.persistent) ? (this.resultdata) : (this.resultset.data(options));\n    };\n\n    /**\n     * queueRebuildEvent() - When the view is not sorted we may still wish to be notified of rebuild events.\n     *     This event will throttle and queue a single rebuild event when batches of updates affect the view.\n     */\n    DynamicView.prototype.queueRebuildEvent = function () {\n      if (this.rebuildPending) {\n        return;\n      }\n      this.rebuildPending = true;\n\n      var self = this;\n      setTimeout(function () {\n        if (self.rebuildPending) {\n          self.rebuildPending = false;\n          self.emit('rebuild', self);\n        }\n      }, this.options.minRebuildInterval);\n    };\n\n    /**\n     * queueSortPhase : If the view is sorted we will throttle sorting to either :\n     *    (1) passive - when the user calls data(), or\n     *    (2) active - once they stop updating and yield js thread control\n     */\n    DynamicView.prototype.queueSortPhase = function () {\n      // already queued? exit without queuing again\n      if (this.sortDirty) {\n        return;\n      }\n      this.sortDirty = true;\n\n      var self = this;\n      if (this.options.sortPriority === \"active\") {\n        // active sorting... once they are done and yield js thread, run async performSortPhase()\n        setTimeout(function () {\n          self.performSortPhase();\n        }, this.options.minRebuildInterval);\n      } else {\n        // must be passive sorting... since not calling performSortPhase (until data call), lets use queueRebuildEvent to\n        // potentially notify user that data has changed.\n        this.queueRebuildEvent();\n      }\n    };\n\n    /**\n     * performSortPhase() - invoked synchronously or asynchronously to perform final sort phase (if needed)\n     *\n     */\n    DynamicView.prototype.performSortPhase = function (options) {\n      // async call to this may have been pre-empted by synchronous call to data before async could fire\n      if (!this.sortDirty && !this.resultsdirty) {\n        return;\n      }\n\n      options = options || {};\n\n      if (this.sortDirty) {\n        if (this.sortFunction) {\n          this.resultset.sort(this.sortFunction);\n        } else if (this.sortCriteria) {\n          this.resultset.compoundsort(this.sortCriteria);\n        } else if (this.sortCriteriaSimple) {\n          this.resultset.simplesort(this.sortCriteriaSimple.propname, this.sortCriteriaSimple.options);\n        }\n\n        this.sortDirty = false;\n      }\n\n      if (this.options.persistent) {\n        // persistent view, rebuild local resultdata array\n        this.resultdata = this.resultset.data();\n        this.resultsdirty = false;\n      }\n\n      if (!options.suppressRebuildEvent) {\n        this.emit('rebuild', this);\n      }\n    };\n\n    /**\n     * evaluateDocument() - internal method for (re)evaluating document inclusion.\n     *    Called by : collection.insert() and collection.update().\n     *\n     * @param {int} objIndex - index of document to (re)run through filter pipeline.\n     * @param {bool} isNew - true if the document was just added to the collection.\n     */\n    DynamicView.prototype.evaluateDocument = function (objIndex, isNew) {\n      // if no filter applied yet, the result 'set' should remain 'everything'\n      if (!this.resultset.filterInitialized) {\n        if (this.options.persistent) {\n          this.resultdata = this.resultset.data();\n        }\n        // need to re-sort to sort new document\n        if (this.sortFunction || this.sortCriteria || this.sortCriteriaSimple) {\n          this.queueSortPhase();\n        } else {\n          this.queueRebuildEvent();\n        }\n        return;\n      }\n\n      var ofr = this.resultset.filteredrows;\n      var oldPos = (isNew) ? (-1) : (ofr.indexOf(+objIndex));\n      var oldlen = ofr.length;\n\n      // creating a 1-element resultset to run filter chain ops on to see if that doc passes filters;\n      // mostly efficient algorithm, slight stack overhead price (this function is called on inserts and updates)\n      var evalResultset = new Resultset(this.collection);\n      evalResultset.filteredrows = [objIndex];\n      evalResultset.filterInitialized = true;\n      var filter;\n      for (var idx = 0, len = this.filterPipeline.length; idx < len; idx++) {\n        filter = this.filterPipeline[idx];\n        evalResultset[filter.type](filter.val);\n      }\n\n      // not a true position, but -1 if not pass our filter(s), 0 if passed filter(s)\n      var newPos = (evalResultset.filteredrows.length === 0) ? -1 : 0;\n\n      // wasn't in old, shouldn't be now... do nothing\n      if (oldPos === -1 && newPos === -1) return;\n\n      // wasn't in resultset, should be now... add\n      if (oldPos === -1 && newPos !== -1) {\n        ofr.push(objIndex);\n\n        if (this.options.persistent) {\n          this.resultdata.push(this.collection.data[objIndex]);\n        }\n\n        // need to re-sort to sort new document\n        if (this.sortFunction || this.sortCriteria || this.sortCriteriaSimple) {\n          this.queueSortPhase();\n        } else {\n          this.queueRebuildEvent();\n        }\n\n        return;\n      }\n\n      // was in resultset, shouldn't be now... delete\n      if (oldPos !== -1 && newPos === -1) {\n        if (oldPos < oldlen - 1) {\n          ofr.splice(oldPos, 1);\n\n          if (this.options.persistent) {\n            this.resultdata.splice(oldPos, 1);\n          }\n        } else {\n          ofr.length = oldlen - 1;\n\n          if (this.options.persistent) {\n            this.resultdata.length = oldlen - 1;\n          }\n        }\n\n        // in case changes to data altered a sort column\n        if (this.sortFunction || this.sortCriteria || this.sortCriteriaSimple) {\n          this.queueSortPhase();\n        } else {\n          this.queueRebuildEvent();\n        }\n\n        return;\n      }\n\n      // was in resultset, should still be now... (update persistent only?)\n      if (oldPos !== -1 && newPos !== -1) {\n        if (this.options.persistent) {\n          // in case document changed, replace persistent view data with the latest collection.data document\n          this.resultdata[oldPos] = this.collection.data[objIndex];\n        }\n\n        // in case changes to data altered a sort column\n        if (this.sortFunction || this.sortCriteria || this.sortCriteriaSimple) {\n          this.queueSortPhase();\n        } else {\n          this.queueRebuildEvent();\n        }\n\n        return;\n      }\n    };\n\n    /**\n     * removeDocument() - internal function called on collection.delete()\n     * @param {number|number[]} objIndex - index of document to (re)run through filter pipeline.\n     */\n    DynamicView.prototype.removeDocument = function (objIndex) {\n      var idx, rmidx, rmlen, rxo = {}, fxo = {};\n      var adjels = [];\n      var drs = this.resultset;\n      var fr = this.resultset.filteredrows;\n      var frlen = fr.length;\n\n      // if no filter applied yet, the result 'set' should remain 'everything'\n      if (!this.resultset.filterInitialized) {\n        if (this.options.persistent) {\n          this.resultdata = this.resultset.data();\n        }\n        // in case changes to data altered a sort column\n        if (this.sortFunction || this.sortCriteria || this.sortCriteriaSimple) {\n          this.queueSortPhase();\n        } else {\n          this.queueRebuildEvent();\n        }\n        return;\n      }\n\n      // if passed single index, wrap in array\n      if (!Array.isArray(objIndex)) {\n        objIndex = [objIndex];\n      }\n\n      rmlen = objIndex.length;\n      // create intersection object of data indices to remove\n      for (rmidx = 0; rmidx < rmlen; rmidx++) {\n        rxo[objIndex[rmidx]] = true;\n      }\n\n      // pivot remove data indices into remove filteredrows indices and dump in hashobject\n      for (idx = 0; idx < frlen; idx++) {\n        if (rxo[fr[idx]]) fxo[idx] = true;\n      }\n\n      // if any of the removed items were in our filteredrows...\n      if (Object.keys(fxo).length > 0) {\n        // remove them from filtered rows\n        this.resultset.filteredrows = this.resultset.filteredrows.filter(function (di, idx) { return !fxo[idx]; });\n        // if persistent...\n        if (this.options.persistent) {\n          // remove from resultdata\n          this.resultdata = this.resultdata.filter(function (obj, idx) { return !fxo[idx]; });\n        }\n\n        // and queue sorts\n        if (this.sortFunction || this.sortCriteria || this.sortCriteriaSimple) {\n          this.queueSortPhase();\n        } else {\n          this.queueRebuildEvent();\n        }\n      }\n\n      // to remove holes, we need to 'shift down' indices, this filter function finds number of positions to shift\n      var filt = function (idx) { return function (di) { return di < drs.filteredrows[idx]; }; };\n\n      frlen = drs.filteredrows.length;\n      for (idx = 0; idx < frlen; idx++) {\n        // grab subset of removed elements where data index is less than current filtered row data index;\n        // use this to determine how many positions iterated remaining data index needs to be 'shifted down'\n        adjels = objIndex.filter(filt(idx));\n        drs.filteredrows[idx] -= adjels.length;\n      }\n    };\n\n    /**\n     * mapReduce() - data transformation via user supplied functions\n     *\n     * @param {function} mapFunction - this function accepts a single document for you to transform and return\n     * @param {function} reduceFunction - this function accepts many (array of map outputs) and returns single value\n     * @returns The output of your reduceFunction\n     * @memberof DynamicView\n     */\n    DynamicView.prototype.mapReduce = function (mapFunction, reduceFunction) {\n      try {\n        return reduceFunction(this.data().map(mapFunction));\n      } catch (err) {\n        throw err;\n      }\n    };\n\n\n    /**\n     * Collection class that handles documents of same type\n     * @constructor Collection\n     * @implements LokiEventEmitter\n     * @param {string} name - collection name\n     * @param {(array|object)=} options - (optional) array of property names to be indicized OR a configuration object\n     * @param {array=} [options.unique=[]] - array of property names to define unique constraints for\n     * @param {array=} [options.exact=[]] - array of property names to define exact constraints for\n     * @param {array=} [options.indices=[]] - array property names to define binary indexes for\n     * @param {boolean} [options.adaptiveBinaryIndices=true] - collection indices will be actively rebuilt rather than lazily\n     * @param {boolean} [options.asyncListeners=false] - whether listeners are invoked asynchronously\n     * @param {boolean} [options.disableMeta=false] - set to true to disable meta property on documents\n     * @param {boolean} [options.disableChangesApi=true] - set to false to enable Changes API\n     * @param {boolean} [options.disableDeltaChangesApi=true] - set to false to enable Delta Changes API (requires Changes API, forces cloning)\n     * @param {boolean} [options.autoupdate=false] - use Object.observe to update objects automatically\n     * @param {boolean} [options.clone=false] - specify whether inserts and queries clone to/from user\n     * @param {boolean} [options.serializableIndices=true[]] - converts date values on binary indexed properties to epoch time\n     * @param {boolean} [options.disableFreeze=true] - when false all docs are frozen\n     * @param {string} [options.cloneMethod='parse-stringify'] - 'parse-stringify', 'jquery-extend-deep', 'shallow', 'shallow-assign'\n     * @param {int=} options.ttl - age of document (in ms.) before document is considered aged/stale.\n     * @param {int=} options.ttlInterval - time interval for clearing out 'aged' documents; not set by default.\n     * @see {@link Loki#addCollection} for normal creation of collections\n     */\n    function Collection(name, options) {\n      // the name of the collection\n\n      this.name = name;\n      // the data held by the collection\n      this.data = [];\n      this.idIndex = null; // position->$loki index (built lazily)\n      this.binaryIndices = {}; // user defined indexes\n      this.constraints = {\n        unique: {},\n        exact: {}\n      };\n\n      // unique contraints contain duplicate object references, so they are not persisted.\n      // we will keep track of properties which have unique contraint applied here, and regenerate lazily\n      this.uniqueNames = [];\n\n      // transforms will be used to store frequently used query chains as a series of steps\n      // which itself can be stored along with the database.\n      this.transforms = {};\n\n      // the object type of the collection\n      this.objType = name;\n\n      // in autosave scenarios we will use collection level dirty flags to determine whether save is needed.\n      // currently, if any collection is dirty we will autosave the whole database if autosave is configured.\n      // defaulting to true since this is called from addCollection and adding a collection should trigger save\n      this.dirty = true;\n\n      // private holders for cached data\n      this.cachedIndex = null;\n      this.cachedBinaryIndex = null;\n      this.cachedData = null;\n      var self = this;\n\n      /* OPTIONS */\n      options = options || {};\n\n      // exact match and unique constraints\n      if (options.hasOwnProperty('unique')) {\n        if (!Array.isArray(options.unique)) {\n          options.unique = [options.unique];\n        }\n        // save names; actual index is built lazily\n        options.unique.forEach(function (prop) {\n          self.uniqueNames.push(prop);\n        });\n      }\n\n      if (options.hasOwnProperty('exact')) {\n        options.exact.forEach(function (prop) {\n          self.constraints.exact[prop] = new ExactIndex(prop);\n        });\n      }\n\n      // if set to true we will optimally keep indices 'fresh' during insert/update/remove ops (never dirty/never needs rebuild)\n      // if you frequently intersperse insert/update/remove ops between find ops this will likely be significantly faster option.\n      this.adaptiveBinaryIndices = options.hasOwnProperty('adaptiveBinaryIndices') ? options.adaptiveBinaryIndices : true;\n\n      // is collection transactional\n      this.transactional = options.hasOwnProperty('transactional') ? options.transactional : false;\n\n      // options to clone objects when inserting them\n      this.cloneObjects = options.hasOwnProperty('clone') ? options.clone : false;\n\n      // default clone method (if enabled) is parse-stringify\n      this.cloneMethod = options.hasOwnProperty('cloneMethod') ? options.cloneMethod : \"parse-stringify\";\n\n      // option to make event listeners async, default is sync\n      this.asyncListeners = options.hasOwnProperty('asyncListeners') ? options.asyncListeners : false;\n\n      // if set to true we will not maintain a meta property for a document\n      this.disableMeta = options.hasOwnProperty('disableMeta') ? options.disableMeta : false;\n\n      // disable track changes\n      this.disableChangesApi = options.hasOwnProperty('disableChangesApi') ? options.disableChangesApi : true;\n\n      // disable delta update object style on changes\n      this.disableDeltaChangesApi = options.hasOwnProperty('disableDeltaChangesApi') ? options.disableDeltaChangesApi : true;\n      if (this.disableChangesApi) { this.disableDeltaChangesApi = true; }\n\n      // option to observe objects and update them automatically, ignored if Object.observe is not supported\n      this.autoupdate = options.hasOwnProperty('autoupdate') ? options.autoupdate : false;\n\n      // by default, if you insert a document into a collection with binary indices, if those indexed properties contain\n      // a DateTime we will convert to epoch time format so that (across serializations) its value position will be the\n      // same 'after' serialization as it was 'before'.\n      this.serializableIndices = options.hasOwnProperty('serializableIndices') ? options.serializableIndices : true;\n\n      // option to deep freeze all documents\n      this.disableFreeze = options.hasOwnProperty('disableFreeze') ? options.disableFreeze : true;\n\n      //option to activate a cleaner daemon - clears \"aged\" documents at set intervals.\n      this.ttl = {\n        age: null,\n        ttlInterval: null,\n        daemon: null\n      };\n      this.setTTL(options.ttl || -1, options.ttlInterval);\n\n      // currentMaxId - change manually at your own peril!\n      this.maxId = 0;\n\n      this.DynamicViews = [];\n\n      // events\n      this.events = {\n        'insert': [],\n        'update': [],\n        'pre-insert': [],\n        'pre-update': [],\n        'close': [],\n        'flushbuffer': [],\n        'error': [],\n        'delete': [],\n        'warning': []\n      };\n\n      // changes are tracked by collection and aggregated by the db\n      this.changes = [];\n\n      // lightweight changes tracking (loki IDs only) for optimized db saving\n      this.dirtyIds = [];\n\n      // initialize optional user-supplied indices array ['age', 'lname', 'zip']\n      var indices = [];\n      if (options && options.indices) {\n        if (Object.prototype.toString.call(options.indices) === '[object Array]') {\n          indices = options.indices;\n        } else if (typeof options.indices === 'string') {\n          indices = [options.indices];\n        } else {\n          throw new TypeError('Indices needs to be a string or an array of strings');\n        }\n      }\n\n      for (var idx = 0; idx < indices.length; idx++) {\n        this.ensureIndex(indices[idx]);\n      }\n\n      function observerCallback(changes) {\n\n        var changedObjects = typeof Set === 'function' ? new Set() : [];\n\n        if (!changedObjects.add)\n          changedObjects.add = function (object) {\n            if (this.indexOf(object) === -1)\n              this.push(object);\n            return this;\n          };\n\n        changes.forEach(function (change) {\n          changedObjects.add(change.object);\n        });\n\n        changedObjects.forEach(function (object) {\n          if (!hasOwnProperty.call(object, '$loki'))\n            return self.removeAutoUpdateObserver(object);\n          try {\n            self.update(object);\n          } catch (err) { }\n        });\n      }\n\n      this.observerCallback = observerCallback;\n\n      //Compare changed object (which is a forced clone) with existing object and return the delta\n      function getChangeDelta(obj, old) {\n        if (old) {\n          return getObjectDelta(old, obj);\n        }\n        else {\n          return JSON.parse(JSON.stringify(obj));\n        }\n      }\n\n      this.getChangeDelta = getChangeDelta;\n\n      function getObjectDelta(oldObject, newObject) {\n        var propertyNames = newObject !== null && typeof newObject === 'object' ? Object.keys(newObject) : null;\n        if (propertyNames && propertyNames.length && ['string', 'boolean', 'number'].indexOf(typeof (newObject)) < 0) {\n          var delta = {};\n          for (var i = 0; i < propertyNames.length; i++) {\n            var propertyName = propertyNames[i];\n            if (newObject.hasOwnProperty(propertyName)) {\n              if (!oldObject.hasOwnProperty(propertyName) || self.uniqueNames.indexOf(propertyName) >= 0 || propertyName == '$loki' || propertyName == 'meta') {\n                delta[propertyName] = newObject[propertyName];\n              }\n              else {\n                var propertyDelta = getObjectDelta(oldObject[propertyName], newObject[propertyName]);\n                if (typeof propertyDelta !== \"undefined\" && propertyDelta != {}) {\n                  delta[propertyName] = propertyDelta;\n                }\n              }\n            }\n          }\n          return Object.keys(delta).length === 0 ? undefined : delta;\n        }\n        else {\n          return oldObject === newObject ? undefined : newObject;\n        }\n      }\n\n      this.getObjectDelta = getObjectDelta;\n\n      // clear all the changes\n      function flushChanges() {\n        self.changes = [];\n      }\n\n      this.getChanges = function () {\n        return self.changes;\n      };\n\n      this.flushChanges = flushChanges;\n\n      this.setChangesApi = function (enabled) {\n        self.disableChangesApi = !enabled;\n        if (!enabled) { self.disableDeltaChangesApi = false; }\n      };\n\n      this.on('delete', function deleteCallback(obj) {\n        if (!self.disableChangesApi) {\n          self.createChange(self.name, 'R', obj);\n        }\n      });\n\n      this.on('warning', function (warning) {\n        self.lokiConsoleWrapper.warn(warning);\n      });\n      // for de-serialization purposes\n      flushChanges();\n    }\n\n    Collection.prototype = new LokiEventEmitter();\n    Collection.prototype.contructor = Collection;\n\n    /*\n      * For ChangeAPI default to clone entire object, for delta changes create object with only differences (+ $loki and meta)\n      */\n    Collection.prototype.createChange = function (name, op, obj, old) {\n      this.changes.push({\n        name: name,\n        operation: op,\n        obj: op == 'U' && !this.disableDeltaChangesApi ? this.getChangeDelta(obj, old) : JSON.parse(JSON.stringify(obj))\n      });\n    };\n\n    Collection.prototype.insertMeta = function (obj) {\n      var len, idx;\n\n      if (this.disableMeta || !obj) {\n        return;\n      }\n\n      // if batch insert\n      if (Array.isArray(obj)) {\n        len = obj.length;\n\n        for (idx = 0; idx < len; idx++) {\n          if (!obj[idx].hasOwnProperty('meta')) {\n            obj[idx].meta = {};\n          }\n\n          obj[idx].meta.created = (new Date()).getTime();\n          obj[idx].meta.revision = 0;\n        }\n\n        return;\n      }\n\n      // single object\n      if (!obj.meta) {\n        obj.meta = {};\n      }\n\n      obj.meta.created = (new Date()).getTime();\n      obj.meta.revision = 0;\n    };\n\n    Collection.prototype.updateMeta = function (obj) {\n      if (this.disableMeta || !obj) {\n        return obj;\n      }\n      if (!this.disableFreeze) {\n        obj = unFreeze(obj);\n        obj.meta = unFreeze(obj.meta);\n      }\n      obj.meta.updated = (new Date()).getTime();\n      obj.meta.revision += 1;\n      return obj;\n    };\n\n    Collection.prototype.createInsertChange = function (obj) {\n      this.createChange(this.name, 'I', obj);\n    };\n\n    Collection.prototype.createUpdateChange = function (obj, old) {\n      this.createChange(this.name, 'U', obj, old);\n    };\n\n    Collection.prototype.insertMetaWithChange = function (obj) {\n      this.insertMeta(obj);\n      this.createInsertChange(obj);\n    };\n\n    Collection.prototype.updateMetaWithChange = function (obj, old, objFrozen) {\n      obj = this.updateMeta(obj, objFrozen);\n      this.createUpdateChange(obj, old);\n      return obj;\n    };\n\n    Collection.prototype.lokiConsoleWrapper = {\n      log: function () { },\n      warn: function () { },\n      error: function () { },\n    };\n\n    Collection.prototype.addAutoUpdateObserver = function (object) {\n      if (!this.autoupdate || typeof Object.observe !== 'function')\n        return;\n\n      Object.observe(object, this.observerCallback, ['add', 'update', 'delete', 'reconfigure', 'setPrototype']);\n    };\n\n    Collection.prototype.removeAutoUpdateObserver = function (object) {\n      if (!this.autoupdate || typeof Object.observe !== 'function')\n        return;\n\n      Object.unobserve(object, this.observerCallback);\n    };\n\n    /**\n     * Adds a named collection transform to the collection\n     * @param {string} name - name to associate with transform\n     * @param {array} transform - an array of transformation 'step' objects to save into the collection\n     * @memberof Collection\n     * @example\n     * users.addTransform('progeny', [\n     *   {\n     *     type: 'find',\n     *     value: {\n     *       'age': {'$lte': 40}\n     *     }\n     *   }\n     * ]);\n     *\n     * var results = users.chain('progeny').data();\n     */\n    Collection.prototype.addTransform = function (name, transform) {\n      if (this.transforms.hasOwnProperty(name)) {\n        throw new Error(\"a transform by that name already exists\");\n      }\n\n      this.transforms[name] = transform;\n    };\n\n    /**\n     * Retrieves a named transform from the collection.\n     * @param {string} name - name of the transform to lookup.\n     * @memberof Collection\n     */\n    Collection.prototype.getTransform = function (name) {\n      return this.transforms[name];\n    };\n\n    /**\n     * Updates a named collection transform to the collection\n     * @param {string} name - name to associate with transform\n     * @param {object} transform - a transformation object to save into collection\n     * @memberof Collection\n     */\n    Collection.prototype.setTransform = function (name, transform) {\n      this.transforms[name] = transform;\n    };\n\n    /**\n     * Removes a named collection transform from the collection\n     * @param {string} name - name of collection transform to remove\n     * @memberof Collection\n     */\n    Collection.prototype.removeTransform = function (name) {\n      delete this.transforms[name];\n    };\n\n    Collection.prototype.byExample = function (template) {\n      var k, obj, query;\n      query = [];\n      for (k in template) {\n        if (!template.hasOwnProperty(k)) continue;\n        query.push((\n          obj = {},\n          obj[k] = template[k],\n          obj\n        ));\n      }\n      return {\n        '$and': query\n      };\n    };\n\n    Collection.prototype.findObject = function (template) {\n      return this.findOne(this.byExample(template));\n    };\n\n    Collection.prototype.findObjects = function (template) {\n      return this.find(this.byExample(template));\n    };\n\n    /*----------------------------+\n    | TTL daemon                  |\n    +----------------------------*/\n    Collection.prototype.ttlDaemonFuncGen = function () {\n      var collection = this;\n      var age = this.ttl.age;\n      return function ttlDaemon() {\n        var now = Date.now();\n        var toRemove = collection.chain().where(function daemonFilter(member) {\n          var timestamp = member.meta.updated || member.meta.created;\n          var diff = now - timestamp;\n          return age < diff;\n        });\n        toRemove.remove();\n      };\n    };\n\n    /**\n     * Updates or applies collection TTL settings.\n     * @param {int} age - age (in ms) to expire document from collection\n     * @param {int} interval - time (in ms) to clear collection of aged documents.\n     * @memberof Collection\n     */\n    Collection.prototype.setTTL = function (age, interval) {\n      if (age < 0) {\n        clearInterval(this.ttl.daemon);\n      } else {\n        this.ttl.age = age;\n        this.ttl.ttlInterval = interval;\n        this.ttl.daemon = setInterval(this.ttlDaemonFuncGen(), interval);\n      }\n    };\n\n    /*----------------------------+\n    | INDEXING                    |\n    +----------------------------*/\n\n    /**\n     * create a row filter that covers all documents in the collection\n     */\n    Collection.prototype.prepareFullDocIndex = function () {\n      var len = this.data.length;\n      var indexes = new Array(len);\n      for (var i = 0; i < len; i += 1) {\n        indexes[i] = i;\n      }\n      return indexes;\n    };\n\n    /**\n     * Will allow reconfiguring certain collection options.\n     * @param {boolean} options.adaptiveBinaryIndices - collection indices will be actively rebuilt rather than lazily\n     * @memberof Collection\n     */\n    Collection.prototype.configureOptions = function (options) {\n      options = options || {};\n\n      if (options.hasOwnProperty('adaptiveBinaryIndices')) {\n        this.adaptiveBinaryIndices = options.adaptiveBinaryIndices;\n\n        // if switching to adaptive binary indices, make sure none are 'dirty'\n        if (this.adaptiveBinaryIndices) {\n          this.ensureAllIndexes();\n        }\n      }\n    };\n\n    /**\n     * Ensure binary index on a certain field\n     * @param {string} property - name of property to create binary index on\n     * @param {boolean=} force - (Optional) flag indicating whether to construct index immediately\n     * @memberof Collection\n     */\n    Collection.prototype.ensureIndex = function (property, force) {\n      // optional parameter to force rebuild whether flagged as dirty or not\n      if (typeof (force) === 'undefined') {\n        force = false;\n      }\n\n      if (property === null || property === undefined) {\n        throw new Error('Attempting to set index without an associated property');\n      }\n\n      if (this.binaryIndices[property] && !force) {\n        if (!this.binaryIndices[property].dirty) return;\n      }\n\n      // if the index is already defined and we are using adaptiveBinaryIndices and we are not forcing a rebuild, return.\n      if (this.adaptiveBinaryIndices === true && this.binaryIndices.hasOwnProperty(property) && !force) {\n        return;\n      }\n\n      var index = {\n        'name': property,\n        'dirty': true,\n        'values': this.prepareFullDocIndex()\n      };\n      this.binaryIndices[property] = index;\n\n      var wrappedComparer =\n        (function (prop, data) {\n          var val1, val2;\n          var propPath = ~prop.indexOf('.') ? prop.split('.') : false;\n          return function (a, b) {\n            if (propPath) {\n              val1 = Utils.getIn(data[a], propPath, true);\n              val2 = Utils.getIn(data[b], propPath, true);\n            } else {\n              val1 = data[a][prop];\n              val2 = data[b][prop];\n            }\n\n            if (val1 !== val2) {\n              if (Comparators.lt(val1, val2, false)) return -1;\n              if (Comparators.gt(val1, val2, false)) return 1;\n            }\n            return 0;\n          };\n        })(property, this.data);\n\n      index.values.sort(wrappedComparer);\n      index.dirty = false;\n\n      this.dirty = true; // for autosave scenarios\n    };\n\n    /**\n     * Perform checks to determine validity/consistency of all binary indices\n     * @param {object=} options - optional configuration object\n     * @param {boolean} [options.randomSampling=false] - whether (faster) random sampling should be used\n     * @param {number} [options.randomSamplingFactor=0.10] - percentage of total rows to randomly sample\n     * @param {boolean} [options.repair=false] - whether to fix problems if they are encountered\n     * @returns {string[]} array of index names where problems were found.\n     * @memberof Collection\n     * @example\n     * // check all indices on a collection, returns array of invalid index names\n     * var result = coll.checkAllIndexes({ repair: true, randomSampling: true, randomSamplingFactor: 0.15 });\n     * if (result.length > 0) {\n     *   results.forEach(function(name) {\n     *     console.log('problem encountered with index : ' + name);\n     *   });\n     * }\n     */\n    Collection.prototype.checkAllIndexes = function (options) {\n      var key, bIndices = this.binaryIndices;\n      var results = [], result;\n\n      for (key in bIndices) {\n        if (hasOwnProperty.call(bIndices, key)) {\n          result = this.checkIndex(key, options);\n          if (!result) {\n            results.push(key);\n          }\n        }\n      }\n\n      return results;\n    };\n\n    /**\n     * Perform checks to determine validity/consistency of a binary index\n     * @param {string} property - name of the binary-indexed property to check\n     * @param {object=} options - optional configuration object\n     * @param {boolean} [options.randomSampling=false] - whether (faster) random sampling should be used\n     * @param {number} [options.randomSamplingFactor=0.10] - percentage of total rows to randomly sample\n     * @param {boolean} [options.repair=false] - whether to fix problems if they are encountered\n     * @returns {boolean} whether the index was found to be valid (before optional correcting).\n     * @memberof Collection\n     * @example\n     * // full test\n     * var valid = coll.checkIndex('name');\n     * // full test with repair (if issues found)\n     * valid = coll.checkIndex('name', { repair: true });\n     * // random sampling (default is 10% of total document count)\n     * valid = coll.checkIndex('name', { randomSampling: true });\n     * // random sampling (sample 20% of total document count)\n     * valid = coll.checkIndex('name', { randomSampling: true, randomSamplingFactor: 0.20 });\n     * // random sampling (implied boolean)\n     * valid = coll.checkIndex('name', { randomSamplingFactor: 0.20 });\n     * // random sampling with repair (if issues found)\n     * valid = coll.checkIndex('name', { repair: true, randomSampling: true });\n     */\n    Collection.prototype.checkIndex = function (property, options) {\n      options = options || {};\n      // if 'randomSamplingFactor' specified but not 'randomSampling', assume true\n      if (options.randomSamplingFactor && options.randomSampling !== false) {\n        options.randomSampling = true;\n      }\n      options.randomSamplingFactor = options.randomSamplingFactor || 0.1;\n      if (options.randomSamplingFactor < 0 || options.randomSamplingFactor > 1) {\n        options.randomSamplingFactor = 0.1;\n      }\n\n      var valid = true, idx, iter, pos, len, biv;\n\n      // make sure we are passed a valid binary index name\n      if (!this.binaryIndices.hasOwnProperty(property)) {\n        throw new Error(\"called checkIndex on property without an index: \" + property);\n      }\n\n      // if lazy indexing, rebuild only if flagged as dirty\n      if (!this.adaptiveBinaryIndices) {\n        this.ensureIndex(property);\n      }\n\n      biv = this.binaryIndices[property].values;\n      len = biv.length;\n\n      // if the index has an incorrect number of values\n      if (len !== this.data.length) {\n        if (options.repair) {\n          this.ensureIndex(property, true);\n        }\n        return false;\n      }\n\n      if (len === 0) {\n        return true;\n      }\n\n      var usingDotNotation = (property.indexOf('.') !== -1);\n\n      if (len === 1) {\n        valid = (biv[0] === 0);\n      }\n      else {\n        if (options.randomSampling) {\n          // validate first and last\n          if (!LokiOps.$lte(Utils.getIn(this.data[biv[0]], property, usingDotNotation),\n            Utils.getIn(this.data[biv[1]], property, usingDotNotation))) {\n            valid = false;\n          }\n          if (!LokiOps.$lte(Utils.getIn(this.data[biv[len - 2]], property, usingDotNotation),\n            Utils.getIn(this.data[biv[len - 1]], property, usingDotNotation))) {\n            valid = false;\n          }\n\n          // if first and last positions are sorted correctly with their nearest neighbor,\n          // continue onto random sampling phase...\n          if (valid) {\n            // # random samplings = total count * sampling factor\n            iter = Math.floor((len - 1) * options.randomSamplingFactor);\n\n            // for each random sampling, validate that the binary index is sequenced properly\n            // with next higher value.\n            for (idx = 0; idx < iter - 1; idx++) {\n              // calculate random position\n              pos = Math.floor(Math.random() * (len - 1));\n              if (!LokiOps.$lte(Utils.getIn(this.data[biv[pos]], property, usingDotNotation),\n                Utils.getIn(this.data[biv[pos + 1]], property, usingDotNotation))) {\n                valid = false;\n                break;\n              }\n            }\n          }\n        }\n        else {\n          // validate that the binary index is sequenced properly\n          for (idx = 0; idx < len - 1; idx++) {\n            if (!LokiOps.$lte(Utils.getIn(this.data[biv[idx]], property, usingDotNotation),\n              Utils.getIn(this.data[biv[idx + 1]], property, usingDotNotation))) {\n              valid = false;\n              break;\n            }\n          }\n        }\n      }\n\n      // if incorrectly sequenced and we are to fix problems, rebuild index\n      if (!valid && options.repair) {\n        this.ensureIndex(property, true);\n      }\n\n      return valid;\n    };\n\n    Collection.prototype.getBinaryIndexValues = function (property) {\n      var idx, idxvals = this.binaryIndices[property].values;\n      var result = [];\n\n      for (idx = 0; idx < idxvals.length; idx++) {\n        result.push(Utils.getIn(this.data[idxvals[idx]], property, true));\n      }\n\n      return result;\n    };\n\n    /**\n     * Returns a named unique index\n     * @param {string} field - indexed field name\n     * @param {boolean} force - if `true`, will rebuild index; otherwise, function may return null\n     */\n    Collection.prototype.getUniqueIndex = function (field, force) {\n      var index = this.constraints.unique[field];\n      if (!index && force) {\n        return this.ensureUniqueIndex(field);\n      }\n      return index;\n    };\n\n    Collection.prototype.ensureUniqueIndex = function (field) {\n      var index = this.constraints.unique[field];\n      if (!index) {\n        // keep track of new unique index for regenerate after database (re)load.\n        if (this.uniqueNames.indexOf(field) == -1) {\n          this.uniqueNames.push(field);\n        }\n      }\n\n      // if index already existed, (re)loading it will likely cause collisions, rebuild always\n      this.constraints.unique[field] = index = new UniqueIndex(field);\n      this.data.forEach(function (obj) {\n        index.set(obj);\n      });\n      return index;\n    };\n\n    /**\n     * Ensure all binary indices\n     * @param {boolean} force - whether to force rebuild of existing lazy binary indices\n     * @memberof Collection\n     */\n    Collection.prototype.ensureAllIndexes = function (force) {\n      var key, bIndices = this.binaryIndices;\n      for (key in bIndices) {\n        if (hasOwnProperty.call(bIndices, key)) {\n          this.ensureIndex(key, force);\n        }\n      }\n    };\n\n    /**\n     * Internal method used to flag all lazy index as dirty\n     */\n    Collection.prototype.flagBinaryIndexesDirty = function () {\n      var key, bIndices = this.binaryIndices;\n      for (key in bIndices) {\n        if (hasOwnProperty.call(bIndices, key)) {\n          bIndices[key].dirty = true;\n        }\n      }\n    };\n\n    /**\n     * Internal method used to flag a lazy index as dirty\n     */\n    Collection.prototype.flagBinaryIndexDirty = function (index) {\n      if (this.binaryIndices[index])\n        this.binaryIndices[index].dirty = true;\n    };\n\n    /**\n     * Quickly determine number of documents in collection (or query)\n     * @param {object=} query - (optional) query object to count results of\n     * @returns {number} number of documents in the collection\n     * @memberof Collection\n     */\n    Collection.prototype.count = function (query) {\n      if (!query) {\n        return this.data.length;\n      }\n\n      return this.chain().find(query).filteredrows.length;\n    };\n\n    /**\n     * Rebuild idIndex\n     */\n    Collection.prototype.ensureId = function () {\n      if (this.idIndex) {\n        return;\n      }\n      var data = this.data,\n        i = 0;\n      var len = data.length;\n      var index = new Array(len);\n      for (i; i < len; i++) {\n        index[i] = data[i].$loki;\n      }\n      this.idIndex = index;\n    };\n\n    /**\n     * Rebuild idIndex async with callback - useful for background syncing with a remote server\n     */\n    Collection.prototype.ensureIdAsync = function (callback) {\n      this.async(function () {\n        this.ensureId();\n      }, callback);\n    };\n\n    /**\n     * Add a dynamic view to the collection\n     * @param {string} name - name of dynamic view to add\n     * @param {object=} options - options to configure dynamic view with\n     * @param {boolean} [options.persistent=false] - indicates if view is to main internal results array in 'resultdata'\n     * @param {string} [options.sortPriority='passive'] - 'passive' (sorts performed on call to data) or 'active' (after updates)\n     * @param {number} options.minRebuildInterval - minimum rebuild interval (need clarification to docs here)\n     * @returns {DynamicView} reference to the dynamic view added\n     * @memberof Collection\n     * @example\n     * var pview = users.addDynamicView('progeny');\n     * pview.applyFind({'age': {'$lte': 40}});\n     * pview.applySimpleSort('name');\n     *\n     * var results = pview.data();\n     **/\n\n    Collection.prototype.addDynamicView = function (name, options) {\n      var dv = new DynamicView(this, name, options);\n      this.DynamicViews.push(dv);\n\n      return dv;\n    };\n\n    /**\n     * Remove a dynamic view from the collection\n     * @param {string} name - name of dynamic view to remove\n     * @memberof Collection\n     **/\n    Collection.prototype.removeDynamicView = function (name) {\n      this.DynamicViews =\n        this.DynamicViews.filter(function (dv) { return dv.name !== name; });\n    };\n\n    /**\n     * Look up dynamic view reference from within the collection\n     * @param {string} name - name of dynamic view to retrieve reference of\n     * @returns {DynamicView} A reference to the dynamic view with that name\n     * @memberof Collection\n     **/\n    Collection.prototype.getDynamicView = function (name) {\n      for (var idx = 0; idx < this.DynamicViews.length; idx++) {\n        if (this.DynamicViews[idx].name === name) {\n          return this.DynamicViews[idx];\n        }\n      }\n\n      return null;\n    };\n\n    /**\n     * Applies a 'mongo-like' find query object and passes all results to an update function.\n     * For filter function querying you should migrate to [updateWhere()]{@link Collection#updateWhere}.\n     *\n     * @param {object|function} filterObject - 'mongo-like' query object (or deprecated filterFunction mode)\n     * @param {function} updateFunction - update function to run against filtered documents\n     * @memberof Collection\n     */\n    Collection.prototype.findAndUpdate = function (filterObject, updateFunction) {\n      if (typeof (filterObject) === \"function\") {\n        this.updateWhere(filterObject, updateFunction);\n      }\n      else {\n        this.chain().find(filterObject).update(updateFunction);\n      }\n    };\n\n    /**\n     * Applies a 'mongo-like' find query object removes all documents which match that filter.\n     *\n     * @param {object} filterObject - 'mongo-like' query object\n     * @memberof Collection\n     */\n    Collection.prototype.findAndRemove = function (filterObject) {\n      this.chain().find(filterObject).remove();\n    };\n\n    /**\n     * Adds object(s) to collection, ensure object(s) have meta properties, clone it if necessary, etc.\n     * @param {(object|array)} doc - the document (or array of documents) to be inserted\n     * @param {boolean=} overrideAdaptiveIndices - (optional) if `true`, adaptive indicies will be\n     *   temporarily disabled and then fully rebuilt after batch. This will be faster for\n     *   large inserts, but slower for small/medium inserts in large collections\n     * @returns {(object|array)} document or documents inserted\n     * @memberof Collection\n     * @example\n     * users.insert({\n     *     name: 'Odin',\n     *     age: 50,\n     *     address: 'Asgard'\n     * });\n     *\n     * // alternatively, insert array of documents\n     * users.insert([{ name: 'Thor', age: 35}, { name: 'Loki', age: 30}]);\n     */\n    Collection.prototype.insert = function (doc, overrideAdaptiveIndices) {\n      if (!Array.isArray(doc)) {\n        return this.insertOne(doc);\n      }\n\n      // holder to the clone of the object inserted if collections is set to clone objects\n      var obj;\n      var results = [];\n\n      // if not cloning, disable adaptive binary indices for the duration of the batch insert,\n      // followed by lazy rebuild and re-enabling adaptive indices after batch insert.\n      var adaptiveBatchOverride = overrideAdaptiveIndices && !this.cloneObjects &&\n        this.adaptiveBinaryIndices && Object.keys(this.binaryIndices).length > 0;\n\n      if (adaptiveBatchOverride) {\n        this.adaptiveBinaryIndices = false;\n      }\n\n      try {\n        this.emit('pre-insert', doc);\n        for (var i = 0, len = doc.length; i < len; i++) {\n          obj = this.insertOne(doc[i], true);\n          if (!obj) {\n            return undefined;\n          }\n          results.push(obj);\n        }\n      } finally {\n        if (adaptiveBatchOverride) {\n          this.ensureAllIndexes();\n          this.adaptiveBinaryIndices = true;\n        }\n      }\n\n      // at the 'batch' level, if clone option is true then emitted docs are clones\n      this.emit('insert', results);\n\n      // if clone option is set, clone return values\n      results = this.cloneObjects ? clone(results, this.cloneMethod) : results;\n\n      return results.length === 1 ? results[0] : results;\n    };\n\n    /**\n     * Adds a single object, ensures it has meta properties, clone it if necessary, etc.\n     * @param {object} doc - the document to be inserted\n     * @param {boolean} bulkInsert - quiet pre-insert and insert event emits\n     * @returns {object} document or 'undefined' if there was a problem inserting it\n     */\n    Collection.prototype.insertOne = function (doc, bulkInsert) {\n      var err = null;\n      var returnObj;\n\n      if (typeof doc !== 'object') {\n        err = new TypeError('Document needs to be an object');\n      } else if (doc === null) {\n        err = new TypeError('Object cannot be null');\n      }\n\n      if (err !== null) {\n        this.emit('error', err);\n        throw err;\n      }\n\n      // if configured to clone, do so now... otherwise just use same obj reference\n      var obj = this.cloneObjects ? clone(doc, this.cloneMethod) : doc;\n      if (!this.disableFreeze) {\n        obj = unFreeze(obj);\n      }\n\n      if (!this.disableMeta) {\n        if (typeof obj.meta === 'undefined') {\n          obj.meta = {\n            revision: 0,\n            created: 0\n          };\n        } else if (!this.disableFreeze) {\n          obj.meta = unFreeze(obj.meta);\n        }\n      }\n\n      // both 'pre-insert' and 'insert' events are passed internal data reference even when cloning\n      // insert needs internal reference because that is where loki itself listens to add meta\n      if (!bulkInsert) {\n        this.emit('pre-insert', obj);\n      }\n      if (!this.add(obj)) {\n        return undefined;\n      }\n\n      // update meta and store changes if ChangesAPI is enabled\n      // (moved from \"insert\" event listener to allow internal reference to be used)\n      if (this.disableChangesApi) {\n        this.insertMeta(obj);\n      } else {\n        this.insertMetaWithChange(obj);\n      }\n\n      if (!this.disableFreeze) {\n        deepFreeze(obj);\n      }\n\n      // if cloning is enabled, emit insert event with clone of new object\n      returnObj = this.cloneObjects ? clone(obj, this.cloneMethod) : obj;\n\n      if (!bulkInsert) {\n        this.emit('insert', returnObj);\n      }\n\n      this.addAutoUpdateObserver(returnObj);\n\n      return returnObj;\n    };\n\n    /**\n     * Empties the collection.\n     * @param {object=} options - configure clear behavior\n     * @param {bool=} [options.removeIndices=false] - whether to remove indices in addition to data\n     * @memberof Collection\n     */\n    Collection.prototype.clear = function (options) {\n      var self = this;\n\n      options = options || {};\n\n      this.data = [];\n      this.idIndex = null;\n      this.cachedIndex = null;\n      this.cachedBinaryIndex = null;\n      this.cachedData = null;\n      this.maxId = 0;\n      this.DynamicViews = [];\n      this.dirty = true;\n      this.constraints = {\n        unique: {},\n        exact: {}\n      };\n\n      // if removing indices entirely\n      if (options.removeIndices === true) {\n        this.binaryIndices = {};\n        this.uniqueNames = [];\n      }\n      // clear indices but leave definitions in place\n      else {\n        // clear binary indices\n        var keys = Object.keys(this.binaryIndices);\n        keys.forEach(function (biname) {\n          self.binaryIndices[biname].dirty = false;\n          self.binaryIndices[biname].values = [];\n        });\n      }\n    };\n\n    /**\n     * Updates an object and notifies collection that the document has changed.\n     * @param {object} doc - document to update within the collection\n     * @memberof Collection\n     */\n    Collection.prototype.update = function (doc) {\n      var adaptiveBatchOverride, k, len;\n\n      if (Array.isArray(doc)) {\n        len = doc.length;\n\n        // if not cloning, disable adaptive binary indices for the duration of the batch update,\n        // followed by lazy rebuild and re-enabling adaptive indices after batch update.\n        adaptiveBatchOverride = !this.cloneObjects &&\n          this.adaptiveBinaryIndices && Object.keys(this.binaryIndices).length > 0;\n\n        if (adaptiveBatchOverride) {\n          this.adaptiveBinaryIndices = false;\n        }\n\n        try {\n          for (k = 0; k < len; k += 1) {\n            this.update(doc[k]);\n          }\n        }\n        finally {\n          if (adaptiveBatchOverride) {\n            this.ensureAllIndexes();\n            this.adaptiveBinaryIndices = true;\n          }\n        }\n\n        return;\n      }\n\n      // verify object is a properly formed document\n      if (!hasOwnProperty.call(doc, '$loki')) {\n        throw new Error('Trying to update unsynced document. Please save the document first by using insert() or addMany()');\n      }\n      try {\n        this.startTransaction();\n        var arr = this.get(doc.$loki, true),\n          oldInternal,   // ref to existing obj\n          newInternal, // ref to new internal obj\n          position,\n          self = this;\n\n        if (!arr) {\n          throw new Error('Trying to update a document not in collection.');\n        }\n\n        oldInternal = arr[0]; // -internal- obj ref\n        position = arr[1]; // position in data array\n\n        // if configured to clone, do so now... otherwise just use same obj reference\n        newInternal = this.cloneObjects || (!this.disableDeltaChangesApi && this.disableFreeze) ? clone(doc, this.cloneMethod) : doc;\n\n        this.emit('pre-update', doc);\n\n        this.uniqueNames.forEach(function (key) {\n          self.getUniqueIndex(key, true).update(oldInternal, newInternal);\n        });\n\n        // operate the update\n        this.data[position] = newInternal;\n\n        if (newInternal !== doc) {\n          this.addAutoUpdateObserver(doc);\n        }\n\n        // now that we can efficiently determine the data[] position of newly added document,\n        // submit it for all registered DynamicViews to evaluate for inclusion/exclusion\n        for (var idx = 0; idx < this.DynamicViews.length; idx++) {\n          this.DynamicViews[idx].evaluateDocument(position, false);\n        }\n\n        var key;\n        if (this.adaptiveBinaryIndices) {\n          // for each binary index defined in collection, immediately update rather than flag for lazy rebuild\n          var bIndices = this.binaryIndices;\n          for (key in bIndices) {\n            this.adaptiveBinaryIndexUpdate(position, key);\n          }\n        }\n        else {\n          this.flagBinaryIndexesDirty();\n        }\n\n        this.idIndex[position] = newInternal.$loki;\n        //this.flagBinaryIndexesDirty();\n\n        if (this.isIncremental) {\n          this.dirtyIds.push(newInternal.$loki);\n        }\n\n        this.commit();\n        this.dirty = true; // for autosave scenarios\n\n        // update meta and store changes if ChangesAPI is enabled\n        if (this.disableChangesApi) {\n          newInternal = this.updateMeta(newInternal);\n        } else {\n          newInternal = this.updateMetaWithChange(newInternal, oldInternal);\n        }\n\n        if (!this.disableFreeze) {\n          deepFreeze(newInternal);\n        }\n\n        var returnObj;\n\n        // if cloning is enabled, emit 'update' event and return with clone of new object\n        if (this.cloneObjects) {\n          returnObj = clone(newInternal, this.cloneMethod);\n        }\n        else {\n          returnObj = newInternal;\n        }\n\n        this.emit('update', returnObj, oldInternal);\n        return returnObj;\n      } catch (err) {\n        this.rollback();\n        this.lokiConsoleWrapper.error(err.message);\n        this.emit('error', err);\n        throw (err); // re-throw error so user does not think it succeeded\n      }\n    };\n\n    /**\n     * Add object to collection\n     */\n    Collection.prototype.add = function (obj) {\n      // if parameter isn't object exit with throw\n      if ('object' !== typeof obj) {\n        throw new TypeError('Object being added needs to be an object');\n      }\n      // if object you are adding already has id column it is either already in the collection\n      // or the object is carrying its own 'id' property.  If it also has a meta property,\n      // then this is already in collection so throw error, otherwise rename to originalId and continue adding.\n      if (typeof (obj.$loki) !== 'undefined') {\n        throw new Error('Document is already in collection, please use update()');\n      }\n\n      /*\n       * try adding object to collection\n       */\n      try {\n        this.startTransaction();\n        this.maxId++;\n\n        if (isNaN(this.maxId)) {\n          this.maxId = (this.data[this.data.length - 1].$loki + 1);\n        }\n\n        var newId = this.maxId;\n        obj.$loki = newId;\n\n        if (!this.disableMeta) {\n          obj.meta.version = 0;\n        }\n\n        for (var i = 0, len = this.uniqueNames.length; i < len; i ++) {\n          this.getUniqueIndex(this.uniqueNames[i], true).set(obj);\n        }\n\n        if (this.idIndex) {\n          this.idIndex.push(newId);\n        }\n\n        if (this.isIncremental) {\n          this.dirtyIds.push(newId);\n        }\n\n        // add the object\n        this.data.push(obj);\n\n        var addedPos = this.data.length - 1;\n\n        // now that we can efficiently determine the data[] position of newly added document,\n        // submit it for all registered DynamicViews to evaluate for inclusion/exclusion\n        var dvlen = this.DynamicViews.length;\n        for (i = 0; i < dvlen; i++) {\n          this.DynamicViews[i].evaluateDocument(addedPos, true);\n        }\n\n        if (this.adaptiveBinaryIndices) {\n          // for each binary index defined in collection, immediately update rather than flag for lazy rebuild\n          var bIndices = this.binaryIndices;\n          for (var key in bIndices) {\n            this.adaptiveBinaryIndexInsert(addedPos, key);\n          }\n        }\n        else {\n          this.flagBinaryIndexesDirty();\n        }\n\n        this.commit();\n        this.dirty = true; // for autosave scenarios\n\n        return (this.cloneObjects) ? (clone(obj, this.cloneMethod)) : (obj);\n      } catch (err) {\n        this.rollback();\n        this.lokiConsoleWrapper.error(err.message);\n        this.emit('error', err);\n        throw (err); // re-throw error so user does not think it succeeded\n      }\n    };\n\n    /**\n     * Applies a filter function and passes all results to an update function.\n     *\n     * @param {function} filterFunction - filter function whose results will execute update\n     * @param {function} updateFunction - update function to run against filtered documents\n     * @memberof Collection\n     */\n    Collection.prototype.updateWhere = function (filterFunction, updateFunction) {\n      var results = this.where(filterFunction),\n        i = 0,\n        obj;\n      try {\n        for (i; i < results.length; i++) {\n          obj = updateFunction(results[i]);\n          this.update(obj);\n        }\n\n      } catch (err) {\n        this.rollback();\n        this.lokiConsoleWrapper.error(err.message);\n      }\n    };\n\n    /**\n     * Remove all documents matching supplied filter function.\n     * For 'mongo-like' querying you should migrate to [findAndRemove()]{@link Collection#findAndRemove}.\n     * @param {function|object} query - query object to filter on\n     * @memberof Collection\n     */\n    Collection.prototype.removeWhere = function (query) {\n      var list;\n      if (typeof query === 'function') {\n        list = this.data.filter(query);\n        this.remove(list);\n      } else {\n        this.chain().find(query).remove();\n      }\n    };\n\n    Collection.prototype.removeDataOnly = function () {\n      this.remove(this.data.slice());\n    };\n\n    /**\n     * Internal method to remove a batch of documents from the collection.\n     * @param {number[]} positions - data/idIndex positions to remove\n     */\n    Collection.prototype.removeBatchByPositions = function (positions) {\n      var len = positions.length;\n      var xo = {};\n      var dlen, didx, idx;\n      var bic = Object.keys(this.binaryIndices).length;\n      var uic = Object.keys(this.constraints.unique).length;\n      var adaptiveOverride = this.adaptiveBinaryIndices && Object.keys(this.binaryIndices).length > 0;\n      var doc, self = this;\n\n      try {\n        this.startTransaction();\n\n        // create hashobject for positional removal inclusion tests...\n        // all keys defined in this hashobject represent $loki ids of the documents to remove.\n        this.ensureId();\n        for (idx = 0; idx < len; idx++) {\n          xo[this.idIndex[positions[idx]]] = true;\n        }\n\n        // if we will need to notify dynamic views and/or binary indices to update themselves...\n        dlen = this.DynamicViews.length;\n        if ((dlen > 0) || (bic > 0) || (uic > 0)) {\n          if (dlen > 0) {\n            // notify dynamic views to remove relevant documents at data positions\n            for (didx = 0; didx < dlen; didx++) {\n              // notify dv of remove (passing batch/array of positions)\n              this.DynamicViews[didx].removeDocument(positions);\n            }\n          }\n\n          // notify binary indices to update\n          if (this.adaptiveBinaryIndices && !adaptiveOverride) {\n            // for each binary index defined in collection, immediately update rather than flag for lazy rebuild\n            var key, bIndices = this.binaryIndices;\n\n            for (key in bIndices) {\n              this.adaptiveBinaryIndexRemove(positions, key);\n            }\n          }\n          else {\n            this.flagBinaryIndexesDirty();\n          }\n\n          if (uic) {\n            this.uniqueNames.forEach(function (key) {\n              var index = self.getUniqueIndex(key);\n              if (index) {\n                for (idx = 0; idx < len; idx++) {\n                  doc = self.data[positions[idx]];\n                  if (doc[key] !== null && doc[key] !== undefined) {\n                    index.remove(doc[key]);\n                  }\n                }\n              }\n            });\n          }\n        }\n\n        // emit 'delete' events only of listeners are attached.\n        // since data not removed yet, in future we can emit single delete event with array...\n        // for now that might be breaking change to put in potential 1.6 or LokiDB (lokijs2) version\n        if (!this.disableChangesApi || this.events.delete.length > 1) {\n          for (idx = 0; idx < len; idx++) {\n            this.emit('delete', this.data[positions[idx]]);\n          }\n        }\n\n        // remove from data[] :\n        // filter collection data for items not in inclusion hashobject\n        this.data = this.data.filter(function (obj) {\n          return !xo[obj.$loki];\n        });\n\n        if (this.isIncremental) {\n          for(idx=0; idx < len; idx++) {\n            this.dirtyIds.push(this.idIndex[positions[idx]]);\n          }\n        }\n\n        // remove from idIndex[] :\n        // filter idIndex for items not in inclusion hashobject\n        this.idIndex = this.idIndex.filter(function (id) {\n          return !xo[id];\n        });\n\n        if (this.adaptiveBinaryIndices && adaptiveOverride) {\n          this.adaptiveBinaryIndices = false;\n          this.ensureAllIndexes(true);\n          this.adaptiveBinaryIndices = true;\n        }\n\n        this.commit();\n\n        // flag collection as dirty for autosave\n        this.dirty = true;\n      }\n      catch (err) {\n        this.rollback();\n        if (adaptiveOverride) {\n          this.adaptiveBinaryIndices = true;\n        }\n        this.lokiConsoleWrapper.error(err.message);\n        this.emit('error', err);\n        return null;\n      }\n    };\n\n    /**\n     *  Internal method called by remove()\n     * @param {object[]|number[]} batch - array of documents or $loki ids to remove\n     */\n    Collection.prototype.removeBatch = function (batch) {\n      var len = batch.length,\n        dlen = this.data.length,\n        idx;\n      var xlt = {};\n      var posx = [];\n\n      // create lookup hashobject to translate $loki id to position\n      for (idx = 0; idx < dlen; idx++) {\n        xlt[this.data[idx].$loki] = idx;\n      }\n\n      // iterate the batch\n      for (idx = 0; idx < len; idx++) {\n        if (typeof (batch[idx]) === 'object') {\n          posx.push(xlt[batch[idx].$loki]);\n        }\n        else {\n          posx.push(xlt[batch[idx]]);\n        }\n      }\n\n      this.removeBatchByPositions(posx);\n    };\n\n    /**\n     * Remove a document from the collection\n     * @param {object} doc - document to remove from collection\n     * @memberof Collection\n     */\n    Collection.prototype.remove = function (doc) {\n      var frozen;\n\n      if (typeof doc === 'number') {\n        doc = this.get(doc);\n      }\n\n      if ('object' !== typeof doc) {\n        throw new Error('Parameter is not an object');\n      }\n      if (Array.isArray(doc)) {\n        this.removeBatch(doc);\n        return;\n      }\n\n      if (!hasOwnProperty.call(doc, '$loki')) {\n        throw new Error('Object is not a document stored in the collection');\n      }\n\n      try {\n        this.startTransaction();\n        var arr = this.get(doc.$loki, true),\n          // obj = arr[0],\n          position = arr[1];\n        var self = this;\n        this.uniqueNames.forEach(function (key) {\n          if (doc[key] !== null && typeof doc[key] !== 'undefined') {\n            var index = self.getUniqueIndex(key);\n            if (index) {\n              index.remove(doc[key]);\n            }\n          }\n        });\n        // now that we can efficiently determine the data[] position of newly added document,\n        // submit it for all registered DynamicViews to remove\n        for (var idx = 0; idx < this.DynamicViews.length; idx++) {\n          this.DynamicViews[idx].removeDocument(position);\n        }\n\n        if (this.adaptiveBinaryIndices) {\n          // for each binary index defined in collection, immediately update rather than flag for lazy rebuild\n          var key, bIndices = this.binaryIndices;\n          for (key in bIndices) {\n            this.adaptiveBinaryIndexRemove(position, key);\n          }\n        }\n        else {\n          this.flagBinaryIndexesDirty();\n        }\n\n        this.data.splice(position, 1);\n        this.removeAutoUpdateObserver(doc);\n\n        // remove id from idIndex\n        this.idIndex.splice(position, 1);\n\n        if (this.isIncremental) {\n          this.dirtyIds.push(doc.$loki);\n        }\n\n        this.commit();\n        this.dirty = true; // for autosave scenarios\n        this.emit('delete', arr[0]);\n\n        if (!this.disableFreeze) {\n          doc = unFreeze(doc);\n        }\n        delete doc.$loki;\n        delete doc.meta;\n        if (!this.disableFreeze) {\n          freeze(doc);\n        }\n        return doc;\n\n      } catch (err) {\n        this.rollback();\n        this.lokiConsoleWrapper.error(err.message);\n        this.emit('error', err);\n        return null;\n      }\n    };\n\n    /*---------------------+\n    | Finding methods     |\n    +----------------------*/\n\n    /**\n     * Get by Id - faster than other methods because of the searching algorithm\n     * @param {int} id - $loki id of document you want to retrieve\n     * @param {boolean} returnPosition - if 'true' we will return [object, position]\n     * @returns {(object|array|null)} Object reference if document was found, null if not,\n     *     or an array if 'returnPosition' was passed.\n     * @memberof Collection\n     */\n    Collection.prototype.get = function (id, returnPosition) {\n      if (!this.idIndex) {\n        this.ensureId();\n      }\n\n      var retpos = returnPosition || false,\n        data = this.idIndex,\n        max = data.length - 1,\n        min = 0,\n        mid = (min + max) >> 1;\n\n      id = typeof id === 'number' ? id : parseInt(id, 10);\n\n      if (isNaN(id)) {\n        throw new TypeError('Passed id is not an integer');\n      }\n\n      while (data[min] < data[max]) {\n        mid = (min + max) >> 1;\n\n        if (data[mid] < id) {\n          min = mid + 1;\n        } else {\n          max = mid;\n        }\n      }\n\n      if (max === min && data[min] === id) {\n        if (retpos) {\n          return [this.data[min], min];\n        }\n        return this.data[min];\n      }\n      return null;\n\n    };\n\n    /**\n     * Perform binary range lookup for the data[dataPosition][binaryIndexName] property value\n     *    Since multiple documents may contain the same value (which the index is sorted on),\n     *    we hone in on range and then linear scan range to find exact index array position.\n     * @param {int} dataPosition : coll.data array index/position\n     * @param {string} binaryIndexName : index to search for dataPosition in\n     */\n    Collection.prototype.getBinaryIndexPosition = function (dataPosition, binaryIndexName) {\n      var val = Utils.getIn(this.data[dataPosition], binaryIndexName, true);\n      var index = this.binaryIndices[binaryIndexName].values;\n\n      // i think calculateRange can probably be moved to collection\n      // as it doesn't seem to need resultset.  need to verify\n      var range = this.calculateRange(\"$eq\", binaryIndexName, val);\n\n      if (range[0] === 0 && range[1] === -1) {\n        // uhoh didn't find range\n        return null;\n      }\n\n      var min = range[0];\n      var max = range[1];\n\n      // narrow down the sub-segment of index values\n      // where the indexed property value exactly matches our\n      // value and then linear scan to find exact -index- position\n      for (var idx = min; idx <= max; idx++) {\n        if (index[idx] === dataPosition) return idx;\n      }\n\n      // uhoh\n      return null;\n    };\n\n    /**\n     * Adaptively insert a selected item to the index.\n     * @param {int} dataPosition : coll.data array index/position\n     * @param {string} binaryIndexName : index to search for dataPosition in\n     */\n    Collection.prototype.adaptiveBinaryIndexInsert = function (dataPosition, binaryIndexName) {\n      var usingDotNotation = (binaryIndexName.indexOf('.') !== -1);\n      var index = this.binaryIndices[binaryIndexName].values;\n      var val = Utils.getIn(this.data[dataPosition], binaryIndexName, usingDotNotation);\n\n      // If you are inserting a javascript Date value into a binary index, convert to epoch time\n      if (this.serializableIndices === true && val instanceof Date) {\n        this.data[dataPosition][binaryIndexName] = val.getTime();\n        val = Utils.getIn(this.data[dataPosition], binaryIndexName);\n      }\n\n      var idxPos = (index.length === 0) ? 0 : this.calculateRangeStart(binaryIndexName, val, true, usingDotNotation);\n\n      // insert new data index into our binary index at the proper sorted location for relevant property calculated by idxPos.\n      // doing this after adjusting dataPositions so no clash with previous item at that position.\n      this.binaryIndices[binaryIndexName].values.splice(idxPos, 0, dataPosition);\n    };\n\n    /**\n     * Adaptively update a selected item within an index.\n     * @param {int} dataPosition : coll.data array index/position\n     * @param {string} binaryIndexName : index to search for dataPosition in\n     */\n    Collection.prototype.adaptiveBinaryIndexUpdate = function (dataPosition, binaryIndexName) {\n      // linear scan needed to find old position within index unless we optimize for clone scenarios later\n      // within (my) node 5.6.0, the following for() loop with strict compare is -much- faster than indexOf()\n      var idxPos,\n        index = this.binaryIndices[binaryIndexName].values,\n        len = index.length;\n\n      for (idxPos = 0; idxPos < len; idxPos++) {\n        if (index[idxPos] === dataPosition) break;\n      }\n\n      //var idxPos = this.binaryIndices[binaryIndexName].values.indexOf(dataPosition);\n      this.binaryIndices[binaryIndexName].values.splice(idxPos, 1);\n\n      //this.adaptiveBinaryIndexRemove(dataPosition, binaryIndexName, true);\n      this.adaptiveBinaryIndexInsert(dataPosition, binaryIndexName);\n    };\n\n    /**\n     * Adaptively remove a selected item from the index.\n     * @param {number|number[]} dataPosition : coll.data array index/position\n     * @param {string} binaryIndexName : index to search for dataPosition in\n     */\n    Collection.prototype.adaptiveBinaryIndexRemove = function (dataPosition, binaryIndexName, removedFromIndexOnly) {\n      var bi = this.binaryIndices[binaryIndexName];\n      var len, idx, rmidx, rmlen, rxo = {};\n      var curr, shift, idxPos;\n\n      if (Array.isArray(dataPosition)) {\n        // when called from chained remove, and only one document in array,\n        // it will be faster to use old algorithm\n        rmlen = dataPosition.length;\n        if (rmlen === 1) {\n          dataPosition = dataPosition[0];\n        }\n        // we were passed an array (batch) of documents so use this 'batch optimized' algorithm\n        else {\n          for (rmidx = 0; rmidx < rmlen; rmidx++) {\n            rxo[dataPosition[rmidx]] = true;\n          }\n\n          // remove document from index (with filter function)\n          bi.values = bi.values.filter(function (di) { return !rxo[di]; });\n\n          // if we passed this optional flag parameter, we are calling from adaptiveBinaryIndexUpdate,\n          // in which case data positions stay the same.\n          if (removedFromIndexOnly === true) {\n            return;\n          }\n\n          var sortedPositions = dataPosition.slice();\n          sortedPositions.sort(function (a, b) { return a - b; });\n\n          // to remove holes, we need to 'shift down' the index's data array positions\n          // we need to adjust array positions -1 for each index data positions greater than removed positions\n          len = bi.values.length;\n          for (idx = 0; idx < len; idx++) {\n            curr = bi.values[idx];\n            shift = 0;\n            for (rmidx = 0; rmidx < rmlen && curr > sortedPositions[rmidx]; rmidx++) {\n              shift++;\n            }\n            bi.values[idx] -= shift;\n          }\n\n          // batch processed, bail out\n          return;\n        }\n\n        // not a batch so continue...\n      }\n\n      idxPos = this.getBinaryIndexPosition(dataPosition, binaryIndexName);\n\n      if (idxPos === null) {\n        // throw new Error('unable to determine binary index position');\n        return null;\n      }\n\n      // remove document from index (with splice)\n      bi.values.splice(idxPos, 1);\n\n      // if we passed this optional flag parameter, we are calling from adaptiveBinaryIndexUpdate,\n      // in which case data positions stay the same.\n      if (removedFromIndexOnly === true) {\n        return;\n      }\n\n      // since index stores data array positions, if we remove a document\n      // we need to adjust array positions -1 for all document positions greater than removed position\n      len = bi.values.length;\n      for (idx = 0; idx < len; idx++) {\n        if (bi.values[idx] > dataPosition) {\n          bi.values[idx]--;\n        }\n      }\n    };\n\n    /**\n     * Internal method used for index maintenance and indexed searching.\n     * Calculates the beginning of an index range for a given value.\n     * For index maintainance (adaptive:true), we will return a valid index position to insert to.\n     * For querying (adaptive:false/undefined), we will :\n     *    return lower bound/index of range of that value (if found)\n     *    return next lower index position if not found (hole)\n     * If index is empty it is assumed to be handled at higher level, so\n     * this method assumes there is at least 1 document in index.\n     *\n     * @param {string} prop - name of property which has binary index\n     * @param {any} val - value to find within index\n     * @param {bool?} adaptive - if true, we will return insert position\n     */\n    Collection.prototype.calculateRangeStart = function (prop, val, adaptive, usingDotNotation) {\n      var rcd = this.data;\n      var index = this.binaryIndices[prop].values;\n      var min = 0;\n      var max = index.length - 1;\n      var mid = 0;\n\n      if (index.length === 0) {\n        return -1;\n      }\n\n      var minVal = Utils.getIn(rcd[index[min]], prop, usingDotNotation);\n      var maxVal = Utils.getIn(rcd[index[max]], prop, usingDotNotation);\n\n      // hone in on start position of value\n      while (min < max) {\n        mid = (min + max) >> 1;\n\n        if (Comparators.lt(Utils.getIn(rcd[index[mid]], prop, usingDotNotation), val, false)) {\n          min = mid + 1;\n        } else {\n          max = mid;\n        }\n      }\n\n      var lbound = min;\n\n      // found it... return it\n      if (Comparators.aeq(val, Utils.getIn(rcd[index[lbound]], prop, usingDotNotation))) {\n        return lbound;\n      }\n\n      // if not in index and our value is less than the found one\n      if (Comparators.lt(val, Utils.getIn(rcd[index[lbound]], prop, usingDotNotation), false)) {\n        return adaptive ? lbound : lbound - 1;\n      }\n\n      // not in index and our value is greater than the found one\n      return adaptive ? lbound + 1 : lbound;\n    };\n\n    /**\n     * Internal method used for indexed $between.  Given a prop (index name), and a value\n     * (which may or may not yet exist) this will find the final position of that upper range value.\n     */\n    Collection.prototype.calculateRangeEnd = function (prop, val, usingDotNotation) {\n      var rcd = this.data;\n      var index = this.binaryIndices[prop].values;\n      var min = 0;\n      var max = index.length - 1;\n      var mid = 0;\n\n      if (index.length === 0) {\n        return -1;\n      }\n\n      var minVal = Utils.getIn(rcd[index[min]], prop, usingDotNotation);\n      var maxVal = Utils.getIn(rcd[index[max]], prop, usingDotNotation);\n\n      // hone in on start position of value\n      while (min < max) {\n        mid = (min + max) >> 1;\n\n        if (Comparators.lt(val, Utils.getIn(rcd[index[mid]], prop, usingDotNotation), false)) {\n          max = mid;\n        } else {\n          min = mid + 1;\n        }\n      }\n\n      var ubound = max;\n\n      // only eq if last element in array is our val\n      if (Comparators.aeq(val, Utils.getIn(rcd[index[ubound]], prop, usingDotNotation))) {\n        return ubound;\n      }\n\n      // if not in index and our value is less than the found one\n      if (Comparators.gt(val, Utils.getIn(rcd[index[ubound]], prop, usingDotNotation), false)) {\n        return ubound + 1;\n      }\n\n      // either hole or first nonmatch\n      if (Comparators.aeq(val, Utils.getIn(rcd[index[ubound - 1]], prop, usingDotNotation))) {\n        return ubound - 1;\n      }\n\n      // hole, so ubound if nearest gt than the val we were looking for\n      return ubound;\n    };\n\n    /**\n     * calculateRange() - Binary Search utility method to find range/segment of values matching criteria.\n     *    this is used for collection.find() and first find filter of resultset/dynview\n     *    slightly different than get() binary search in that get() hones in on 1 value,\n     *    but we have to hone in on many (range)\n     * @param {string} op - operation, such as $eq\n     * @param {string} prop - name of property to calculate range for\n     * @param {object} val - value to use for range calculation.\n     * @returns {array} [start, end] index array positions\n     */\n    Collection.prototype.calculateRange = function (op, prop, val) {\n      var rcd = this.data;\n      var index = this.binaryIndices[prop].values;\n      var min = 0;\n      var max = index.length - 1;\n      var mid = 0;\n      var lbound, lval;\n      var ubound, uval;\n\n      // when no documents are in collection, return empty range condition\n      if (rcd.length === 0) {\n        return [0, -1];\n      }\n\n      var usingDotNotation = (prop.indexOf('.') !== -1);\n\n      var minVal = Utils.getIn(rcd[index[min]], prop, usingDotNotation);\n      var maxVal = Utils.getIn(rcd[index[max]], prop, usingDotNotation);\n\n      // if value falls outside of our range return [0, -1] to designate no results\n      switch (op) {\n        case '$eq':\n        case '$aeq':\n          if (Comparators.lt(val, minVal, false) || Comparators.gt(val, maxVal, false)) {\n            return [0, -1];\n          }\n          break;\n        case '$dteq':\n          if (Comparators.lt(val, minVal, false) || Comparators.gt(val, maxVal, false)) {\n            return [0, -1];\n          }\n          break;\n        case '$gt':\n          // none are within range\n          if (Comparators.gt(val, maxVal, true)) {\n            return [0, -1];\n          }\n          // all are within range\n          if (Comparators.gt(minVal, val, false)) {\n            return [min, max];\n          }\n          break;\n        case '$gte':\n          // none are within range\n          if (Comparators.gt(val, maxVal, false)) {\n            return [0, -1];\n          }\n          // all are within range\n          if (Comparators.gt(minVal, val, true)) {\n            return [min, max];\n          }\n          break;\n        case '$lt':\n          // none are within range\n          if (Comparators.lt(val, minVal, true)) {\n            return [0, -1];\n          }\n          // all are within range\n          if (Comparators.lt(maxVal, val, false)) {\n            return [min, max];\n          }\n          break;\n        case '$lte':\n          // none are within range\n          if (Comparators.lt(val, minVal, false)) {\n            return [0, -1];\n          }\n          // all are within range\n          if (Comparators.lt(maxVal, val, true)) {\n            return [min, max];\n          }\n          break;\n        case '$between':\n          // none are within range (low range is greater)\n          if (Comparators.gt(val[0], maxVal, false)) {\n            return [0, -1];\n          }\n          // none are within range (high range lower)\n          if (Comparators.lt(val[1], minVal, false)) {\n            return [0, -1];\n          }\n\n          lbound = this.calculateRangeStart(prop, val[0], false, usingDotNotation);\n          ubound = this.calculateRangeEnd(prop, val[1], usingDotNotation);\n\n          if (lbound < 0) lbound++;\n          if (ubound > max) ubound--;\n\n          if (!Comparators.gt(Utils.getIn(rcd[index[lbound]], prop, usingDotNotation), val[0], true)) lbound++;\n          if (!Comparators.lt(Utils.getIn(rcd[index[ubound]], prop, usingDotNotation), val[1], true)) ubound--;\n\n          if (ubound < lbound) return [0, -1];\n\n          return ([lbound, ubound]);\n        case '$in':\n          var idxset = [],\n            segResult = [];\n          // query each value '$eq' operator and merge the seqment results.\n          for (var j = 0, len = val.length; j < len; j++) {\n            var seg = this.calculateRange('$eq', prop, val[j]);\n\n            for (var i = seg[0]; i <= seg[1]; i++) {\n              if (idxset[i] === undefined) {\n                idxset[i] = true;\n                segResult.push(i);\n              }\n            }\n          }\n          return segResult;\n      }\n\n      // determine lbound where needed\n      switch (op) {\n        case '$eq':\n        case '$aeq':\n        case '$dteq':\n        case '$gte':\n        case '$lt':\n          lbound = this.calculateRangeStart(prop, val, false, usingDotNotation);\n          lval = Utils.getIn(rcd[index[lbound]], prop, usingDotNotation);\n          break;\n        default: break;\n      }\n\n      // determine ubound where needed\n      switch (op) {\n        case '$eq':\n        case '$aeq':\n        case '$dteq':\n        case '$lte':\n        case '$gt':\n          ubound = this.calculateRangeEnd(prop, val, usingDotNotation);\n          uval = Utils.getIn(rcd[index[ubound]], prop, usingDotNotation);\n          break;\n        default: break;\n      }\n\n\n      switch (op) {\n        case '$eq':\n        case '$aeq':\n        case '$dteq':\n          // if hole (not found)\n          if (!Comparators.aeq(lval, val)) {\n            return [0, -1];\n          }\n\n          return [lbound, ubound];\n\n        case '$gt':\n          // if hole (not found) ub position is already greater\n          if (!Comparators.aeq(Utils.getIn(rcd[index[ubound]], prop, usingDotNotation), val)) {\n            return [ubound, max];\n          }\n          // otherwise (found) so ubound is still equal, get next\n          return [ubound + 1, max];\n\n        case '$gte':\n          // if hole (not found) lb position marks left outside of range\n          if (!Comparators.aeq(Utils.getIn(rcd[index[lbound]], prop, usingDotNotation), val)) {\n            return [lbound + 1, max];\n          }\n          // otherwise (found) so lb is first position where its equal\n          return [lbound, max];\n\n        case '$lt':\n          // if hole (not found) position already is less than\n          if (!Comparators.aeq(Utils.getIn(rcd[index[lbound]], prop, usingDotNotation), val)) {\n            return [min, lbound];\n          }\n          // otherwise (found) so lb marks left inside of eq range, get previous\n          return [min, lbound - 1];\n\n        case '$lte':\n          // if hole (not found) ub position marks right outside so get previous\n          if (!Comparators.aeq(Utils.getIn(rcd[index[ubound]], prop, usingDotNotation), val)) {\n            return [min, ubound - 1];\n          }\n          // otherwise (found) so ub is last position where its still equal\n          return [min, ubound];\n\n        default:\n          return [0, rcd.length - 1];\n      }\n    };\n\n    /**\n     * Retrieve doc by Unique index\n     * @param {string} field - name of uniquely indexed property to use when doing lookup\n     * @param {value} value - unique value to search for\n     * @returns {object} document matching the value passed\n     * @memberof Collection\n     */\n    Collection.prototype.by = function (field, value) {\n      var self;\n      if (value === undefined) {\n        self = this;\n        return function (value) {\n          return self.by(field, value);\n        };\n      }\n\n      var result = this.getUniqueIndex(field, true).get(value);\n      if (!this.cloneObjects) {\n        return result;\n      } else {\n        return clone(result, this.cloneMethod);\n      }\n    };\n\n    /**\n     * Find one object by index property, by property equal to value\n     * @param {object} query - query object used to perform search with\n     * @returns {(object|null)} First matching document, or null if none\n     * @memberof Collection\n     */\n    Collection.prototype.findOne = function (query) {\n      query = query || {};\n\n      // Instantiate Resultset and exec find op passing firstOnly = true param\n      var result = this.chain().find(query, true).data();\n\n      if (Array.isArray(result) && result.length === 0) {\n        return null;\n      } else {\n        if (!this.cloneObjects) {\n          return result[0];\n        } else {\n          return clone(result[0], this.cloneMethod);\n        }\n      }\n    };\n\n    /**\n     * Chain method, used for beginning a series of chained find() and/or view() operations\n     * on a collection.\n     *\n     * @param {string|array=} transform - named transform or array of transform steps\n     * @param {object=} parameters - Object containing properties representing parameters to substitute\n     * @returns {Resultset} (this) resultset, or data array if any map or join functions where called\n     * @memberof Collection\n     */\n    Collection.prototype.chain = function (transform, parameters) {\n      var rs = new Resultset(this);\n\n      if (typeof transform === 'undefined') {\n        return rs;\n      }\n\n      return rs.transform(transform, parameters);\n    };\n\n    /**\n     * Find method, api is similar to mongodb.\n     * for more complex queries use [chain()]{@link Collection#chain} or [where()]{@link Collection#where}.\n     * @example {@tutorial Query Examples}\n     * @param {object} query - 'mongo-like' query object\n     * @returns {array} Array of matching documents\n     * @memberof Collection\n     */\n    Collection.prototype.find = function (query) {\n      return this.chain().find(query).data();\n    };\n\n    /**\n     * Find object by unindexed field by property equal to value,\n     * simply iterates and returns the first element matching the query\n     */\n    Collection.prototype.findOneUnindexed = function (prop, value) {\n      var i = this.data.length,\n        doc;\n      while (i--) {\n        if (Utils.getIn(this.data[i], prop, true) === value) {\n          doc = this.data[i];\n          return doc;\n        }\n      }\n      return null;\n    };\n\n    /**\n     * Transaction methods\n     */\n\n    /** start the transation */\n    Collection.prototype.startTransaction = function () {\n      if (this.transactional) {\n        this.cachedData = clone(this.data, this.cloneMethod);\n        this.cachedIndex = this.idIndex;\n        this.cachedBinaryIndex = this.binaryIndices;\n        this.cachedDirtyIds = this.dirtyIds;\n\n        // propagate startTransaction to dynamic views\n        for (var idx = 0; idx < this.DynamicViews.length; idx++) {\n          this.DynamicViews[idx].startTransaction();\n        }\n      }\n    };\n\n    /** commit the transation */\n    Collection.prototype.commit = function () {\n      if (this.transactional) {\n        this.cachedData = null;\n        this.cachedIndex = null;\n        this.cachedBinaryIndex = null;\n        this.cachedDirtyIds = null;\n\n        // propagate commit to dynamic views\n        for (var idx = 0; idx < this.DynamicViews.length; idx++) {\n          this.DynamicViews[idx].commit();\n        }\n      }\n    };\n\n    /** roll back the transation */\n    Collection.prototype.rollback = function () {\n      if (this.transactional) {\n        if (this.cachedData !== null && this.cachedIndex !== null) {\n          this.data = this.cachedData;\n          this.idIndex = this.cachedIndex;\n          this.binaryIndices = this.cachedBinaryIndex;\n          this.dirtyIds = this.cachedDirtyIds;\n        }\n\n        // propagate rollback to dynamic views\n        for (var idx = 0; idx < this.DynamicViews.length; idx++) {\n          this.DynamicViews[idx].rollback();\n        }\n      }\n    };\n\n    // async executor. This is only to enable callbacks at the end of the execution.\n    Collection.prototype.async = function (fun, callback) {\n      setTimeout(function () {\n        if (typeof fun === 'function') {\n          fun();\n          callback();\n        } else {\n          throw new TypeError('Argument passed for async execution is not a function');\n        }\n      }, 0);\n    };\n\n    /**\n     * Query the collection by supplying a javascript filter function.\n     * @example\n     * var results = coll.where(function(obj) {\n     *   return obj.legs === 8;\n     * });\n     *\n     * @param {function} fun - filter function to run against all collection docs\n     * @returns {array} all documents which pass your filter function\n     * @memberof Collection\n     */\n    Collection.prototype.where = function (fun) {\n      return this.chain().where(fun).data();\n    };\n\n    /**\n     * Map Reduce operation\n     *\n     * @param {function} mapFunction - function to use as map function\n     * @param {function} reduceFunction - function to use as reduce function\n     * @returns {data} The result of your mapReduce operation\n     * @memberof Collection\n     */\n    Collection.prototype.mapReduce = function (mapFunction, reduceFunction) {\n      try {\n        return reduceFunction(this.data.map(mapFunction));\n      } catch (err) {\n        throw err;\n      }\n    };\n\n    /**\n     * Join two collections on specified properties\n     *\n     * @param {array|Resultset|Collection} joinData - array of documents to 'join' to this collection\n     * @param {string} leftJoinProp - property name in collection\n     * @param {string} rightJoinProp - property name in joinData\n     * @param {function=} mapFun - (Optional) map function to use\n     * @param {object=} dataOptions - options to data() before input to your map function\n     * @param {bool} dataOptions.removeMeta - allows removing meta before calling mapFun\n     * @param {boolean} dataOptions.forceClones - forcing the return of cloned objects to your map object\n     * @param {string} dataOptions.forceCloneMethod - Allows overriding the default or collection specified cloning method.\n     * @returns {Resultset} Result of the mapping operation\n     * @memberof Collection\n     */\n    Collection.prototype.eqJoin = function (joinData, leftJoinProp, rightJoinProp, mapFun, dataOptions) {\n      // logic in Resultset class\n      return new Resultset(this).eqJoin(joinData, leftJoinProp, rightJoinProp, mapFun, dataOptions);\n    };\n\n    /* ------ STAGING API -------- */\n    /**\n     * stages: a map of uniquely identified 'stages', which hold copies of objects to be\n     * manipulated without affecting the data in the original collection\n     */\n    Collection.prototype.stages = {};\n\n    /**\n     * (Staging API) create a stage and/or retrieve it\n     * @memberof Collection\n     */\n    Collection.prototype.getStage = function (name) {\n      if (!this.stages[name]) {\n        this.stages[name] = {};\n      }\n      return this.stages[name];\n    };\n    /**\n     * a collection of objects recording the changes applied through a commmitStage\n     */\n    Collection.prototype.commitLog = [];\n\n    /**\n     * (Staging API) create a copy of an object and insert it into a stage\n     * @memberof Collection\n     */\n    Collection.prototype.stage = function (stageName, obj) {\n      var copy = JSON.parse(JSON.stringify(obj));\n      this.getStage(stageName)[obj.$loki] = copy;\n      return copy;\n    };\n\n    /**\n     * (Staging API) re-attach all objects to the original collection, so indexes and views can be rebuilt\n     * then create a message to be inserted in the commitlog\n     * @param {string} stageName - name of stage\n     * @param {string} message\n     * @memberof Collection\n     */\n    Collection.prototype.commitStage = function (stageName, message) {\n      var stage = this.getStage(stageName),\n        prop,\n        timestamp = new Date().getTime();\n\n      for (prop in stage) {\n\n        this.update(stage[prop]);\n        this.commitLog.push({\n          timestamp: timestamp,\n          message: message,\n          data: JSON.parse(JSON.stringify(stage[prop]))\n        });\n      }\n      this.stages[stageName] = {};\n    };\n\n    Collection.prototype.no_op = function () {\n      return;\n    };\n\n    /**\n     * @memberof Collection\n     */\n    Collection.prototype.extract = function (field) {\n      var i = 0,\n        len = this.data.length,\n        isDotNotation = isDeepProperty(field),\n        result = [];\n      for (i; i < len; i += 1) {\n        result.push(deepProperty(this.data[i], field, isDotNotation));\n      }\n      return result;\n    };\n\n    /**\n     * @memberof Collection\n     */\n    Collection.prototype.max = function (field) {\n      return Math.max.apply(null, this.extract(field));\n    };\n\n    /**\n     * @memberof Collection\n     */\n    Collection.prototype.min = function (field) {\n      return Math.min.apply(null, this.extract(field));\n    };\n\n    /**\n     * @memberof Collection\n     */\n    Collection.prototype.maxRecord = function (field) {\n      var i = 0,\n        len = this.data.length,\n        deep = isDeepProperty(field),\n        result = {\n          index: 0,\n          value: undefined\n        },\n        max;\n\n      for (i; i < len; i += 1) {\n        if (max !== undefined) {\n          if (max < deepProperty(this.data[i], field, deep)) {\n            max = deepProperty(this.data[i], field, deep);\n            result.index = this.data[i].$loki;\n          }\n        } else {\n          max = deepProperty(this.data[i], field, deep);\n          result.index = this.data[i].$loki;\n        }\n      }\n      result.value = max;\n      return result;\n    };\n\n    /**\n     * @memberof Collection\n     */\n    Collection.prototype.minRecord = function (field) {\n      var i = 0,\n        len = this.data.length,\n        deep = isDeepProperty(field),\n        result = {\n          index: 0,\n          value: undefined\n        },\n        min;\n\n      for (i; i < len; i += 1) {\n        if (min !== undefined) {\n          if (min > deepProperty(this.data[i], field, deep)) {\n            min = deepProperty(this.data[i], field, deep);\n            result.index = this.data[i].$loki;\n          }\n        } else {\n          min = deepProperty(this.data[i], field, deep);\n          result.index = this.data[i].$loki;\n        }\n      }\n      result.value = min;\n      return result;\n    };\n\n    /**\n     * @memberof Collection\n     */\n    Collection.prototype.extractNumerical = function (field) {\n      return this.extract(field).map(parseBase10).filter(Number).filter(function (n) {\n        return !(isNaN(n));\n      });\n    };\n\n    /**\n     * Calculates the average numerical value of a property\n     *\n     * @param {string} field - name of property in docs to average\n     * @returns {number} average of property in all docs in the collection\n     * @memberof Collection\n     */\n    Collection.prototype.avg = function (field) {\n      return average(this.extractNumerical(field));\n    };\n\n    /**\n     * Calculate standard deviation of a field\n     * @memberof Collection\n     * @param {string} field\n     */\n    Collection.prototype.stdDev = function (field) {\n      return standardDeviation(this.extractNumerical(field));\n    };\n\n    /**\n     * @memberof Collection\n     * @param {string} field\n     */\n    Collection.prototype.mode = function (field) {\n      var dict = {},\n        data = this.extract(field);\n      data.forEach(function (obj) {\n        if (dict[obj]) {\n          dict[obj] += 1;\n        } else {\n          dict[obj] = 1;\n        }\n      });\n      var max,\n        prop, mode;\n      for (prop in dict) {\n        if (max) {\n          if (max < dict[prop]) {\n            mode = prop;\n          }\n        } else {\n          mode = prop;\n          max = dict[prop];\n        }\n      }\n      return mode;\n    };\n\n    /**\n     * @memberof Collection\n     * @param {string} field - property name\n     */\n    Collection.prototype.median = function (field) {\n      var values = this.extractNumerical(field);\n      values.sort(sub);\n\n      var half = Math.floor(values.length / 2);\n\n      if (values.length % 2) {\n        return values[half];\n      } else {\n        return (values[half - 1] + values[half]) / 2.0;\n      }\n    };\n\n    /**\n     * General utils, including statistical functions\n     */\n    function isDeepProperty(field) {\n      return field.indexOf('.') !== -1;\n    }\n\n    function parseBase10(num) {\n      return parseFloat(num, 10);\n    }\n\n    function isNotUndefined(obj) {\n      return obj !== undefined;\n    }\n\n    function add(a, b) {\n      return a + b;\n    }\n\n    function sub(a, b) {\n      return a - b;\n    }\n\n    function median(values) {\n      values.sort(sub);\n      var half = Math.floor(values.length / 2);\n      return (values.length % 2) ? values[half] : ((values[half - 1] + values[half]) / 2.0);\n    }\n\n    function average(array) {\n      return (array.reduce(add, 0)) / array.length;\n    }\n\n    function standardDeviation(values) {\n      var avg = average(values);\n      var squareDiffs = values.map(function (value) {\n        var diff = value - avg;\n        var sqrDiff = diff * diff;\n        return sqrDiff;\n      });\n\n      var avgSquareDiff = average(squareDiffs);\n\n      var stdDev = Math.sqrt(avgSquareDiff);\n      return stdDev;\n    }\n\n    function deepProperty(obj, property, isDeep) {\n      if (isDeep === false) {\n        // pass without processing\n        return obj[property];\n      }\n      var pieces = property.split('.'),\n        root = obj;\n      while (pieces.length > 0) {\n        root = root[pieces.shift()];\n      }\n      return root;\n    }\n\n    function binarySearch(array, item, fun) {\n      var lo = 0,\n        hi = array.length,\n        compared,\n        mid;\n      while (lo < hi) {\n        mid = (lo + hi) >> 1;\n        compared = fun.apply(null, [item, array[mid]]);\n        if (compared === 0) {\n          return {\n            found: true,\n            index: mid\n          };\n        } else if (compared < 0) {\n          hi = mid;\n        } else {\n          lo = mid + 1;\n        }\n      }\n      return {\n        found: false,\n        index: hi\n      };\n    }\n\n    function BSonSort(fun) {\n      return function (array, item) {\n        return binarySearch(array, item, fun);\n      };\n    }\n\n    function KeyValueStore() { }\n\n    KeyValueStore.prototype = {\n      keys: [],\n      values: [],\n      sort: function (a, b) {\n        return (a < b) ? -1 : ((a > b) ? 1 : 0);\n      },\n      setSort: function (fun) {\n        this.bs = new BSonSort(fun);\n      },\n      bs: function () {\n        return new BSonSort(this.sort);\n      },\n      set: function (key, value) {\n        var pos = this.bs(this.keys, key);\n        if (pos.found) {\n          this.values[pos.index] = value;\n        } else {\n          this.keys.splice(pos.index, 0, key);\n          this.values.splice(pos.index, 0, value);\n        }\n      },\n      get: function (key) {\n        return this.values[binarySearch(this.keys, key, this.sort).index];\n      }\n    };\n\n    function UniqueIndex(uniqueField) {\n      this.field = uniqueField;\n      this.keyMap = Object.create(null);\n      this.lokiMap = Object.create(null);\n    }\n    UniqueIndex.prototype.keyMap = {};\n    UniqueIndex.prototype.lokiMap = {};\n    UniqueIndex.prototype.set = function (obj) {\n      var fieldValue = obj[this.field];\n      if (fieldValue !== null && typeof (fieldValue) !== 'undefined') {\n        if (this.keyMap[fieldValue]) {\n          throw new Error('Duplicate key for property ' + this.field + ': ' + fieldValue);\n        } else {\n          this.keyMap[fieldValue] = obj;\n          this.lokiMap[obj.$loki] = fieldValue;\n        }\n      }\n    };\n    UniqueIndex.prototype.get = function (key) {\n      return this.keyMap[key];\n    };\n\n    UniqueIndex.prototype.byId = function (id) {\n      return this.keyMap[this.lokiMap[id]];\n    };\n    /**\n     * Updates a document's unique index given an updated object.\n     * @param  {Object} obj Original document object\n     * @param  {Object} doc New document object (likely the same as obj)\n     */\n    UniqueIndex.prototype.update = function (obj, doc) {\n      if (this.lokiMap[obj.$loki] !== doc[this.field]) {\n        var old = this.lokiMap[obj.$loki];\n        this.set(doc);\n        // make the old key fail bool test, while avoiding the use of delete (mem-leak prone)\n        this.keyMap[old] = undefined;\n      } else {\n        this.keyMap[obj[this.field]] = doc;\n      }\n    };\n    UniqueIndex.prototype.remove = function (key) {\n      var obj = this.keyMap[key];\n      if (obj !== null && typeof obj !== 'undefined') {\n        // avoid using `delete`\n        this.keyMap[key] = undefined;\n        this.lokiMap[obj.$loki] = undefined;\n      } else {\n        throw new Error('Key is not in unique index: ' + this.field);\n      }\n    };\n    UniqueIndex.prototype.clear = function () {\n      this.keyMap = Object.create(null);\n      this.lokiMap = Object.create(null);\n    };\n\n    function ExactIndex(exactField) {\n      this.index = Object.create(null);\n      this.field = exactField;\n    }\n\n    // add the value you want returned to the key in the index\n    ExactIndex.prototype = {\n      set: function add(key, val) {\n        if (this.index[key]) {\n          this.index[key].push(val);\n        } else {\n          this.index[key] = [val];\n        }\n      },\n\n      // remove the value from the index, if the value was the last one, remove the key\n      remove: function remove(key, val) {\n        var idxSet = this.index[key];\n        for (var i in idxSet) {\n          if (idxSet[i] == val) {\n            idxSet.splice(i, 1);\n          }\n        }\n        if (idxSet.length < 1) {\n          this.index[key] = undefined;\n        }\n      },\n\n      // get the values related to the key, could be more than one\n      get: function get(key) {\n        return this.index[key];\n      },\n\n      // clear will zap the index\n      clear: function clear(key) {\n        this.index = {};\n      }\n    };\n\n    function SortedIndex(sortedField) {\n      this.field = sortedField;\n    }\n\n    SortedIndex.prototype = {\n      keys: [],\n      values: [],\n      // set the default sort\n      sort: function (a, b) {\n        return (a < b) ? -1 : ((a > b) ? 1 : 0);\n      },\n      bs: function () {\n        return new BSonSort(this.sort);\n      },\n      // and allow override of the default sort\n      setSort: function (fun) {\n        this.bs = new BSonSort(fun);\n      },\n      // add the value you want returned  to the key in the index\n      set: function (key, value) {\n        var pos = binarySearch(this.keys, key, this.sort);\n        if (pos.found) {\n          this.values[pos.index].push(value);\n        } else {\n          this.keys.splice(pos.index, 0, key);\n          this.values.splice(pos.index, 0, [value]);\n        }\n      },\n      // get all values which have a key == the given key\n      get: function (key) {\n        var bsr = binarySearch(this.keys, key, this.sort);\n        if (bsr.found) {\n          return this.values[bsr.index];\n        } else {\n          return [];\n        }\n      },\n      // get all values which have a key < the given key\n      getLt: function (key) {\n        var bsr = binarySearch(this.keys, key, this.sort);\n        var pos = bsr.index;\n        if (bsr.found) pos--;\n        return this.getAll(key, 0, pos);\n      },\n      // get all values which have a key > the given key\n      getGt: function (key) {\n        var bsr = binarySearch(this.keys, key, this.sort);\n        var pos = bsr.index;\n        if (bsr.found) pos++;\n        return this.getAll(key, pos, this.keys.length);\n      },\n\n      // get all vals from start to end\n      getAll: function (key, start, end) {\n        var results = [];\n        for (var i = start; i < end; i++) {\n          results = results.concat(this.values[i]);\n        }\n        return results;\n      },\n      // just in case someone wants to do something smart with ranges\n      getPos: function (key) {\n        return binarySearch(this.keys, key, this.sort);\n      },\n      // remove the value from the index, if the value was the last one, remove the key\n      remove: function (key, value) {\n        var pos = binarySearch(this.keys, key, this.sort).index;\n        var idxSet = this.values[pos];\n        for (var i in idxSet) {\n          if (idxSet[i] == value) idxSet.splice(i, 1);\n        }\n        if (idxSet.length < 1) {\n          this.keys.splice(pos, 1);\n          this.values.splice(pos, 1);\n        }\n      },\n      // clear will zap the index\n      clear: function () {\n        this.keys = [];\n        this.values = [];\n      }\n    };\n\n    Loki.deepFreeze = deepFreeze;\n    Loki.freeze = freeze;\n    Loki.unFreeze = unFreeze;\n    Loki.LokiOps = LokiOps;\n    Loki.Collection = Collection;\n    Loki.DynamicView = DynamicView;\n    Loki.Resultset = Resultset;\n    Loki.KeyValueStore = KeyValueStore;\n    Loki.LokiMemoryAdapter = LokiMemoryAdapter;\n    Loki.LokiPartitioningAdapter = LokiPartitioningAdapter;\n    Loki.LokiLocalStorageAdapter = LokiLocalStorageAdapter;\n    Loki.LokiFsAdapter = LokiFsAdapter;\n    Loki.persistenceAdapters = {\n      fs: LokiFsAdapter,\n      localStorage: LokiLocalStorageAdapter\n    };\n    Loki.aeq = aeqHelper;\n    Loki.lt = ltHelper;\n    Loki.gt = gtHelper;\n    Loki.Comparators = Comparators;\n    return Loki;\n  }());\n\n}));\n","(function (root, factory) {\n  'use strict'\n\n  /*istanbul ignore next:cant test*/\n  if (typeof module === 'object' && typeof module.exports === 'object') {\n    module.exports = factory()\n  } else if (typeof define === 'function' && define.amd) {\n    // AMD. Register as an anonymous module.\n    define([], factory)\n  } else {\n    // Browser globals\n    root.objectPath = factory()\n  }\n})(this, function () {\n  'use strict'\n\n  var toStr = Object.prototype.toString\n\n  function hasOwnProperty (obj, prop) {\n    if (obj == null) {\n      return false\n    }\n    //to handle objects with null prototypes (too edge case?)\n    return Object.prototype.hasOwnProperty.call(obj, prop)\n  }\n\n  function isEmpty (value) {\n    if (!value) {\n      return true\n    }\n    if (isArray(value) && value.length === 0) {\n      return true\n    } else if (typeof value !== 'string') {\n      for (var i in value) {\n        if (hasOwnProperty(value, i)) {\n          return false\n        }\n      }\n      return true\n    }\n    return false\n  }\n\n  function toString (type) {\n    return toStr.call(type)\n  }\n\n  function isObject (obj) {\n    return typeof obj === 'object' && toString(obj) === '[object Object]'\n  }\n\n  var isArray = Array.isArray || function (obj) {\n    /*istanbul ignore next:cant test*/\n    return toStr.call(obj) === '[object Array]'\n  }\n\n  function isBoolean (obj) {\n    return typeof obj === 'boolean' || toString(obj) === '[object Boolean]'\n  }\n\n  function getKey (key) {\n    var intKey = parseInt(key)\n    if (intKey.toString() === key) {\n      return intKey\n    }\n    return key\n  }\n\n  function factory (options) {\n    options = options || {}\n\n    var objectPath = function (obj) {\n      return Object.keys(objectPath).reduce(function (proxy, prop) {\n        if (prop === 'create') {\n          return proxy\n        }\n\n        /*istanbul ignore else*/\n        if (typeof objectPath[prop] === 'function') {\n          proxy[prop] = objectPath[prop].bind(objectPath, obj)\n        }\n\n        return proxy\n      }, {})\n    }\n\n    var hasShallowProperty\n    if (options.includeInheritedProps) {\n      hasShallowProperty = function () {\n        return true\n      }\n    } else {\n      hasShallowProperty = function (obj, prop) {\n        return (typeof prop === 'number' && Array.isArray(obj)) || hasOwnProperty(obj, prop)\n      }\n    }\n\n    function getShallowProperty (obj, prop) {\n      if (hasShallowProperty(obj, prop)) {\n        return obj[prop]\n      }\n    }\n\n    var getShallowPropertySafely\n    if (options.includeInheritedProps) {\n      getShallowPropertySafely = function (obj, currentPath) {\n        if (typeof currentPath !== 'string' && typeof currentPath !== 'number') {\n          currentPath = String(currentPath)\n        }\n        var currentValue = getShallowProperty(obj, currentPath)\n        if (currentPath === '__proto__' || currentPath === 'prototype' ||\n          (currentPath === 'constructor' && typeof currentValue === 'function')) {\n          throw new Error('For security reasons, object\\'s magic properties cannot be set')\n        }\n        return currentValue\n      }\n    } else {\n      getShallowPropertySafely = function (obj, currentPath) {\n        return getShallowProperty(obj, currentPath)\n      }\n    }\n\n    function set (obj, path, value, doNotReplace) {\n      if (typeof path === 'number') {\n        path = [path]\n      }\n      if (!path || path.length === 0) {\n        return obj\n      }\n      if (typeof path === 'string') {\n        return set(obj, path.split('.').map(getKey), value, doNotReplace)\n      }\n      var currentPath = path[0]\n      var currentValue = getShallowPropertySafely(obj, currentPath)\n      if (path.length === 1) {\n        if (currentValue === void 0 || !doNotReplace) {\n          obj[currentPath] = value\n        }\n        return currentValue\n      }\n\n      if (currentValue === void 0) {\n        //check if we assume an array\n        if (typeof path[1] === 'number') {\n          obj[currentPath] = []\n        } else {\n          obj[currentPath] = {}\n        }\n      }\n\n      return set(obj[currentPath], path.slice(1), value, doNotReplace)\n    }\n\n    objectPath.has = function (obj, path) {\n      if (typeof path === 'number') {\n        path = [path]\n      } else if (typeof path === 'string') {\n        path = path.split('.')\n      }\n\n      if (!path || path.length === 0) {\n        return !!obj\n      }\n\n      for (var i = 0; i < path.length; i++) {\n        var j = getKey(path[i])\n\n        if ((typeof j === 'number' && isArray(obj) && j < obj.length) ||\n          (options.includeInheritedProps ? (j in Object(obj)) : hasOwnProperty(obj, j))) {\n          obj = obj[j]\n        } else {\n          return false\n        }\n      }\n\n      return true\n    }\n\n    objectPath.ensureExists = function (obj, path, value) {\n      return set(obj, path, value, true)\n    }\n\n    objectPath.set = function (obj, path, value, doNotReplace) {\n      return set(obj, path, value, doNotReplace)\n    }\n\n    objectPath.insert = function (obj, path, value, at) {\n      var arr = objectPath.get(obj, path)\n      at = ~~at\n      if (!isArray(arr)) {\n        arr = []\n        objectPath.set(obj, path, arr)\n      }\n      arr.splice(at, 0, value)\n    }\n\n    objectPath.empty = function (obj, path) {\n      if (isEmpty(path)) {\n        return void 0\n      }\n      if (obj == null) {\n        return void 0\n      }\n\n      var value, i\n      if (!(value = objectPath.get(obj, path))) {\n        return void 0\n      }\n\n      if (typeof value === 'string') {\n        return objectPath.set(obj, path, '')\n      } else if (isBoolean(value)) {\n        return objectPath.set(obj, path, false)\n      } else if (typeof value === 'number') {\n        return objectPath.set(obj, path, 0)\n      } else if (isArray(value)) {\n        value.length = 0\n      } else if (isObject(value)) {\n        for (i in value) {\n          if (hasShallowProperty(value, i)) {\n            delete value[i]\n          }\n        }\n      } else {\n        return objectPath.set(obj, path, null)\n      }\n    }\n\n    objectPath.push = function (obj, path /*, values */) {\n      var arr = objectPath.get(obj, path)\n      if (!isArray(arr)) {\n        arr = []\n        objectPath.set(obj, path, arr)\n      }\n\n      arr.push.apply(arr, Array.prototype.slice.call(arguments, 2))\n    }\n\n    objectPath.coalesce = function (obj, paths, defaultValue) {\n      var value\n\n      for (var i = 0, len = paths.length; i < len; i++) {\n        if ((value = objectPath.get(obj, paths[i])) !== void 0) {\n          return value\n        }\n      }\n\n      return defaultValue\n    }\n\n    objectPath.get = function (obj, path, defaultValue) {\n      if (typeof path === 'number') {\n        path = [path]\n      }\n      if (!path || path.length === 0) {\n        return obj\n      }\n      if (obj == null) {\n        return defaultValue\n      }\n      if (typeof path === 'string') {\n        return objectPath.get(obj, path.split('.'), defaultValue)\n      }\n\n      var currentPath = getKey(path[0])\n      var nextObj = getShallowPropertySafely(obj, currentPath)\n      if (nextObj === void 0) {\n        return defaultValue\n      }\n\n      if (path.length === 1) {\n        return nextObj\n      }\n\n      return objectPath.get(obj[currentPath], path.slice(1), defaultValue)\n    }\n\n    objectPath.del = function del (obj, path) {\n      if (typeof path === 'number') {\n        path = [path]\n      }\n\n      if (obj == null) {\n        return obj\n      }\n\n      if (isEmpty(path)) {\n        return obj\n      }\n      if (typeof path === 'string') {\n        return objectPath.del(obj, path.split('.'))\n      }\n\n      var currentPath = getKey(path[0])\n      getShallowPropertySafely(obj, currentPath)\n      if (!hasShallowProperty(obj, currentPath)) {\n        return obj\n      }\n\n      if (path.length === 1) {\n        if (isArray(obj)) {\n          obj.splice(currentPath, 1)\n        } else {\n          delete obj[currentPath]\n        }\n      } else {\n        return objectPath.del(obj[currentPath], path.slice(1))\n      }\n\n      return obj\n    }\n\n    return objectPath\n  }\n\n  var mod = factory()\n  mod.create = factory\n  mod.withInheritedProps = factory({includeInheritedProps: true})\n  return mod\n})\n","(function (factory) {\n    if (typeof exports === 'object') {\n        // Node/CommonJS\n        module.exports = factory();\n    } else if (typeof define === 'function' && define.amd) {\n        // AMD\n        define(factory);\n    } else {\n        // Browser globals (with support for web workers)\n        var glob;\n\n        try {\n            glob = window;\n        } catch (e) {\n            glob = self;\n        }\n\n        glob.SparkMD5 = factory();\n    }\n}(function (undefined) {\n\n    'use strict';\n\n    /*\n     * Fastest md5 implementation around (JKM md5).\n     * Credits: Joseph Myers\n     *\n     * @see http://www.myersdaily.org/joseph/javascript/md5-text.html\n     * @see http://jsperf.com/md5-shootout/7\n     */\n\n    /* this function is much faster,\n      so if possible we use it. Some IEs\n      are the only ones I know of that\n      need the idiotic second function,\n      generated by an if clause.  */\n    var add32 = function (a, b) {\n        return (a + b) & 0xFFFFFFFF;\n    },\n        hex_chr = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f'];\n\n\n    function cmn(q, a, b, x, s, t) {\n        a = add32(add32(a, q), add32(x, t));\n        return add32((a << s) | (a >>> (32 - s)), b);\n    }\n\n    function md5cycle(x, k) {\n        var a = x[0],\n            b = x[1],\n            c = x[2],\n            d = x[3];\n\n        a += (b & c | ~b & d) + k[0] - 680876936 | 0;\n        a  = (a << 7 | a >>> 25) + b | 0;\n        d += (a & b | ~a & c) + k[1] - 389564586 | 0;\n        d  = (d << 12 | d >>> 20) + a | 0;\n        c += (d & a | ~d & b) + k[2] + 606105819 | 0;\n        c  = (c << 17 | c >>> 15) + d | 0;\n        b += (c & d | ~c & a) + k[3] - 1044525330 | 0;\n        b  = (b << 22 | b >>> 10) + c | 0;\n        a += (b & c | ~b & d) + k[4] - 176418897 | 0;\n        a  = (a << 7 | a >>> 25) + b | 0;\n        d += (a & b | ~a & c) + k[5] + 1200080426 | 0;\n        d  = (d << 12 | d >>> 20) + a | 0;\n        c += (d & a | ~d & b) + k[6] - 1473231341 | 0;\n        c  = (c << 17 | c >>> 15) + d | 0;\n        b += (c & d | ~c & a) + k[7] - 45705983 | 0;\n        b  = (b << 22 | b >>> 10) + c | 0;\n        a += (b & c | ~b & d) + k[8] + 1770035416 | 0;\n        a  = (a << 7 | a >>> 25) + b | 0;\n        d += (a & b | ~a & c) + k[9] - 1958414417 | 0;\n        d  = (d << 12 | d >>> 20) + a | 0;\n        c += (d & a | ~d & b) + k[10] - 42063 | 0;\n        c  = (c << 17 | c >>> 15) + d | 0;\n        b += (c & d | ~c & a) + k[11] - 1990404162 | 0;\n        b  = (b << 22 | b >>> 10) + c | 0;\n        a += (b & c | ~b & d) + k[12] + 1804603682 | 0;\n        a  = (a << 7 | a >>> 25) + b | 0;\n        d += (a & b | ~a & c) + k[13] - 40341101 | 0;\n        d  = (d << 12 | d >>> 20) + a | 0;\n        c += (d & a | ~d & b) + k[14] - 1502002290 | 0;\n        c  = (c << 17 | c >>> 15) + d | 0;\n        b += (c & d | ~c & a) + k[15] + 1236535329 | 0;\n        b  = (b << 22 | b >>> 10) + c | 0;\n\n        a += (b & d | c & ~d) + k[1] - 165796510 | 0;\n        a  = (a << 5 | a >>> 27) + b | 0;\n        d += (a & c | b & ~c) + k[6] - 1069501632 | 0;\n        d  = (d << 9 | d >>> 23) + a | 0;\n        c += (d & b | a & ~b) + k[11] + 643717713 | 0;\n        c  = (c << 14 | c >>> 18) + d | 0;\n        b += (c & a | d & ~a) + k[0] - 373897302 | 0;\n        b  = (b << 20 | b >>> 12) + c | 0;\n        a += (b & d | c & ~d) + k[5] - 701558691 | 0;\n        a  = (a << 5 | a >>> 27) + b | 0;\n        d += (a & c | b & ~c) + k[10] + 38016083 | 0;\n        d  = (d << 9 | d >>> 23) + a | 0;\n        c += (d & b | a & ~b) + k[15] - 660478335 | 0;\n        c  = (c << 14 | c >>> 18) + d | 0;\n        b += (c & a | d & ~a) + k[4] - 405537848 | 0;\n        b  = (b << 20 | b >>> 12) + c | 0;\n        a += (b & d | c & ~d) + k[9] + 568446438 | 0;\n        a  = (a << 5 | a >>> 27) + b | 0;\n        d += (a & c | b & ~c) + k[14] - 1019803690 | 0;\n        d  = (d << 9 | d >>> 23) + a | 0;\n        c += (d & b | a & ~b) + k[3] - 187363961 | 0;\n        c  = (c << 14 | c >>> 18) + d | 0;\n        b += (c & a | d & ~a) + k[8] + 1163531501 | 0;\n        b  = (b << 20 | b >>> 12) + c | 0;\n        a += (b & d | c & ~d) + k[13] - 1444681467 | 0;\n        a  = (a << 5 | a >>> 27) + b | 0;\n        d += (a & c | b & ~c) + k[2] - 51403784 | 0;\n        d  = (d << 9 | d >>> 23) + a | 0;\n        c += (d & b | a & ~b) + k[7] + 1735328473 | 0;\n        c  = (c << 14 | c >>> 18) + d | 0;\n        b += (c & a | d & ~a) + k[12] - 1926607734 | 0;\n        b  = (b << 20 | b >>> 12) + c | 0;\n\n        a += (b ^ c ^ d) + k[5] - 378558 | 0;\n        a  = (a << 4 | a >>> 28) + b | 0;\n        d += (a ^ b ^ c) + k[8] - 2022574463 | 0;\n        d  = (d << 11 | d >>> 21) + a | 0;\n        c += (d ^ a ^ b) + k[11] + 1839030562 | 0;\n        c  = (c << 16 | c >>> 16) + d | 0;\n        b += (c ^ d ^ a) + k[14] - 35309556 | 0;\n        b  = (b << 23 | b >>> 9) + c | 0;\n        a += (b ^ c ^ d) + k[1] - 1530992060 | 0;\n        a  = (a << 4 | a >>> 28) + b | 0;\n        d += (a ^ b ^ c) + k[4] + 1272893353 | 0;\n        d  = (d << 11 | d >>> 21) + a | 0;\n        c += (d ^ a ^ b) + k[7] - 155497632 | 0;\n        c  = (c << 16 | c >>> 16) + d | 0;\n        b += (c ^ d ^ a) + k[10] - 1094730640 | 0;\n        b  = (b << 23 | b >>> 9) + c | 0;\n        a += (b ^ c ^ d) + k[13] + 681279174 | 0;\n        a  = (a << 4 | a >>> 28) + b | 0;\n        d += (a ^ b ^ c) + k[0] - 358537222 | 0;\n        d  = (d << 11 | d >>> 21) + a | 0;\n        c += (d ^ a ^ b) + k[3] - 722521979 | 0;\n        c  = (c << 16 | c >>> 16) + d | 0;\n        b += (c ^ d ^ a) + k[6] + 76029189 | 0;\n        b  = (b << 23 | b >>> 9) + c | 0;\n        a += (b ^ c ^ d) + k[9] - 640364487 | 0;\n        a  = (a << 4 | a >>> 28) + b | 0;\n        d += (a ^ b ^ c) + k[12] - 421815835 | 0;\n        d  = (d << 11 | d >>> 21) + a | 0;\n        c += (d ^ a ^ b) + k[15] + 530742520 | 0;\n        c  = (c << 16 | c >>> 16) + d | 0;\n        b += (c ^ d ^ a) + k[2] - 995338651 | 0;\n        b  = (b << 23 | b >>> 9) + c | 0;\n\n        a += (c ^ (b | ~d)) + k[0] - 198630844 | 0;\n        a  = (a << 6 | a >>> 26) + b | 0;\n        d += (b ^ (a | ~c)) + k[7] + 1126891415 | 0;\n        d  = (d << 10 | d >>> 22) + a | 0;\n        c += (a ^ (d | ~b)) + k[14] - 1416354905 | 0;\n        c  = (c << 15 | c >>> 17) + d | 0;\n        b += (d ^ (c | ~a)) + k[5] - 57434055 | 0;\n        b  = (b << 21 |b >>> 11) + c | 0;\n        a += (c ^ (b | ~d)) + k[12] + 1700485571 | 0;\n        a  = (a << 6 | a >>> 26) + b | 0;\n        d += (b ^ (a | ~c)) + k[3] - 1894986606 | 0;\n        d  = (d << 10 | d >>> 22) + a | 0;\n        c += (a ^ (d | ~b)) + k[10] - 1051523 | 0;\n        c  = (c << 15 | c >>> 17) + d | 0;\n        b += (d ^ (c | ~a)) + k[1] - 2054922799 | 0;\n        b  = (b << 21 |b >>> 11) + c | 0;\n        a += (c ^ (b | ~d)) + k[8] + 1873313359 | 0;\n        a  = (a << 6 | a >>> 26) + b | 0;\n        d += (b ^ (a | ~c)) + k[15] - 30611744 | 0;\n        d  = (d << 10 | d >>> 22) + a | 0;\n        c += (a ^ (d | ~b)) + k[6] - 1560198380 | 0;\n        c  = (c << 15 | c >>> 17) + d | 0;\n        b += (d ^ (c | ~a)) + k[13] + 1309151649 | 0;\n        b  = (b << 21 |b >>> 11) + c | 0;\n        a += (c ^ (b | ~d)) + k[4] - 145523070 | 0;\n        a  = (a << 6 | a >>> 26) + b | 0;\n        d += (b ^ (a | ~c)) + k[11] - 1120210379 | 0;\n        d  = (d << 10 | d >>> 22) + a | 0;\n        c += (a ^ (d | ~b)) + k[2] + 718787259 | 0;\n        c  = (c << 15 | c >>> 17) + d | 0;\n        b += (d ^ (c | ~a)) + k[9] - 343485551 | 0;\n        b  = (b << 21 | b >>> 11) + c | 0;\n\n        x[0] = a + x[0] | 0;\n        x[1] = b + x[1] | 0;\n        x[2] = c + x[2] | 0;\n        x[3] = d + x[3] | 0;\n    }\n\n    function md5blk(s) {\n        var md5blks = [],\n            i; /* Andy King said do it this way. */\n\n        for (i = 0; i < 64; i += 4) {\n            md5blks[i >> 2] = s.charCodeAt(i) + (s.charCodeAt(i + 1) << 8) + (s.charCodeAt(i + 2) << 16) + (s.charCodeAt(i + 3) << 24);\n        }\n        return md5blks;\n    }\n\n    function md5blk_array(a) {\n        var md5blks = [],\n            i; /* Andy King said do it this way. */\n\n        for (i = 0; i < 64; i += 4) {\n            md5blks[i >> 2] = a[i] + (a[i + 1] << 8) + (a[i + 2] << 16) + (a[i + 3] << 24);\n        }\n        return md5blks;\n    }\n\n    function md51(s) {\n        var n = s.length,\n            state = [1732584193, -271733879, -1732584194, 271733878],\n            i,\n            length,\n            tail,\n            tmp,\n            lo,\n            hi;\n\n        for (i = 64; i <= n; i += 64) {\n            md5cycle(state, md5blk(s.substring(i - 64, i)));\n        }\n        s = s.substring(i - 64);\n        length = s.length;\n        tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n        for (i = 0; i < length; i += 1) {\n            tail[i >> 2] |= s.charCodeAt(i) << ((i % 4) << 3);\n        }\n        tail[i >> 2] |= 0x80 << ((i % 4) << 3);\n        if (i > 55) {\n            md5cycle(state, tail);\n            for (i = 0; i < 16; i += 1) {\n                tail[i] = 0;\n            }\n        }\n\n        // Beware that the final length might not fit in 32 bits so we take care of that\n        tmp = n * 8;\n        tmp = tmp.toString(16).match(/(.*?)(.{0,8})$/);\n        lo = parseInt(tmp[2], 16);\n        hi = parseInt(tmp[1], 16) || 0;\n\n        tail[14] = lo;\n        tail[15] = hi;\n\n        md5cycle(state, tail);\n        return state;\n    }\n\n    function md51_array(a) {\n        var n = a.length,\n            state = [1732584193, -271733879, -1732584194, 271733878],\n            i,\n            length,\n            tail,\n            tmp,\n            lo,\n            hi;\n\n        for (i = 64; i <= n; i += 64) {\n            md5cycle(state, md5blk_array(a.subarray(i - 64, i)));\n        }\n\n        // Not sure if it is a bug, however IE10 will always produce a sub array of length 1\n        // containing the last element of the parent array if the sub array specified starts\n        // beyond the length of the parent array - weird.\n        // https://connect.microsoft.com/IE/feedback/details/771452/typed-array-subarray-issue\n        a = (i - 64) < n ? a.subarray(i - 64) : new Uint8Array(0);\n\n        length = a.length;\n        tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n        for (i = 0; i < length; i += 1) {\n            tail[i >> 2] |= a[i] << ((i % 4) << 3);\n        }\n\n        tail[i >> 2] |= 0x80 << ((i % 4) << 3);\n        if (i > 55) {\n            md5cycle(state, tail);\n            for (i = 0; i < 16; i += 1) {\n                tail[i] = 0;\n            }\n        }\n\n        // Beware that the final length might not fit in 32 bits so we take care of that\n        tmp = n * 8;\n        tmp = tmp.toString(16).match(/(.*?)(.{0,8})$/);\n        lo = parseInt(tmp[2], 16);\n        hi = parseInt(tmp[1], 16) || 0;\n\n        tail[14] = lo;\n        tail[15] = hi;\n\n        md5cycle(state, tail);\n\n        return state;\n    }\n\n    function rhex(n) {\n        var s = '',\n            j;\n        for (j = 0; j < 4; j += 1) {\n            s += hex_chr[(n >> (j * 8 + 4)) & 0x0F] + hex_chr[(n >> (j * 8)) & 0x0F];\n        }\n        return s;\n    }\n\n    function hex(x) {\n        var i;\n        for (i = 0; i < x.length; i += 1) {\n            x[i] = rhex(x[i]);\n        }\n        return x.join('');\n    }\n\n    // In some cases the fast add32 function cannot be used..\n    if (hex(md51('hello')) !== '5d41402abc4b2a76b9719d911017c592') {\n        add32 = function (x, y) {\n            var lsw = (x & 0xFFFF) + (y & 0xFFFF),\n                msw = (x >> 16) + (y >> 16) + (lsw >> 16);\n            return (msw << 16) | (lsw & 0xFFFF);\n        };\n    }\n\n    // ---------------------------------------------------\n\n    /**\n     * ArrayBuffer slice polyfill.\n     *\n     * @see https://github.com/ttaubert/node-arraybuffer-slice\n     */\n\n    if (typeof ArrayBuffer !== 'undefined' && !ArrayBuffer.prototype.slice) {\n        (function () {\n            function clamp(val, length) {\n                val = (val | 0) || 0;\n\n                if (val < 0) {\n                    return Math.max(val + length, 0);\n                }\n\n                return Math.min(val, length);\n            }\n\n            ArrayBuffer.prototype.slice = function (from, to) {\n                var length = this.byteLength,\n                    begin = clamp(from, length),\n                    end = length,\n                    num,\n                    target,\n                    targetArray,\n                    sourceArray;\n\n                if (to !== undefined) {\n                    end = clamp(to, length);\n                }\n\n                if (begin > end) {\n                    return new ArrayBuffer(0);\n                }\n\n                num = end - begin;\n                target = new ArrayBuffer(num);\n                targetArray = new Uint8Array(target);\n\n                sourceArray = new Uint8Array(this, begin, num);\n                targetArray.set(sourceArray);\n\n                return target;\n            };\n        })();\n    }\n\n    // ---------------------------------------------------\n\n    /**\n     * Helpers.\n     */\n\n    function toUtf8(str) {\n        if (/[\\u0080-\\uFFFF]/.test(str)) {\n            str = unescape(encodeURIComponent(str));\n        }\n\n        return str;\n    }\n\n    function utf8Str2ArrayBuffer(str, returnUInt8Array) {\n        var length = str.length,\n           buff = new ArrayBuffer(length),\n           arr = new Uint8Array(buff),\n           i;\n\n        for (i = 0; i < length; i += 1) {\n            arr[i] = str.charCodeAt(i);\n        }\n\n        return returnUInt8Array ? arr : buff;\n    }\n\n    function arrayBuffer2Utf8Str(buff) {\n        return String.fromCharCode.apply(null, new Uint8Array(buff));\n    }\n\n    function concatenateArrayBuffers(first, second, returnUInt8Array) {\n        var result = new Uint8Array(first.byteLength + second.byteLength);\n\n        result.set(new Uint8Array(first));\n        result.set(new Uint8Array(second), first.byteLength);\n\n        return returnUInt8Array ? result : result.buffer;\n    }\n\n    function hexToBinaryString(hex) {\n        var bytes = [],\n            length = hex.length,\n            x;\n\n        for (x = 0; x < length - 1; x += 2) {\n            bytes.push(parseInt(hex.substr(x, 2), 16));\n        }\n\n        return String.fromCharCode.apply(String, bytes);\n    }\n\n    // ---------------------------------------------------\n\n    /**\n     * SparkMD5 OOP implementation.\n     *\n     * Use this class to perform an incremental md5, otherwise use the\n     * static methods instead.\n     */\n\n    function SparkMD5() {\n        // call reset to init the instance\n        this.reset();\n    }\n\n    /**\n     * Appends a string.\n     * A conversion will be applied if an utf8 string is detected.\n     *\n     * @param {String} str The string to be appended\n     *\n     * @return {SparkMD5} The instance itself\n     */\n    SparkMD5.prototype.append = function (str) {\n        // Converts the string to utf8 bytes if necessary\n        // Then append as binary\n        this.appendBinary(toUtf8(str));\n\n        return this;\n    };\n\n    /**\n     * Appends a binary string.\n     *\n     * @param {String} contents The binary string to be appended\n     *\n     * @return {SparkMD5} The instance itself\n     */\n    SparkMD5.prototype.appendBinary = function (contents) {\n        this._buff += contents;\n        this._length += contents.length;\n\n        var length = this._buff.length,\n            i;\n\n        for (i = 64; i <= length; i += 64) {\n            md5cycle(this._hash, md5blk(this._buff.substring(i - 64, i)));\n        }\n\n        this._buff = this._buff.substring(i - 64);\n\n        return this;\n    };\n\n    /**\n     * Finishes the incremental computation, reseting the internal state and\n     * returning the result.\n     *\n     * @param {Boolean} raw True to get the raw string, false to get the hex string\n     *\n     * @return {String} The result\n     */\n    SparkMD5.prototype.end = function (raw) {\n        var buff = this._buff,\n            length = buff.length,\n            i,\n            tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n            ret;\n\n        for (i = 0; i < length; i += 1) {\n            tail[i >> 2] |= buff.charCodeAt(i) << ((i % 4) << 3);\n        }\n\n        this._finish(tail, length);\n        ret = hex(this._hash);\n\n        if (raw) {\n            ret = hexToBinaryString(ret);\n        }\n\n        this.reset();\n\n        return ret;\n    };\n\n    /**\n     * Resets the internal state of the computation.\n     *\n     * @return {SparkMD5} The instance itself\n     */\n    SparkMD5.prototype.reset = function () {\n        this._buff = '';\n        this._length = 0;\n        this._hash = [1732584193, -271733879, -1732584194, 271733878];\n\n        return this;\n    };\n\n    /**\n     * Gets the internal state of the computation.\n     *\n     * @return {Object} The state\n     */\n    SparkMD5.prototype.getState = function () {\n        return {\n            buff: this._buff,\n            length: this._length,\n            hash: this._hash.slice()\n        };\n    };\n\n    /**\n     * Gets the internal state of the computation.\n     *\n     * @param {Object} state The state\n     *\n     * @return {SparkMD5} The instance itself\n     */\n    SparkMD5.prototype.setState = function (state) {\n        this._buff = state.buff;\n        this._length = state.length;\n        this._hash = state.hash;\n\n        return this;\n    };\n\n    /**\n     * Releases memory used by the incremental buffer and other additional\n     * resources. If you plan to use the instance again, use reset instead.\n     */\n    SparkMD5.prototype.destroy = function () {\n        delete this._hash;\n        delete this._buff;\n        delete this._length;\n    };\n\n    /**\n     * Finish the final calculation based on the tail.\n     *\n     * @param {Array}  tail   The tail (will be modified)\n     * @param {Number} length The length of the remaining buffer\n     */\n    SparkMD5.prototype._finish = function (tail, length) {\n        var i = length,\n            tmp,\n            lo,\n            hi;\n\n        tail[i >> 2] |= 0x80 << ((i % 4) << 3);\n        if (i > 55) {\n            md5cycle(this._hash, tail);\n            for (i = 0; i < 16; i += 1) {\n                tail[i] = 0;\n            }\n        }\n\n        // Do the final computation based on the tail and length\n        // Beware that the final length may not fit in 32 bits so we take care of that\n        tmp = this._length * 8;\n        tmp = tmp.toString(16).match(/(.*?)(.{0,8})$/);\n        lo = parseInt(tmp[2], 16);\n        hi = parseInt(tmp[1], 16) || 0;\n\n        tail[14] = lo;\n        tail[15] = hi;\n        md5cycle(this._hash, tail);\n    };\n\n    /**\n     * Performs the md5 hash on a string.\n     * A conversion will be applied if utf8 string is detected.\n     *\n     * @param {String}  str The string\n     * @param {Boolean} [raw] True to get the raw string, false to get the hex string\n     *\n     * @return {String} The result\n     */\n    SparkMD5.hash = function (str, raw) {\n        // Converts the string to utf8 bytes if necessary\n        // Then compute it using the binary function\n        return SparkMD5.hashBinary(toUtf8(str), raw);\n    };\n\n    /**\n     * Performs the md5 hash on a binary string.\n     *\n     * @param {String}  content The binary string\n     * @param {Boolean} [raw]     True to get the raw string, false to get the hex string\n     *\n     * @return {String} The result\n     */\n    SparkMD5.hashBinary = function (content, raw) {\n        var hash = md51(content),\n            ret = hex(hash);\n\n        return raw ? hexToBinaryString(ret) : ret;\n    };\n\n    // ---------------------------------------------------\n\n    /**\n     * SparkMD5 OOP implementation for array buffers.\n     *\n     * Use this class to perform an incremental md5 ONLY for array buffers.\n     */\n    SparkMD5.ArrayBuffer = function () {\n        // call reset to init the instance\n        this.reset();\n    };\n\n    /**\n     * Appends an array buffer.\n     *\n     * @param {ArrayBuffer} arr The array to be appended\n     *\n     * @return {SparkMD5.ArrayBuffer} The instance itself\n     */\n    SparkMD5.ArrayBuffer.prototype.append = function (arr) {\n        var buff = concatenateArrayBuffers(this._buff.buffer, arr, true),\n            length = buff.length,\n            i;\n\n        this._length += arr.byteLength;\n\n        for (i = 64; i <= length; i += 64) {\n            md5cycle(this._hash, md5blk_array(buff.subarray(i - 64, i)));\n        }\n\n        this._buff = (i - 64) < length ? new Uint8Array(buff.buffer.slice(i - 64)) : new Uint8Array(0);\n\n        return this;\n    };\n\n    /**\n     * Finishes the incremental computation, reseting the internal state and\n     * returning the result.\n     *\n     * @param {Boolean} raw True to get the raw string, false to get the hex string\n     *\n     * @return {String} The result\n     */\n    SparkMD5.ArrayBuffer.prototype.end = function (raw) {\n        var buff = this._buff,\n            length = buff.length,\n            tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n            i,\n            ret;\n\n        for (i = 0; i < length; i += 1) {\n            tail[i >> 2] |= buff[i] << ((i % 4) << 3);\n        }\n\n        this._finish(tail, length);\n        ret = hex(this._hash);\n\n        if (raw) {\n            ret = hexToBinaryString(ret);\n        }\n\n        this.reset();\n\n        return ret;\n    };\n\n    /**\n     * Resets the internal state of the computation.\n     *\n     * @return {SparkMD5.ArrayBuffer} The instance itself\n     */\n    SparkMD5.ArrayBuffer.prototype.reset = function () {\n        this._buff = new Uint8Array(0);\n        this._length = 0;\n        this._hash = [1732584193, -271733879, -1732584194, 271733878];\n\n        return this;\n    };\n\n    /**\n     * Gets the internal state of the computation.\n     *\n     * @return {Object} The state\n     */\n    SparkMD5.ArrayBuffer.prototype.getState = function () {\n        var state = SparkMD5.prototype.getState.call(this);\n\n        // Convert buffer to a string\n        state.buff = arrayBuffer2Utf8Str(state.buff);\n\n        return state;\n    };\n\n    /**\n     * Gets the internal state of the computation.\n     *\n     * @param {Object} state The state\n     *\n     * @return {SparkMD5.ArrayBuffer} The instance itself\n     */\n    SparkMD5.ArrayBuffer.prototype.setState = function (state) {\n        // Convert string to buffer\n        state.buff = utf8Str2ArrayBuffer(state.buff, true);\n\n        return SparkMD5.prototype.setState.call(this, state);\n    };\n\n    SparkMD5.ArrayBuffer.prototype.destroy = SparkMD5.prototype.destroy;\n\n    SparkMD5.ArrayBuffer.prototype._finish = SparkMD5.prototype._finish;\n\n    /**\n     * Performs the md5 hash on an array buffer.\n     *\n     * @param {ArrayBuffer} arr The array buffer\n     * @param {Boolean}     [raw] True to get the raw string, false to get the hex one\n     *\n     * @return {String} The result\n     */\n    SparkMD5.ArrayBuffer.hash = function (arr, raw) {\n        var hash = md51_array(new Uint8Array(arr)),\n            ret = hex(hash);\n\n        return raw ? hexToBinaryString(ret) : ret;\n    };\n\n    return SparkMD5;\n}));\n","(function (factory) {\n    if (typeof exports === 'object') {\n        // Node/CommonJS\n        module.exports = factory();\n    } else if (typeof define === 'function' && define.amd) {\n        // AMD\n        define(factory);\n    } else {\n        // Browser globals (with support for web workers)\n        var glob;\n\n        try {\n            glob = window;\n        } catch (e) {\n            glob = self;\n        }\n\n        glob.SparkMD5 = factory();\n    }\n}(function (undefined) {\n\n    'use strict';\n\n    /*\n     * Fastest md5 implementation around (JKM md5).\n     * Credits: Joseph Myers\n     *\n     * @see http://www.myersdaily.org/joseph/javascript/md5-text.html\n     * @see http://jsperf.com/md5-shootout/7\n     */\n\n    /* this function is much faster,\n      so if possible we use it. Some IEs\n      are the only ones I know of that\n      need the idiotic second function,\n      generated by an if clause.  */\n    var add32 = function (a, b) {\n        return (a + b) & 0xFFFFFFFF;\n    },\n        hex_chr = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f'];\n\n\n    function cmn(q, a, b, x, s, t) {\n        a = add32(add32(a, q), add32(x, t));\n        return add32((a << s) | (a >>> (32 - s)), b);\n    }\n\n    function md5cycle(x, k) {\n        var a = x[0],\n            b = x[1],\n            c = x[2],\n            d = x[3];\n\n        a += (b & c | ~b & d) + k[0] - 680876936 | 0;\n        a  = (a << 7 | a >>> 25) + b | 0;\n        d += (a & b | ~a & c) + k[1] - 389564586 | 0;\n        d  = (d << 12 | d >>> 20) + a | 0;\n        c += (d & a | ~d & b) + k[2] + 606105819 | 0;\n        c  = (c << 17 | c >>> 15) + d | 0;\n        b += (c & d | ~c & a) + k[3] - 1044525330 | 0;\n        b  = (b << 22 | b >>> 10) + c | 0;\n        a += (b & c | ~b & d) + k[4] - 176418897 | 0;\n        a  = (a << 7 | a >>> 25) + b | 0;\n        d += (a & b | ~a & c) + k[5] + 1200080426 | 0;\n        d  = (d << 12 | d >>> 20) + a | 0;\n        c += (d & a | ~d & b) + k[6] - 1473231341 | 0;\n        c  = (c << 17 | c >>> 15) + d | 0;\n        b += (c & d | ~c & a) + k[7] - 45705983 | 0;\n        b  = (b << 22 | b >>> 10) + c | 0;\n        a += (b & c | ~b & d) + k[8] + 1770035416 | 0;\n        a  = (a << 7 | a >>> 25) + b | 0;\n        d += (a & b | ~a & c) + k[9] - 1958414417 | 0;\n        d  = (d << 12 | d >>> 20) + a | 0;\n        c += (d & a | ~d & b) + k[10] - 42063 | 0;\n        c  = (c << 17 | c >>> 15) + d | 0;\n        b += (c & d | ~c & a) + k[11] - 1990404162 | 0;\n        b  = (b << 22 | b >>> 10) + c | 0;\n        a += (b & c | ~b & d) + k[12] + 1804603682 | 0;\n        a  = (a << 7 | a >>> 25) + b | 0;\n        d += (a & b | ~a & c) + k[13] - 40341101 | 0;\n        d  = (d << 12 | d >>> 20) + a | 0;\n        c += (d & a | ~d & b) + k[14] - 1502002290 | 0;\n        c  = (c << 17 | c >>> 15) + d | 0;\n        b += (c & d | ~c & a) + k[15] + 1236535329 | 0;\n        b  = (b << 22 | b >>> 10) + c | 0;\n\n        a += (b & d | c & ~d) + k[1] - 165796510 | 0;\n        a  = (a << 5 | a >>> 27) + b | 0;\n        d += (a & c | b & ~c) + k[6] - 1069501632 | 0;\n        d  = (d << 9 | d >>> 23) + a | 0;\n        c += (d & b | a & ~b) + k[11] + 643717713 | 0;\n        c  = (c << 14 | c >>> 18) + d | 0;\n        b += (c & a | d & ~a) + k[0] - 373897302 | 0;\n        b  = (b << 20 | b >>> 12) + c | 0;\n        a += (b & d | c & ~d) + k[5] - 701558691 | 0;\n        a  = (a << 5 | a >>> 27) + b | 0;\n        d += (a & c | b & ~c) + k[10] + 38016083 | 0;\n        d  = (d << 9 | d >>> 23) + a | 0;\n        c += (d & b | a & ~b) + k[15] - 660478335 | 0;\n        c  = (c << 14 | c >>> 18) + d | 0;\n        b += (c & a | d & ~a) + k[4] - 405537848 | 0;\n        b  = (b << 20 | b >>> 12) + c | 0;\n        a += (b & d | c & ~d) + k[9] + 568446438 | 0;\n        a  = (a << 5 | a >>> 27) + b | 0;\n        d += (a & c | b & ~c) + k[14] - 1019803690 | 0;\n        d  = (d << 9 | d >>> 23) + a | 0;\n        c += (d & b | a & ~b) + k[3] - 187363961 | 0;\n        c  = (c << 14 | c >>> 18) + d | 0;\n        b += (c & a | d & ~a) + k[8] + 1163531501 | 0;\n        b  = (b << 20 | b >>> 12) + c | 0;\n        a += (b & d | c & ~d) + k[13] - 1444681467 | 0;\n        a  = (a << 5 | a >>> 27) + b | 0;\n        d += (a & c | b & ~c) + k[2] - 51403784 | 0;\n        d  = (d << 9 | d >>> 23) + a | 0;\n        c += (d & b | a & ~b) + k[7] + 1735328473 | 0;\n        c  = (c << 14 | c >>> 18) + d | 0;\n        b += (c & a | d & ~a) + k[12] - 1926607734 | 0;\n        b  = (b << 20 | b >>> 12) + c | 0;\n\n        a += (b ^ c ^ d) + k[5] - 378558 | 0;\n        a  = (a << 4 | a >>> 28) + b | 0;\n        d += (a ^ b ^ c) + k[8] - 2022574463 | 0;\n        d  = (d << 11 | d >>> 21) + a | 0;\n        c += (d ^ a ^ b) + k[11] + 1839030562 | 0;\n        c  = (c << 16 | c >>> 16) + d | 0;\n        b += (c ^ d ^ a) + k[14] - 35309556 | 0;\n        b  = (b << 23 | b >>> 9) + c | 0;\n        a += (b ^ c ^ d) + k[1] - 1530992060 | 0;\n        a  = (a << 4 | a >>> 28) + b | 0;\n        d += (a ^ b ^ c) + k[4] + 1272893353 | 0;\n        d  = (d << 11 | d >>> 21) + a | 0;\n        c += (d ^ a ^ b) + k[7] - 155497632 | 0;\n        c  = (c << 16 | c >>> 16) + d | 0;\n        b += (c ^ d ^ a) + k[10] - 1094730640 | 0;\n        b  = (b << 23 | b >>> 9) + c | 0;\n        a += (b ^ c ^ d) + k[13] + 681279174 | 0;\n        a  = (a << 4 | a >>> 28) + b | 0;\n        d += (a ^ b ^ c) + k[0] - 358537222 | 0;\n        d  = (d << 11 | d >>> 21) + a | 0;\n        c += (d ^ a ^ b) + k[3] - 722521979 | 0;\n        c  = (c << 16 | c >>> 16) + d | 0;\n        b += (c ^ d ^ a) + k[6] + 76029189 | 0;\n        b  = (b << 23 | b >>> 9) + c | 0;\n        a += (b ^ c ^ d) + k[9] - 640364487 | 0;\n        a  = (a << 4 | a >>> 28) + b | 0;\n        d += (a ^ b ^ c) + k[12] - 421815835 | 0;\n        d  = (d << 11 | d >>> 21) + a | 0;\n        c += (d ^ a ^ b) + k[15] + 530742520 | 0;\n        c  = (c << 16 | c >>> 16) + d | 0;\n        b += (c ^ d ^ a) + k[2] - 995338651 | 0;\n        b  = (b << 23 | b >>> 9) + c | 0;\n\n        a += (c ^ (b | ~d)) + k[0] - 198630844 | 0;\n        a  = (a << 6 | a >>> 26) + b | 0;\n        d += (b ^ (a | ~c)) + k[7] + 1126891415 | 0;\n        d  = (d << 10 | d >>> 22) + a | 0;\n        c += (a ^ (d | ~b)) + k[14] - 1416354905 | 0;\n        c  = (c << 15 | c >>> 17) + d | 0;\n        b += (d ^ (c | ~a)) + k[5] - 57434055 | 0;\n        b  = (b << 21 |b >>> 11) + c | 0;\n        a += (c ^ (b | ~d)) + k[12] + 1700485571 | 0;\n        a  = (a << 6 | a >>> 26) + b | 0;\n        d += (b ^ (a | ~c)) + k[3] - 1894986606 | 0;\n        d  = (d << 10 | d >>> 22) + a | 0;\n        c += (a ^ (d | ~b)) + k[10] - 1051523 | 0;\n        c  = (c << 15 | c >>> 17) + d | 0;\n        b += (d ^ (c | ~a)) + k[1] - 2054922799 | 0;\n        b  = (b << 21 |b >>> 11) + c | 0;\n        a += (c ^ (b | ~d)) + k[8] + 1873313359 | 0;\n        a  = (a << 6 | a >>> 26) + b | 0;\n        d += (b ^ (a | ~c)) + k[15] - 30611744 | 0;\n        d  = (d << 10 | d >>> 22) + a | 0;\n        c += (a ^ (d | ~b)) + k[6] - 1560198380 | 0;\n        c  = (c << 15 | c >>> 17) + d | 0;\n        b += (d ^ (c | ~a)) + k[13] + 1309151649 | 0;\n        b  = (b << 21 |b >>> 11) + c | 0;\n        a += (c ^ (b | ~d)) + k[4] - 145523070 | 0;\n        a  = (a << 6 | a >>> 26) + b | 0;\n        d += (b ^ (a | ~c)) + k[11] - 1120210379 | 0;\n        d  = (d << 10 | d >>> 22) + a | 0;\n        c += (a ^ (d | ~b)) + k[2] + 718787259 | 0;\n        c  = (c << 15 | c >>> 17) + d | 0;\n        b += (d ^ (c | ~a)) + k[9] - 343485551 | 0;\n        b  = (b << 21 | b >>> 11) + c | 0;\n\n        x[0] = a + x[0] | 0;\n        x[1] = b + x[1] | 0;\n        x[2] = c + x[2] | 0;\n        x[3] = d + x[3] | 0;\n    }\n\n    function md5blk(s) {\n        var md5blks = [],\n            i; /* Andy King said do it this way. */\n\n        for (i = 0; i < 64; i += 4) {\n            md5blks[i >> 2] = s.charCodeAt(i) + (s.charCodeAt(i + 1) << 8) + (s.charCodeAt(i + 2) << 16) + (s.charCodeAt(i + 3) << 24);\n        }\n        return md5blks;\n    }\n\n    function md5blk_array(a) {\n        var md5blks = [],\n            i; /* Andy King said do it this way. */\n\n        for (i = 0; i < 64; i += 4) {\n            md5blks[i >> 2] = a[i] + (a[i + 1] << 8) + (a[i + 2] << 16) + (a[i + 3] << 24);\n        }\n        return md5blks;\n    }\n\n    function md51(s) {\n        var n = s.length,\n            state = [1732584193, -271733879, -1732584194, 271733878],\n            i,\n            length,\n            tail,\n            tmp,\n            lo,\n            hi;\n\n        for (i = 64; i <= n; i += 64) {\n            md5cycle(state, md5blk(s.substring(i - 64, i)));\n        }\n        s = s.substring(i - 64);\n        length = s.length;\n        tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n        for (i = 0; i < length; i += 1) {\n            tail[i >> 2] |= s.charCodeAt(i) << ((i % 4) << 3);\n        }\n        tail[i >> 2] |= 0x80 << ((i % 4) << 3);\n        if (i > 55) {\n            md5cycle(state, tail);\n            for (i = 0; i < 16; i += 1) {\n                tail[i] = 0;\n            }\n        }\n\n        // Beware that the final length might not fit in 32 bits so we take care of that\n        tmp = n * 8;\n        tmp = tmp.toString(16).match(/(.*?)(.{0,8})$/);\n        lo = parseInt(tmp[2], 16);\n        hi = parseInt(tmp[1], 16) || 0;\n\n        tail[14] = lo;\n        tail[15] = hi;\n\n        md5cycle(state, tail);\n        return state;\n    }\n\n    function md51_array(a) {\n        var n = a.length,\n            state = [1732584193, -271733879, -1732584194, 271733878],\n            i,\n            length,\n            tail,\n            tmp,\n            lo,\n            hi;\n\n        for (i = 64; i <= n; i += 64) {\n            md5cycle(state, md5blk_array(a.subarray(i - 64, i)));\n        }\n\n        // Not sure if it is a bug, however IE10 will always produce a sub array of length 1\n        // containing the last element of the parent array if the sub array specified starts\n        // beyond the length of the parent array - weird.\n        // https://connect.microsoft.com/IE/feedback/details/771452/typed-array-subarray-issue\n        a = (i - 64) < n ? a.subarray(i - 64) : new Uint8Array(0);\n\n        length = a.length;\n        tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n        for (i = 0; i < length; i += 1) {\n            tail[i >> 2] |= a[i] << ((i % 4) << 3);\n        }\n\n        tail[i >> 2] |= 0x80 << ((i % 4) << 3);\n        if (i > 55) {\n            md5cycle(state, tail);\n            for (i = 0; i < 16; i += 1) {\n                tail[i] = 0;\n            }\n        }\n\n        // Beware that the final length might not fit in 32 bits so we take care of that\n        tmp = n * 8;\n        tmp = tmp.toString(16).match(/(.*?)(.{0,8})$/);\n        lo = parseInt(tmp[2], 16);\n        hi = parseInt(tmp[1], 16) || 0;\n\n        tail[14] = lo;\n        tail[15] = hi;\n\n        md5cycle(state, tail);\n\n        return state;\n    }\n\n    function rhex(n) {\n        var s = '',\n            j;\n        for (j = 0; j < 4; j += 1) {\n            s += hex_chr[(n >> (j * 8 + 4)) & 0x0F] + hex_chr[(n >> (j * 8)) & 0x0F];\n        }\n        return s;\n    }\n\n    function hex(x) {\n        var i;\n        for (i = 0; i < x.length; i += 1) {\n            x[i] = rhex(x[i]);\n        }\n        return x.join('');\n    }\n\n    // In some cases the fast add32 function cannot be used..\n    if (hex(md51('hello')) !== '5d41402abc4b2a76b9719d911017c592') {\n        add32 = function (x, y) {\n            var lsw = (x & 0xFFFF) + (y & 0xFFFF),\n                msw = (x >> 16) + (y >> 16) + (lsw >> 16);\n            return (msw << 16) | (lsw & 0xFFFF);\n        };\n    }\n\n    // ---------------------------------------------------\n\n    /**\n     * ArrayBuffer slice polyfill.\n     *\n     * @see https://github.com/ttaubert/node-arraybuffer-slice\n     */\n\n    if (typeof ArrayBuffer !== 'undefined' && !ArrayBuffer.prototype.slice) {\n        (function () {\n            function clamp(val, length) {\n                val = (val | 0) || 0;\n\n                if (val < 0) {\n                    return Math.max(val + length, 0);\n                }\n\n                return Math.min(val, length);\n            }\n\n            ArrayBuffer.prototype.slice = function (from, to) {\n                var length = this.byteLength,\n                    begin = clamp(from, length),\n                    end = length,\n                    num,\n                    target,\n                    targetArray,\n                    sourceArray;\n\n                if (to !== undefined) {\n                    end = clamp(to, length);\n                }\n\n                if (begin > end) {\n                    return new ArrayBuffer(0);\n                }\n\n                num = end - begin;\n                target = new ArrayBuffer(num);\n                targetArray = new Uint8Array(target);\n\n                sourceArray = new Uint8Array(this, begin, num);\n                targetArray.set(sourceArray);\n\n                return target;\n            };\n        })();\n    }\n\n    // ---------------------------------------------------\n\n    /**\n     * Helpers.\n     */\n\n    function toUtf8(str) {\n        if (/[\\u0080-\\uFFFF]/.test(str)) {\n            str = unescape(encodeURIComponent(str));\n        }\n\n        return str;\n    }\n\n    function utf8Str2ArrayBuffer(str, returnUInt8Array) {\n        var length = str.length,\n           buff = new ArrayBuffer(length),\n           arr = new Uint8Array(buff),\n           i;\n\n        for (i = 0; i < length; i += 1) {\n            arr[i] = str.charCodeAt(i);\n        }\n\n        return returnUInt8Array ? arr : buff;\n    }\n\n    function arrayBuffer2Utf8Str(buff) {\n        return String.fromCharCode.apply(null, new Uint8Array(buff));\n    }\n\n    function concatenateArrayBuffers(first, second, returnUInt8Array) {\n        var result = new Uint8Array(first.byteLength + second.byteLength);\n\n        result.set(new Uint8Array(first));\n        result.set(new Uint8Array(second), first.byteLength);\n\n        return returnUInt8Array ? result : result.buffer;\n    }\n\n    function hexToBinaryString(hex) {\n        var bytes = [],\n            length = hex.length,\n            x;\n\n        for (x = 0; x < length - 1; x += 2) {\n            bytes.push(parseInt(hex.substr(x, 2), 16));\n        }\n\n        return String.fromCharCode.apply(String, bytes);\n    }\n\n    // ---------------------------------------------------\n\n    /**\n     * SparkMD5 OOP implementation.\n     *\n     * Use this class to perform an incremental md5, otherwise use the\n     * static methods instead.\n     */\n\n    function SparkMD5() {\n        // call reset to init the instance\n        this.reset();\n    }\n\n    /**\n     * Appends a string.\n     * A conversion will be applied if an utf8 string is detected.\n     *\n     * @param {String} str The string to be appended\n     *\n     * @return {SparkMD5} The instance itself\n     */\n    SparkMD5.prototype.append = function (str) {\n        // Converts the string to utf8 bytes if necessary\n        // Then append as binary\n        this.appendBinary(toUtf8(str));\n\n        return this;\n    };\n\n    /**\n     * Appends a binary string.\n     *\n     * @param {String} contents The binary string to be appended\n     *\n     * @return {SparkMD5} The instance itself\n     */\n    SparkMD5.prototype.appendBinary = function (contents) {\n        this._buff += contents;\n        this._length += contents.length;\n\n        var length = this._buff.length,\n            i;\n\n        for (i = 64; i <= length; i += 64) {\n            md5cycle(this._hash, md5blk(this._buff.substring(i - 64, i)));\n        }\n\n        this._buff = this._buff.substring(i - 64);\n\n        return this;\n    };\n\n    /**\n     * Finishes the incremental computation, reseting the internal state and\n     * returning the result.\n     *\n     * @param {Boolean} raw True to get the raw string, false to get the hex string\n     *\n     * @return {String} The result\n     */\n    SparkMD5.prototype.end = function (raw) {\n        var buff = this._buff,\n            length = buff.length,\n            i,\n            tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n            ret;\n\n        for (i = 0; i < length; i += 1) {\n            tail[i >> 2] |= buff.charCodeAt(i) << ((i % 4) << 3);\n        }\n\n        this._finish(tail, length);\n        ret = hex(this._hash);\n\n        if (raw) {\n            ret = hexToBinaryString(ret);\n        }\n\n        this.reset();\n\n        return ret;\n    };\n\n    /**\n     * Resets the internal state of the computation.\n     *\n     * @return {SparkMD5} The instance itself\n     */\n    SparkMD5.prototype.reset = function () {\n        this._buff = '';\n        this._length = 0;\n        this._hash = [1732584193, -271733879, -1732584194, 271733878];\n\n        return this;\n    };\n\n    /**\n     * Gets the internal state of the computation.\n     *\n     * @return {Object} The state\n     */\n    SparkMD5.prototype.getState = function () {\n        return {\n            buff: this._buff,\n            length: this._length,\n            hash: this._hash.slice()\n        };\n    };\n\n    /**\n     * Gets the internal state of the computation.\n     *\n     * @param {Object} state The state\n     *\n     * @return {SparkMD5} The instance itself\n     */\n    SparkMD5.prototype.setState = function (state) {\n        this._buff = state.buff;\n        this._length = state.length;\n        this._hash = state.hash;\n\n        return this;\n    };\n\n    /**\n     * Releases memory used by the incremental buffer and other additional\n     * resources. If you plan to use the instance again, use reset instead.\n     */\n    SparkMD5.prototype.destroy = function () {\n        delete this._hash;\n        delete this._buff;\n        delete this._length;\n    };\n\n    /**\n     * Finish the final calculation based on the tail.\n     *\n     * @param {Array}  tail   The tail (will be modified)\n     * @param {Number} length The length of the remaining buffer\n     */\n    SparkMD5.prototype._finish = function (tail, length) {\n        var i = length,\n            tmp,\n            lo,\n            hi;\n\n        tail[i >> 2] |= 0x80 << ((i % 4) << 3);\n        if (i > 55) {\n            md5cycle(this._hash, tail);\n            for (i = 0; i < 16; i += 1) {\n                tail[i] = 0;\n            }\n        }\n\n        // Do the final computation based on the tail and length\n        // Beware that the final length may not fit in 32 bits so we take care of that\n        tmp = this._length * 8;\n        tmp = tmp.toString(16).match(/(.*?)(.{0,8})$/);\n        lo = parseInt(tmp[2], 16);\n        hi = parseInt(tmp[1], 16) || 0;\n\n        tail[14] = lo;\n        tail[15] = hi;\n        md5cycle(this._hash, tail);\n    };\n\n    /**\n     * Performs the md5 hash on a string.\n     * A conversion will be applied if utf8 string is detected.\n     *\n     * @param {String}  str The string\n     * @param {Boolean} [raw] True to get the raw string, false to get the hex string\n     *\n     * @return {String} The result\n     */\n    SparkMD5.hash = function (str, raw) {\n        // Converts the string to utf8 bytes if necessary\n        // Then compute it using the binary function\n        return SparkMD5.hashBinary(toUtf8(str), raw);\n    };\n\n    /**\n     * Performs the md5 hash on a binary string.\n     *\n     * @param {String}  content The binary string\n     * @param {Boolean} [raw]     True to get the raw string, false to get the hex string\n     *\n     * @return {String} The result\n     */\n    SparkMD5.hashBinary = function (content, raw) {\n        var hash = md51(content),\n            ret = hex(hash);\n\n        return raw ? hexToBinaryString(ret) : ret;\n    };\n\n    // ---------------------------------------------------\n\n    /**\n     * SparkMD5 OOP implementation for array buffers.\n     *\n     * Use this class to perform an incremental md5 ONLY for array buffers.\n     */\n    SparkMD5.ArrayBuffer = function () {\n        // call reset to init the instance\n        this.reset();\n    };\n\n    /**\n     * Appends an array buffer.\n     *\n     * @param {ArrayBuffer} arr The array to be appended\n     *\n     * @return {SparkMD5.ArrayBuffer} The instance itself\n     */\n    SparkMD5.ArrayBuffer.prototype.append = function (arr) {\n        var buff = concatenateArrayBuffers(this._buff.buffer, arr, true),\n            length = buff.length,\n            i;\n\n        this._length += arr.byteLength;\n\n        for (i = 64; i <= length; i += 64) {\n            md5cycle(this._hash, md5blk_array(buff.subarray(i - 64, i)));\n        }\n\n        this._buff = (i - 64) < length ? new Uint8Array(buff.buffer.slice(i - 64)) : new Uint8Array(0);\n\n        return this;\n    };\n\n    /**\n     * Finishes the incremental computation, reseting the internal state and\n     * returning the result.\n     *\n     * @param {Boolean} raw True to get the raw string, false to get the hex string\n     *\n     * @return {String} The result\n     */\n    SparkMD5.ArrayBuffer.prototype.end = function (raw) {\n        var buff = this._buff,\n            length = buff.length,\n            tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n            i,\n            ret;\n\n        for (i = 0; i < length; i += 1) {\n            tail[i >> 2] |= buff[i] << ((i % 4) << 3);\n        }\n\n        this._finish(tail, length);\n        ret = hex(this._hash);\n\n        if (raw) {\n            ret = hexToBinaryString(ret);\n        }\n\n        this.reset();\n\n        return ret;\n    };\n\n    /**\n     * Resets the internal state of the computation.\n     *\n     * @return {SparkMD5.ArrayBuffer} The instance itself\n     */\n    SparkMD5.ArrayBuffer.prototype.reset = function () {\n        this._buff = new Uint8Array(0);\n        this._length = 0;\n        this._hash = [1732584193, -271733879, -1732584194, 271733878];\n\n        return this;\n    };\n\n    /**\n     * Gets the internal state of the computation.\n     *\n     * @return {Object} The state\n     */\n    SparkMD5.ArrayBuffer.prototype.getState = function () {\n        var state = SparkMD5.prototype.getState.call(this);\n\n        // Convert buffer to a string\n        state.buff = arrayBuffer2Utf8Str(state.buff);\n\n        return state;\n    };\n\n    /**\n     * Gets the internal state of the computation.\n     *\n     * @param {Object} state The state\n     *\n     * @return {SparkMD5.ArrayBuffer} The instance itself\n     */\n    SparkMD5.ArrayBuffer.prototype.setState = function (state) {\n        // Convert string to buffer\n        state.buff = utf8Str2ArrayBuffer(state.buff, true);\n\n        return SparkMD5.prototype.setState.call(this, state);\n    };\n\n    SparkMD5.ArrayBuffer.prototype.destroy = SparkMD5.prototype.destroy;\n\n    SparkMD5.ArrayBuffer.prototype._finish = SparkMD5.prototype._finish;\n\n    /**\n     * Performs the md5 hash on an array buffer.\n     *\n     * @param {ArrayBuffer} arr The array buffer\n     * @param {Boolean}     [raw] True to get the raw string, false to get the hex one\n     *\n     * @return {String} The result\n     */\n    SparkMD5.ArrayBuffer.hash = function (arr, raw) {\n        var hash = md51_array(new Uint8Array(arr)),\n            ret = hex(hash);\n\n        return raw ? hexToBinaryString(ret) : ret;\n    };\n\n    return SparkMD5;\n}));\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.serialize = exports.deserialize = exports.registerSerializer = void 0;\nconst serializers_1 = require(\"./serializers\");\nlet registeredSerializer = serializers_1.DefaultSerializer;\nfunction registerSerializer(serializer) {\n    registeredSerializer = serializers_1.extendSerializer(registeredSerializer, serializer);\n}\nexports.registerSerializer = registerSerializer;\nfunction deserialize(message) {\n    return registeredSerializer.deserialize(message);\n}\nexports.deserialize = deserialize;\nfunction serialize(input) {\n    return registeredSerializer.serialize(input);\n}\nexports.serialize = serialize;\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.DefaultSerializer = exports.extendSerializer = void 0;\nfunction extendSerializer(extend, implementation) {\n    const fallbackDeserializer = extend.deserialize.bind(extend);\n    const fallbackSerializer = extend.serialize.bind(extend);\n    return {\n        deserialize(message) {\n            return implementation.deserialize(message, fallbackDeserializer);\n        },\n        serialize(input) {\n            return implementation.serialize(input, fallbackSerializer);\n        }\n    };\n}\nexports.extendSerializer = extendSerializer;\nconst DefaultErrorSerializer = {\n    deserialize(message) {\n        return Object.assign(Error(message.message), {\n            name: message.name,\n            stack: message.stack\n        });\n    },\n    serialize(error) {\n        return {\n            __error_marker: \"$$error\",\n            message: error.message,\n            name: error.name,\n            stack: error.stack\n        };\n    }\n};\nconst isSerializedError = (thing) => thing && typeof thing === \"object\" && \"__error_marker\" in thing && thing.__error_marker === \"$$error\";\nexports.DefaultSerializer = {\n    deserialize(message) {\n        if (isSerializedError(message)) {\n            return DefaultErrorSerializer.deserialize(message);\n        }\n        else {\n            return message;\n        }\n    },\n    serialize(input) {\n        if (input instanceof Error) {\n            return DefaultErrorSerializer.serialize(input);\n        }\n        else {\n            return input;\n        }\n    }\n};\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.$worker = exports.$transferable = exports.$terminate = exports.$events = exports.$errors = void 0;\nexports.$errors = Symbol(\"thread.errors\");\nexports.$events = Symbol(\"thread.events\");\nexports.$terminate = Symbol(\"thread.terminate\");\nexports.$transferable = Symbol(\"thread.transferable\");\nexports.$worker = Symbol(\"thread.worker\");\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.Transfer = exports.isTransferDescriptor = void 0;\nconst symbols_1 = require(\"./symbols\");\nfunction isTransferable(thing) {\n    if (!thing || typeof thing !== \"object\")\n        return false;\n    // Don't check too thoroughly, since the list of transferable things in JS might grow over time\n    return true;\n}\nfunction isTransferDescriptor(thing) {\n    return thing && typeof thing === \"object\" && thing[symbols_1.$transferable];\n}\nexports.isTransferDescriptor = isTransferDescriptor;\nfunction Transfer(payload, transferables) {\n    if (!transferables) {\n        if (!isTransferable(payload))\n            throw Error();\n        transferables = [payload];\n    }\n    return {\n        [symbols_1.$transferable]: true,\n        send: payload,\n        transferables\n    };\n}\nexports.Transfer = Transfer;\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.WorkerMessageType = exports.MasterMessageType = void 0;\n/////////////////////////////\n// Messages sent by master:\nvar MasterMessageType;\n(function (MasterMessageType) {\n    MasterMessageType[\"cancel\"] = \"cancel\";\n    MasterMessageType[\"run\"] = \"run\";\n})(MasterMessageType = exports.MasterMessageType || (exports.MasterMessageType = {}));\n////////////////////////////\n// Messages sent by worker:\nvar WorkerMessageType;\n(function (WorkerMessageType) {\n    WorkerMessageType[\"error\"] = \"error\";\n    WorkerMessageType[\"init\"] = \"init\";\n    WorkerMessageType[\"result\"] = \"result\";\n    WorkerMessageType[\"running\"] = \"running\";\n    WorkerMessageType[\"uncaughtError\"] = \"uncaughtError\";\n})(WorkerMessageType = exports.WorkerMessageType || (exports.WorkerMessageType = {}));\n","\"use strict\";\n/// <reference lib=\"dom\" />\n// tslint:disable no-shadowed-variable\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst isWorkerRuntime = function isWorkerRuntime() {\n    const isWindowContext = typeof self !== \"undefined\" && typeof Window !== \"undefined\" && self instanceof Window;\n    return typeof self !== \"undefined\" && self.postMessage && !isWindowContext ? true : false;\n};\nconst postMessageToMaster = function postMessageToMaster(data, transferList) {\n    self.postMessage(data, transferList);\n};\nconst subscribeToMasterMessages = function subscribeToMasterMessages(onMessage) {\n    const messageHandler = (messageEvent) => {\n        onMessage(messageEvent.data);\n    };\n    const unsubscribe = () => {\n        self.removeEventListener(\"message\", messageHandler);\n    };\n    self.addEventListener(\"message\", messageHandler);\n    return unsubscribe;\n};\nexports.default = {\n    isWorkerRuntime,\n    postMessageToMaster,\n    subscribeToMasterMessages\n};\n","\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.expose = exports.isWorkerRuntime = exports.Transfer = exports.registerSerializer = void 0;\nconst is_observable_1 = __importDefault(require(\"is-observable\"));\nconst common_1 = require(\"../common\");\nconst transferable_1 = require(\"../transferable\");\nconst messages_1 = require(\"../types/messages\");\nconst implementation_1 = __importDefault(require(\"./implementation\"));\nvar common_2 = require(\"../common\");\nObject.defineProperty(exports, \"registerSerializer\", { enumerable: true, get: function () { return common_2.registerSerializer; } });\nvar transferable_2 = require(\"../transferable\");\nObject.defineProperty(exports, \"Transfer\", { enumerable: true, get: function () { return transferable_2.Transfer; } });\n/** Returns `true` if this code is currently running in a worker. */\nexports.isWorkerRuntime = implementation_1.default.isWorkerRuntime;\nlet exposeCalled = false;\nconst activeSubscriptions = new Map();\nconst isMasterJobCancelMessage = (thing) => thing && thing.type === messages_1.MasterMessageType.cancel;\nconst isMasterJobRunMessage = (thing) => thing && thing.type === messages_1.MasterMessageType.run;\n/**\n * There are issues with `is-observable` not recognizing zen-observable's instances.\n * We are using `observable-fns`, but it's based on zen-observable, too.\n */\nconst isObservable = (thing) => is_observable_1.default(thing) || isZenObservable(thing);\nfunction isZenObservable(thing) {\n    return thing && typeof thing === \"object\" && typeof thing.subscribe === \"function\";\n}\nfunction deconstructTransfer(thing) {\n    return transferable_1.isTransferDescriptor(thing)\n        ? { payload: thing.send, transferables: thing.transferables }\n        : { payload: thing, transferables: undefined };\n}\nfunction postFunctionInitMessage() {\n    const initMessage = {\n        type: messages_1.WorkerMessageType.init,\n        exposed: {\n            type: \"function\"\n        }\n    };\n    implementation_1.default.postMessageToMaster(initMessage);\n}\nfunction postModuleInitMessage(methodNames) {\n    const initMessage = {\n        type: messages_1.WorkerMessageType.init,\n        exposed: {\n            type: \"module\",\n            methods: methodNames\n        }\n    };\n    implementation_1.default.postMessageToMaster(initMessage);\n}\nfunction postJobErrorMessage(uid, rawError) {\n    const { payload: error, transferables } = deconstructTransfer(rawError);\n    const errorMessage = {\n        type: messages_1.WorkerMessageType.error,\n        uid,\n        error: common_1.serialize(error)\n    };\n    implementation_1.default.postMessageToMaster(errorMessage, transferables);\n}\nfunction postJobResultMessage(uid, completed, resultValue) {\n    const { payload, transferables } = deconstructTransfer(resultValue);\n    const resultMessage = {\n        type: messages_1.WorkerMessageType.result,\n        uid,\n        complete: completed ? true : undefined,\n        payload\n    };\n    implementation_1.default.postMessageToMaster(resultMessage, transferables);\n}\nfunction postJobStartMessage(uid, resultType) {\n    const startMessage = {\n        type: messages_1.WorkerMessageType.running,\n        uid,\n        resultType\n    };\n    implementation_1.default.postMessageToMaster(startMessage);\n}\nfunction postUncaughtErrorMessage(error) {\n    try {\n        const errorMessage = {\n            type: messages_1.WorkerMessageType.uncaughtError,\n            error: common_1.serialize(error)\n        };\n        implementation_1.default.postMessageToMaster(errorMessage);\n    }\n    catch (subError) {\n        // tslint:disable-next-line no-console\n        console.error(\"Not reporting uncaught error back to master thread as it \" +\n            \"occured while reporting an uncaught error already.\" +\n            \"\\nLatest error:\", subError, \"\\nOriginal error:\", error);\n    }\n}\nfunction runFunction(jobUID, fn, args) {\n    return __awaiter(this, void 0, void 0, function* () {\n        let syncResult;\n        try {\n            syncResult = fn(...args);\n        }\n        catch (error) {\n            return postJobErrorMessage(jobUID, error);\n        }\n        const resultType = isObservable(syncResult) ? \"observable\" : \"promise\";\n        postJobStartMessage(jobUID, resultType);\n        if (isObservable(syncResult)) {\n            const subscription = syncResult.subscribe(value => postJobResultMessage(jobUID, false, common_1.serialize(value)), error => {\n                postJobErrorMessage(jobUID, common_1.serialize(error));\n                activeSubscriptions.delete(jobUID);\n            }, () => {\n                postJobResultMessage(jobUID, true);\n                activeSubscriptions.delete(jobUID);\n            });\n            activeSubscriptions.set(jobUID, subscription);\n        }\n        else {\n            try {\n                const result = yield syncResult;\n                postJobResultMessage(jobUID, true, common_1.serialize(result));\n            }\n            catch (error) {\n                postJobErrorMessage(jobUID, common_1.serialize(error));\n            }\n        }\n    });\n}\n/**\n * Expose a function or a module (an object whose values are functions)\n * to the main thread. Must be called exactly once in every worker thread\n * to signal its API to the main thread.\n *\n * @param exposed Function or object whose values are functions\n */\nfunction expose(exposed) {\n    if (!implementation_1.default.isWorkerRuntime()) {\n        throw Error(\"expose() called in the master thread.\");\n    }\n    if (exposeCalled) {\n        throw Error(\"expose() called more than once. This is not possible. Pass an object to expose() if you want to expose multiple functions.\");\n    }\n    exposeCalled = true;\n    if (typeof exposed === \"function\") {\n        implementation_1.default.subscribeToMasterMessages(messageData => {\n            if (isMasterJobRunMessage(messageData) && !messageData.method) {\n                runFunction(messageData.uid, exposed, messageData.args.map(common_1.deserialize));\n            }\n        });\n        postFunctionInitMessage();\n    }\n    else if (typeof exposed === \"object\" && exposed) {\n        implementation_1.default.subscribeToMasterMessages(messageData => {\n            if (isMasterJobRunMessage(messageData) && messageData.method) {\n                runFunction(messageData.uid, exposed[messageData.method], messageData.args.map(common_1.deserialize));\n            }\n        });\n        const methodNames = Object.keys(exposed).filter(key => typeof exposed[key] === \"function\");\n        postModuleInitMessage(methodNames);\n    }\n    else {\n        throw Error(`Invalid argument passed to expose(). Expected a function or an object, got: ${exposed}`);\n    }\n    implementation_1.default.subscribeToMasterMessages(messageData => {\n        if (isMasterJobCancelMessage(messageData)) {\n            const jobUID = messageData.uid;\n            const subscription = activeSubscriptions.get(jobUID);\n            if (subscription) {\n                subscription.unsubscribe();\n                activeSubscriptions.delete(jobUID);\n            }\n        }\n    });\n}\nexports.expose = expose;\nif (typeof self !== \"undefined\" && typeof self.addEventListener === \"function\" && implementation_1.default.isWorkerRuntime()) {\n    self.addEventListener(\"error\", event => {\n        // Post with some delay, so the master had some time to subscribe to messages\n        setTimeout(() => postUncaughtErrorMessage(event.error || event), 250);\n    });\n    self.addEventListener(\"unhandledrejection\", event => {\n        const error = event.reason;\n        if (error && typeof error.message === \"string\") {\n            // Post with some delay, so the master had some time to subscribe to messages\n            setTimeout(() => postUncaughtErrorMessage(error), 250);\n        }\n    });\n}\nif (typeof process !== \"undefined\" && typeof process.on === \"function\" && implementation_1.default.isWorkerRuntime()) {\n    process.on(\"uncaughtException\", (error) => {\n        // Post with some delay, so the master had some time to subscribe to messages\n        setTimeout(() => postUncaughtErrorMessage(error), 250);\n    });\n    process.on(\"unhandledRejection\", (error) => {\n        if (error && typeof error.message === \"string\") {\n            // Post with some delay, so the master had some time to subscribe to messages\n            setTimeout(() => postUncaughtErrorMessage(error), 250);\n        }\n    });\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.g = (function() {\n\tif (typeof globalThis === 'object') return globalThis;\n\ttry {\n\t\treturn this || new Function('return this')();\n\t} catch (e) {\n\t\tif (typeof window === 'object') return window;\n\t}\n})();","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","import type {\n    BlobBuffer,\n    DeepReadonlyObject,\n    MaybeReadonly,\n    RxDocumentData,\n    RxDocumentMeta\n} from './types';\nimport {\n    default as deepClone\n} from 'clone';\n\n/**\n * Returns an error that indicates that a plugin is missing\n * We do not throw a RxError because this should not be handled\n * programmatically but by using the correct import\n */\nexport function pluginMissing(\n    pluginKey: string\n): Error {\n    const keyParts = pluginKey.split('-');\n    let pluginName = 'RxDB';\n    keyParts.forEach(part => {\n        pluginName += ucfirst(part);\n    });\n    pluginName += 'Plugin';\n    return new Error(\n        `You are using a function which must be overwritten by a plugin.\n        You should either prevent the usage of this function or add the plugin via:\n            import { ${pluginName} } from 'rxdb/plugins/${pluginKey}';\n            addRxPlugin(${pluginName});\n        `\n    );\n}\n\n/**\n * this is a very fast hashing but its unsecure\n * @link http://stackoverflow.com/questions/7616461/generate-a-hash-from-string-in-javascript-jquery\n * @return a number as hash-result\n */\nexport function fastUnsecureHash(obj: any): number {\n    if (typeof obj !== 'string') obj = JSON.stringify(obj);\n    let hashValue = 0,\n        i, chr, len;\n    if (obj.length === 0) return hashValue;\n    for (i = 0, len = obj.length; i < len; i++) {\n        chr = obj.charCodeAt(i);\n        // tslint:disable-next-line\n        hashValue = ((hashValue << 5) - hashValue) + chr;\n        // tslint:disable-next-line\n        hashValue |= 0; // Convert to 32bit integer\n    }\n    if (hashValue < 0) hashValue = hashValue * -1;\n    return hashValue;\n}\n\n/**\n * Does a RxDB-specific hashing of the given data.\n * We use a static salt so using a rainbow-table\n * or google-ing the hash will not work.\n *\n * spark-md5 is used here\n * because pouchdb uses the same\n * and build-size could be reduced by 9kb\n * \n * TODO instead of using md5 we should use the hash method from the given RxStorage\n * this change would require some rewrites because the RxStorage hash is async.\n * So maybe it is even better to use non-cryptographic hashing like we do at fastUnsecureHash()\n * which would even be faster.\n */\nimport Md5 from 'spark-md5';\nexport const RXDB_HASH_SALT = 'rxdb-specific-hash-salt';\nexport function hash(msg: string | any): string {\n    if (typeof msg !== 'string') {\n        msg = JSON.stringify(msg);\n    }\n    return Md5.hash(RXDB_HASH_SALT + msg);\n}\n\n/**\n * Returns the current unix time in milliseconds\n * Because the accuracy of getTime() in javascript is bad,\n * and we cannot rely on performance.now() on all plattforms,\n * this method implements a way to never return the same value twice.\n * This ensures that when now() is called often, we do not loose the information\n * about which call came first and which came after.\n * Caution: Do not call this too often in a short timespan\n * because it might return 'the future'\n */\nlet _lastNow: number = 0;\n/**\n * Returns the current time in milliseconds,\n * also ensures to not return the same value twice.\n */\nexport function now(): number {\n    let ret = new Date().getTime();\n    if (ret <= _lastNow) {\n        ret = _lastNow + 1;\n    }\n    _lastNow = ret;\n    return ret;\n}\n\n/**\n * returns a promise that resolves on the next tick\n */\nexport function nextTick(): Promise<void> {\n    return new Promise(res => setTimeout(res, 0));\n}\n\nexport function promiseWait(ms: number = 0): Promise<void> {\n    return new Promise(res => setTimeout(res, ms));\n}\n\nexport function toPromise<T>(maybePromise: Promise<T> | T): Promise<T> {\n    if (maybePromise && typeof (maybePromise as any).then === 'function') {\n        // is promise\n        return maybePromise as any;\n    } else {\n        return Promise.resolve(maybePromise);\n    }\n}\n\nexport const PROMISE_RESOLVE_TRUE: Promise<true> = Promise.resolve(true);\nexport const PROMISE_RESOLVE_FALSE: Promise<false> = Promise.resolve(false);\nexport const PROMISE_RESOLVE_NULL: Promise<null> = Promise.resolve(null);\nexport const PROMISE_RESOLVE_VOID: Promise<void> = Promise.resolve();\n\nexport function requestIdlePromise(timeout: number | null = null) {\n    if (\n        typeof window === 'object' &&\n        (window as any)['requestIdleCallback']\n    ) {\n        return new Promise(\n            res => (window as any)['requestIdleCallback'](res, {\n                timeout\n            })\n        );\n    } else {\n        return promiseWait(0);\n    }\n}\n\n\n/**\n * like Promise.all() but runs in series instead of parallel\n * @link https://github.com/egoist/promise.series/blob/master/index.js\n * @param tasks array with functions that return a promise\n */\nexport function promiseSeries(\n    tasks: Function[],\n    initial?: any\n): Promise<any[]> {\n    return tasks\n        .reduce(\n            (current, next) => (current as any).then(next),\n            Promise.resolve(initial)\n        );\n}\n\n/**\n * run the callback if requestIdleCallback available\n * do nothing if not\n * @link https://developer.mozilla.org/de/docs/Web/API/Window/requestIdleCallback\n */\nexport function requestIdleCallbackIfAvailable(fun: Function): void {\n    if (\n        typeof window === 'object' &&\n        (window as any)['requestIdleCallback']\n    ) (window as any)['requestIdleCallback'](fun);\n}\n\n/**\n * uppercase first char\n */\nexport function ucfirst(str: string): string {\n    str += '';\n    const f = str.charAt(0)\n        .toUpperCase();\n    return f + str.substr(1);\n}\n\n/**\n * removes trailing and ending dots from the string\n */\nexport function trimDots(str: string): string {\n    // start\n    while (str.charAt(0) === '.')\n        str = str.substr(1);\n\n    // end\n    while (str.slice(-1) === '.')\n        str = str.slice(0, -1);\n\n    return str;\n}\n\n\nexport function runXTimes(xTimes: number, fn: (idx: number) => void) {\n    new Array(xTimes).fill(0).forEach((_v, idx) => fn(idx));\n}\n\nexport function ensureNotFalsy<T>(obj: T | false | undefined | null): T {\n    if (!obj) {\n        throw new Error('ensureNotFalsy() is falsy');\n    }\n    return obj;\n}\n\n/**\n * deep-sort an object so its attributes are in lexical order.\n * Also sorts the arrays inside of the object if no-array-sort not set\n */\nexport function sortObject(obj: any, noArraySort = false): any {\n    if (!obj) return obj; // do not sort null, false or undefined\n\n    // array\n    if (!noArraySort && Array.isArray(obj)) {\n        return obj\n            .sort((a, b) => {\n                if (typeof a === 'string' && typeof b === 'string')\n                    return a.localeCompare(b);\n\n                if (typeof a === 'object') return 1;\n                else return -1;\n            })\n            .map(i => sortObject(i, noArraySort));\n    }\n\n    // object\n    // array is also of type object\n    if (typeof obj === 'object' && !Array.isArray(obj)) {\n        if (obj instanceof RegExp)\n            return obj;\n\n        const out: any = {};\n        Object.keys(obj)\n            .sort((a, b) => a.localeCompare(b))\n            .forEach(key => {\n                out[key] = sortObject(obj[key], noArraySort);\n            });\n        return out;\n    }\n\n    // everything else\n    return obj;\n}\n\n\n/**\n * used to JSON.stringify() objects that contain a regex\n * @link https://stackoverflow.com/a/33416684 thank you Fabian Jakobs!\n */\nexport function stringifyFilter(key: string, value: any) {\n    if (value instanceof RegExp) {\n        return value.toString();\n    }\n    return value;\n}\n\n/**\n * get a random string which can be used with couchdb\n * @link http://stackoverflow.com/a/1349426/3443137\n */\nexport function randomCouchString(length: number = 10): string {\n    let text = '';\n    const possible = 'abcdefghijklmnopqrstuvwxyz';\n\n    for (let i = 0; i < length; i++) {\n        text += possible.charAt(Math.floor(Math.random() * possible.length));\n    }\n\n    return text;\n}\n\n/**\n * A random string that is never inside of any storage\n */\nexport const RANDOM_STRING = 'Fz7SZXPmYJujkzjY1rpXWvlWBqoGAfAX';\n\n\nexport function lastOfArray<T>(ar: T[]): T {\n    return ar[ar.length - 1];\n}\n\n/**\n * shuffle the given array\n */\nexport function shuffleArray<T>(arr: T[]): T[] {\n    return arr.sort(() => (Math.random() - 0.5));\n}\n\n/**\n * Split array with items into smaller arrays with items\n * @link https://stackoverflow.com/a/7273794/3443137\n */\nexport function batchArray<T>(array: T[], batchSize: number): T[][] {\n    array = array.slice(0);\n    const ret: T[][] = [];\n    while (array.length) {\n        const batch = array.splice(0, batchSize);\n        ret.push(batch);\n    }\n    return ret;\n}\n\n\n/**\n * @link https://stackoverflow.com/a/15996017\n */\nexport function removeOneFromArrayIfMatches<T>(ar: T[], condition: (x: T) => boolean): T[] {\n    ar = ar.slice();\n    let i = ar.length;\n    let done = false;\n    while (i-- && !done) {\n        if (condition(ar[i])) {\n            done = true;\n            ar.splice(i, 1);\n        }\n    }\n    return ar;\n}\n\n\n/**\n * transforms the given adapter into a pouch-compatible object\n */\nexport function adapterObject(adapter: any): any {\n    let adapterObj: any = {\n        db: adapter\n    };\n    if (typeof adapter === 'string') {\n        adapterObj = {\n            adapter,\n            db: undefined,\n        };\n    }\n    return adapterObj;\n}\n\n\nfunction recursiveDeepCopy<T>(o: T | DeepReadonlyObject<T>): T {\n    if (!o) return o;\n    return deepClone(o, false) as any;\n}\nexport const clone = recursiveDeepCopy;\n\n/**\n * does a flat copy on the objects,\n * is about 3 times faster then using deepClone\n * @link https://jsperf.com/object-rest-spread-vs-clone/2\n */\nexport function flatClone<T>(obj: T | DeepReadonlyObject<T>): T {\n    return Object.assign({}, obj) as any;\n}\n\n/**\n * @link https://stackoverflow.com/a/11509718/3443137\n */\nexport function firstPropertyNameOfObject(obj: any): string {\n    return Object.keys(obj)[0];\n}\nexport function firstPropertyValueOfObject<T>(obj: { [k: string]: T }): T {\n    const key = Object.keys(obj)[0];\n    return obj[key];\n}\n\n\nimport isElectron from 'is-electron';\nexport const isElectronRenderer = isElectron();\n\n\n/**\n * returns a flattened object\n * @link https://gist.github.com/penguinboy/762197\n */\nexport function flattenObject(ob: any) {\n    const toReturn: any = {};\n\n    for (const i in ob) {\n        if (!ob.hasOwnProperty(i)) continue;\n\n        if ((typeof ob[i]) === 'object') {\n            const flatObject = flattenObject(ob[i]);\n            for (const x in flatObject) {\n                if (!flatObject.hasOwnProperty(x)) continue;\n\n                toReturn[i + '.' + x] = flatObject[x];\n            }\n        } else {\n            toReturn[i] = ob[i];\n        }\n    }\n    return toReturn;\n}\n\n\nexport function parseRevision(revision: string): { height: number; hash: string } {\n    const split = revision.split('-');\n    return {\n        height: parseInt(split[0], 10),\n        hash: split[1]\n    }\n}\n\nexport function getHeightOfRevision(revision: string): number {\n    return parseRevision(revision).height;\n}\n\n/**\n * Creates the next write revision for a given document.\n */\nexport function createRevision<RxDocType>(\n    docData: RxDocumentData<RxDocType> & {\n        /**\n         * Passing a revision is optional here,\n         * because it is anyway not needed to calculate\n         * the new revision.\n         */\n        _rev?: string;\n    },\n    previousDocData?: RxDocumentData<RxDocType>\n): string {\n\n    const previousRevision = previousDocData ? previousDocData._rev : null;\n    const previousRevisionHeigth = previousRevision ? parseRevision(previousRevision).height : 0;\n    const newRevisionHeight = previousRevisionHeigth + 1;\n\n    const docWithoutRev = Object.assign({}, docData, {\n        _rev: undefined,\n        _rev_tree: undefined\n    });\n    const diggestString = JSON.stringify(docWithoutRev);\n    const revisionHash = Md5.hash(diggestString);\n\n\n    return newRevisionHeight + '-' + revisionHash;\n}\n\n/**\n * overwrites the getter with the actual value\n * Mostly used for caching stuff on the first run\n */\nexport function overwriteGetterForCaching<ValueType = any>(\n    obj: any,\n    getterName: string,\n    value: ValueType\n): ValueType {\n    Object.defineProperty(obj, getterName, {\n        get: function () { return value; }\n    });\n    return value;\n}\n\n/**\n * returns true if the given name is likely a folder path\n */\nexport function isFolderPath(name: string) {\n    // do not check, if foldername is given\n    if (\n        name.includes('/') || // unix\n        name.includes('\\\\') // windows\n    ) {\n        return true;\n    } else {\n        return false;\n    }\n}\n\nexport function getFromMapOrThrow<K, V>(map: Map<K, V> | WeakMap<any, V>, key: K): V {\n    const val = map.get(key);\n    if (!val) {\n        throw new Error('missing value from map ' + key);\n    }\n    return val;\n}\n\nexport function getFromObjectOrThrow<V>(\n    obj: { [k: string]: V },\n    key: string\n): V {\n    const val = obj[key];\n    if (!val) {\n        throw new Error('missing value from object ' + key);\n    }\n    return val;\n}\n\n/**\n * returns true if the supplied argument is either an Array<T> or a Readonly<Array<T>>\n */\nexport function isMaybeReadonlyArray(x: any): x is MaybeReadonly<any[]> {\n    // While this looks strange, it's a workaround for an issue in TypeScript:\n    // https://github.com/microsoft/TypeScript/issues/17002\n    //\n    // The problem is that `Array.isArray` as a type guard returns `false` for a readonly array,\n    // but at runtime the object is an array and the runtime call to `Array.isArray` would return `true`.\n    // The type predicate here allows for both `Array<T>` and `Readonly<Array<T>>` to pass a type check while\n    // still performing runtime type inspection.\n    return Array.isArray(x);\n}\n\nexport const blobBufferUtil = {\n    /**\n     * depending if we are on node or browser,\n     * we have to use Buffer(node) or Blob(browser)\n     */\n    createBlobBuffer(\n        data: string,\n        type: string\n    ): BlobBuffer {\n\n        let blobBuffer: any;\n        if (isElectronRenderer) {\n            // if we are inside of electron-renderer, always use the node-buffer\n            return Buffer.from(data, {\n                type\n            } as any);\n        }\n\n        try {\n            // for browsers\n            blobBuffer = new Blob([data], {\n                type\n            } as any);\n        } catch (e) {\n            // for node\n            blobBuffer = Buffer.from(data, {\n                type\n            } as any);\n        }\n\n        return blobBuffer;\n    },\n    /**\n     * depending if we are on node or browser,\n     * we have to use Buffer(node) or Blob(browser)\n     */\n    async createBlobBufferFromBase64(\n        base64String: string,\n        type: string\n    ): Promise<BlobBuffer> {\n        let blobBuffer: any;\n        if (isElectronRenderer) {\n            // if we are inside of electron-renderer, always use the node-buffer\n            return Buffer.from(\n                base64String,\n                'base64'\n            );\n        }\n\n        try {\n            /**\n             * For browsers.\n             * @link https://ionicframework.com/blog/converting-a-base64-string-to-a-blob-in-javascript/\n             */\n            const base64Response = await fetch(`data:${type};base64,${base64String}`);\n            const blob = await base64Response.blob();\n            return blob;\n        } catch (e) {\n            // for node\n            blobBuffer = Buffer.from(\n                base64String,\n                'base64'\n            );\n        }\n\n        return blobBuffer;\n    },\n    isBlobBuffer(data: any): boolean {\n        if ((typeof Buffer !== 'undefined' && Buffer.isBuffer(data)) || data instanceof Blob) {\n            return true;\n        } else {\n            return false;\n        }\n    },\n    toString(blobBuffer: BlobBuffer | string): Promise<string> {\n        if (typeof blobBuffer === 'string') {\n            return Promise.resolve(blobBuffer);\n        }\n        if (typeof Buffer !== 'undefined' && blobBuffer instanceof Buffer) {\n            // node\n            return nextTick()\n                .then(() => blobBuffer.toString());\n        }\n        return new Promise(res => {\n            // browser\n            const reader = new FileReader();\n            reader.addEventListener('loadend', e => {\n                const text = (e.target as any).result;\n                res(text);\n            });\n\n            const blobBufferType = Object.prototype.toString.call(blobBuffer);\n\n            /**\n             * in the electron-renderer we have a typed array insteaf of a blob\n             * so we have to transform it.\n             * @link https://github.com/pubkey/rxdb/issues/1371\n             */\n            if (blobBufferType === '[object Uint8Array]') {\n                blobBuffer = new Blob([blobBuffer]);\n            }\n\n            reader.readAsText(blobBuffer as any);\n        });\n    },\n    toBase64String(blobBuffer: BlobBuffer | string): Promise<string> {\n        if (typeof blobBuffer === 'string') {\n            return Promise.resolve(blobBuffer);\n        }\n        if (typeof Buffer !== 'undefined' && blobBuffer instanceof Buffer) {\n            // node\n            return nextTick()\n                /**\n                 * We use btoa() instead of blobBuffer.toString('base64')\n                 * to ensure that we have the same behavior in nodejs and the browser.\n                 */\n                .then(() => blobBuffer.toString('base64'));\n        }\n        return new Promise((res, rej) => {\n            /**\n             * Browser\n             * @link https://ionicframework.com/blog/converting-a-base64-string-to-a-blob-in-javascript/\n             */\n            const reader = new FileReader;\n            reader.onerror = rej;\n            reader.onload = () => {\n                // looks like 'data:plain/text;base64,YWFh...'\n                const fullResult = reader.result as any;\n                const split = fullResult.split(',');\n                split.shift();\n                res(split.join(','));\n            };\n\n            const blobBufferType = Object.prototype.toString.call(blobBuffer);\n\n            /**\n             * in the electron-renderer we have a typed array insteaf of a blob\n             * so we have to transform it.\n             * @link https://github.com/pubkey/rxdb/issues/1371\n             */\n            if (blobBufferType === '[object Uint8Array]') {\n                blobBuffer = new Blob([blobBuffer]);\n            }\n\n            reader.readAsDataURL(blobBuffer as any);\n        });\n    },\n    size(blobBuffer: BlobBuffer): number {\n        if (typeof Buffer !== 'undefined' && blobBuffer instanceof Buffer) {\n            // node\n            return Buffer.byteLength(blobBuffer);\n        } else {\n            // browser\n            return (blobBuffer as Blob).size;\n        }\n    }\n};\n\n/**\n * Using shareReplay() without settings will not unsubscribe\n * if there are no more subscribers.\n * So we use these defaults.\n * @link https://cartant.medium.com/rxjs-whats-changed-with-sharereplay-65c098843e95\n */\nexport const RXJS_SHARE_REPLAY_DEFAULTS = {\n    bufferSize: 1,\n    refCount: true\n}\n\n/**\n * We use 1 as minimum so that the value is never falsy.\n * This const is used in several places because querying\n * with a value lower then the minimum could give false results.\n */\nexport const RX_META_LWT_MINIMUM = 1;\n\nexport function getDefaultRxDocumentMeta(): RxDocumentMeta {\n    return {\n        /**\n         * Set this to 1 to not waste performance\n         * while calling new Date()..\n         * The storage wrappers will anyway update\n         * the lastWrite time while calling transformDocumentDataFromRxDBToRxStorage()\n         */\n        lwt: RX_META_LWT_MINIMUM\n    }\n}\n\n/**\n * Returns a revision that is not valid.\n * Use this to have correct typings\n * while the storage wrapper anyway will overwrite the revision.\n */\nexport function getDefaultRevision(): string {\n    /**\n     * Use a non-valid revision format,\n     * to ensure that the RxStorage will throw\n     * when the revision is not replaced downstream.\n     */\n    return '';\n}\n\n\nexport function getSortDocumentsByLastWriteTimeComparator<RxDocType>(primaryPath: string) {\n    return (a: RxDocumentData<RxDocType>, b: RxDocumentData<RxDocType>) => {\n        if (a._meta.lwt === b._meta.lwt) {\n            if ((b as any)[primaryPath] < (a as any)[primaryPath]) {\n                return 1;\n            } else {\n                return -1;\n            }\n        } else {\n            return a._meta.lwt - b._meta.lwt;\n        }\n    };\n}\nexport function sortDocumentsByLastWriteTime<RxDocType>(\n    primaryPath: string,\n    docs: RxDocumentData<RxDocType>[]\n): RxDocumentData<RxDocType>[] {\n    return docs.sort(getSortDocumentsByLastWriteTimeComparator(primaryPath));\n}\n","/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    if (typeof b !== \"function\" && b !== null)\r\n        throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport var __createBinding = Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n});\r\n\r\nexport function __exportStar(m, o) {\r\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(o, p)) __createBinding(o, m, p);\r\n}\r\n\r\nexport function __values(o) {\r\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\r\n    if (m) return m.call(o);\r\n    if (o && typeof o.length === \"number\") return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n}\r\n\r\nexport function __spreadArray(to, from, pack) {\r\n    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\r\n        if (ar || !(i in from)) {\r\n            if (!ar) ar = Array.prototype.slice.call(from, 0, i);\r\n            ar[i] = from[i];\r\n        }\r\n    }\r\n    return to.concat(ar || Array.prototype.slice.call(from));\r\n}\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nvar __setModuleDefault = Object.create ? (function(o, v) {\r\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\r\n}) : function(o, v) {\r\n    o[\"default\"] = v;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\r\n    __setModuleDefault(result, mod);\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n\r\nexport function __classPrivateFieldGet(receiver, state, kind, f) {\r\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\r\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\r\n    return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\r\n}\r\n\r\nexport function __classPrivateFieldSet(receiver, state, value, kind, f) {\r\n    if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\r\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\r\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\r\n    return (kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value)), value;\r\n}\r\n","export function isFunction(value) {\n    return typeof value === 'function';\n}\n//# sourceMappingURL=isFunction.js.map","export function createErrorClass(createImpl) {\n    var _super = function (instance) {\n        Error.call(instance);\n        instance.stack = new Error().stack;\n    };\n    var ctorFunc = createImpl(_super);\n    ctorFunc.prototype = Object.create(Error.prototype);\n    ctorFunc.prototype.constructor = ctorFunc;\n    return ctorFunc;\n}\n//# sourceMappingURL=createErrorClass.js.map","import { createErrorClass } from './createErrorClass';\nexport var UnsubscriptionError = createErrorClass(function (_super) {\n    return function UnsubscriptionErrorImpl(errors) {\n        _super(this);\n        this.message = errors\n            ? errors.length + \" errors occurred during unsubscription:\\n\" + errors.map(function (err, i) { return i + 1 + \") \" + err.toString(); }).join('\\n  ')\n            : '';\n        this.name = 'UnsubscriptionError';\n        this.errors = errors;\n    };\n});\n//# sourceMappingURL=UnsubscriptionError.js.map","export function arrRemove(arr, item) {\n    if (arr) {\n        var index = arr.indexOf(item);\n        0 <= index && arr.splice(index, 1);\n    }\n}\n//# sourceMappingURL=arrRemove.js.map","import { __read, __spreadArray, __values } from \"tslib\";\nimport { isFunction } from './util/isFunction';\nimport { UnsubscriptionError } from './util/UnsubscriptionError';\nimport { arrRemove } from './util/arrRemove';\nvar Subscription = (function () {\n    function Subscription(initialTeardown) {\n        this.initialTeardown = initialTeardown;\n        this.closed = false;\n        this._parentage = null;\n        this._teardowns = null;\n    }\n    Subscription.prototype.unsubscribe = function () {\n        var e_1, _a, e_2, _b;\n        var errors;\n        if (!this.closed) {\n            this.closed = true;\n            var _parentage = this._parentage;\n            if (_parentage) {\n                this._parentage = null;\n                if (Array.isArray(_parentage)) {\n                    try {\n                        for (var _parentage_1 = __values(_parentage), _parentage_1_1 = _parentage_1.next(); !_parentage_1_1.done; _parentage_1_1 = _parentage_1.next()) {\n                            var parent_1 = _parentage_1_1.value;\n                            parent_1.remove(this);\n                        }\n                    }\n                    catch (e_1_1) { e_1 = { error: e_1_1 }; }\n                    finally {\n                        try {\n                            if (_parentage_1_1 && !_parentage_1_1.done && (_a = _parentage_1.return)) _a.call(_parentage_1);\n                        }\n                        finally { if (e_1) throw e_1.error; }\n                    }\n                }\n                else {\n                    _parentage.remove(this);\n                }\n            }\n            var initialTeardown = this.initialTeardown;\n            if (isFunction(initialTeardown)) {\n                try {\n                    initialTeardown();\n                }\n                catch (e) {\n                    errors = e instanceof UnsubscriptionError ? e.errors : [e];\n                }\n            }\n            var _teardowns = this._teardowns;\n            if (_teardowns) {\n                this._teardowns = null;\n                try {\n                    for (var _teardowns_1 = __values(_teardowns), _teardowns_1_1 = _teardowns_1.next(); !_teardowns_1_1.done; _teardowns_1_1 = _teardowns_1.next()) {\n                        var teardown_1 = _teardowns_1_1.value;\n                        try {\n                            execTeardown(teardown_1);\n                        }\n                        catch (err) {\n                            errors = errors !== null && errors !== void 0 ? errors : [];\n                            if (err instanceof UnsubscriptionError) {\n                                errors = __spreadArray(__spreadArray([], __read(errors)), __read(err.errors));\n                            }\n                            else {\n                                errors.push(err);\n                            }\n                        }\n                    }\n                }\n                catch (e_2_1) { e_2 = { error: e_2_1 }; }\n                finally {\n                    try {\n                        if (_teardowns_1_1 && !_teardowns_1_1.done && (_b = _teardowns_1.return)) _b.call(_teardowns_1);\n                    }\n                    finally { if (e_2) throw e_2.error; }\n                }\n            }\n            if (errors) {\n                throw new UnsubscriptionError(errors);\n            }\n        }\n    };\n    Subscription.prototype.add = function (teardown) {\n        var _a;\n        if (teardown && teardown !== this) {\n            if (this.closed) {\n                execTeardown(teardown);\n            }\n            else {\n                if (teardown instanceof Subscription) {\n                    if (teardown.closed || teardown._hasParent(this)) {\n                        return;\n                    }\n                    teardown._addParent(this);\n                }\n                (this._teardowns = (_a = this._teardowns) !== null && _a !== void 0 ? _a : []).push(teardown);\n            }\n        }\n    };\n    Subscription.prototype._hasParent = function (parent) {\n        var _parentage = this._parentage;\n        return _parentage === parent || (Array.isArray(_parentage) && _parentage.includes(parent));\n    };\n    Subscription.prototype._addParent = function (parent) {\n        var _parentage = this._parentage;\n        this._parentage = Array.isArray(_parentage) ? (_parentage.push(parent), _parentage) : _parentage ? [_parentage, parent] : parent;\n    };\n    Subscription.prototype._removeParent = function (parent) {\n        var _parentage = this._parentage;\n        if (_parentage === parent) {\n            this._parentage = null;\n        }\n        else if (Array.isArray(_parentage)) {\n            arrRemove(_parentage, parent);\n        }\n    };\n    Subscription.prototype.remove = function (teardown) {\n        var _teardowns = this._teardowns;\n        _teardowns && arrRemove(_teardowns, teardown);\n        if (teardown instanceof Subscription) {\n            teardown._removeParent(this);\n        }\n    };\n    Subscription.EMPTY = (function () {\n        var empty = new Subscription();\n        empty.closed = true;\n        return empty;\n    })();\n    return Subscription;\n}());\nexport { Subscription };\nexport var EMPTY_SUBSCRIPTION = Subscription.EMPTY;\nexport function isSubscription(value) {\n    return (value instanceof Subscription ||\n        (value && 'closed' in value && isFunction(value.remove) && isFunction(value.add) && isFunction(value.unsubscribe)));\n}\nfunction execTeardown(teardown) {\n    if (isFunction(teardown)) {\n        teardown();\n    }\n    else {\n        teardown.unsubscribe();\n    }\n}\n//# sourceMappingURL=Subscription.js.map","export var config = {\n    onUnhandledError: null,\n    onStoppedNotification: null,\n    Promise: undefined,\n    useDeprecatedSynchronousErrorHandling: false,\n    useDeprecatedNextContext: false,\n};\n//# sourceMappingURL=config.js.map","import { __read, __spreadArray } from \"tslib\";\nexport var timeoutProvider = {\n    setTimeout: function () {\n        var args = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n            args[_i] = arguments[_i];\n        }\n        var delegate = timeoutProvider.delegate;\n        return ((delegate === null || delegate === void 0 ? void 0 : delegate.setTimeout) || setTimeout).apply(void 0, __spreadArray([], __read(args)));\n    },\n    clearTimeout: function (handle) {\n        var delegate = timeoutProvider.delegate;\n        return ((delegate === null || delegate === void 0 ? void 0 : delegate.clearTimeout) || clearTimeout)(handle);\n    },\n    delegate: undefined,\n};\n//# sourceMappingURL=timeoutProvider.js.map","export function noop() { }\n//# sourceMappingURL=noop.js.map","export var COMPLETE_NOTIFICATION = (function () { return createNotification('C', undefined, undefined); })();\nexport function errorNotification(error) {\n    return createNotification('E', undefined, error);\n}\nexport function nextNotification(value) {\n    return createNotification('N', value, undefined);\n}\nexport function createNotification(kind, value, error) {\n    return {\n        kind: kind,\n        value: value,\n        error: error,\n    };\n}\n//# sourceMappingURL=NotificationFactories.js.map","import { config } from '../config';\nvar context = null;\nexport function errorContext(cb) {\n    if (config.useDeprecatedSynchronousErrorHandling) {\n        var isRoot = !context;\n        if (isRoot) {\n            context = { errorThrown: false, error: null };\n        }\n        cb();\n        if (isRoot) {\n            var _a = context, errorThrown = _a.errorThrown, error = _a.error;\n            context = null;\n            if (errorThrown) {\n                throw error;\n            }\n        }\n    }\n    else {\n        cb();\n    }\n}\nexport function captureError(err) {\n    if (config.useDeprecatedSynchronousErrorHandling && context) {\n        context.errorThrown = true;\n        context.error = err;\n    }\n}\n//# sourceMappingURL=errorContext.js.map","import { __extends } from \"tslib\";\nimport { isFunction } from './util/isFunction';\nimport { isSubscription, Subscription } from './Subscription';\nimport { config } from './config';\nimport { reportUnhandledError } from './util/reportUnhandledError';\nimport { noop } from './util/noop';\nimport { nextNotification, errorNotification, COMPLETE_NOTIFICATION } from './NotificationFactories';\nimport { timeoutProvider } from './scheduler/timeoutProvider';\nimport { captureError } from './util/errorContext';\nvar Subscriber = (function (_super) {\n    __extends(Subscriber, _super);\n    function Subscriber(destination) {\n        var _this = _super.call(this) || this;\n        _this.isStopped = false;\n        if (destination) {\n            _this.destination = destination;\n            if (isSubscription(destination)) {\n                destination.add(_this);\n            }\n        }\n        else {\n            _this.destination = EMPTY_OBSERVER;\n        }\n        return _this;\n    }\n    Subscriber.create = function (next, error, complete) {\n        return new SafeSubscriber(next, error, complete);\n    };\n    Subscriber.prototype.next = function (value) {\n        if (this.isStopped) {\n            handleStoppedNotification(nextNotification(value), this);\n        }\n        else {\n            this._next(value);\n        }\n    };\n    Subscriber.prototype.error = function (err) {\n        if (this.isStopped) {\n            handleStoppedNotification(errorNotification(err), this);\n        }\n        else {\n            this.isStopped = true;\n            this._error(err);\n        }\n    };\n    Subscriber.prototype.complete = function () {\n        if (this.isStopped) {\n            handleStoppedNotification(COMPLETE_NOTIFICATION, this);\n        }\n        else {\n            this.isStopped = true;\n            this._complete();\n        }\n    };\n    Subscriber.prototype.unsubscribe = function () {\n        if (!this.closed) {\n            this.isStopped = true;\n            _super.prototype.unsubscribe.call(this);\n            this.destination = null;\n        }\n    };\n    Subscriber.prototype._next = function (value) {\n        this.destination.next(value);\n    };\n    Subscriber.prototype._error = function (err) {\n        try {\n            this.destination.error(err);\n        }\n        finally {\n            this.unsubscribe();\n        }\n    };\n    Subscriber.prototype._complete = function () {\n        try {\n            this.destination.complete();\n        }\n        finally {\n            this.unsubscribe();\n        }\n    };\n    return Subscriber;\n}(Subscription));\nexport { Subscriber };\nvar _bind = Function.prototype.bind;\nfunction bind(fn, thisArg) {\n    return _bind.call(fn, thisArg);\n}\nvar ConsumerObserver = (function () {\n    function ConsumerObserver(partialObserver) {\n        this.partialObserver = partialObserver;\n    }\n    ConsumerObserver.prototype.next = function (value) {\n        var partialObserver = this.partialObserver;\n        if (partialObserver.next) {\n            try {\n                partialObserver.next(value);\n            }\n            catch (error) {\n                handleUnhandledError(error);\n            }\n        }\n    };\n    ConsumerObserver.prototype.error = function (err) {\n        var partialObserver = this.partialObserver;\n        if (partialObserver.error) {\n            try {\n                partialObserver.error(err);\n            }\n            catch (error) {\n                handleUnhandledError(error);\n            }\n        }\n        else {\n            handleUnhandledError(err);\n        }\n    };\n    ConsumerObserver.prototype.complete = function () {\n        var partialObserver = this.partialObserver;\n        if (partialObserver.complete) {\n            try {\n                partialObserver.complete();\n            }\n            catch (error) {\n                handleUnhandledError(error);\n            }\n        }\n    };\n    return ConsumerObserver;\n}());\nvar SafeSubscriber = (function (_super) {\n    __extends(SafeSubscriber, _super);\n    function SafeSubscriber(observerOrNext, error, complete) {\n        var _this = _super.call(this) || this;\n        var partialObserver;\n        if (isFunction(observerOrNext) || !observerOrNext) {\n            partialObserver = {\n                next: observerOrNext !== null && observerOrNext !== void 0 ? observerOrNext : undefined,\n                error: error !== null && error !== void 0 ? error : undefined,\n                complete: complete !== null && complete !== void 0 ? complete : undefined,\n            };\n        }\n        else {\n            var context_1;\n            if (_this && config.useDeprecatedNextContext) {\n                context_1 = Object.create(observerOrNext);\n                context_1.unsubscribe = function () { return _this.unsubscribe(); };\n                partialObserver = {\n                    next: observerOrNext.next && bind(observerOrNext.next, context_1),\n                    error: observerOrNext.error && bind(observerOrNext.error, context_1),\n                    complete: observerOrNext.complete && bind(observerOrNext.complete, context_1),\n                };\n            }\n            else {\n                partialObserver = observerOrNext;\n            }\n        }\n        _this.destination = new ConsumerObserver(partialObserver);\n        return _this;\n    }\n    return SafeSubscriber;\n}(Subscriber));\nexport { SafeSubscriber };\nfunction handleUnhandledError(error) {\n    if (config.useDeprecatedSynchronousErrorHandling) {\n        captureError(error);\n    }\n    else {\n        reportUnhandledError(error);\n    }\n}\nfunction defaultErrorHandler(err) {\n    throw err;\n}\nfunction handleStoppedNotification(notification, subscriber) {\n    var onStoppedNotification = config.onStoppedNotification;\n    onStoppedNotification && timeoutProvider.setTimeout(function () { return onStoppedNotification(notification, subscriber); });\n}\nexport var EMPTY_OBSERVER = {\n    closed: true,\n    next: noop,\n    error: defaultErrorHandler,\n    complete: noop,\n};\n//# sourceMappingURL=Subscriber.js.map","import { config } from '../config';\nimport { timeoutProvider } from '../scheduler/timeoutProvider';\nexport function reportUnhandledError(err) {\n    timeoutProvider.setTimeout(function () {\n        var onUnhandledError = config.onUnhandledError;\n        if (onUnhandledError) {\n            onUnhandledError(err);\n        }\n        else {\n            throw err;\n        }\n    });\n}\n//# sourceMappingURL=reportUnhandledError.js.map","export var observable = (function () { return (typeof Symbol === 'function' && Symbol.observable) || '@@observable'; })();\n//# sourceMappingURL=observable.js.map","export function identity(x) {\n    return x;\n}\n//# sourceMappingURL=identity.js.map","import { identity } from './identity';\nexport function pipe() {\n    var fns = [];\n    for (var _i = 0; _i < arguments.length; _i++) {\n        fns[_i] = arguments[_i];\n    }\n    return pipeFromArray(fns);\n}\nexport function pipeFromArray(fns) {\n    if (fns.length === 0) {\n        return identity;\n    }\n    if (fns.length === 1) {\n        return fns[0];\n    }\n    return function piped(input) {\n        return fns.reduce(function (prev, fn) { return fn(prev); }, input);\n    };\n}\n//# sourceMappingURL=pipe.js.map","import { SafeSubscriber, Subscriber } from './Subscriber';\nimport { isSubscription } from './Subscription';\nimport { observable as Symbol_observable } from './symbol/observable';\nimport { pipeFromArray } from './util/pipe';\nimport { config } from './config';\nimport { isFunction } from './util/isFunction';\nimport { errorContext } from './util/errorContext';\nvar Observable = (function () {\n    function Observable(subscribe) {\n        if (subscribe) {\n            this._subscribe = subscribe;\n        }\n    }\n    Observable.prototype.lift = function (operator) {\n        var observable = new Observable();\n        observable.source = this;\n        observable.operator = operator;\n        return observable;\n    };\n    Observable.prototype.subscribe = function (observerOrNext, error, complete) {\n        var _this = this;\n        var subscriber = isSubscriber(observerOrNext) ? observerOrNext : new SafeSubscriber(observerOrNext, error, complete);\n        errorContext(function () {\n            var _a = _this, operator = _a.operator, source = _a.source;\n            subscriber.add(operator\n                ?\n                    operator.call(subscriber, source)\n                : source\n                    ?\n                        _this._subscribe(subscriber)\n                    :\n                        _this._trySubscribe(subscriber));\n        });\n        return subscriber;\n    };\n    Observable.prototype._trySubscribe = function (sink) {\n        try {\n            return this._subscribe(sink);\n        }\n        catch (err) {\n            sink.error(err);\n        }\n    };\n    Observable.prototype.forEach = function (next, promiseCtor) {\n        var _this = this;\n        promiseCtor = getPromiseCtor(promiseCtor);\n        return new promiseCtor(function (resolve, reject) {\n            var subscriber = new SafeSubscriber({\n                next: function (value) {\n                    try {\n                        next(value);\n                    }\n                    catch (err) {\n                        reject(err);\n                        subscriber.unsubscribe();\n                    }\n                },\n                error: reject,\n                complete: resolve,\n            });\n            _this.subscribe(subscriber);\n        });\n    };\n    Observable.prototype._subscribe = function (subscriber) {\n        var _a;\n        return (_a = this.source) === null || _a === void 0 ? void 0 : _a.subscribe(subscriber);\n    };\n    Observable.prototype[Symbol_observable] = function () {\n        return this;\n    };\n    Observable.prototype.pipe = function () {\n        var operations = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n            operations[_i] = arguments[_i];\n        }\n        return pipeFromArray(operations)(this);\n    };\n    Observable.prototype.toPromise = function (promiseCtor) {\n        var _this = this;\n        promiseCtor = getPromiseCtor(promiseCtor);\n        return new promiseCtor(function (resolve, reject) {\n            var value;\n            _this.subscribe(function (x) { return (value = x); }, function (err) { return reject(err); }, function () { return resolve(value); });\n        });\n    };\n    Observable.create = function (subscribe) {\n        return new Observable(subscribe);\n    };\n    return Observable;\n}());\nexport { Observable };\nfunction getPromiseCtor(promiseCtor) {\n    var _a;\n    return (_a = promiseCtor !== null && promiseCtor !== void 0 ? promiseCtor : config.Promise) !== null && _a !== void 0 ? _a : Promise;\n}\nfunction isObserver(value) {\n    return value && isFunction(value.next) && isFunction(value.error) && isFunction(value.complete);\n}\nfunction isSubscriber(value) {\n    return (value && value instanceof Subscriber) || (isObserver(value) && isSubscription(value));\n}\n//# sourceMappingURL=Observable.js.map","import { createErrorClass } from './createErrorClass';\nexport var ObjectUnsubscribedError = createErrorClass(function (_super) {\n    return function ObjectUnsubscribedErrorImpl() {\n        _super(this);\n        this.name = 'ObjectUnsubscribedError';\n        this.message = 'object unsubscribed';\n    };\n});\n//# sourceMappingURL=ObjectUnsubscribedError.js.map","import { __extends, __values } from \"tslib\";\nimport { Observable } from './Observable';\nimport { Subscription, EMPTY_SUBSCRIPTION } from './Subscription';\nimport { ObjectUnsubscribedError } from './util/ObjectUnsubscribedError';\nimport { arrRemove } from './util/arrRemove';\nimport { errorContext } from './util/errorContext';\nvar Subject = (function (_super) {\n    __extends(Subject, _super);\n    function Subject() {\n        var _this = _super.call(this) || this;\n        _this.closed = false;\n        _this.observers = [];\n        _this.isStopped = false;\n        _this.hasError = false;\n        _this.thrownError = null;\n        return _this;\n    }\n    Subject.prototype.lift = function (operator) {\n        var subject = new AnonymousSubject(this, this);\n        subject.operator = operator;\n        return subject;\n    };\n    Subject.prototype._throwIfClosed = function () {\n        if (this.closed) {\n            throw new ObjectUnsubscribedError();\n        }\n    };\n    Subject.prototype.next = function (value) {\n        var _this = this;\n        errorContext(function () {\n            var e_1, _a;\n            _this._throwIfClosed();\n            if (!_this.isStopped) {\n                var copy = _this.observers.slice();\n                try {\n                    for (var copy_1 = __values(copy), copy_1_1 = copy_1.next(); !copy_1_1.done; copy_1_1 = copy_1.next()) {\n                        var observer = copy_1_1.value;\n                        observer.next(value);\n                    }\n                }\n                catch (e_1_1) { e_1 = { error: e_1_1 }; }\n                finally {\n                    try {\n                        if (copy_1_1 && !copy_1_1.done && (_a = copy_1.return)) _a.call(copy_1);\n                    }\n                    finally { if (e_1) throw e_1.error; }\n                }\n            }\n        });\n    };\n    Subject.prototype.error = function (err) {\n        var _this = this;\n        errorContext(function () {\n            _this._throwIfClosed();\n            if (!_this.isStopped) {\n                _this.hasError = _this.isStopped = true;\n                _this.thrownError = err;\n                var observers = _this.observers;\n                while (observers.length) {\n                    observers.shift().error(err);\n                }\n            }\n        });\n    };\n    Subject.prototype.complete = function () {\n        var _this = this;\n        errorContext(function () {\n            _this._throwIfClosed();\n            if (!_this.isStopped) {\n                _this.isStopped = true;\n                var observers = _this.observers;\n                while (observers.length) {\n                    observers.shift().complete();\n                }\n            }\n        });\n    };\n    Subject.prototype.unsubscribe = function () {\n        this.isStopped = this.closed = true;\n        this.observers = null;\n    };\n    Object.defineProperty(Subject.prototype, \"observed\", {\n        get: function () {\n            var _a;\n            return ((_a = this.observers) === null || _a === void 0 ? void 0 : _a.length) > 0;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Subject.prototype._trySubscribe = function (subscriber) {\n        this._throwIfClosed();\n        return _super.prototype._trySubscribe.call(this, subscriber);\n    };\n    Subject.prototype._subscribe = function (subscriber) {\n        this._throwIfClosed();\n        this._checkFinalizedStatuses(subscriber);\n        return this._innerSubscribe(subscriber);\n    };\n    Subject.prototype._innerSubscribe = function (subscriber) {\n        var _a = this, hasError = _a.hasError, isStopped = _a.isStopped, observers = _a.observers;\n        return hasError || isStopped\n            ? EMPTY_SUBSCRIPTION\n            : (observers.push(subscriber), new Subscription(function () { return arrRemove(observers, subscriber); }));\n    };\n    Subject.prototype._checkFinalizedStatuses = function (subscriber) {\n        var _a = this, hasError = _a.hasError, thrownError = _a.thrownError, isStopped = _a.isStopped;\n        if (hasError) {\n            subscriber.error(thrownError);\n        }\n        else if (isStopped) {\n            subscriber.complete();\n        }\n    };\n    Subject.prototype.asObservable = function () {\n        var observable = new Observable();\n        observable.source = this;\n        return observable;\n    };\n    Subject.create = function (destination, source) {\n        return new AnonymousSubject(destination, source);\n    };\n    return Subject;\n}(Observable));\nexport { Subject };\nvar AnonymousSubject = (function (_super) {\n    __extends(AnonymousSubject, _super);\n    function AnonymousSubject(destination, source) {\n        var _this = _super.call(this) || this;\n        _this.destination = destination;\n        _this.source = source;\n        return _this;\n    }\n    AnonymousSubject.prototype.next = function (value) {\n        var _a, _b;\n        (_b = (_a = this.destination) === null || _a === void 0 ? void 0 : _a.next) === null || _b === void 0 ? void 0 : _b.call(_a, value);\n    };\n    AnonymousSubject.prototype.error = function (err) {\n        var _a, _b;\n        (_b = (_a = this.destination) === null || _a === void 0 ? void 0 : _a.error) === null || _b === void 0 ? void 0 : _b.call(_a, err);\n    };\n    AnonymousSubject.prototype.complete = function () {\n        var _a, _b;\n        (_b = (_a = this.destination) === null || _a === void 0 ? void 0 : _a.complete) === null || _b === void 0 ? void 0 : _b.call(_a);\n    };\n    AnonymousSubject.prototype._subscribe = function (subscriber) {\n        var _a, _b;\n        return (_b = (_a = this.source) === null || _a === void 0 ? void 0 : _a.subscribe(subscriber)) !== null && _b !== void 0 ? _b : EMPTY_SUBSCRIPTION;\n    };\n    return AnonymousSubject;\n}(Subject));\nexport { AnonymousSubject };\n//# sourceMappingURL=Subject.js.map","function _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nexport default function _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  Object.defineProperty(Constructor, \"prototype\", {\n    writable: false\n  });\n  return Constructor;\n}","export default function _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n\n  return _setPrototypeOf(o, p);\n}","import setPrototypeOf from \"./setPrototypeOf.js\";\nexport default function _inheritsLoose(subClass, superClass) {\n  subClass.prototype = Object.create(superClass.prototype);\n  subClass.prototype.constructor = subClass;\n  setPrototypeOf(subClass, superClass);\n}","export default function _getPrototypeOf(o) {\n  _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) {\n    return o.__proto__ || Object.getPrototypeOf(o);\n  };\n  return _getPrototypeOf(o);\n}","export default function _isNativeReflectConstruct() {\n  if (typeof Reflect === \"undefined\" || !Reflect.construct) return false;\n  if (Reflect.construct.sham) return false;\n  if (typeof Proxy === \"function\") return true;\n\n  try {\n    Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {}));\n    return true;\n  } catch (e) {\n    return false;\n  }\n}","import setPrototypeOf from \"./setPrototypeOf.js\";\nimport isNativeReflectConstruct from \"./isNativeReflectConstruct.js\";\nexport default function _construct(Parent, args, Class) {\n  if (isNativeReflectConstruct()) {\n    _construct = Reflect.construct;\n  } else {\n    _construct = function _construct(Parent, args, Class) {\n      var a = [null];\n      a.push.apply(a, args);\n      var Constructor = Function.bind.apply(Parent, a);\n      var instance = new Constructor();\n      if (Class) setPrototypeOf(instance, Class.prototype);\n      return instance;\n    };\n  }\n\n  return _construct.apply(null, arguments);\n}","import getPrototypeOf from \"./getPrototypeOf.js\";\nimport setPrototypeOf from \"./setPrototypeOf.js\";\nimport isNativeFunction from \"./isNativeFunction.js\";\nimport construct from \"./construct.js\";\nexport default function _wrapNativeSuper(Class) {\n  var _cache = typeof Map === \"function\" ? new Map() : undefined;\n\n  _wrapNativeSuper = function _wrapNativeSuper(Class) {\n    if (Class === null || !isNativeFunction(Class)) return Class;\n\n    if (typeof Class !== \"function\") {\n      throw new TypeError(\"Super expression must either be null or a function\");\n    }\n\n    if (typeof _cache !== \"undefined\") {\n      if (_cache.has(Class)) return _cache.get(Class);\n\n      _cache.set(Class, Wrapper);\n    }\n\n    function Wrapper() {\n      return construct(Class, arguments, getPrototypeOf(this).constructor);\n    }\n\n    Wrapper.prototype = Object.create(Class.prototype, {\n      constructor: {\n        value: Wrapper,\n        enumerable: false,\n        writable: true,\n        configurable: true\n      }\n    });\n    return setPrototypeOf(Wrapper, Class);\n  };\n\n  return _wrapNativeSuper(Class);\n}","export default function _isNativeFunction(fn) {\n  return Function.toString.call(fn).indexOf(\"[native code]\") !== -1;\n}","/**\n * functions that can or should be overwritten by plugins\n * IMPORTANT: Do not import any big stuff from RxDB here,\n * the 'overwritable' can be used inside of WebWorkers for the RxStorage only and\n * we do not want to have the full RxDB lib bundled in them.\n */\n\nimport type { DeepReadonly } from './types/util';\nimport {\n    pluginMissing\n} from './util';\n\nexport const overwritable = {\n    /**\n     * if this method is overwritte with one\n     * that returns true, we do additional checks\n     * which help the developer but have bad performance\n     */\n    isDevMode(): boolean {\n        return false;\n    },\n\n    /**\n     * Deep freezes and object when in dev-mode.\n     * Deep-Freezing has the same performaance as deep-cloning, so we only do that in dev-mode.\n     * Also we can ensure the readonly state via typescript\n     * @link https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze\n     */\n    deepFreezeWhenDevMode<T>(obj: T): DeepReadonly<T> {\n        return obj as any;\n    },\n\n    /**\n     * validates if a password can be used\n     * @overwritten by plugin (optional)\n     * @throws if password not valid\n     */\n    validatePassword(_password: string | any): void {\n        throw pluginMissing('encryption');\n    },\n\n    /**\n     * overwritte to map error-codes to text-messages\n     */\n    tunnelErrorMessage(message: string): string {\n        return `RxDB Error-Code ${message}.\n        Error messages are not included in RxDB core to reduce build size.\n        - To find out what this error means, either use the dev-mode-plugin https://rxdb.info/dev-mode.html\n        - or search for the error code here: https://github.com/pubkey/rxdb/search?q=${message}\n        `;\n    }\n};\n","/**\n * here we use custom errors with the additional field 'parameters'\n */\n\nimport { overwritable } from './overwritable';\nimport type {\n    RxErrorParameters,\n    PouchWriteError,\n    RxErrorKey\n} from './types';\n\n/**\n * transform an object of parameters to a presentable string\n */\nfunction parametersToString(parameters: any): string {\n    let ret = '';\n    if (Object.keys(parameters).length === 0)\n        return ret;\n    ret += 'Given parameters: {\\n';\n    ret += Object.keys(parameters)\n        .map(k => {\n            let paramStr = '[object Object]';\n            try {\n                paramStr = JSON.stringify(\n                    parameters[k],\n                    (_k, v) => v === undefined ? null : v,\n                    2\n                );\n            } catch (e) { }\n            return k + ':' + paramStr;\n        })\n        .join('\\n');\n    ret += '}';\n    return ret;\n}\n\nfunction messageForError(\n    message: string,\n    code: string,\n    parameters: any\n): string {\n    return 'RxError (' + code + '):' + '\\n' +\n        message + '\\n' +\n        parametersToString(parameters);\n}\n\nexport class RxError extends Error {\n    public code: RxErrorKey;\n    public message: string;\n    public parameters: RxErrorParameters;\n    public rxdb: true;\n    constructor(\n        code: RxErrorKey,\n        message: string,\n        parameters: RxErrorParameters = {}\n    ) {\n        const mes = messageForError(message, code, parameters);\n        super(mes);\n        this.code = code;\n        this.message = mes;\n        this.parameters = parameters;\n        this.rxdb = true; // tag them as internal\n    }\n    get name(): string {\n        return 'RxError (' + this.code + ')';\n    }\n    toString(): string {\n        return this.message;\n    }\n    get typeError(): boolean {\n        return false;\n    }\n}\n\nexport class RxTypeError extends TypeError {\n    public code: RxErrorKey;\n    public message: string;\n    public parameters: RxErrorParameters;\n    public rxdb: true;\n    constructor(\n        code: RxErrorKey,\n        message: string,\n        parameters: RxErrorParameters = {}\n    ) {\n        const mes = messageForError(message, code, parameters);\n        super(mes);\n        this.code = code;\n        this.message = mes;\n        this.parameters = parameters;\n        this.rxdb = true; // tag them as internal\n    }\n    get name(): string {\n        return 'RxTypeError (' + this.code + ')';\n    }\n    toString(): string {\n        return this.message;\n    }\n    get typeError(): boolean {\n        return true;\n    }\n}\n\nexport function newRxError(\n    code: RxErrorKey,\n    parameters?: RxErrorParameters\n): RxError {\n    return new RxError(\n        code,\n        overwritable.tunnelErrorMessage(code),\n        parameters\n    );\n}\n\nexport function newRxTypeError(\n    code: RxErrorKey,\n    parameters?: RxErrorParameters\n): RxTypeError {\n    return new RxTypeError(\n        code,\n        overwritable.tunnelErrorMessage(code),\n        parameters\n    );\n}\n\nexport function isPouchdbConflictError(err: RxError | RxTypeError): boolean {\n    if (\n        err.parameters && err.parameters.pouchDbError &&\n        (err.parameters.pouchDbError as PouchWriteError).status === 409\n    ) {\n        return true;\n    } else {\n        return false;\n    }\n}\n","/* global WorkerGlobalScope */\nfunction add(fn) {\n  if (typeof WorkerGlobalScope === 'function' && self instanceof WorkerGlobalScope) {// this is run inside of a webworker\n  } else {\n    /**\n     * if we are on react-native, there is no window.addEventListener\n     * @link https://github.com/pubkey/unload/issues/6\n     */\n    if (typeof window.addEventListener !== 'function') return;\n    /**\n     * for normal browser-windows, we use the beforeunload-event\n     */\n\n    window.addEventListener('beforeunload', function () {\n      fn();\n    }, true);\n    /**\n     * for iframes, we have to use the unload-event\n     * @link https://stackoverflow.com/q/47533670/3443137\n     */\n\n    window.addEventListener('unload', function () {\n      fn();\n    }, true);\n  }\n  /**\n   * TODO add fallback for safari-mobile\n   * @link https://stackoverflow.com/a/26193516/3443137\n   */\n\n}\n\nexport default {\n  add: add\n};","import isNode from 'detect-node';\nimport BrowserMethod from './browser.js';\nimport NodeMethod from './node.js';\nvar USE_METHOD = isNode ? NodeMethod : BrowserMethod;\nvar LISTENERS = new Set();\nvar startedListening = false;\n\nfunction startListening() {\n  if (startedListening) return;\n  startedListening = true;\n  USE_METHOD.add(runAll);\n}\n\nexport function add(fn) {\n  startListening();\n  if (typeof fn !== 'function') throw new Error('Listener is no function');\n  LISTENERS.add(fn);\n  var addReturn = {\n    remove: function remove() {\n      return LISTENERS[\"delete\"](fn);\n    },\n    run: function run() {\n      LISTENERS[\"delete\"](fn);\n      return fn();\n    }\n  };\n  return addReturn;\n}\nexport function runAll() {\n  var promises = [];\n  LISTENERS.forEach(function (fn) {\n    promises.push(fn());\n    LISTENERS[\"delete\"](fn);\n  });\n  return Promise.all(promises);\n}\nexport function removeAll() {\n  LISTENERS.clear();\n}\nexport function getSize() {\n  return LISTENERS.size;\n}","import type { LokiDatabaseSettings } from '../../types';\nimport {\n    PROMISE_RESOLVE_VOID,\n    requestIdlePromise\n} from '../../util';\n\n/**\n * The autosave feature of lokijs has strange behaviors\n * and often runs a save in critical moments when other\n * more important tasks are running.\n * So instead we use a custom save queue that ensures we\n * only run loki.saveDatabase() when nothing else is running.\n */\nexport class LokiSaveQueue {\n    public writesSinceLastRun: number = 0;\n\n    /**\n     * Ensures that we do not run multiple saves\n     * in parallel\n     */\n    public saveQueue: Promise<void> = PROMISE_RESOLVE_VOID;\n    // track amount of non-finished save calls in the queue.\n    public saveQueueC = 0;\n\n    constructor(\n        public readonly lokiDatabase: Loki,\n        public readonly databaseSettings: LokiDatabaseSettings\n    ) {\n\n    }\n\n    public addWrite() {\n        this.writesSinceLastRun = this.writesSinceLastRun + 1;\n        this.run();\n    }\n\n    public run() {\n        if (\n            // no persistence adapter given, so we do not need to save\n            !this.databaseSettings.adapter ||\n            // do not add more then two pending calls to the queue.\n            this.saveQueueC > 2\n\n        ) {\n            return this.saveQueue;\n        }\n\n        this.saveQueueC = this.saveQueueC + 1;\n        this.saveQueue = this.saveQueue\n            .then(async () => {\n                /**\n                 * Always wait until the JavaScript process is idle.\n                 * This ensures that CPU blocking writes are finished\n                 * before we proceed.\n                 */\n                await requestIdlePromise();\n\n                // no write happened since the last save call\n                if (this.writesSinceLastRun === 0) {\n                    return;\n                }\n\n                /**\n                 * Because LokiJS is a in-memory database,\n                 * we can just wait until the JavaScript process is idle\n                 * via requestIdlePromise(). Then we know that nothing important\n                 * is running at the moment. Also we wait at least wait 100ms\n                 * to ensure it has enough time to free up stuff.\n                 */\n                await requestIdlePromise().then(() => requestIdlePromise());\n\n                if (this.writesSinceLastRun === 0) {\n                    return;\n                }\n\n                const writeAmount = this.writesSinceLastRun;\n                this.writesSinceLastRun = 0;\n                return new Promise<void>((res, rej) => {\n                    this.lokiDatabase.saveDatabase(err => {\n                        if (err) {\n                            this.writesSinceLastRun = this.writesSinceLastRun + writeAmount;\n                            rej(err);\n                        } else {\n                            if (this.databaseSettings.autosaveCallback) {\n                                this.databaseSettings.autosaveCallback();\n                            }\n                            res();\n                        }\n                    });\n                });\n            })\n            .catch(() => { })\n            .then(() => {\n                this.saveQueueC = this.saveQueueC - 1;\n            });\n        return this.saveQueue;\n    }\n}\n","/**\n * returns true if the given object is a promise\n */\nexport function isPromise(obj) {\n  if (obj && typeof obj.then === 'function') {\n    return true;\n  } else {\n    return false;\n  }\n}\nexport var PROMISE_RESOLVED_FALSE = Promise.resolve(false);\nexport var PROMISE_RESOLVED_TRUE = Promise.resolve(true);\nexport var PROMISE_RESOLVED_VOID = Promise.resolve();\nexport function sleep(time, resolveWith) {\n  if (!time) time = 0;\n  return new Promise(function (res) {\n    return setTimeout(function () {\n      return res(resolveWith);\n    }, time);\n  });\n}\nexport function randomInt(min, max) {\n  return Math.floor(Math.random() * (max - min + 1) + min);\n}\n/**\n * https://stackoverflow.com/a/8084248\n */\n\nexport function randomToken() {\n  return Math.random().toString(36).substring(2);\n}\nvar lastMs = 0;\nvar additional = 0;\n/**\n * returns the current time in micro-seconds,\n * WARNING: This is a pseudo-function\n * Performance.now is not reliable in webworkers, so we just make sure to never return the same time.\n * This is enough in browsers, and this function will not be used in nodejs.\n * The main reason for this hack is to ensure that BroadcastChannel behaves equal to production when it is used in fast-running unit tests.\n */\n\nexport function microSeconds() {\n  var ms = new Date().getTime();\n\n  if (ms === lastMs) {\n    additional++;\n    return ms * 1000 + additional;\n  } else {\n    lastMs = ms;\n    additional = 0;\n    return ms * 1000;\n  }\n}\n/**\n * copied from the 'detect-node' npm module\n * We cannot use the module directly because it causes problems with rollup\n * @link https://github.com/iliakan/detect-node/blob/master/index.js\n */\n\nexport var isNode = Object.prototype.toString.call(typeof process !== 'undefined' ? process : 0) === '[object process]';","import { microSeconds as micro, isNode, PROMISE_RESOLVED_VOID } from '../util';\nexport var microSeconds = micro;\nexport var type = 'native';\nexport function create(channelName) {\n  var state = {\n    messagesCallback: null,\n    bc: new BroadcastChannel(channelName),\n    subFns: [] // subscriberFunctions\n\n  };\n\n  state.bc.onmessage = function (msg) {\n    if (state.messagesCallback) {\n      state.messagesCallback(msg.data);\n    }\n  };\n\n  return state;\n}\nexport function close(channelState) {\n  channelState.bc.close();\n  channelState.subFns = [];\n}\nexport function postMessage(channelState, messageJson) {\n  try {\n    channelState.bc.postMessage(messageJson, false);\n    return PROMISE_RESOLVED_VOID;\n  } catch (err) {\n    return Promise.reject(err);\n  }\n}\nexport function onMessage(channelState, fn) {\n  channelState.messagesCallback = fn;\n}\nexport function canBeUsed() {\n  /**\n   * in the electron-renderer, isNode will be true even if we are in browser-context\n   * so we also check if window is undefined\n   */\n  if (isNode && typeof window === 'undefined') return false;\n\n  if (typeof BroadcastChannel === 'function') {\n    if (BroadcastChannel._pubkey) {\n      throw new Error('BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill');\n    }\n\n    return true;\n  } else return false;\n}\nexport function averageResponseTime() {\n  return 150;\n}\nexport default {\n  create: create,\n  close: close,\n  onMessage: onMessage,\n  postMessage: postMessage,\n  canBeUsed: canBeUsed,\n  type: type,\n  averageResponseTime: averageResponseTime,\n  microSeconds: microSeconds\n};","/**\n * this is a set which automatically forgets\n * a given entry when a new entry is set and the ttl\n * of the old one is over\n */\nvar ObliviousSet = /** @class */ (function () {\n    function ObliviousSet(ttl) {\n        this.ttl = ttl;\n        this.set = new Set();\n        this.timeMap = new Map();\n    }\n    ObliviousSet.prototype.has = function (value) {\n        return this.set.has(value);\n    };\n    ObliviousSet.prototype.add = function (value) {\n        var _this = this;\n        this.timeMap.set(value, now());\n        this.set.add(value);\n        /**\n         * When a new value is added,\n         * start the cleanup at the next tick\n         * to not block the cpu for more important stuff\n         * that might happen.\n         */\n        setTimeout(function () {\n            removeTooOldValues(_this);\n        }, 0);\n    };\n    ObliviousSet.prototype.clear = function () {\n        this.set.clear();\n        this.timeMap.clear();\n    };\n    return ObliviousSet;\n}());\nexport { ObliviousSet };\n/**\n * Removes all entries from the set\n * where the TTL has expired\n */\nexport function removeTooOldValues(obliviousSet) {\n    var olderThen = now() - obliviousSet.ttl;\n    var iterator = obliviousSet.set[Symbol.iterator]();\n    /**\n     * Because we can assume the new values are added at the bottom,\n     * we start from the top and stop as soon as we reach a non-too-old value.\n     */\n    while (true) {\n        var value = iterator.next().value;\n        if (!value) {\n            return; // no more elements\n        }\n        var time = obliviousSet.timeMap.get(value);\n        if (time < olderThen) {\n            obliviousSet.timeMap.delete(value);\n            obliviousSet.set.delete(value);\n        }\n        else {\n            // We reached a value that is not old enough\n            return;\n        }\n    }\n}\nexport function now() {\n    return new Date().getTime();\n}\n//# sourceMappingURL=index.js.map","export function fillOptionsWithDefaults() {\n  var originalOptions = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  var options = JSON.parse(JSON.stringify(originalOptions)); // main\n\n  if (typeof options.webWorkerSupport === 'undefined') options.webWorkerSupport = true; // indexed-db\n\n  if (!options.idb) options.idb = {}; //  after this time the messages get deleted\n\n  if (!options.idb.ttl) options.idb.ttl = 1000 * 45;\n  if (!options.idb.fallbackInterval) options.idb.fallbackInterval = 150; //  handles abrupt db onclose events.\n\n  if (originalOptions.idb && typeof originalOptions.idb.onclose === 'function') options.idb.onclose = originalOptions.idb.onclose; // localstorage\n\n  if (!options.localstorage) options.localstorage = {};\n  if (!options.localstorage.removeTimeout) options.localstorage.removeTimeout = 1000 * 60; // custom methods\n\n  if (originalOptions.methods) options.methods = originalOptions.methods; // node\n\n  if (!options.node) options.node = {};\n  if (!options.node.ttl) options.node.ttl = 1000 * 60 * 2; // 2 minutes;\n\n  /**\n   * On linux use 'ulimit -Hn' to get the limit of open files.\n   * On ubuntu this was 4096 for me, so we use half of that as maxParallelWrites default.\n   */\n\n  if (!options.node.maxParallelWrites) options.node.maxParallelWrites = 2048;\n  if (typeof options.node.useFastPath === 'undefined') options.node.useFastPath = true;\n  return options;\n}","/**\n * this method uses indexeddb to store the messages\n * There is currently no observerAPI for idb\n * @link https://github.com/w3c/IndexedDB/issues/51\n */\nimport { sleep, randomInt, randomToken, microSeconds as micro, isNode, PROMISE_RESOLVED_VOID } from '../util.js';\nexport var microSeconds = micro;\nimport { ObliviousSet } from 'oblivious-set';\nimport { fillOptionsWithDefaults } from '../options';\nvar DB_PREFIX = 'pubkey.broadcast-channel-0-';\nvar OBJECT_STORE_ID = 'messages';\nexport var type = 'idb';\nexport function getIdb() {\n  if (typeof indexedDB !== 'undefined') return indexedDB;\n\n  if (typeof window !== 'undefined') {\n    if (typeof window.mozIndexedDB !== 'undefined') return window.mozIndexedDB;\n    if (typeof window.webkitIndexedDB !== 'undefined') return window.webkitIndexedDB;\n    if (typeof window.msIndexedDB !== 'undefined') return window.msIndexedDB;\n  }\n\n  return false;\n}\nexport function createDatabase(channelName) {\n  var IndexedDB = getIdb(); // create table\n\n  var dbName = DB_PREFIX + channelName;\n  var openRequest = IndexedDB.open(dbName, 1);\n\n  openRequest.onupgradeneeded = function (ev) {\n    var db = ev.target.result;\n    db.createObjectStore(OBJECT_STORE_ID, {\n      keyPath: 'id',\n      autoIncrement: true\n    });\n  };\n\n  var dbPromise = new Promise(function (res, rej) {\n    openRequest.onerror = function (ev) {\n      return rej(ev);\n    };\n\n    openRequest.onsuccess = function () {\n      res(openRequest.result);\n    };\n  });\n  return dbPromise;\n}\n/**\n * writes the new message to the database\n * so other readers can find it\n */\n\nexport function writeMessage(db, readerUuid, messageJson) {\n  var time = new Date().getTime();\n  var writeObject = {\n    uuid: readerUuid,\n    time: time,\n    data: messageJson\n  };\n  var transaction = db.transaction([OBJECT_STORE_ID], 'readwrite');\n  return new Promise(function (res, rej) {\n    transaction.oncomplete = function () {\n      return res();\n    };\n\n    transaction.onerror = function (ev) {\n      return rej(ev);\n    };\n\n    var objectStore = transaction.objectStore(OBJECT_STORE_ID);\n    objectStore.add(writeObject);\n  });\n}\nexport function getAllMessages(db) {\n  var objectStore = db.transaction(OBJECT_STORE_ID).objectStore(OBJECT_STORE_ID);\n  var ret = [];\n  return new Promise(function (res) {\n    objectStore.openCursor().onsuccess = function (ev) {\n      var cursor = ev.target.result;\n\n      if (cursor) {\n        ret.push(cursor.value); //alert(\"Name for SSN \" + cursor.key + \" is \" + cursor.value.name);\n\n        cursor[\"continue\"]();\n      } else {\n        res(ret);\n      }\n    };\n  });\n}\nexport function getMessagesHigherThan(db, lastCursorId) {\n  var objectStore = db.transaction(OBJECT_STORE_ID).objectStore(OBJECT_STORE_ID);\n  var ret = [];\n\n  function openCursor() {\n    // Occasionally Safari will fail on IDBKeyRange.bound, this\n    // catches that error, having it open the cursor to the first\n    // item. When it gets data it will advance to the desired key.\n    try {\n      var keyRangeValue = IDBKeyRange.bound(lastCursorId + 1, Infinity);\n      return objectStore.openCursor(keyRangeValue);\n    } catch (e) {\n      return objectStore.openCursor();\n    }\n  }\n\n  return new Promise(function (res) {\n    openCursor().onsuccess = function (ev) {\n      var cursor = ev.target.result;\n\n      if (cursor) {\n        if (cursor.value.id < lastCursorId + 1) {\n          cursor[\"continue\"](lastCursorId + 1);\n        } else {\n          ret.push(cursor.value);\n          cursor[\"continue\"]();\n        }\n      } else {\n        res(ret);\n      }\n    };\n  });\n}\nexport function removeMessageById(db, id) {\n  var request = db.transaction([OBJECT_STORE_ID], 'readwrite').objectStore(OBJECT_STORE_ID)[\"delete\"](id);\n  return new Promise(function (res) {\n    request.onsuccess = function () {\n      return res();\n    };\n  });\n}\nexport function getOldMessages(db, ttl) {\n  var olderThen = new Date().getTime() - ttl;\n  var objectStore = db.transaction(OBJECT_STORE_ID).objectStore(OBJECT_STORE_ID);\n  var ret = [];\n  return new Promise(function (res) {\n    objectStore.openCursor().onsuccess = function (ev) {\n      var cursor = ev.target.result;\n\n      if (cursor) {\n        var msgObk = cursor.value;\n\n        if (msgObk.time < olderThen) {\n          ret.push(msgObk); //alert(\"Name for SSN \" + cursor.key + \" is \" + cursor.value.name);\n\n          cursor[\"continue\"]();\n        } else {\n          // no more old messages,\n          res(ret);\n          return;\n        }\n      } else {\n        res(ret);\n      }\n    };\n  });\n}\nexport function cleanOldMessages(db, ttl) {\n  return getOldMessages(db, ttl).then(function (tooOld) {\n    return Promise.all(tooOld.map(function (msgObj) {\n      return removeMessageById(db, msgObj.id);\n    }));\n  });\n}\nexport function create(channelName, options) {\n  options = fillOptionsWithDefaults(options);\n  return createDatabase(channelName).then(function (db) {\n    var state = {\n      closed: false,\n      lastCursorId: 0,\n      channelName: channelName,\n      options: options,\n      uuid: randomToken(),\n\n      /**\n       * emittedMessagesIds\n       * contains all messages that have been emitted before\n       * @type {ObliviousSet}\n       */\n      eMIs: new ObliviousSet(options.idb.ttl * 2),\n      // ensures we do not read messages in parrallel\n      writeBlockPromise: PROMISE_RESOLVED_VOID,\n      messagesCallback: null,\n      readQueuePromises: [],\n      db: db\n    };\n    /**\n     * Handle abrupt closes that do not originate from db.close().\n     * This could happen, for example, if the underlying storage is\n     * removed or if the user clears the database in the browser's\n     * history preferences.\n     */\n\n    db.onclose = function () {\n      state.closed = true;\n      if (options.idb.onclose) options.idb.onclose();\n    };\n    /**\n     * if service-workers are used,\n     * we have no 'storage'-event if they post a message,\n     * therefore we also have to set an interval\n     */\n\n\n    _readLoop(state);\n\n    return state;\n  });\n}\n\nfunction _readLoop(state) {\n  if (state.closed) return;\n  readNewMessages(state).then(function () {\n    return sleep(state.options.idb.fallbackInterval);\n  }).then(function () {\n    return _readLoop(state);\n  });\n}\n\nfunction _filterMessage(msgObj, state) {\n  if (msgObj.uuid === state.uuid) return false; // send by own\n\n  if (state.eMIs.has(msgObj.id)) return false; // already emitted\n\n  if (msgObj.data.time < state.messagesCallbackTime) return false; // older then onMessageCallback\n\n  return true;\n}\n/**\n * reads all new messages from the database and emits them\n */\n\n\nfunction readNewMessages(state) {\n  // channel already closed\n  if (state.closed) return PROMISE_RESOLVED_VOID; // if no one is listening, we do not need to scan for new messages\n\n  if (!state.messagesCallback) return PROMISE_RESOLVED_VOID;\n  return getMessagesHigherThan(state.db, state.lastCursorId).then(function (newerMessages) {\n    var useMessages = newerMessages\n    /**\n     * there is a bug in iOS where the msgObj can be undefined some times\n     * so we filter them out\n     * @link https://github.com/pubkey/broadcast-channel/issues/19\n     */\n    .filter(function (msgObj) {\n      return !!msgObj;\n    }).map(function (msgObj) {\n      if (msgObj.id > state.lastCursorId) {\n        state.lastCursorId = msgObj.id;\n      }\n\n      return msgObj;\n    }).filter(function (msgObj) {\n      return _filterMessage(msgObj, state);\n    }).sort(function (msgObjA, msgObjB) {\n      return msgObjA.time - msgObjB.time;\n    }); // sort by time\n\n    useMessages.forEach(function (msgObj) {\n      if (state.messagesCallback) {\n        state.eMIs.add(msgObj.id);\n        state.messagesCallback(msgObj.data);\n      }\n    });\n    return PROMISE_RESOLVED_VOID;\n  });\n}\n\nexport function close(channelState) {\n  channelState.closed = true;\n  channelState.db.close();\n}\nexport function postMessage(channelState, messageJson) {\n  channelState.writeBlockPromise = channelState.writeBlockPromise.then(function () {\n    return writeMessage(channelState.db, channelState.uuid, messageJson);\n  }).then(function () {\n    if (randomInt(0, 10) === 0) {\n      /* await (do not await) */\n      cleanOldMessages(channelState.db, channelState.options.idb.ttl);\n    }\n  });\n  return channelState.writeBlockPromise;\n}\nexport function onMessage(channelState, fn, time) {\n  channelState.messagesCallbackTime = time;\n  channelState.messagesCallback = fn;\n  readNewMessages(channelState);\n}\nexport function canBeUsed() {\n  if (isNode) return false;\n  var idb = getIdb();\n  if (!idb) return false;\n  return true;\n}\nexport function averageResponseTime(options) {\n  return options.idb.fallbackInterval * 2;\n}\nexport default {\n  create: create,\n  close: close,\n  onMessage: onMessage,\n  postMessage: postMessage,\n  canBeUsed: canBeUsed,\n  type: type,\n  averageResponseTime: averageResponseTime,\n  microSeconds: microSeconds\n};","/**\n * A localStorage-only method which uses localstorage and its 'storage'-event\n * This does not work inside of webworkers because they have no access to locastorage\n * This is basically implemented to support IE9 or your grandmothers toaster.\n * @link https://caniuse.com/#feat=namevalue-storage\n * @link https://caniuse.com/#feat=indexeddb\n */\nimport { ObliviousSet } from 'oblivious-set';\nimport { fillOptionsWithDefaults } from '../options';\nimport { sleep, randomToken, microSeconds as micro, isNode } from '../util';\nexport var microSeconds = micro;\nvar KEY_PREFIX = 'pubkey.broadcastChannel-';\nexport var type = 'localstorage';\n/**\n * copied from crosstab\n * @link https://github.com/tejacques/crosstab/blob/master/src/crosstab.js#L32\n */\n\nexport function getLocalStorage() {\n  var localStorage;\n  if (typeof window === 'undefined') return null;\n\n  try {\n    localStorage = window.localStorage;\n    localStorage = window['ie8-eventlistener/storage'] || window.localStorage;\n  } catch (e) {// New versions of Firefox throw a Security exception\n    // if cookies are disabled. See\n    // https://bugzilla.mozilla.org/show_bug.cgi?id=1028153\n  }\n\n  return localStorage;\n}\nexport function storageKey(channelName) {\n  return KEY_PREFIX + channelName;\n}\n/**\n* writes the new message to the storage\n* and fires the storage-event so other readers can find it\n*/\n\nexport function postMessage(channelState, messageJson) {\n  return new Promise(function (res) {\n    sleep().then(function () {\n      var key = storageKey(channelState.channelName);\n      var writeObj = {\n        token: randomToken(),\n        time: new Date().getTime(),\n        data: messageJson,\n        uuid: channelState.uuid\n      };\n      var value = JSON.stringify(writeObj);\n      getLocalStorage().setItem(key, value);\n      /**\n       * StorageEvent does not fire the 'storage' event\n       * in the window that changes the state of the local storage.\n       * So we fire it manually\n       */\n\n      var ev = document.createEvent('Event');\n      ev.initEvent('storage', true, true);\n      ev.key = key;\n      ev.newValue = value;\n      window.dispatchEvent(ev);\n      res();\n    });\n  });\n}\nexport function addStorageEventListener(channelName, fn) {\n  var key = storageKey(channelName);\n\n  var listener = function listener(ev) {\n    if (ev.key === key) {\n      fn(JSON.parse(ev.newValue));\n    }\n  };\n\n  window.addEventListener('storage', listener);\n  return listener;\n}\nexport function removeStorageEventListener(listener) {\n  window.removeEventListener('storage', listener);\n}\nexport function create(channelName, options) {\n  options = fillOptionsWithDefaults(options);\n\n  if (!canBeUsed()) {\n    throw new Error('BroadcastChannel: localstorage cannot be used');\n  }\n\n  var uuid = randomToken();\n  /**\n   * eMIs\n   * contains all messages that have been emitted before\n   * @type {ObliviousSet}\n   */\n\n  var eMIs = new ObliviousSet(options.localstorage.removeTimeout);\n  var state = {\n    channelName: channelName,\n    uuid: uuid,\n    eMIs: eMIs // emittedMessagesIds\n\n  };\n  state.listener = addStorageEventListener(channelName, function (msgObj) {\n    if (!state.messagesCallback) return; // no listener\n\n    if (msgObj.uuid === uuid) return; // own message\n\n    if (!msgObj.token || eMIs.has(msgObj.token)) return; // already emitted\n\n    if (msgObj.data.time && msgObj.data.time < state.messagesCallbackTime) return; // too old\n\n    eMIs.add(msgObj.token);\n    state.messagesCallback(msgObj.data);\n  });\n  return state;\n}\nexport function close(channelState) {\n  removeStorageEventListener(channelState.listener);\n}\nexport function onMessage(channelState, fn, time) {\n  channelState.messagesCallbackTime = time;\n  channelState.messagesCallback = fn;\n}\nexport function canBeUsed() {\n  if (isNode) return false;\n  var ls = getLocalStorage();\n  if (!ls) return false;\n\n  try {\n    var key = '__broadcastchannel_check';\n    ls.setItem(key, 'works');\n    ls.removeItem(key);\n  } catch (e) {\n    // Safari 10 in private mode will not allow write access to local\n    // storage and fail with a QuotaExceededError. See\n    // https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API#Private_Browsing_Incognito_modes\n    return false;\n  }\n\n  return true;\n}\nexport function averageResponseTime() {\n  var defaultTime = 120;\n  var userAgent = navigator.userAgent.toLowerCase();\n\n  if (userAgent.includes('safari') && !userAgent.includes('chrome')) {\n    // safari is much slower so this time is higher\n    return defaultTime * 2;\n  }\n\n  return defaultTime;\n}\nexport default {\n  create: create,\n  close: close,\n  onMessage: onMessage,\n  postMessage: postMessage,\n  canBeUsed: canBeUsed,\n  type: type,\n  averageResponseTime: averageResponseTime,\n  microSeconds: microSeconds\n};","import { microSeconds as micro } from '../util';\nexport var microSeconds = micro;\nexport var type = 'simulate';\nvar SIMULATE_CHANNELS = new Set();\nexport function create(channelName) {\n  var state = {\n    name: channelName,\n    messagesCallback: null\n  };\n  SIMULATE_CHANNELS.add(state);\n  return state;\n}\nexport function close(channelState) {\n  SIMULATE_CHANNELS[\"delete\"](channelState);\n}\nexport function postMessage(channelState, messageJson) {\n  return new Promise(function (res) {\n    return setTimeout(function () {\n      var channelArray = Array.from(SIMULATE_CHANNELS);\n      channelArray.filter(function (channel) {\n        return channel.name === channelState.name;\n      }).filter(function (channel) {\n        return channel !== channelState;\n      }).filter(function (channel) {\n        return !!channel.messagesCallback;\n      }).forEach(function (channel) {\n        return channel.messagesCallback(messageJson);\n      });\n      res();\n    }, 5);\n  });\n}\nexport function onMessage(channelState, fn) {\n  channelState.messagesCallback = fn;\n}\nexport function canBeUsed() {\n  return true;\n}\nexport function averageResponseTime() {\n  return 5;\n}\nexport default {\n  create: create,\n  close: close,\n  onMessage: onMessage,\n  postMessage: postMessage,\n  canBeUsed: canBeUsed,\n  type: type,\n  averageResponseTime: averageResponseTime,\n  microSeconds: microSeconds\n};","import NativeMethod from './methods/native.js';\nimport IndexeDbMethod from './methods/indexed-db.js';\nimport LocalstorageMethod from './methods/localstorage.js';\nimport SimulateMethod from './methods/simulate.js'; // the line below will be removed from es5/browser builds\n\n\nimport { isNode } from './util'; // order is important\n\nvar METHODS = [NativeMethod, // fastest\nIndexeDbMethod, LocalstorageMethod];\nexport function chooseMethod(options) {\n  var chooseMethods = [].concat(options.methods, METHODS).filter(Boolean); // the line below will be removed from es5/browser builds\n\n\n\n  if (options.type) {\n    if (options.type === 'simulate') {\n      // only use simulate-method if directly chosen\n      return SimulateMethod;\n    }\n\n    var ret = chooseMethods.find(function (m) {\n      return m.type === options.type;\n    });\n    if (!ret) throw new Error('method-type ' + options.type + ' not found');else return ret;\n  }\n  /**\n   * if no webworker support is needed,\n   * remove idb from the list so that localstorage is been chosen\n   */\n\n\n  if (!options.webWorkerSupport && !isNode) {\n    chooseMethods = chooseMethods.filter(function (m) {\n      return m.type !== 'idb';\n    });\n  }\n\n  var useMethod = chooseMethods.find(function (method) {\n    return method.canBeUsed();\n  });\n  if (!useMethod) throw new Error(\"No useable method found in \" + JSON.stringify(METHODS.map(function (m) {\n    return m.type;\n  })));else return useMethod;\n}","import { isPromise, PROMISE_RESOLVED_FALSE, PROMISE_RESOLVED_VOID } from './util.js';\nimport { chooseMethod } from './method-chooser.js';\nimport { fillOptionsWithDefaults } from './options.js';\n/**\n * Contains all open channels,\n * used in tests to ensure everything is closed.\n */\n\nexport var OPEN_BROADCAST_CHANNELS = new Set();\nvar lastId = 0;\nexport var BroadcastChannel = function BroadcastChannel(name, options) {\n  // identifier of the channel to debug stuff\n  this.id = lastId++;\n  OPEN_BROADCAST_CHANNELS.add(this);\n  this.name = name;\n\n  if (ENFORCED_OPTIONS) {\n    options = ENFORCED_OPTIONS;\n  }\n\n  this.options = fillOptionsWithDefaults(options);\n  this.method = chooseMethod(this.options); // isListening\n\n  this._iL = false;\n  /**\n   * _onMessageListener\n   * setting onmessage twice,\n   * will overwrite the first listener\n   */\n\n  this._onML = null;\n  /**\n   * _addEventListeners\n   */\n\n  this._addEL = {\n    message: [],\n    internal: []\n  };\n  /**\n   * Unsend message promises\n   * where the sending is still in progress\n   * @type {Set<Promise>}\n   */\n\n  this._uMP = new Set();\n  /**\n   * _beforeClose\n   * array of promises that will be awaited\n   * before the channel is closed\n   */\n\n  this._befC = [];\n  /**\n   * _preparePromise\n   */\n\n  this._prepP = null;\n\n  _prepareChannel(this);\n}; // STATICS\n\n/**\n * used to identify if someone overwrites\n * window.BroadcastChannel with this\n * See methods/native.js\n */\n\nBroadcastChannel._pubkey = true;\n/**\n * clears the tmp-folder if is node\n * @return {Promise<boolean>} true if has run, false if not node\n */\n\nexport function clearNodeFolder(options) {\n  options = fillOptionsWithDefaults(options);\n  var method = chooseMethod(options);\n\n  if (method.type === 'node') {\n    return method.clearNodeFolder().then(function () {\n      return true;\n    });\n  } else {\n    return PROMISE_RESOLVED_FALSE;\n  }\n}\n/**\n * if set, this method is enforced,\n * no mather what the options are\n */\n\nvar ENFORCED_OPTIONS;\nexport function enforceOptions(options) {\n  ENFORCED_OPTIONS = options;\n} // PROTOTYPE\n\nBroadcastChannel.prototype = {\n  postMessage: function postMessage(msg) {\n    if (this.closed) {\n      throw new Error('BroadcastChannel.postMessage(): ' + 'Cannot post message after channel has closed ' +\n      /**\n       * In the past when this error appeared, it was realy hard to debug.\n       * So now we log the msg together with the error so it at least\n       * gives some clue about where in your application this happens.\n       */\n      JSON.stringify(msg));\n    }\n\n    return _post(this, 'message', msg);\n  },\n  postInternal: function postInternal(msg) {\n    return _post(this, 'internal', msg);\n  },\n\n  set onmessage(fn) {\n    var time = this.method.microSeconds();\n    var listenObj = {\n      time: time,\n      fn: fn\n    };\n\n    _removeListenerObject(this, 'message', this._onML);\n\n    if (fn && typeof fn === 'function') {\n      this._onML = listenObj;\n\n      _addListenerObject(this, 'message', listenObj);\n    } else {\n      this._onML = null;\n    }\n  },\n\n  addEventListener: function addEventListener(type, fn) {\n    var time = this.method.microSeconds();\n    var listenObj = {\n      time: time,\n      fn: fn\n    };\n\n    _addListenerObject(this, type, listenObj);\n  },\n  removeEventListener: function removeEventListener(type, fn) {\n    var obj = this._addEL[type].find(function (obj) {\n      return obj.fn === fn;\n    });\n\n    _removeListenerObject(this, type, obj);\n  },\n  close: function close() {\n    var _this = this;\n\n    if (this.closed) {\n      return;\n    }\n\n    OPEN_BROADCAST_CHANNELS[\"delete\"](this);\n    this.closed = true;\n    var awaitPrepare = this._prepP ? this._prepP : PROMISE_RESOLVED_VOID;\n    this._onML = null;\n    this._addEL.message = [];\n    return awaitPrepare // wait until all current sending are processed\n    .then(function () {\n      return Promise.all(Array.from(_this._uMP));\n    }) // run before-close hooks\n    .then(function () {\n      return Promise.all(_this._befC.map(function (fn) {\n        return fn();\n      }));\n    }) // close the channel\n    .then(function () {\n      return _this.method.close(_this._state);\n    });\n  },\n\n  get type() {\n    return this.method.type;\n  },\n\n  get isClosed() {\n    return this.closed;\n  }\n\n};\n/**\n * Post a message over the channel\n * @returns {Promise} that resolved when the message sending is done\n */\n\nfunction _post(broadcastChannel, type, msg) {\n  var time = broadcastChannel.method.microSeconds();\n  var msgObj = {\n    time: time,\n    type: type,\n    data: msg\n  };\n  var awaitPrepare = broadcastChannel._prepP ? broadcastChannel._prepP : PROMISE_RESOLVED_VOID;\n  return awaitPrepare.then(function () {\n    var sendPromise = broadcastChannel.method.postMessage(broadcastChannel._state, msgObj); // add/remove to unsend messages list\n\n    broadcastChannel._uMP.add(sendPromise);\n\n    sendPromise[\"catch\"]().then(function () {\n      return broadcastChannel._uMP[\"delete\"](sendPromise);\n    });\n    return sendPromise;\n  });\n}\n\nfunction _prepareChannel(channel) {\n  var maybePromise = channel.method.create(channel.name, channel.options);\n\n  if (isPromise(maybePromise)) {\n    channel._prepP = maybePromise;\n    maybePromise.then(function (s) {\n      // used in tests to simulate slow runtime\n\n      /*if (channel.options.prepareDelay) {\n           await new Promise(res => setTimeout(res, this.options.prepareDelay));\n      }*/\n      channel._state = s;\n    });\n  } else {\n    channel._state = maybePromise;\n  }\n}\n\nfunction _hasMessageListeners(channel) {\n  if (channel._addEL.message.length > 0) return true;\n  if (channel._addEL.internal.length > 0) return true;\n  return false;\n}\n\nfunction _addListenerObject(channel, type, obj) {\n  channel._addEL[type].push(obj);\n\n  _startListening(channel);\n}\n\nfunction _removeListenerObject(channel, type, obj) {\n  channel._addEL[type] = channel._addEL[type].filter(function (o) {\n    return o !== obj;\n  });\n\n  _stopListening(channel);\n}\n\nfunction _startListening(channel) {\n  if (!channel._iL && _hasMessageListeners(channel)) {\n    // someone is listening, start subscribing\n    var listenerFn = function listenerFn(msgObj) {\n      channel._addEL[msgObj.type].forEach(function (listenerObject) {\n        /**\n         * Getting the current time in JavaScript has no good precision.\n         * So instead of only listening to events that happend 'after' the listener\n         * was added, we also listen to events that happended 100ms before it.\n         * This ensures that when another process, like a WebWorker, sends events\n         * we do not miss them out because their timestamp is a bit off compared to the main process.\n         * Not doing this would make messages missing when we send data directly after subscribing and awaiting a response.\n         * @link https://johnresig.com/blog/accuracy-of-javascript-time/\n         */\n        var hundredMsInMicro = 100 * 1000;\n        var minMessageTime = listenerObject.time - hundredMsInMicro;\n\n        if (msgObj.time >= minMessageTime) {\n          listenerObject.fn(msgObj.data);\n        }\n      });\n    };\n\n    var time = channel.method.microSeconds();\n\n    if (channel._prepP) {\n      channel._prepP.then(function () {\n        channel._iL = true;\n        channel.method.onMessage(channel._state, listenerFn, time);\n      });\n    } else {\n      channel._iL = true;\n      channel.method.onMessage(channel._state, listenerFn, time);\n    }\n  }\n}\n\nfunction _stopListening(channel) {\n  if (channel._iL && !_hasMessageListeners(channel)) {\n    // noone is listening, stop subscribing\n    channel._iL = false;\n    var time = channel.method.microSeconds();\n    channel.method.onMessage(channel._state, null, time);\n  }\n}","import { sleep, randomToken, PROMISE_RESOLVED_VOID, PROMISE_RESOLVED_TRUE } from './util.js';\nimport { add as unloadAdd } from 'unload';\n\nvar LeaderElection = function LeaderElection(broadcastChannel, options) {\n  var _this = this;\n\n  this.broadcastChannel = broadcastChannel;\n  this._options = options;\n  this.isLeader = false;\n  this.hasLeader = false;\n  this.isDead = false;\n  this.token = randomToken();\n  /**\n   * Apply Queue,\n   * used to ensure we do not run applyOnce()\n   * in parallel.\n   */\n\n  this._aplQ = PROMISE_RESOLVED_VOID; // amount of unfinished applyOnce() calls\n\n  this._aplQC = 0; // things to clean up\n\n  this._unl = []; // _unloads\n\n  this._lstns = []; // _listeners\n\n  this._dpL = function () {}; // onduplicate listener\n\n\n  this._dpLC = false; // true when onduplicate called\n\n  /**\n   * Even when the own instance is not applying,\n   * we still listen to messages to ensure the hasLeader flag\n   * is set correctly.\n   */\n\n  var hasLeaderListener = function hasLeaderListener(msg) {\n    if (msg.context === 'leader') {\n      if (msg.action === 'death') {\n        _this.hasLeader = false;\n      }\n\n      if (msg.action === 'tell') {\n        _this.hasLeader = true;\n      }\n    }\n  };\n\n  this.broadcastChannel.addEventListener('internal', hasLeaderListener);\n\n  this._lstns.push(hasLeaderListener);\n};\n\nLeaderElection.prototype = {\n  /**\n   * Returns true if the instance is leader,\n   * false if not.\n   * @async\n   */\n  applyOnce: function applyOnce( // true if the applyOnce() call came from the fallbackInterval cycle\n  isFromFallbackInterval) {\n    var _this2 = this;\n\n    if (this.isLeader) {\n      return sleep(0, true);\n    }\n\n    if (this.isDead) {\n      return sleep(0, false);\n    }\n    /**\n     * Already applying more then once,\n     * -> wait for the apply queue to be finished.\n     */\n\n\n    if (this._aplQC > 1) {\n      return this._aplQ;\n    }\n    /**\n     * Add a new apply-run\n     */\n\n\n    var applyRun = function applyRun() {\n      /**\n       * Optimization shortcuts.\n       * Directly return if a previous run\n       * has already elected a leader.\n       */\n      if (_this2.isLeader) {\n        return PROMISE_RESOLVED_TRUE;\n      }\n\n      var stopCriteria = false;\n      var stopCriteriaPromiseResolve;\n      /**\n       * Resolves when a stop criteria is reached.\n       * Uses as a performance shortcut so we do not\n       * have to await the responseTime when it is already clear\n       * that the election failed.\n       */\n\n      var stopCriteriaPromise = new Promise(function (res) {\n        stopCriteriaPromiseResolve = function stopCriteriaPromiseResolve() {\n          stopCriteria = true;\n          res();\n        };\n      });\n      var recieved = [];\n\n      var handleMessage = function handleMessage(msg) {\n        if (msg.context === 'leader' && msg.token != _this2.token) {\n          recieved.push(msg);\n\n          if (msg.action === 'apply') {\n            // other is applying\n            if (msg.token > _this2.token) {\n              /**\n               * other has higher token\n               * -> stop applying and let other become leader.\n               */\n              stopCriteriaPromiseResolve();\n            }\n          }\n\n          if (msg.action === 'tell') {\n            // other is already leader\n            stopCriteriaPromiseResolve();\n            _this2.hasLeader = true;\n          }\n        }\n      };\n\n      _this2.broadcastChannel.addEventListener('internal', handleMessage);\n      /**\n       * If the applyOnce() call came from the fallbackInterval,\n       * we can assume that the election runs in the background and\n       * not critical process is waiting for it.\n       * When this is true, we give the other intances\n       * more time to answer to messages in the election cycle.\n       * This makes it less likely to elect duplicate leaders.\n       * But also it takes longer which is not a problem because we anyway\n       * run in the background.\n       */\n\n\n      var waitForAnswerTime = isFromFallbackInterval ? _this2._options.responseTime * 4 : _this2._options.responseTime;\n\n      var applyPromise = _sendMessage(_this2, 'apply') // send out that this one is applying\n      .then(function () {\n        return Promise.race([sleep(waitForAnswerTime), stopCriteriaPromise.then(function () {\n          return Promise.reject(new Error());\n        })]);\n      }) // send again in case another instance was just created\n      .then(function () {\n        return _sendMessage(_this2, 'apply');\n      }) // let others time to respond\n      .then(function () {\n        return Promise.race([sleep(waitForAnswerTime), stopCriteriaPromise.then(function () {\n          return Promise.reject(new Error());\n        })]);\n      })[\"catch\"](function () {}).then(function () {\n        _this2.broadcastChannel.removeEventListener('internal', handleMessage);\n\n        if (!stopCriteria) {\n          // no stop criteria -> own is leader\n          return beLeader(_this2).then(function () {\n            return true;\n          });\n        } else {\n          // other is leader\n          return false;\n        }\n      });\n\n      return applyPromise;\n    };\n\n    this._aplQC = this._aplQC + 1;\n    this._aplQ = this._aplQ.then(function () {\n      return applyRun();\n    }).then(function () {\n      _this2._aplQC = _this2._aplQC - 1;\n    });\n    return this._aplQ.then(function () {\n      return _this2.isLeader;\n    });\n  },\n  awaitLeadership: function awaitLeadership() {\n    if (\n    /* _awaitLeadershipPromise */\n    !this._aLP) {\n      this._aLP = _awaitLeadershipOnce(this);\n    }\n\n    return this._aLP;\n  },\n\n  set onduplicate(fn) {\n    this._dpL = fn;\n  },\n\n  die: function die() {\n    var _this3 = this;\n\n    this._lstns.forEach(function (listener) {\n      return _this3.broadcastChannel.removeEventListener('internal', listener);\n    });\n\n    this._lstns = [];\n\n    this._unl.forEach(function (uFn) {\n      return uFn.remove();\n    });\n\n    this._unl = [];\n\n    if (this.isLeader) {\n      this.hasLeader = false;\n      this.isLeader = false;\n    }\n\n    this.isDead = true;\n    return _sendMessage(this, 'death');\n  }\n};\n/**\n * @param leaderElector {LeaderElector}\n */\n\nfunction _awaitLeadershipOnce(leaderElector) {\n  if (leaderElector.isLeader) {\n    return PROMISE_RESOLVED_VOID;\n  }\n\n  return new Promise(function (res) {\n    var resolved = false;\n\n    function finish() {\n      if (resolved) {\n        return;\n      }\n\n      resolved = true;\n      leaderElector.broadcastChannel.removeEventListener('internal', whenDeathListener);\n      res(true);\n    } // try once now\n\n\n    leaderElector.applyOnce().then(function () {\n      if (leaderElector.isLeader) {\n        finish();\n      }\n    });\n    /**\n     * Try on fallbackInterval\n     * @recursive\n     */\n\n    var tryOnFallBack = function tryOnFallBack() {\n      return sleep(leaderElector._options.fallbackInterval).then(function () {\n        if (leaderElector.isDead || resolved) {\n          return;\n        }\n\n        if (leaderElector.isLeader) {\n          finish();\n        } else {\n          return leaderElector.applyOnce(true).then(function () {\n            if (leaderElector.isLeader) {\n              finish();\n            } else {\n              tryOnFallBack();\n            }\n          });\n        }\n      });\n    };\n\n    tryOnFallBack(); // try when other leader dies\n\n    var whenDeathListener = function whenDeathListener(msg) {\n      if (msg.context === 'leader' && msg.action === 'death') {\n        leaderElector.hasLeader = false;\n        leaderElector.applyOnce().then(function () {\n          if (leaderElector.isLeader) {\n            finish();\n          }\n        });\n      }\n    };\n\n    leaderElector.broadcastChannel.addEventListener('internal', whenDeathListener);\n\n    leaderElector._lstns.push(whenDeathListener);\n  });\n}\n/**\n * sends and internal message over the broadcast-channel\n */\n\n\nfunction _sendMessage(leaderElector, action) {\n  var msgJson = {\n    context: 'leader',\n    action: action,\n    token: leaderElector.token\n  };\n  return leaderElector.broadcastChannel.postInternal(msgJson);\n}\n\nexport function beLeader(leaderElector) {\n  leaderElector.isLeader = true;\n  leaderElector.hasLeader = true;\n  var unloadFn = unloadAdd(function () {\n    return leaderElector.die();\n  });\n\n  leaderElector._unl.push(unloadFn);\n\n  var isLeaderListener = function isLeaderListener(msg) {\n    if (msg.context === 'leader' && msg.action === 'apply') {\n      _sendMessage(leaderElector, 'tell');\n    }\n\n    if (msg.context === 'leader' && msg.action === 'tell' && !leaderElector._dpLC) {\n      /**\n       * another instance is also leader!\n       * This can happen on rare events\n       * like when the CPU is at 100% for long time\n       * or the tabs are open very long and the browser throttles them.\n       * @link https://github.com/pubkey/broadcast-channel/issues/414\n       * @link https://github.com/pubkey/broadcast-channel/issues/385\n       */\n      leaderElector._dpLC = true;\n\n      leaderElector._dpL(); // message the lib user so the app can handle the problem\n\n\n      _sendMessage(leaderElector, 'tell'); // ensure other leader also knows the problem\n\n    }\n  };\n\n  leaderElector.broadcastChannel.addEventListener('internal', isLeaderListener);\n\n  leaderElector._lstns.push(isLeaderListener);\n\n  return _sendMessage(leaderElector, 'tell');\n}\n\nfunction fillOptionsWithDefaults(options, channel) {\n  if (!options) options = {};\n  options = JSON.parse(JSON.stringify(options));\n\n  if (!options.fallbackInterval) {\n    options.fallbackInterval = 3000;\n  }\n\n  if (!options.responseTime) {\n    options.responseTime = channel.method.averageResponseTime(channel.options);\n  }\n\n  return options;\n}\n\nexport function createLeaderElection(channel, options) {\n  if (channel._leaderElector) {\n    throw new Error('BroadcastChannel already has a leader-elector');\n  }\n\n  options = fillOptionsWithDefaults(options, channel);\n  var elector = new LeaderElection(channel, options);\n\n  channel._befC.push(function () {\n    return elector.die();\n  });\n\n  channel._leaderElector = elector;\n  return elector;\n}","import { createLokiLocalState, RxStorageInstanceLoki } from './rx-storage-instance-loki';\nimport lokijs, { Collection } from 'lokijs';\nimport type {\n    LokiDatabaseSettings,\n    LokiDatabaseState,\n    LokiLocalDatabaseState,\n    LokiRemoteResponseBroadcastMessage,\n    MangoQuery,\n    MangoQuerySortDirection,\n    MangoQuerySortPart,\n    RxDocumentData,\n    RxJsonSchema\n} from '../../types';\nimport {\n    add as unloadAdd, AddReturn\n} from 'unload';\nimport { ensureNotFalsy, flatClone, promiseWait, randomCouchString } from '../../util';\nimport { LokiSaveQueue } from './loki-save-queue';\nimport type { DeterministicSortComparator } from 'event-reduce-js';\nimport { newRxError } from '../../rx-error';\nimport {\n    BroadcastChannel,\n    createLeaderElection,\n    LeaderElector,\n    OnMessageHandler\n} from 'broadcast-channel';\nimport type { RxStorageLoki } from './rx-storage-lokijs';\n\nexport const CHANGES_COLLECTION_SUFFIX = '-rxdb-changes';\nexport const LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE = 'rxdb-lokijs-remote-request';\nexport const LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE = 'rxdb-lokijs-remote-request-key-object';\n\n\n/**\n * Loki attaches a $loki property to all data\n * which must be removed before returning the data back to RxDB.\n */\nexport function stripLokiKey<T>(docData: RxDocumentData<T> & { $loki?: number; }): T {\n    if (!docData.$loki) {\n        return docData;\n    }\n    const cloned = flatClone(docData);\n\n    /**\n     * In RxDB version 12.0.0,\n     * we introduced the _meta field that already contains the last write time.\n     * To be backwards compatible, we have to move the $lastWriteAt to the _meta field.\n     */\n    if ((cloned as any).$lastWriteAt) {\n        cloned._meta = {\n            lwt: (cloned as any).$lastWriteAt\n        };\n        delete (cloned as any).$lastWriteAt;\n    }\n\n    delete cloned.$loki;\n    return cloned;\n}\n\n/**\n * Used to check in tests if all instances have been cleaned up.\n */\nexport const OPEN_LOKIJS_STORAGE_INSTANCES: Set<RxStorageInstanceLoki<any>> = new Set();\n\n\nexport const LOKIJS_COLLECTION_DEFAULT_OPTIONS: Partial<CollectionOptions<any>> = {\n    disableChangesApi: true,\n    disableMeta: true,\n    disableDeltaChangesApi: true,\n    disableFreeze: true,\n    // TODO use 'immutable' like WatermelonDB does it\n    cloneMethod: 'shallow-assign',\n    clone: false,\n    transactional: false,\n    autoupdate: false\n}\n\nconst LOKI_DATABASE_STATE_BY_NAME: Map<string, Promise<LokiDatabaseState>> = new Map();\nexport function getLokiDatabase(\n    databaseName: string,\n    databaseSettings: LokiDatabaseSettings\n): Promise<LokiDatabaseState> {\n    let databaseState: Promise<LokiDatabaseState> | undefined = LOKI_DATABASE_STATE_BY_NAME.get(databaseName);\n    if (!databaseState) {\n        /**\n         * We assume that as soon as an adapter is passed,\n         * the database has to be persistend.\n         */\n        const hasPersistence: boolean = !!databaseSettings.adapter;\n        databaseState = (async () => {\n\n            let persistenceMethod = hasPersistence ? 'adapter' : 'memory';\n            if (databaseSettings.persistenceMethod) {\n                persistenceMethod = databaseSettings.persistenceMethod;\n            }\n            const useSettings = Object.assign(\n                // defaults\n                {\n                    autoload: hasPersistence,\n                    persistenceMethod,\n                    verbose: true\n                },\n                databaseSettings,\n                // overwrites\n                {\n                    /**\n                     * RxDB uses its custom load and save handling\n                     * so we disable the LokiJS save/load handlers.\n                     */\n                    autoload: false,\n                    autosave: false,\n                    throttledSaves: false\n                }\n            );\n            const database = new lokijs(\n                databaseName + '.db',\n                flatClone(useSettings)\n            );\n            const lokiSaveQueue = new LokiSaveQueue(\n                database,\n                useSettings\n            );\n\n            /**\n             * Wait until all data is loaded from persistence adapter.\n             * Wrap the loading into the saveQueue to ensure that when many\n             * collections are created at the same time, the load-calls do not interfere\n             * with each other and cause error logs.\n             */\n            if (hasPersistence) {\n                const loadDatabasePromise = new Promise<void>((res, rej) => {\n                    database.loadDatabase({}, (err) => {\n                        if (useSettings.autoloadCallback) {\n                            useSettings.autoloadCallback(err);\n                        }\n                        err ? rej(err) : res();\n                    });\n                });\n                lokiSaveQueue.saveQueue = lokiSaveQueue.saveQueue.then(() => loadDatabasePromise);\n                await loadDatabasePromise;\n            }\n\n            /**\n             * Autosave database on process end\n             */\n            const unloads: AddReturn[] = [];\n            if (hasPersistence) {\n                unloads.push(\n                    unloadAdd(() => lokiSaveQueue.run())\n                );\n            }\n\n            const state: LokiDatabaseState = {\n                database,\n                databaseSettings: useSettings,\n                saveQueue: lokiSaveQueue,\n                collections: {},\n                unloads\n            };\n\n            return state;\n        })();\n        LOKI_DATABASE_STATE_BY_NAME.set(databaseName, databaseState);\n    }\n    return databaseState;\n}\n\nexport async function closeLokiCollections(\n    databaseName: string,\n    collections: Collection[]\n) {\n    const databaseState = await LOKI_DATABASE_STATE_BY_NAME.get(databaseName);\n    if (!databaseState) {\n        // already closed\n        return;\n    }\n    await databaseState.saveQueue.run();\n    collections.forEach(collection => {\n        const collectionName = collection.name;\n        delete databaseState.collections[collectionName];\n    });\n    if (Object.keys(databaseState.collections).length === 0) {\n        // all collections closed -> also close database\n        LOKI_DATABASE_STATE_BY_NAME.delete(databaseName);\n        databaseState.unloads.forEach(u => u.remove());\n        await new Promise<void>((res, rej) => {\n            databaseState.database.close(err => {\n                err ? rej(err) : res();\n            });\n        });\n    }\n}\n\n/**\n * This function is at lokijs-helper\n * because we need it in multiple places.\n */\nexport function getLokiSortComparator<RxDocType>(\n    _schema: RxJsonSchema<RxDocumentData<RxDocType>>,\n    query: MangoQuery<RxDocType>\n): DeterministicSortComparator<RxDocType> {\n    if (!query.sort) {\n        throw newRxError('SNH', { query });\n    }\n    const sortOptions: MangoQuerySortPart<RxDocType>[] = query.sort;\n\n    const fun: DeterministicSortComparator<RxDocType> = (a: RxDocType, b: RxDocType) => {\n        let compareResult: number = 0; // 1 | -1\n        sortOptions.find(sortPart => {\n            const fieldName: string = Object.keys(sortPart)[0];\n            const direction: MangoQuerySortDirection = Object.values(sortPart)[0];\n            const directionMultiplier = direction === 'asc' ? 1 : -1;\n            const valueA: any = (a as any)[fieldName];\n            const valueB: any = (b as any)[fieldName];\n            if (valueA === valueB) {\n                return false;\n            } else {\n                if (valueA > valueB) {\n                    compareResult = 1 * directionMultiplier;\n                    return true;\n                } else {\n                    compareResult = -1 * directionMultiplier;\n                    return true;\n                }\n            }\n        });\n\n        /**\n         * Two different objects should never have the same sort position.\n         * We ensure this by having the unique primaryKey in the sort params\n         * which is added by RxDB if not existing yet.\n         */\n        if (!compareResult) {\n            throw newRxError('SNH', { args: { query, a, b } });\n        }\n\n        return compareResult as any;\n    }\n    return fun;\n}\n\n\nexport function getLokiLeaderElector(\n    storage: RxStorageLoki,\n    databaseName: string\n): LeaderElector {\n    let electorState = storage.leaderElectorByLokiDbName.get(databaseName);\n    if (!electorState) {\n        const channelName = 'rxdb-lokijs-' + databaseName;\n        const channel = new BroadcastChannel(channelName);\n        const elector = createLeaderElection(channel);\n        electorState = {\n            leaderElector: elector,\n            intancesCount: 1\n        }\n        storage.leaderElectorByLokiDbName.set(databaseName, electorState);\n    } else {\n        electorState.intancesCount = electorState.intancesCount + 1;\n    }\n    return electorState.leaderElector;\n}\n\nexport function removeLokiLeaderElectorReference(\n    storage: RxStorageLoki,\n    databaseName: string\n) {\n    const electorState = storage.leaderElectorByLokiDbName.get(databaseName);\n    if (electorState) {\n        electorState.intancesCount = electorState.intancesCount - 1;\n        if (electorState.intancesCount === 0) {\n            electorState.leaderElector.broadcastChannel.close();\n            storage.leaderElectorByLokiDbName.delete(databaseName);\n        }\n    }\n}\n\n/**\n * For multi-instance usage, we send requests to the RxStorage\n * to the current leading instance over the BroadcastChannel.\n */\nexport async function requestRemoteInstance(\n    instance: RxStorageInstanceLoki<any>,\n    operation: string,\n    params: any[]\n): Promise<any | any[]> {\n    const isRxStorageInstanceLoki = typeof (instance as any).query === 'function';\n    const messageType = isRxStorageInstanceLoki ? LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE : LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE;\n\n    const leaderElector = ensureNotFalsy(instance.internals.leaderElector);\n    await waitUntilHasLeader(leaderElector);\n    const broadcastChannel = leaderElector.broadcastChannel;\n\n    type WinningPromise = {\n        retry: boolean,\n        result?: any;\n        error?: any;\n    }\n\n    let whenDeathListener: OnMessageHandler<any>;\n    const leaderDeadPromise = new Promise<WinningPromise>(res => {\n        whenDeathListener = (msg: any) => {\n            if (msg.context === 'leader' && msg.action === 'death') {\n                res({\n                    retry: true\n                });\n            }\n        };\n        broadcastChannel.addEventListener('internal', whenDeathListener);\n    });\n    const requestId = randomCouchString(12);\n    let responseListener: OnMessageHandler<any>;\n    const responsePromise = new Promise<WinningPromise>((res, _rej) => {\n        responseListener = (msg: any) => {\n            if (\n                msg.type === messageType &&\n                msg.response === true &&\n                msg.requestId === requestId\n            ) {\n                if (msg.isError) {\n                    res({\n                        retry: false,\n                        error: msg.result\n                    });\n                } else {\n                    res({\n                        retry: false,\n                        result: msg.result\n                    });\n                }\n            }\n        };\n        broadcastChannel.addEventListener('message', responseListener);\n    });\n\n    // send out the request to the other instance\n    broadcastChannel.postMessage({\n        response: false,\n        type: messageType,\n        operation,\n        params,\n        requestId,\n        databaseName: instance.databaseName,\n        collectionName: instance.collectionName\n    });\n\n\n    return Promise.race([\n        leaderDeadPromise,\n        responsePromise\n    ]).then(firstResolved => {\n\n        // clean up listeners\n        broadcastChannel.removeEventListener('message', responseListener);\n        broadcastChannel.removeEventListener('internal', whenDeathListener);\n\n        if (firstResolved.retry) {\n            /**\n             * The leader died while a remote request was running\n             * we re-run the whole operation.\n             * We cannot just re-run requestRemoteInstance()\n             * because the current instance might be the new leader now\n             * and then we have to use the local state instead of requesting the remote.\n             */\n            return (instance as any)[operation](...params);\n        } else {\n            if (firstResolved.error) {\n                throw firstResolved.error;\n            } else {\n                return firstResolved.result;\n            }\n        }\n    });\n}\n\n/**\n * Handles a request that came from a remote instance via requestRemoteInstance()\n * Runs the requested operation over the local db instance and sends back the result.\n */\nexport async function handleRemoteRequest(\n    instance: RxStorageInstanceLoki<any>,\n    msg: any\n) {\n    if (\n        msg.type === LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE &&\n        msg.requestId &&\n        msg.databaseName === instance.databaseName &&\n        msg.collectionName === instance.collectionName &&\n        !msg.response\n    ) {\n        const operation = (msg as any).operation;\n        const params = (msg as any).params;\n        let result: any;\n        let isError = false;\n        try {\n            result = await (instance as any)[operation](...params);\n        } catch (err) {\n            isError = true;\n            result = err;\n        }\n        const response: LokiRemoteResponseBroadcastMessage = {\n            response: true,\n            requestId: msg.requestId,\n            databaseName: instance.databaseName,\n            collectionName: instance.collectionName,\n            result,\n            isError,\n            type: msg.type\n        };\n        ensureNotFalsy(instance.internals.leaderElector).broadcastChannel.postMessage(response);\n    }\n}\n\n\nexport async function waitUntilHasLeader(leaderElector: LeaderElector) {\n    while (\n        !leaderElector.hasLeader\n    ) {\n        await leaderElector.applyOnce();\n        await promiseWait(0);\n    }\n}\n\n/**\n * If the local state must be used, that one is returned.\n * Returns false if a remote instance must be used.\n */\nexport async function mustUseLocalState(\n    instance: RxStorageInstanceLoki<any>\n): Promise<LokiLocalDatabaseState | false> {\n    if (instance.closed) {\n        /**\n         * If this happens, it means that RxDB made a call to an already closed storage instance.\n         * This must never happen because when RxDB closes a collection or database,\n         * all tasks must be cleared so that no more calls are made the the storage.\n         */\n        throw newRxError('SNH', {\n            args: {\n                instanceClosed: instance.closed,\n                databaseName: instance.databaseName,\n                collectionName: instance.collectionName\n            }\n        });\n    }\n\n\n    if (instance.internals.localState) {\n        return instance.internals.localState;\n    }\n    const leaderElector = ensureNotFalsy(instance.internals.leaderElector);\n    await waitUntilHasLeader(leaderElector);\n\n    /**\n     * It might already have a localState after the applying\n     * because another subtask also called mustUSeLocalState()\n     */\n    if (instance.internals.localState) {\n        return instance.internals.localState;\n    }\n\n    if (\n        leaderElector.isLeader &&\n        !instance.internals.localState\n    ) {\n        // own is leader, use local instance\n        instance.internals.localState = createLokiLocalState<any>({\n            databaseName: instance.databaseName,\n            collectionName: instance.collectionName,\n            options: instance.options,\n            schema: (instance as RxStorageInstanceLoki<any>).schema,\n            multiInstance: instance.internals.leaderElector ? true : false\n        }, instance.databaseSettings);\n        return ensureNotFalsy(instance.internals.localState);\n    } else {\n        // other is leader, send message to remote leading instance\n        return false;\n    }\n}\n","import objectPath from 'object-path';\nimport { newRxError } from './rx-error';\nimport type {\n    CompositePrimaryKey,\n    JsonSchema,\n    PrimaryKey,\n    RxDocumentData,\n    RxJsonSchema,\n    StringKeys\n} from './types';\nimport { clone, flatClone, isMaybeReadonlyArray, RX_META_LWT_MINIMUM, sortObject, trimDots } from './util';\n\n/**\n * Helper function to create a valid RxJsonSchema\n * with a given version.\n */\nexport function getPseudoSchemaForVersion<T = any>(\n    version: number,\n    primaryKey: StringKeys<T>\n): RxJsonSchema<RxDocumentData<T>> {\n    const pseudoSchema: RxJsonSchema<RxDocumentData<T>> = fillWithDefaultSettings({\n        version,\n        type: 'object',\n        primaryKey: primaryKey as any,\n        properties: {\n            [primaryKey]: {\n                type: 'string',\n                maxLength: 100\n            }\n        } as any,\n        required: [primaryKey]\n    });\n    return pseudoSchema;\n}\n\n/**\n * Returns the sub-schema for a given path\n */\nexport function getSchemaByObjectPath<T = any>(\n    rxJsonSchema: RxJsonSchema<T>,\n    path: keyof T | string\n): JsonSchema {\n    let usePath: string = path as string;\n    usePath = usePath.replace(/\\./g, '.properties.');\n    usePath = 'properties.' + usePath;\n    usePath = trimDots(usePath);\n\n    const ret = objectPath.get(rxJsonSchema, usePath);\n    return ret;\n}\n\nexport function fillPrimaryKey<T>(\n    primaryPath: keyof T,\n    jsonSchema: RxJsonSchema<T>,\n    documentData: RxDocumentData<T>\n): RxDocumentData<T> {\n    const cloned = flatClone(documentData);\n    const newPrimary = getComposedPrimaryKeyOfDocumentData<T>(\n        jsonSchema,\n        documentData\n    );\n    const existingPrimary: string | undefined = documentData[primaryPath] as any;\n    if (\n        existingPrimary &&\n        existingPrimary !== newPrimary\n    ) {\n        throw newRxError(\n            'DOC19',\n            {\n                args: {\n                    documentData,\n                    existingPrimary,\n                    newPrimary,\n                },\n                schema: jsonSchema\n            });\n    }\n\n    (cloned as any)[primaryPath] = newPrimary;\n    return cloned;\n}\n\nexport function getPrimaryFieldOfPrimaryKey<RxDocType>(\n    primaryKey: PrimaryKey<RxDocType>\n): keyof RxDocType {\n    if (typeof primaryKey === 'string') {\n        return primaryKey as any;\n    } else {\n        return (primaryKey as CompositePrimaryKey<RxDocType>).key;\n    }\n}\n\n/**\n * Returns the composed primaryKey of a document by its data.\n */\nexport function getComposedPrimaryKeyOfDocumentData<RxDocType>(\n    jsonSchema: RxJsonSchema<RxDocType> | RxJsonSchema<RxDocumentData<RxDocType>>,\n    documentData: Partial<RxDocType>\n): string {\n    if (typeof jsonSchema.primaryKey === 'string') {\n        return (documentData as any)[jsonSchema.primaryKey];\n    }\n\n    const compositePrimary: CompositePrimaryKey<RxDocType> = jsonSchema.primaryKey as any;\n    return compositePrimary.fields.map(field => {\n        const value = objectPath.get(documentData as any, field as string);\n        if (typeof value === 'undefined') {\n            throw newRxError('DOC18', { args: { field, documentData } });\n        }\n        return value;\n    }).join(compositePrimary.separator);\n}\n\n\n/**\n * Normalize the RxJsonSchema.\n * We need this to ensure everything is set up properly\n * and we have the same hash on schemas that represent the same value but\n * have different json.\n * \n * - Orders the schemas attributes by alphabetical order\n * - Adds the primaryKey to all indexes that do not contain the primaryKey\n * - We need this for determinstic sort order on all queries, which is required for event-reduce to work.\n *\n * @return RxJsonSchema - ordered and filled\n */\nexport function normalizeRxJsonSchema<T>(jsonSchema: RxJsonSchema<T>): RxJsonSchema<T> {\n    // TODO do we need the deep clone() here?\n    const normalizedSchema: RxJsonSchema<T> = sortObject(clone(jsonSchema));\n\n    // indexes must NOT be sorted because sort order is important here.\n    if (jsonSchema.indexes) {\n        normalizedSchema.indexes = Array.from(jsonSchema.indexes);\n    }\n\n    // primaryKey.fields must NOT be sorted because sort order is important here.\n    if (\n        typeof normalizedSchema.primaryKey === 'object' &&\n        typeof jsonSchema.primaryKey === 'object'\n    ) {\n        normalizedSchema.primaryKey.fields = jsonSchema.primaryKey.fields;\n    }\n\n\n\n    return normalizedSchema;\n}\n\n/**\n * fills the schema-json with default-settings\n * @return cloned schemaObj\n */\nexport function fillWithDefaultSettings<T = any>(\n    schemaObj: RxJsonSchema<T>\n): RxJsonSchema<RxDocumentData<T>> {\n    schemaObj = flatClone(schemaObj);\n    const primaryPath: string = getPrimaryFieldOfPrimaryKey(schemaObj.primaryKey) as string;\n    schemaObj.properties = flatClone(schemaObj.properties);\n\n    // additionalProperties is always false\n    schemaObj.additionalProperties = false;\n\n    // fill with key-compression-state ()\n    if (!schemaObj.hasOwnProperty('keyCompression')) {\n        schemaObj.keyCompression = false;\n    }\n\n    // indexes must be array\n    schemaObj.indexes = schemaObj.indexes ? schemaObj.indexes.slice(0) : [];\n\n    // required must be array\n    schemaObj.required = schemaObj.required ? schemaObj.required.slice(0) : [];\n\n    // encrypted must be array\n    schemaObj.encrypted = schemaObj.encrypted ? schemaObj.encrypted.slice(0) : [];\n\n    /**\n     * TODO we should not need to add the internal fields to the schema.\n     * Better remove the fields before validation.\n     */\n    // add _rev\n    (schemaObj.properties as any)._rev = {\n        type: 'string',\n        minLength: 1\n    };\n\n    // add attachments\n    (schemaObj.properties as any)._attachments = {\n        type: 'object'\n    };\n\n    // add deleted flag\n    (schemaObj.properties as any)._deleted = {\n        type: 'boolean'\n    };\n\n    // add meta property\n    (schemaObj.properties as any)._meta = RX_META_SCHEMA;\n\n    /**\n     * meta fields are all required\n     */\n    schemaObj.required = schemaObj.required ? schemaObj.required.slice(0) : [];\n    (schemaObj.required as string[]).push('_deleted');\n    (schemaObj.required as string[]).push('_rev');\n    (schemaObj.required as string[]).push('_meta');\n    (schemaObj.required as string[]).push('_attachments');\n\n    // final fields are always required\n    const finalFields = getFinalFields(schemaObj);\n    schemaObj.required = schemaObj.required\n        .concat(finalFields as any)\n        .filter((field: string) => !field.includes('.'))\n        .filter((elem: any, pos: any, arr: any) => arr.indexOf(elem) === pos); // unique;\n\n    // version is 0 by default\n    schemaObj.version = schemaObj.version || 0;\n\n    /**\n     * Append primary key to indexes that do not contain the primaryKey.\n     * All indexes must have the primaryKey to ensure a deterministic sort order.\n     */\n    if (schemaObj.indexes) {\n        schemaObj.indexes = schemaObj.indexes.map(index => {\n            const arIndex = isMaybeReadonlyArray(index) ? index.slice(0) : [index];\n            if (!arIndex.includes(primaryPath)) {\n                const modifiedIndex = arIndex.slice(0);\n                modifiedIndex.push(primaryPath);\n                return modifiedIndex;\n            }\n            return arIndex;\n        });\n    }\n\n    return schemaObj as any;\n}\n\n\nexport const RX_META_SCHEMA: JsonSchema = {\n    type: 'object',\n    properties: {\n        /**\n         * The last-write time.\n         * Unix time in milliseconds.\n         */\n        lwt: {\n            type: 'number',\n            /**\n             * We use 1 as minimum so that the value is never falsy.\n             */\n            minimum: RX_META_LWT_MINIMUM,\n            maximum: 1000000000000000,\n            multipleOf: 1\n        }\n    },\n    /**\n     * Additional properties are allowed\n     * and can be used by plugins to set various flags.\n     */\n    additionalProperties: true as any,\n    required: [\n        'lwt'\n    ]\n}\n\n\n/**\n * returns the final-fields of the schema\n * @return field-names of the final-fields\n */\nexport function getFinalFields<T = any>(\n    jsonSchema: RxJsonSchema<T>\n): string[] {\n    const ret = Object.keys(jsonSchema.properties)\n        .filter(key => (jsonSchema as any).properties[key].final);\n\n    // primary is also final\n    const primaryPath = getPrimaryFieldOfPrimaryKey(jsonSchema.primaryKey);\n    ret.push(primaryPath as string);\n\n    // fields of composite primary are final\n    if (typeof jsonSchema.primaryKey !== 'string') {\n        (jsonSchema.primaryKey as CompositePrimaryKey<T>).fields\n            .forEach(field => ret.push(field as string));\n    }\n\n    return ret;\n}\n","/**\n * Helper functions for accessing the RxStorage instances.\n */\n\nimport type { ChangeEvent } from 'event-reduce-js';\nimport { map } from 'rxjs/operators';\nimport { runPluginHooks } from './hooks';\nimport { overwritable } from './overwritable';\nimport { newRxError } from './rx-error';\nimport { fillPrimaryKey, getPrimaryFieldOfPrimaryKey } from './rx-schema-helper';\nimport type {\n    BulkWriteRow,\n    EventBulk,\n    RxChangeEvent,\n    RxCollection,\n    RxDatabase,\n    RxDocumentData,\n    RxDocumentWriteData,\n    RxJsonSchema,\n    RxStorageBulkWriteError,\n    RxStorageBulkWriteResponse,\n    RxStorageChangeEvent,\n    RxStorageInstance,\n    RxStorageStatics\n} from './types';\nimport {\n    createRevision,\n    firstPropertyValueOfObject,\n    flatClone,\n    now,\n    randomCouchString\n} from './util';\n\nexport const INTERNAL_STORAGE_NAME = '_rxdb_internal';\nexport const RX_DATABASE_LOCAL_DOCS_STORAGE_NAME = 'rxdatabase_storage_local';\n\n/**\n * Returns all non-deleted documents\n * of the storage.\n */\nexport async function getAllDocuments<RxDocType>(\n    primaryKey: keyof RxDocType,\n    storageInstance: RxStorageInstance<RxDocType, any, any>\n): Promise<RxDocumentData<RxDocType>[]> {\n    const storage = storageInstance.storage;\n    const getAllQueryPrepared = storage.statics.prepareQuery(\n        storageInstance.schema,\n        {\n            selector: {},\n            sort: [{ [primaryKey]: 'asc' } as any],\n            skip: 0\n        }\n    );\n    const queryResult = await storageInstance.query(getAllQueryPrepared);\n    const allDocs = queryResult.documents;\n    return allDocs;\n}\n\nexport async function getSingleDocument<RxDocType>(\n    storageInstance: RxStorageInstance<RxDocType, any, any>,\n    documentId: string\n): Promise<RxDocumentData<RxDocType> | null> {\n    const results = await storageInstance.findDocumentsById([documentId], false);\n    const doc = results[documentId];\n    if (doc) {\n        return doc;\n    } else {\n        return null;\n    }\n}\n\n/**\n * Writes a single document,\n * throws RxStorageBulkWriteError on failure\n */\nexport async function writeSingle<RxDocType>(\n    instance: RxStorageInstance<RxDocType, any, any>,\n    writeRow: BulkWriteRow<RxDocType>\n): Promise<RxDocumentData<RxDocType>> {\n    const writeResult = await instance.bulkWrite(\n        [writeRow]\n    );\n\n    if (Object.keys(writeResult.error).length > 0) {\n        const error = firstPropertyValueOfObject(writeResult.error);\n        throw error;\n    } else {\n        const ret = firstPropertyValueOfObject(writeResult.success);\n        return ret;\n    }\n}\n\nexport function storageChangeEventToRxChangeEvent<DocType>(\n    isLocal: boolean,\n    rxStorageChangeEvent: RxStorageChangeEvent<DocType>,\n    rxCollection?: RxCollection,\n): RxChangeEvent<DocType> {\n    let documentData;\n    if (rxStorageChangeEvent.change.operation !== 'DELETE') {\n        documentData = rxStorageChangeEvent.change.doc;\n    }\n    let previousDocumentData;\n    if (rxStorageChangeEvent.change.operation !== 'INSERT') {\n        previousDocumentData = rxStorageChangeEvent.change.previous;\n    }\n    const ret: RxChangeEvent<DocType> = {\n        eventId: rxStorageChangeEvent.eventId,\n        documentId: rxStorageChangeEvent.documentId,\n        collectionName: rxCollection ? rxCollection.name : undefined,\n        startTime: rxStorageChangeEvent.startTime,\n        endTime: rxStorageChangeEvent.endTime,\n        isLocal,\n        operation: rxStorageChangeEvent.change.operation,\n        documentData: overwritable.deepFreezeWhenDevMode(documentData as any),\n        previousDocumentData: overwritable.deepFreezeWhenDevMode(previousDocumentData as any)\n    };\n    return ret;\n}\n\nexport function throwIfIsStorageWriteError<RxDocType>(\n    collection: RxCollection<RxDocType>,\n    documentId: string,\n    writeData: RxDocumentWriteData<RxDocType> | RxDocType,\n    error: RxStorageBulkWriteError<RxDocType> | undefined\n) {\n    if (error) {\n        if (error.status === 409) {\n            throw newRxError('COL19', {\n                collection: collection.name,\n                id: documentId,\n                pouchDbError: error,\n                data: writeData\n            });\n        } else {\n            throw error;\n        }\n    }\n}\n\n/**\n * Analyzes a list of BulkWriteRows and determines\n * which documents must be inserted, updated or deleted\n * and which events must be emitted and which documents cause a conflict\n * and must not be written.\n * Used as helper inside of some RxStorage implementations.\n */\nexport function categorizeBulkWriteRows<RxDocType>(\n    storageInstance: RxStorageInstance<any, any, any>,\n    primaryPath: keyof RxDocType,\n    /**\n     * Current state of the documents\n     * inside of the storage. Used to determine\n     * which writes cause conflicts.\n     */\n    docsInDb: Map<RxDocumentData<RxDocType>[keyof RxDocType], RxDocumentData<RxDocType>>,\n    /**\n     * The write rows that are passed to\n     * RxStorageInstance().bulkWrite().\n     */\n    bulkWriteRows: BulkWriteRow<RxDocType>[]\n): {\n    bulkInsertDocs: BulkWriteRow<RxDocType>[];\n    bulkUpdateDocs: BulkWriteRow<RxDocType>[];\n    /**\n     * Ids of all documents that are changed\n     * and so their change must be written into the\n     * sequences table so that they can be fetched via\n     * RxStorageInstance().getChangedDocumentsSince().\n     */\n    changedDocumentIds: RxDocumentData<RxDocType>[keyof RxDocType][];\n    errors: RxStorageBulkWriteError<RxDocType>[];\n    eventBulk: EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>>;\n} {\n    const bulkInsertDocs: BulkWriteRow<RxDocType>[] = [];\n    const bulkUpdateDocs: BulkWriteRow<RxDocType>[] = [];\n    const errors: RxStorageBulkWriteError<RxDocType>[] = [];\n    const changedDocumentIds: RxDocumentData<RxDocType>[keyof RxDocType][] = [];\n    const eventBulk: EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>> = {\n        id: randomCouchString(10),\n        events: []\n    };\n\n\n    const startTime = now();\n    bulkWriteRows.forEach(writeRow => {\n        const id = writeRow.document[primaryPath];\n        const documentInDb = docsInDb.get(id);\n\n        if (!documentInDb) {\n            /**\n             * It is possible to insert already deleted documents,\n             * this can happen on replication.\n             */\n            const insertedIsDeleted = writeRow.document._deleted ? true : false;\n            bulkInsertDocs.push(writeRow);\n            if (!insertedIsDeleted) {\n                changedDocumentIds.push(id);\n                eventBulk.events.push({\n                    eventId: getUniqueDeterministicEventKey(storageInstance, primaryPath as any, writeRow),\n                    documentId: id as any,\n                    change: {\n                        doc: writeRow.document,\n                        id: id as any,\n                        operation: 'INSERT',\n                        previous: null\n                    },\n                    startTime,\n                    endTime: now()\n                });\n            }\n        } else {\n            // update existing document\n            const revInDb: string = documentInDb._rev;\n\n            // inserting a deleted document is possible\n            // without sending the previous data.\n            if (!writeRow.previous && documentInDb._deleted) {\n                writeRow.previous = documentInDb;\n            }\n\n            /**\n             * Check for conflict\n             */\n            if (\n                (\n                    !writeRow.previous &&\n                    !documentInDb._deleted\n                ) ||\n                (\n                    !!writeRow.previous &&\n                    revInDb !== writeRow.previous._rev\n                )\n            ) {\n                // is conflict error\n                const err: RxStorageBulkWriteError<RxDocType> = {\n                    isError: true,\n                    status: 409,\n                    documentId: id as any,\n                    writeRow: writeRow,\n                    documentInDb\n                };\n                errors.push(err);\n                return;\n            }\n\n            bulkUpdateDocs.push(writeRow);\n            let change: ChangeEvent<RxDocumentData<RxDocType>> | null = null;\n            const writeDoc = writeRow.document;\n            if (writeRow.previous && writeRow.previous._deleted && !writeDoc._deleted) {\n                change = {\n                    id: id as any,\n                    operation: 'INSERT',\n                    previous: null,\n                    doc: writeDoc\n                };\n            } else if (writeRow.previous && !writeRow.previous._deleted && !writeDoc._deleted) {\n                change = {\n                    id: id as any,\n                    operation: 'UPDATE',\n                    previous: writeRow.previous,\n                    doc: writeDoc\n                };\n            } else if (writeRow.previous && !writeRow.previous._deleted && writeDoc._deleted) {\n                change = {\n                    id: id as any,\n                    operation: 'DELETE',\n                    previous: writeRow.previous,\n                    doc: null\n                };\n            }\n            if (!change) {\n                if (\n                    writeRow.previous && writeRow.previous._deleted &&\n                    writeRow.document._deleted\n                ) {\n                    // deleted doc got overwritten with other deleted doc -> do not send an event\n                } else {\n                    throw newRxError('SNH', { args: { writeRow } });\n                }\n            } else {\n                changedDocumentIds.push(id);\n                eventBulk.events.push({\n                    eventId: getUniqueDeterministicEventKey(storageInstance, primaryPath as any, writeRow),\n                    documentId: id as any,\n                    change,\n                    startTime,\n                    endTime: now()\n                });\n            }\n        }\n    });\n\n\n    return {\n        bulkInsertDocs,\n        bulkUpdateDocs,\n        errors,\n        changedDocumentIds,\n        eventBulk\n    };\n}\n\n/**\n * Each event is labeled with the id\n * to make it easy to filter out duplicates.\n */\nexport function getUniqueDeterministicEventKey(\n    storageInstance: RxStorageInstance<any, any, any>,\n    primaryPath: string,\n    writeRow: BulkWriteRow<any>\n): string {\n    const docId = writeRow.document[primaryPath];\n    const binaryValues: boolean[] = [\n        !!writeRow.previous,\n        (writeRow.previous && writeRow.previous._deleted),\n        !!writeRow.document._deleted\n    ];\n    const binary = binaryValues.map(v => v ? '1' : '0').join('');\n    const eventKey = storageInstance.databaseName + '|' + storageInstance.collectionName + '|' + docId + '|' + '|' + binary + '|' + writeRow.document._rev;\n    return eventKey;\n}\n\n\nexport function hashAttachmentData(\n    attachmentBase64String: string,\n    storageStatics: RxStorageStatics\n): Promise<string> {\n    return storageStatics.hash(atob(attachmentBase64String));\n}\nexport function getAttachmentSize(\n    attachmentBase64String: string\n): number {\n    return atob(attachmentBase64String).length;\n}\n\n/**\n * Wraps the normal storageInstance of a RxCollection\n * to ensure that all access is properly using the hooks\n * and other data transformations and also ensure that database.lockedRun()\n * is used properly.\n */\n\nexport function getWrappedStorageInstance<RxDocType, Internals, InstanceCreationOptions>(\n    database: RxDatabase<{}, Internals, InstanceCreationOptions>,\n    storageInstance: RxStorageInstance<RxDocType, Internals, InstanceCreationOptions>,\n    /**\n     * The original RxJsonSchema\n     * before it was mutated by hooks.\n     */\n    rxJsonSchema: RxJsonSchema<RxDocumentData<RxDocType>>\n): RxStorageInstance<RxDocType, Internals, InstanceCreationOptions> {\n    overwritable.deepFreezeWhenDevMode(rxJsonSchema);\n    const primaryPath = getPrimaryFieldOfPrimaryKey(rxJsonSchema.primaryKey);\n\n    function transformDocumentDataFromRxDBToRxStorage(\n        writeRow: BulkWriteRow<RxDocType>\n    ) {\n        let data = flatClone(writeRow.document);\n        data._meta = flatClone(data._meta);\n\n        // ensure primary key has not been changed\n        if (overwritable.isDevMode()) {\n            data = fillPrimaryKey(\n                primaryPath,\n                rxJsonSchema,\n                data as any\n            );\n        }\n\n        data._meta.lwt = now();\n        const hookParams = {\n            database,\n            primaryPath,\n            schema: rxJsonSchema,\n            doc: data\n        };\n\n\n        /**\n         * Run the hooks once for the previous doc,\n         * once for the new write data\n         */\n        let previous = writeRow.previous;\n        if (previous) {\n            hookParams.doc = previous;\n            runPluginHooks('preWriteToStorageInstance', hookParams);\n            previous = hookParams.doc;\n        }\n\n        hookParams.doc = data;\n        runPluginHooks('preWriteToStorageInstance', hookParams);\n        data = hookParams.doc;\n\n        /**\n         * Update the revision after the hooks have run.\n         * Do not update the revision if no previous is given,\n         * because the migration plugin must be able to do an insert\n         * with a pre-created revision.\n         */\n        if (\n            writeRow.previous ||\n            !data._rev\n        ) {\n            data._rev = createRevision(data, writeRow.previous);\n        }\n\n        return {\n            document: data,\n            previous\n        };\n    }\n\n    function transformDocumentDataFromRxStorageToRxDB(\n        data: any\n    ): any {\n        const hookParams = {\n            database,\n            primaryPath,\n            schema: rxJsonSchema,\n            doc: data\n        };\n\n        runPluginHooks('postReadFromInstance', hookParams);\n        return hookParams.doc;\n    }\n\n    const ret: RxStorageInstance<RxDocType, Internals, InstanceCreationOptions> = {\n        storage: storageInstance.storage,\n        schema: storageInstance.schema,\n        internals: storageInstance.internals,\n        collectionName: storageInstance.collectionName,\n        databaseName: storageInstance.databaseName,\n        options: storageInstance.options,\n        bulkWrite(rows: BulkWriteRow<RxDocType>[]) {\n            const toStorageWriteRows: BulkWriteRow<RxDocType>[] = rows\n                .map(row => transformDocumentDataFromRxDBToRxStorage(row));\n            return database.lockedRun(\n                () => storageInstance.bulkWrite(\n                    toStorageWriteRows\n                )\n            ).then(writeResult => {\n                const ret: RxStorageBulkWriteResponse<RxDocType> = {\n                    success: {},\n                    error: {}\n                };\n                Object.entries(writeResult.error).forEach(([k, v]) => {\n                    ret.error[k] = v;\n                });\n                Object.entries(writeResult.success).forEach(([k, v]) => {\n                    ret.success[k] = transformDocumentDataFromRxStorageToRxDB(v);\n                });\n\n                return ret;\n            });\n        },\n        query(preparedQuery) {\n            return database.lockedRun(\n                () => storageInstance.query(preparedQuery)\n            ).then(queryResult => {\n                return {\n                    documents: queryResult.documents.map(doc => transformDocumentDataFromRxStorageToRxDB(doc))\n                };\n            });\n        },\n        findDocumentsById(ids, deleted) {\n            return database.lockedRun(\n                () => storageInstance.findDocumentsById(ids, deleted)\n            ).then(findResult => {\n                const ret: { [documentId: string]: RxDocumentData<RxDocType>; } = {};\n                Object.entries(findResult).forEach(([key, doc]) => {\n                    ret[key] = transformDocumentDataFromRxStorageToRxDB(doc);\n                });\n                return ret;\n            });\n        },\n        getAttachmentData(\n            documentId: string,\n            attachmentId: string\n        ) {\n            return database.lockedRun(\n                () => storageInstance.getAttachmentData(documentId, attachmentId)\n            );\n        },\n        getChangedDocumentsSince(limit: number, checkpoint?: any) {\n            return database.lockedRun(\n                () => storageInstance.getChangedDocumentsSince(limit, checkpoint)\n            ).then(result => {\n                return result.map(row => ({\n                    checkpoint: row.checkpoint,\n                    document: transformDocumentDataFromRxStorageToRxDB(row.document)\n                }));\n            });\n        },\n        cleanup(minDeletedTime: number) {\n            return database.lockedRun(\n                () => storageInstance.cleanup(minDeletedTime)\n            );\n        },\n        remove() {\n            return database.lockedRun(\n                () => storageInstance.remove()\n            );\n        },\n        close() {\n            return database.lockedRun(\n                () => storageInstance.close()\n            );\n        },\n        changeStream() {\n            return storageInstance.changeStream().pipe(\n                map(eventBulk => {\n                    const ret: EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>> = {\n                        id: eventBulk.id,\n                        events: eventBulk.events.map(event => {\n                            return {\n                                eventId: event.eventId,\n                                documentId: event.documentId,\n                                endTime: event.endTime,\n                                startTime: event.startTime,\n                                change: {\n                                    id: event.change.id,\n                                    operation: event.change.operation,\n                                    doc: event.change.doc ? transformDocumentDataFromRxStorageToRxDB(event.change.doc) : undefined,\n                                    previous: event.change.previous ? transformDocumentDataFromRxStorageToRxDB(event.change.previous) : undefined\n                                }\n                            }\n\n                        })\n                    };\n                    return ret;\n                })\n            )\n        }\n    };\n    return ret;\n}\n","import {\n    Subject,\n    Observable\n} from 'rxjs';\nimport {\n    flatClone,\n    now,\n    ensureNotFalsy,\n    isMaybeReadonlyArray,\n    getFromMapOrThrow,\n    getSortDocumentsByLastWriteTimeComparator,\n    RX_META_LWT_MINIMUM\n} from '../../util';\nimport { newRxError } from '../../rx-error';\nimport type {\n    RxStorageInstance,\n    LokiSettings,\n    RxStorageChangeEvent,\n    RxDocumentData,\n    BulkWriteRow,\n    RxStorageBulkWriteResponse,\n    RxStorageQueryResult,\n    RxJsonSchema,\n    MangoQuery,\n    LokiStorageInternals,\n    RxStorageInstanceCreationParams,\n    LokiDatabaseSettings,\n    LokiLocalDatabaseState,\n    EventBulk,\n    LokiChangesCheckpoint\n} from '../../types';\nimport {\n    closeLokiCollections,\n    getLokiDatabase,\n    OPEN_LOKIJS_STORAGE_INSTANCES,\n    LOKIJS_COLLECTION_DEFAULT_OPTIONS,\n    stripLokiKey,\n    getLokiSortComparator,\n    getLokiLeaderElector,\n    removeLokiLeaderElectorReference,\n    requestRemoteInstance,\n    mustUseLocalState,\n    handleRemoteRequest\n} from './lokijs-helper';\nimport type {\n    Collection\n} from 'lokijs';\nimport type { RxStorageLoki } from './rx-storage-lokijs';\nimport { getPrimaryFieldOfPrimaryKey } from '../../rx-schema-helper';\nimport { categorizeBulkWriteRows } from '../../rx-storage-helper';\n\nlet instanceId = now();\n\nexport class RxStorageInstanceLoki<RxDocType> implements RxStorageInstance<\n    RxDocType,\n    LokiStorageInternals,\n    LokiSettings\n> {\n\n    public readonly primaryPath: keyof RxDocType;\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>>> = new Subject();\n    private lastChangefeedSequence: number = 0;\n    public readonly instanceId = instanceId++;\n\n    public closed = false;\n\n    constructor(\n        public readonly storage: RxStorageLoki,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<RxDocumentData<RxDocType>>>,\n        public readonly internals: LokiStorageInternals,\n        public readonly options: Readonly<LokiSettings>,\n        public readonly databaseSettings: LokiDatabaseSettings\n    ) {\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey) as any;\n        OPEN_LOKIJS_STORAGE_INSTANCES.add(this);\n        if (this.internals.leaderElector) {\n            this.internals.leaderElector.awaitLeadership().then(() => {\n                // this instance is leader now, so it has to reply to queries from other instances\n                ensureNotFalsy(this.internals.leaderElector).broadcastChannel\n                    .addEventListener('message', async (msg) => handleRemoteRequest(this, msg));\n            });\n        }\n    }\n\n    async bulkWrite(documentWrites: BulkWriteRow<RxDocType>[]): Promise<RxStorageBulkWriteResponse<RxDocType>> {\n        if (documentWrites.length === 0) {\n            throw newRxError('P2', {\n                args: {\n                    documentWrites\n                }\n            });\n        }\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'bulkWrite', [documentWrites]);\n        }\n\n        const ret: RxStorageBulkWriteResponse<RxDocType> = {\n            success: {},\n            error: {}\n        };\n\n        const docsInDb: Map<RxDocumentData<RxDocType>[keyof RxDocType], RxDocumentData<RxDocType>> = new Map();\n        const docsInDbWithLokiKey: Map<\n            RxDocumentData<RxDocType>[keyof RxDocType],\n            RxDocumentData<RxDocType> & { $loki: number; }\n        > = new Map();\n        documentWrites.forEach(writeRow => {\n            const id = writeRow.document[this.primaryPath];\n            const documentInDb = localState.collection.by(this.primaryPath, id);\n            if (documentInDb) {\n                docsInDbWithLokiKey.set(id, documentInDb);\n                docsInDb.set(id, stripLokiKey(documentInDb));\n            }\n        });\n\n        const categorized = categorizeBulkWriteRows<RxDocType>(\n            this,\n            this.primaryPath,\n            docsInDb,\n            documentWrites\n        );\n\n        categorized.bulkInsertDocs.forEach(writeRow => {\n            const docId = writeRow.document[this.primaryPath];\n            localState.collection.insert(flatClone(writeRow.document));\n            ret.success[docId as any] = writeRow.document;\n        });\n        categorized.bulkUpdateDocs.forEach(writeRow => {\n            const docId = writeRow.document[this.primaryPath];\n            const documentInDbWithLokiKey = getFromMapOrThrow(docsInDbWithLokiKey, docId);\n            const writeDoc: any = Object.assign(\n                {},\n                writeRow.document,\n                {\n                    $loki: documentInDbWithLokiKey.$loki\n                }\n            );\n            localState.collection.update(writeDoc);\n            ret.success[docId as any] = writeRow.document;\n        });\n        categorized.errors.forEach(err => {\n            ret.error[err.documentId] = err;\n        });\n        localState.databaseState.saveQueue.addWrite();\n        this.changes$.next(categorized.eventBulk);\n\n        return ret;\n    }\n    async findDocumentsById(ids: string[], deleted: boolean): Promise<{ [documentId: string]: RxDocumentData<RxDocType> }> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'findDocumentsById', [ids, deleted]);\n        }\n\n        const ret: { [documentId: string]: RxDocumentData<RxDocType> } = {};\n        ids.forEach(id => {\n            const documentInDb = localState.collection.by(this.primaryPath, id);\n            if (\n                documentInDb &&\n                (!documentInDb._deleted || deleted)\n            ) {\n                ret[id] = stripLokiKey(documentInDb);\n            }\n        });\n        return ret;\n    }\n    async query(preparedQuery: MangoQuery<RxDocType>): Promise<RxStorageQueryResult<RxDocType>> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'query', [preparedQuery]);\n        }\n\n        let query = localState.collection\n            .chain()\n            .find(preparedQuery.selector);\n\n        if (preparedQuery.sort) {\n            query = query.sort(getLokiSortComparator(this.schema, preparedQuery));\n        }\n\n        /**\n         * Offset must be used before limit in LokiJS\n         * @link https://github.com/techfort/LokiJS/issues/570\n         */\n        if (preparedQuery.skip) {\n            query = query.offset(preparedQuery.skip);\n        }\n\n        if (preparedQuery.limit) {\n            query = query.limit(preparedQuery.limit);\n        }\n\n        const foundDocuments = query.data().map(lokiDoc => stripLokiKey(lokiDoc));\n        return {\n            documents: foundDocuments\n        };\n    }\n    getAttachmentData(_documentId: string, _attachmentId: string): Promise<string> {\n        throw new Error('Attachments are not implemented in the lokijs RxStorage. Make a pull request.');\n    }\n\n\n    async getChangedDocumentsSince(\n        limit: number,\n        checkpoint?: LokiChangesCheckpoint\n    ): Promise<{\n        document: RxDocumentData<RxDocType>;\n        checkpoint: LokiChangesCheckpoint;\n    }[]> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'getChangedDocumentsSince', [limit, checkpoint]);\n        }\n\n        const sinceLwt = checkpoint ? checkpoint.lwt : RX_META_LWT_MINIMUM;\n        const query = localState.collection\n            .chain()\n            .find({\n                '_meta.lwt': {\n                    $gte: sinceLwt\n                }\n            })\n            .sort(getSortDocumentsByLastWriteTimeComparator(this.primaryPath as any));\n        let changedDocs = query.data();\n\n        const first = changedDocs[0];\n        if (\n            checkpoint &&\n            first &&\n            first[this.primaryPath] === checkpoint.id &&\n            first._meta.lwt === checkpoint.lwt\n        ) {\n            changedDocs.shift();\n        }\n\n        changedDocs = changedDocs.slice(0, limit);\n        return changedDocs.map(docData => ({\n            document: stripLokiKey(docData),\n            checkpoint: {\n                id: docData[this.primaryPath] as any,\n                lwt: docData._meta.lwt\n            }\n        }));\n    }\n\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>>> {\n        return this.changes$.asObservable();\n    }\n\n    async cleanup(minimumDeletedTime: number): Promise<boolean> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'cleanup', [minimumDeletedTime]);\n        }\n\n        const deleteAmountPerRun = 10;\n        const maxDeletionTime = now() - minimumDeletedTime;\n        const query = localState.collection\n            .chain()\n            .find({\n                _deleted: true,\n                '_meta.lwt': {\n                    $lt: maxDeletionTime\n                }\n            }).limit(deleteAmountPerRun);\n        const foundDocuments = query.data();\n        if (foundDocuments.length > 0) {\n            localState.collection.remove(foundDocuments);\n            localState.databaseState.saveQueue.addWrite();\n        }\n\n        return foundDocuments.length !== deleteAmountPerRun;\n    }\n\n    async close(): Promise<void> {\n        this.closed = true;\n        this.changes$.complete();\n        OPEN_LOKIJS_STORAGE_INSTANCES.delete(this);\n\n        if (this.internals.localState) {\n            const localState = await this.internals.localState;\n            const dbState = await getLokiDatabase(\n                this.databaseName,\n                this.databaseSettings\n            );\n            await dbState.saveQueue.run();\n            await closeLokiCollections(\n                this.databaseName,\n                [\n                    localState.collection\n                ]\n            );\n        }\n        removeLokiLeaderElectorReference(this.storage, this.databaseName);\n    }\n    async remove(): Promise<void> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'remove', []);\n        }\n        localState.databaseState.database.removeCollection(localState.collection.name);\n        return this.close();\n    }\n}\n\nexport async function createLokiLocalState<RxDocType>(\n    params: RxStorageInstanceCreationParams<RxDocType, LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<LokiLocalDatabaseState> {\n    if (!params.options) {\n        params.options = {};\n    }\n\n    const databaseState = await getLokiDatabase(\n        params.databaseName,\n        databaseSettings\n    );\n\n    /**\n     * Construct loki indexes from RxJsonSchema indexes.\n     * TODO what about compound indexes? Are they possible in lokijs?\n     */\n    const indices: string[] = [];\n    if (params.schema.indexes) {\n        params.schema.indexes.forEach(idx => {\n            if (!isMaybeReadonlyArray(idx)) {\n                indices.push(idx);\n            }\n        });\n    }\n    /**\n     * LokiJS has no concept of custom primary key, they use a number-id that is generated.\n     * To be able to query fast by primary key, we always add an index to the primary.\n     */\n    const primaryKey = getPrimaryFieldOfPrimaryKey(params.schema.primaryKey);\n    indices.push(primaryKey as string);\n\n    const lokiCollectionName = params.collectionName + '-' + params.schema.version;\n    const collectionOptions: Partial<CollectionOptions<RxDocumentData<RxDocType>>> = Object.assign(\n        {},\n        lokiCollectionName,\n        {\n            indices: indices as string[],\n            unique: [primaryKey]\n        } as any,\n        LOKIJS_COLLECTION_DEFAULT_OPTIONS\n    );\n\n    const collection: Collection = databaseState.database.addCollection(\n        lokiCollectionName,\n        collectionOptions as any\n    );\n    databaseState.collections[params.collectionName] = collection;\n    const ret: LokiLocalDatabaseState = {\n        databaseState,\n        collection\n    };\n\n    return ret;\n}\n\n\nexport async function createLokiStorageInstance<RxDocType>(\n    storage: RxStorageLoki,\n    params: RxStorageInstanceCreationParams<RxDocType, LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<RxStorageInstanceLoki<RxDocType>> {\n    const internals: LokiStorageInternals = {};\n\n    if (params.multiInstance) {\n        const leaderElector = getLokiLeaderElector(storage, params.databaseName);\n        internals.leaderElector = leaderElector;\n    } else {\n        // optimisation shortcut, directly create db is non multi instance.\n        internals.localState = createLokiLocalState(params, databaseSettings);\n        await internals.localState;\n    }\n\n    const instance = new RxStorageInstanceLoki(\n        storage,\n        params.databaseName,\n        params.collectionName,\n        params.schema,\n        internals,\n        params.options,\n        databaseSettings\n    );\n\n    /**\n     * Directly create the localState if the db becomes leader.\n     */\n    if (params.multiInstance) {\n        ensureNotFalsy(internals.leaderElector)\n            .awaitLeadership()\n            .then(() => {\n                if (!instance.closed) {\n                    mustUseLocalState(instance)\n                }\n            });\n    }\n\n\n    return instance;\n}\n","var thisAtob = function (str) {\n  return atob(str);\n};\n\nvar thisBtoa = function (str) {\n  return btoa(str);\n};\n\n// Abstracts constructing a Blob object, so it also works in older\n// browsers that don't support the native Blob constructor (e.g.\n// old QtWebKit versions, Android < 4.4).\nfunction createBlob(parts, properties) {\n  /* global BlobBuilder,MSBlobBuilder,MozBlobBuilder,WebKitBlobBuilder */\n  parts = parts || [];\n  properties = properties || {};\n  try {\n    return new Blob(parts, properties);\n  } catch (e) {\n    if (e.name !== \"TypeError\") {\n      throw e;\n    }\n    var Builder = typeof BlobBuilder !== 'undefined' ? BlobBuilder :\n                  typeof MSBlobBuilder !== 'undefined' ? MSBlobBuilder :\n                  typeof MozBlobBuilder !== 'undefined' ? MozBlobBuilder :\n                  WebKitBlobBuilder;\n    var builder = new Builder();\n    for (var i = 0; i < parts.length; i += 1) {\n      builder.append(parts[i]);\n    }\n    return builder.getBlob(properties.type);\n  }\n}\n\n// From http://stackoverflow.com/questions/14967647/ (continues on next line)\n// encode-decode-image-with-base64-breaks-image (2013-04-21)\nfunction binaryStringToArrayBuffer(bin) {\n  var length = bin.length;\n  var buf = new ArrayBuffer(length);\n  var arr = new Uint8Array(buf);\n  for (var i = 0; i < length; i++) {\n    arr[i] = bin.charCodeAt(i);\n  }\n  return buf;\n}\n\nfunction binStringToBluffer(binString, type) {\n  return createBlob([binaryStringToArrayBuffer(binString)], {type: type});\n}\n\nfunction b64ToBluffer(b64, type) {\n  return binStringToBluffer(thisAtob(b64), type);\n}\n\n//Can't find original post, but this is close\n//http://stackoverflow.com/questions/6965107/ (continues on next line)\n//converting-between-strings-and-arraybuffers\nfunction arrayBufferToBinaryString(buffer) {\n  var binary = '';\n  var bytes = new Uint8Array(buffer);\n  var length = bytes.byteLength;\n  for (var i = 0; i < length; i++) {\n    binary += String.fromCharCode(bytes[i]);\n  }\n  return binary;\n}\n\n// shim for browsers that don't support it\nfunction readAsBinaryString(blob, callback) {\n  var reader = new FileReader();\n  var hasBinaryString = typeof reader.readAsBinaryString === 'function';\n  reader.onloadend = function (e) {\n    var result = e.target.result || '';\n    if (hasBinaryString) {\n      return callback(result);\n    }\n    callback(arrayBufferToBinaryString(result));\n  };\n  if (hasBinaryString) {\n    reader.readAsBinaryString(blob);\n  } else {\n    reader.readAsArrayBuffer(blob);\n  }\n}\n\nfunction blobToBinaryString(blobOrBuffer, callback) {\n  readAsBinaryString(blobOrBuffer, function (bin) {\n    callback(bin);\n  });\n}\n\nfunction blobToBase64(blobOrBuffer, callback) {\n  blobToBinaryString(blobOrBuffer, function (base64) {\n    callback(thisBtoa(base64));\n  });\n}\n\n// simplified API. universal browser support is assumed\nfunction readAsArrayBuffer(blob, callback) {\n  var reader = new FileReader();\n  reader.onloadend = function (e) {\n    var result = e.target.result || new ArrayBuffer(0);\n    callback(result);\n  };\n  reader.readAsArrayBuffer(blob);\n}\n\n// this is not used in the browser\nfunction typedBuffer() {\n}\n\nexport { thisAtob as atob, thisBtoa as btoa, b64ToBluffer as base64StringToBlobOrBuffer, binaryStringToArrayBuffer, binStringToBluffer as binaryStringToBlobOrBuffer, createBlob as blob, blobToBase64 as blobOrBufferToBase64, blobToBinaryString as blobOrBufferToBinaryString, readAsArrayBuffer, readAsBinaryString, typedBuffer };\n","import { btoa, readAsArrayBuffer } from 'pouchdb-binary-utils';\nimport Md5 from 'spark-md5';\n\nvar setImmediateShim = self.setImmediate || self.setTimeout;\nvar MD5_CHUNK_SIZE = 32768;\n\nfunction rawToBase64(raw) {\n  return btoa(raw);\n}\n\nfunction sliceBlob(blob, start, end) {\n  if (blob.webkitSlice) {\n    return blob.webkitSlice(start, end);\n  }\n  return blob.slice(start, end);\n}\n\nfunction appendBlob(buffer, blob, start, end, callback) {\n  if (start > 0 || end < blob.size) {\n    // only slice blob if we really need to\n    blob = sliceBlob(blob, start, end);\n  }\n  readAsArrayBuffer(blob, function (arrayBuffer) {\n    buffer.append(arrayBuffer);\n    callback();\n  });\n}\n\nfunction appendString(buffer, string, start, end, callback) {\n  if (start > 0 || end < string.length) {\n    // only create a substring if we really need to\n    string = string.substring(start, end);\n  }\n  buffer.appendBinary(string);\n  callback();\n}\n\nfunction binaryMd5(data, callback) {\n  var inputIsString = typeof data === 'string';\n  var len = inputIsString ? data.length : data.size;\n  var chunkSize = Math.min(MD5_CHUNK_SIZE, len);\n  var chunks = Math.ceil(len / chunkSize);\n  var currentChunk = 0;\n  var buffer = inputIsString ? new Md5() : new Md5.ArrayBuffer();\n\n  var append = inputIsString ? appendString : appendBlob;\n\n  function next() {\n    setImmediateShim(loadNextChunk);\n  }\n\n  function done() {\n    var raw = buffer.end(true);\n    var base64 = rawToBase64(raw);\n    callback(base64);\n    buffer.destroy();\n  }\n\n  function loadNextChunk() {\n    var start = currentChunk * chunkSize;\n    var end = start + chunkSize;\n    currentChunk++;\n    if (currentChunk < chunks) {\n      append(buffer, data, start, end, next);\n    } else {\n      append(buffer, data, start, end, done);\n    }\n  }\n  loadNextChunk();\n}\n\nfunction stringMd5(string) {\n  return Md5.hash(string);\n}\n\nexport { binaryMd5, stringMd5 };\n","import type {\n    DeterministicSortComparator,\n    QueryMatcher\n} from 'event-reduce-js';\nimport lokijs from 'lokijs';\nimport type {\n    LokiDatabaseSettings,\n    LokiSettings,\n    LokiStorageInternals,\n    MangoQuery,\n    RxDocumentData,\n    RxDocumentWriteData,\n    RxJsonSchema,\n    RxStorage,\n    RxStorageInstanceCreationParams,\n    RxStorageStatics\n} from '../../types';\nimport {\n    ensureNotFalsy,\n    flatClone\n} from '../../util';\nimport {\n    createLokiStorageInstance,\n    RxStorageInstanceLoki\n} from './rx-storage-instance-loki';\nimport { getLokiSortComparator } from './lokijs-helper';\nimport type { LeaderElector } from 'broadcast-channel';\n\nimport { binaryMd5 } from 'pouchdb-md5';\n\nexport const RxStorageLokiStatics: RxStorageStatics = {\n\n    hash(data: Buffer | Blob | string): Promise<string> {\n        return new Promise(res => {\n            binaryMd5(data, (digest: string) => {\n                res(digest);\n            });\n        });\n    },\n    hashKey: 'md5',\n    doesBroadcastChangestream() {\n        return false;\n    },\n    prepareQuery<RxDocType>(\n        _schema: RxJsonSchema<RxDocumentData<RxDocType>>,\n        mutateableQuery: MangoQuery<RxDocType>\n    ) {\n        if (Object.keys(ensureNotFalsy(mutateableQuery.selector)).length > 0) {\n            mutateableQuery.selector = {\n                $and: [\n                    {\n                        _deleted: false\n                    },\n                    mutateableQuery.selector\n                ]\n            };\n        } else {\n            mutateableQuery.selector = {\n                _deleted: false\n            };\n        }\n\n        return mutateableQuery;\n    },\n\n\n    getSortComparator<RxDocType>(\n        schema: RxJsonSchema<RxDocumentData<RxDocType>>,\n        query: MangoQuery<RxDocType>\n    ): DeterministicSortComparator<RxDocType> {\n        return getLokiSortComparator(schema, query);\n    },\n\n    /**\n     * Returns a function that determines if a document matches a query selector.\n     * It is important to have the exact same logix as lokijs uses, to be sure\n     * that the event-reduce algorithm works correct.\n     * But LokisJS does not export such a function, the query logic is deep inside of\n     * the Resultset prototype.\n     * Because I am lazy, I do not copy paste and maintain that code.\n     * Instead we create a fake Resultset and apply the prototype method Resultset.prototype.find(),\n     * same with Collection.\n     */\n    getQueryMatcher<RxDocType>(\n        _schema: RxJsonSchema<RxDocType>,\n        query: MangoQuery<RxDocType>\n    ): QueryMatcher<RxDocumentWriteData<RxDocType>> {\n        const fun: QueryMatcher<RxDocumentWriteData<RxDocType>> = (doc: RxDocumentWriteData<RxDocType>) => {\n            if (doc._deleted) {\n                return false;\n            }\n            const docWithResetDeleted = flatClone(doc);\n            docWithResetDeleted._deleted = !!docWithResetDeleted._deleted;\n\n            const fakeCollection = {\n                data: [docWithResetDeleted],\n                binaryIndices: {}\n            };\n            Object.setPrototypeOf(fakeCollection, (lokijs as any).Collection.prototype);\n            const fakeResultSet: any = {\n                collection: fakeCollection\n            };\n            Object.setPrototypeOf(fakeResultSet, (lokijs as any).Resultset.prototype);\n            fakeResultSet.find(query.selector, true);\n\n            const ret = fakeResultSet.filteredrows.length > 0;\n            return ret;\n        }\n        return fun;\n    }\n\n}\n\nexport class RxStorageLoki implements RxStorage<LokiStorageInternals, LokiSettings> {\n    public name = 'lokijs';\n    public statics = RxStorageLokiStatics;\n\n    /**\n     * Create one leader elector by db name.\n     * This is done inside of the storage, not globally\n     * to make it easier to test multi-tab behavior.\n     */\n    public leaderElectorByLokiDbName: Map<string, {\n        leaderElector: LeaderElector,\n        /**\n         * Count the instances that currently use the elector.\n         * If is goes to zero again, the elector can be closed.\n         */\n        intancesCount: number;\n    }> = new Map();\n\n    constructor(\n        public databaseSettings: LokiDatabaseSettings\n    ) { }\n\n    public createStorageInstance<RxDocType>(\n        params: RxStorageInstanceCreationParams<RxDocType, LokiSettings>\n    ): Promise<RxStorageInstanceLoki<RxDocType>> {\n        return createLokiStorageInstance(this, params, this.databaseSettings);\n    }\n}\n\nexport function getRxStorageLoki(\n    databaseSettings: LokiDatabaseSettings = {}\n): RxStorageLoki {\n    const storage = new RxStorageLoki(databaseSettings);\n    return storage;\n}\n","import WorkerContext from \"./dist/worker/index.js\"\n\nexport const expose = WorkerContext.expose\nexport const registerSerializer = WorkerContext.registerSerializer\nexport const Transfer = WorkerContext.Transfer\n","import { getRxStorageLoki } from '../../lokijs';\nimport { wrappedWorkerRxStorage } from '../../worker';\nconst LokiIncrementalIndexedDBAdapter = require('lokijs/src/incremental-indexeddb-adapter');\n\nconst storage = getRxStorageLoki({\n    adapter: new LokiIncrementalIndexedDBAdapter()\n});\nwrappedWorkerRxStorage({\n    storage\n});\n","/**\n * This file contains everything\n * that is supposed to run inside of the worker.\n */\nimport type {\n    BulkWriteRow,\n    EventBulk,\n    RxDocumentData,\n    RxStorage,\n    RxStorageBulkWriteResponse,\n    RxStorageChangeEvent,\n    RxStorageInstanceCreationParams,\n    RxStorageQueryResult\n} from '../../types';\nimport { expose } from 'threads/worker';\nimport { getFromMapOrThrow } from '../../util';\nimport { Observable } from 'rxjs';\n\n\nexport type InWorkerStorage = {\n    createStorageInstance<RxDocType>(\n        params: RxStorageInstanceCreationParams<RxDocType, any>\n    ): Promise<number>;\n    bulkWrite<DocumentData>(\n        instanceId: number,\n        documentWrites: BulkWriteRow<DocumentData>[]\n    ): Promise<RxStorageBulkWriteResponse<DocumentData>>;\n    findDocumentsById<DocumentData>(\n        instanceId: number,\n        ids: string[], deleted: boolean\n    ): Promise<{ [documentId: string]: RxDocumentData<DocumentData> }>;\n    query<DocumentData>(\n        instanceId: number,\n        preparedQuery: any\n    ): Promise<RxStorageQueryResult<DocumentData>>;\n    getAttachmentData(\n        instanceId: number,\n        documentId: string,\n        attachmentId: string\n    ): Promise<string>;\n    getChangedDocumentsSince<RxDocType>(\n        instanceId: number,\n        limit: number,\n        checkpoint: any\n    ): Promise<{\n        document: RxDocumentData<RxDocType>;\n        checkpoint: any;\n    }[]>;\n    changeStream<DocumentData>(\n        instanceById: number\n    ): Observable<EventBulk<RxStorageChangeEvent<RxDocumentData<DocumentData>>>>;\n    cleanup(instanceId: number, minDeletedTime: number): Promise<boolean>;\n    close(instanceId: number): Promise<void>;\n    remove(instanceId: number): Promise<void>;\n}\n\nexport function wrappedWorkerRxStorage<T, D>(\n    args: {\n        storage: RxStorage<T, D>\n    }\n) {\n    let nextId = 0;\n    const instanceById: Map<number, any> = new Map();\n\n    const exposeMe: InWorkerStorage = {\n        /**\n         * RxStorageInstance\n         */\n        async createStorageInstance(params) {\n            const instanceId = nextId++;\n            const instance = await args.storage.createStorageInstance(params);\n            instanceById.set(instanceId, instance);\n            return instanceId;\n        },\n        bulkWrite<DocumentData>(\n            instanceId: number,\n            documentWrites: BulkWriteRow<DocumentData>[]\n        ) {\n            const instance = getFromMapOrThrow(instanceById, instanceId);\n            return instance.bulkWrite(documentWrites);\n        },\n        findDocumentsById<DocumentData>(\n            instanceId: number,\n            ids: string[],\n            deleted: boolean\n        ): Promise<{ [documentId: string]: RxDocumentData<DocumentData> }> {\n            const instance = getFromMapOrThrow(instanceById, instanceId);\n            return instance.findDocumentsById(ids, deleted);\n        },\n        query<DocumentData>(\n            instanceId: number,\n            preparedQuery: any\n        ): Promise<RxStorageQueryResult<DocumentData>> {\n            const instance = getFromMapOrThrow(instanceById, instanceId);\n            return instance.query(preparedQuery);\n        },\n        getAttachmentData(\n            instanceId: number,\n            documentId: string,\n            attachmentId: string\n        ): Promise<string> {\n            const instance = getFromMapOrThrow(instanceById, instanceId);\n            return instance.getAttachmentData(\n                documentId,\n                attachmentId\n            );\n        },\n        getChangedDocumentsSince<RxDocType>(\n            instanceId: number,\n            limit: number,\n            checkpoint: any\n        ): Promise<{\n            document: RxDocumentData<RxDocType>;\n            checkpoint: any;\n        }[]> {\n            const instance = getFromMapOrThrow(instanceById, instanceId);\n            return instance.getChangedDocumentsSince(\n                limit,\n                checkpoint\n            );\n        },\n        changeStream<DocumentData>(\n            instanceId: number\n        ): Observable<EventBulk<RxStorageChangeEvent<RxDocumentData<DocumentData>>>> {\n            const instance = getFromMapOrThrow(instanceById, instanceId);\n            return instance.changeStream();\n        },\n        cleanup(\n            instanceId: number,\n            minDeletedTime: number\n        ) {\n            const instance = getFromMapOrThrow(instanceById, instanceId);\n            return instance.cleanup(minDeletedTime);\n        },\n        close(instanceId: number) {\n            const instance = getFromMapOrThrow(instanceById, instanceId);\n            return instance.close();\n        },\n        remove(instanceId: number) {\n            const instance = getFromMapOrThrow(instanceById, instanceId);\n            return instance.remove();\n        }\n    }\n    expose(exposeMe);\n}\n"],"names":["clone","_instanceof","obj","type","nativeMap","nativeSet","nativePromise","Map","_","Set","Promise","parent","circular","depth","prototype","includeNonEnumerable","allParents","allChildren","useBuffer","Buffer","Infinity","_clone","child","proto","resolve","reject","then","value","err","__isArray","__isRegExp","RegExp","source","__getRegExpFlags","lastIndex","__isDate","Date","getTime","isBuffer","allocUnsafe","length","copy","Error","Object","create","getPrototypeOf","index","indexOf","push","i","forEach","key","keyChild","valueChild","set","entryChild","add","attrs","getOwnPropertyDescriptor","getOwnPropertySymbols","symbols","symbol","descriptor","enumerable","defineProperty","allPropertyNames","getOwnPropertyNames","propertyName","__objToStr","o","toString","call","re","flags","global","ignoreCase","multiline","clonePrototype","c","module","exports","window","process","versions","electron","navigator","userAgent","Symbol","observable","DEBUG","__loki_incremental_idb_debug","IncrementalIndexedDBAdapter","options","this","mode","chunkSize","megachunkCount","idb","_prevLokiVersionId","_prevCollectionVersionIds","getMaxChunkIds","allKeys","maxChunkIds","keySegments","split","collection","chunkId","parseInt","currentMax","lokiChunkVersionId","chunk","JSON","parse","idbVersionId","e","console","error","chunksToMap","chunks","loki","chunkMap","sortChunksInPlace","object","includes","colName","dataChunks","metadata","name","populateLoki","collections","collectionStub","chunkCollection","doc","data","parseChunk","deserializeChunk","segments","collectionName","randomVersionId","Math","random","substring","_getSortKey","sort","a","b","aKey","bKey","createKeyRanges","keys","count","minKey","maxKey","countPerRange","floor","keyRanges","IDBKeyRange","upperBound","lowerBound","bound","idbReq","request","onsuccess","onerror","_getChunk","minId","maxId","ensureId","mid","idIndex","firstDataPosition","max","min","lastDataPosition","firstElement","$loki","lastElement","chunkData","slice","saveDatabase","dbname","getLokiCopy","callback","that","operationInProgress","log","time","updatePrevVersionIds","didOverwrite","tx","transaction","oncomplete","finish","onDidOverwrite","onabort","store","objectStore","performSave","incremental","chunkInfo","_putInChunks","lokiVersionId","collectionVersionIds","collectionInfo","versionId","commit","abort","getAllKeysThenSave","getAllKeys","target","result","get","warn","_initializeIDB","timeEnd","idbStore","savedSize","prepareCollection","dirtyChunks","dirtyIds","lokiId","prepareChunk","serializeChunk","stringify","put","maxChunkId","j","persistedMaxChunkId","k","deletedChunkName","delete","dirty","size","metadataChunk","serializedMetadata","loadDatabase","_getAllChunks","Array","isArray","onError","onSuccess","idbInitInProgress","openRequest","indexedDB","open","onupgradeneeded","db","oldVersion","createObjectStore","keyPath","objectStoreNames","contains","deleteDatabase","onversionchange","versionChangeEvent","close","onblocked","getMegachunks","allChunks","megachunksReceived","processMegachunk","megachunkIndex","keyRange","megachunk","requestMegachunk","getAll","getAllChunks","onFetchStart","success","LokiIndexedAdapter","appname","app","catalog","checkAvailability","LokiCatalog","initializeLokiCatalog","closeDatabase","appName","adapter","getAppKey","id","val","cat","loadKey","dbstring","saveCallback","closeAfterSave","setAppKey","saveKey","deleteAppKey","deleteKey","deleteDatabasePartitions","self","getDatabaseList","str","startsWith","getAppKeys","results","names","idx","getKeyList","getCatalogSummary","oapp","okey","oval","entries","thisDB","deleteObjectStore","autoIncrement","createIndex","unique","usercallback","appkey","lres","getAppKeyById","res","requestPut","evt","singleKeyRange","only","cursor","openCursor","localdata","currObject","continue","hasOwnProperty","deepFreeze","prop","freeze","isFrozen","unFreeze","Utils","copyProperties","src","dest","resolveTransformObject","subObj","params","pname","resolveTransformParams","transform","clonedStep","resolvedTransform","getIn","path","usingDotNotation","undefined","Comparators","aeq","aeqHelper","lt","ltHelper","gt","gtHelper","prop1","prop2","cv1","cv2","t1","t2","Number","equal","sortHelper","desc","compoundeval","properties","obj1","obj2","field","val1","val2","arr","len","dotSubScan","root","paths","fun","extra","poffset","element","pathOffset","valueFound","containsCheckFn","doQueryOp","op","record","p","LokiOps","$eq","$aeq","$ne","$dteq","$gt","$gte","$lt","$lte","$jgt","$jgte","$jlt","$jlte","$between","vals","$jbetween","$in","$inSet","has","$nin","$keyin","$nkeyin","$definedin","$undefinedin","$regex","test","$containsString","$containsNone","$containsAny","checkFn","some","$contains","every","$elemMatch","item","property","filter","$type","$finite","isFinite","$size","$len","$where","$not","$and","$or","$exists","spec","indexedOps","method","cloned","jQuery","extend","constructor","map","assign","cloneObjectArray","objarray","localStorageAvailable","localStorage","LokiEventEmitter","Loki","filename","databaseVersion","engineVersion","autosave","autosaveInterval","autosaveHandle","throttledSaves","persistenceMethod","persistenceAdapter","throttledSavePending","throttledCallbacks","verbose","events","getENV","g","android","NSObject","document","URL","ENV","env","configureOptions","on","clearChanges","LokiMemoryAdapter","hashStore","asyncResponses","asyncTimeout","LokiPartitioningAdapter","dbref","pageIterator","paging","pageSize","delimiter","LokiFsAdapter","fs","LokiLocalStorageAdapter","Resultset","filteredrows","filterInitialized","precompileQuery","operator","DynamicView","rebuildPending","persistent","sortPriority","minRebuildInterval","resultset","resultdata","resultsdirty","cachedresultset","filterPipeline","disableFreeze","sortFunction","sortCriteria","sortCriteriaSimple","sortDirty","Collection","binaryIndices","constraints","exact","uniqueNames","transforms","objType","cachedIndex","cachedBinaryIndex","cachedData","ExactIndex","adaptiveBinaryIndices","transactional","cloneObjects","cloneMethod","asyncListeners","disableMeta","disableChangesApi","disableDeltaChangesApi","autoupdate","serializableIndices","ttl","age","ttlInterval","daemon","setTTL","DynamicViews","changes","indices","TypeError","ensureIndex","observerCallback","changedObjects","change","removeAutoUpdateObserver","update","getChangeDelta","old","getObjectDelta","oldObject","newObject","propertyNames","delta","propertyDelta","flushChanges","getChanges","setChangesApi","enabled","createChange","warning","lokiConsoleWrapper","isDeepProperty","parseBase10","num","parseFloat","sub","average","array","reduce","standardDeviation","values","avg","avgSquareDiff","diff","sqrt","deepProperty","isDeep","pieces","shift","binarySearch","compared","lo","hi","apply","found","BSonSort","KeyValueStore","UniqueIndex","uniqueField","keyMap","lokiMap","exactField","SortedIndex","sortedField","eventName","listener","event","currentEventName","emit","selfArgs","arguments","setTimeout","addListener","removeListener","listeners","splice","getIndexedAdapter","initialConfig","defaultPersistence","persistenceMethods","isIncremental","autoload","autoloadCallback","autosaveDisable","autosaveEnable","autosaveCallback","serializationMethod","destructureDelimiter","clen","databaseCopy","loadJSONObject","retainDirtyFlags","removeNonSerializable","addCollection","loadCollection","getCollection","renameCollection","oldName","newName","listCollections","colls","removeCollection","tmpcol","curcol","getName","serializeReplacer","serialize","serializeDestructured","toJson","sidx","resultlen","dbcopy","reconstruct","partitioned","delimited","partition","serializeCollection","collectionIndex","join","doccount","docidx","resultlines","deserializeDestructured","destructuredSource","cdb","collCount","workarray","collIndex","lineIndex","done","deserializeCollection","pop","loadJSON","serializedDb","dbObject","coll","copyColl","loader","collObj","makeLoader","inflater","collOptions","inflate","addAutoUpdateObserver","colldv","dv","addDynamicView","rematerialize","removeWhereFilters","ensureAllIndexes","autosaveDirty","generateChangesNotification","arrayOfCollectionNames","getCollName","selectedCollections","concat","serializeChanges","collectionNamesArray","saveCount","savecount","lastsave","pageIndex","loadNextPartition","keyname","loadNextPage","dlen","isLastPage","exportDatabase","dirtyPartitions","saveNextPartition","docIndex","saveNextPage","pageLen","cdlen","delimlen","serializedObject","pageBuilder","doneWithPartition","doneWithPage","pageSaveCallback","stat","stats","isFile","readFile","encoding","tmpdbname","writeFile","rename","unlink","getItem","setItem","removeItem","throttledSaveDrain","now","recursiveWait","recursiveWaitLimit","recursiveWaitLimitDuration","started","loadDatabaseInternal","cFun","dbString","parseSuccess","saveDatabaseInternal","cachedDirty","ignoreAutosave","lokiCopy","col","cached","autosaveClearFlags","localCallbacks","unshift","pcb","save","delay","setInterval","clearInterval","reset","toJSON","limit","qty","prepareFullDocIndex","rscopy","offset","pos","branch","parameters","step","rs","find","where","simplesort","compoundsort","dataOptions","eqJoin","joinData","leftJoinKey","rightJoinKey","mapFun","mapReduce","mapFunction","reduceFunction","remove","comparefun","userComparer","wrappedComparer","propname","eff","targetEff","dc","frl","hasBinaryIndex","reverse","disableIndexIntersect","useJavascriptSorting","forceIndexIntersect","fr","io","pv","n","props","findOr","expressionArray","fri","frlen","docset","idxset","ei","elen","findAnd","query","firstOnly","queryObjectOp","queryObject","searchByIndex","filters","t","rowIdx","segm","calculateRange","viewFunction","removeMeta","forceClones","forceCloneMethod","meta","updateFunction","rcd","removeBatchByPositions","leftDataLength","rightDataLength","leftData","rightData","leftKeyisFunction","rightKeyisFunction","joinMap","chain","left","right","insert","getSort","fpl","fpi","wasFrozen","ofp","applyFind","uid","branchResultset","removeFilters","filterChanged","queueSortPhase","applySort","applySimpleSort","applySortCriteria","criteria","startTransaction","rollback","_indexOfFilterWithId","_addFilter","reapplyFilters","queueRebuildEvent","applyFilter","applyWhere","removeFilter","performSortPhase","suppressRebuildEvent","evaluateDocument","objIndex","isNew","ofr","oldPos","oldlen","evalResultset","newPos","removeDocument","rmidx","rmlen","rxo","fxo","adjels","drs","di","filt","contructor","operation","insertMeta","created","revision","updateMeta","updated","createInsertChange","createUpdateChange","insertMetaWithChange","updateMetaWithChange","objFrozen","observe","unobserve","addTransform","getTransform","setTransform","removeTransform","byExample","template","findObject","findOne","findObjects","ttlDaemonFuncGen","member","timestamp","interval","indexes","force","propPath","checkAllIndexes","bIndices","checkIndex","randomSamplingFactor","randomSampling","iter","biv","valid","repair","getBinaryIndexValues","idxvals","getUniqueIndex","ensureUniqueIndex","flagBinaryIndexesDirty","flagBinaryIndexDirty","ensureIdAsync","async","removeDynamicView","getDynamicView","findAndUpdate","filterObject","updateWhere","findAndRemove","overrideAdaptiveIndices","insertOne","adaptiveBatchOverride","bulkInsert","returnObj","clear","removeIndices","biname","oldInternal","newInternal","position","adaptiveBinaryIndexUpdate","message","isNaN","newId","version","addedPos","dvlen","adaptiveBinaryIndexInsert","filterFunction","removeWhere","list","removeDataOnly","positions","didx","xo","bic","uic","adaptiveOverride","adaptiveBinaryIndexRemove","removeBatch","batch","xlt","posx","returnPosition","retpos","getBinaryIndexPosition","dataPosition","binaryIndexName","range","idxPos","calculateRangeStart","removedFromIndexOnly","curr","bi","sortedPositions","adaptive","lbound","calculateRangeEnd","ubound","lval","minVal","maxVal","segResult","seg","by","findOneUnindexed","cachedDirtyIds","leftJoinProp","rightJoinProp","stages","getStage","commitLog","stage","stageName","commitStage","no_op","extract","isDotNotation","maxRecord","deep","minRecord","extractNumerical","stdDev","dict","median","half","setSort","bs","fieldValue","byId","idxSet","bsr","getLt","getGt","start","end","getPos","persistenceAdapters","factory","toStr","isEmpty","getKey","intKey","hasShallowProperty","getShallowPropertySafely","objectPath","proxy","bind","getShallowProperty","doNotReplace","currentPath","currentValue","includeInheritedProps","String","ensureExists","at","empty","isBoolean","isObject","coalesce","defaultValue","nextObj","del","mod","withInheritedProps","hex_chr","md5cycle","x","d","md5blk","s","md5blks","charCodeAt","md5blk_array","md51","tail","tmp","state","match","md51_array","subarray","Uint8Array","rhex","hex","toUtf8","unescape","encodeURIComponent","utf8Str2ArrayBuffer","returnUInt8Array","buff","ArrayBuffer","arrayBuffer2Utf8Str","fromCharCode","concatenateArrayBuffers","first","second","byteLength","buffer","hexToBinaryString","bytes","substr","SparkMD5","clamp","from","to","targetArray","sourceArray","begin","append","appendBinary","contents","_buff","_length","_hash","raw","ret","_finish","getState","hash","setState","destroy","hashBinary","content","deserialize","registerSerializer","serializers_1","registeredSerializer","DefaultSerializer","serializer","extendSerializer","input","implementation","fallbackDeserializer","fallbackSerializer","DefaultErrorSerializer","stack","__error_marker","thing","$worker","$transferable","$terminate","$events","$errors","Transfer","isTransferDescriptor","symbols_1","payload","transferables","send","WorkerMessageType","MasterMessageType","isWorkerRuntime","isWindowContext","Window","postMessage","postMessageToMaster","transferList","subscribeToMasterMessages","onMessage","messageHandler","messageEvent","addEventListener","removeEventListener","__awaiter","thisArg","_arguments","P","generator","fulfilled","next","rejected","__importDefault","__esModule","expose","is_observable_1","common_1","transferable_1","messages_1","implementation_1","common_2","transferable_2","default","exposeCalled","activeSubscriptions","isMasterJobRunMessage","run","isObservable","subscribe","isZenObservable","deconstructTransfer","postJobErrorMessage","rawError","errorMessage","postJobResultMessage","completed","resultValue","resultMessage","complete","postUncaughtErrorMessage","uncaughtError","subError","runFunction","jobUID","fn","args","syncResult","resultType","startMessage","running","postJobStartMessage","subscription","exposed","messageData","initMessage","init","postFunctionInitMessage","methodNames","methods","postModuleInitMessage","cancel","unsubscribe","reason","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","getter","definition","globalThis","Function","_lastNow","promiseWait","ms","PROMISE_RESOLVE_VOID","requestIdlePromise","timeout","ensureNotFalsy","randomCouchString","text","possible","charAt","flatClone","isElectron","getFromMapOrThrow","getSortDocumentsByLastWriteTimeComparator","primaryPath","_meta","lwt","extendStatics","setPrototypeOf","__proto__","__extends","__","__values","iterator","m","__read","r","ar","__spreadArray","pack","l","isFunction","createErrorClass","createImpl","ctorFunc","instance","UnsubscriptionError","_super","errors","arrRemove","Subscription","initialTeardown","closed","_parentage","_teardowns","e_1","_a","e_2","_b","_parentage_1","_parentage_1_1","e_1_1","return","_teardowns_1","_teardowns_1_1","teardown_1","execTeardown","e_2_1","teardown","_hasParent","_addParent","_removeParent","EMPTY","EMPTY_SUBSCRIPTION","isSubscription","config","onUnhandledError","onStoppedNotification","useDeprecatedSynchronousErrorHandling","useDeprecatedNextContext","timeoutProvider","_i","delegate","clearTimeout","handle","noop","COMPLETE_NOTIFICATION","createNotification","kind","context","errorContext","cb","isRoot","errorThrown","Subscriber","destination","_this","isStopped","EMPTY_OBSERVER","SafeSubscriber","handleStoppedNotification","nextNotification","_next","_error","_complete","_bind","ConsumerObserver","partialObserver","handleUnhandledError","observerOrNext","context_1","reportUnhandledError","notification","subscriber","identity","pipeFromArray","fns","prev","Observable","_subscribe","lift","isObserver","_trySubscribe","sink","promiseCtor","getPromiseCtor","pipe","operations","toPromise","ObjectUnsubscribedError","Subject","observers","hasError","thrownError","subject","AnonymousSubject","_throwIfClosed","copy_1","copy_1_1","configurable","_checkFinalizedStatuses","_innerSubscribe","asObservable","_defineProperties","writable","_createClass","Constructor","protoProps","staticProps","_setPrototypeOf","_inheritsLoose","subClass","superClass","_getPrototypeOf","_isNativeReflectConstruct","Reflect","construct","sham","Proxy","Boolean","valueOf","_construct","Parent","Class","_wrapNativeSuper","_cache","Wrapper","overwritable","messageForError","code","paramStr","_k","v","parametersToString","RxError","mes","rxdb","newRxError","WorkerGlobalScope","USE_METHOD","LISTENERS","startedListening","runAll","promises","all","LokiSaveQueue","lokiDatabase","databaseSettings","writesSinceLastRun","saveQueue","saveQueueC","addWrite","writeAmount","rej","PROMISE_RESOLVED_TRUE","PROMISE_RESOLVED_VOID","sleep","resolveWith","randomToken","lastMs","additional","microSeconds","isNode","channelName","messagesCallback","bc","BroadcastChannel","subFns","onmessage","msg","channelState","messageJson","canBeUsed","_pubkey","averageResponseTime","ObliviousSet","timeMap","obliviousSet","olderThen","removeTooOldValues","originalOptions","webWorkerSupport","fallbackInterval","onclose","localstorage","removeTimeout","node","maxParallelWrites","useFastPath","OBJECT_STORE_ID","getIdb","mozIndexedDB","webkitIndexedDB","msIndexedDB","getMessagesHigherThan","lastCursorId","keyRangeValue","ev","cleanOldMessages","msgObk","getOldMessages","tooOld","msgObj","removeMessageById","_readLoop","readNewMessages","newerMessages","useMessages","uuid","eMIs","messagesCallbackTime","_filterMessage","msgObjA","msgObjB","dbName","createDatabase","writeBlockPromise","readQueuePromises","readerUuid","writeObject","writeMessage","getLocalStorage","storageKey","ls","newValue","addStorageEventListener","token","writeObj","createEvent","initEvent","dispatchEvent","toLowerCase","defaultTime","SIMULATE_CHANNELS","channel","METHODS","ENFORCED_OPTIONS","OPEN_BROADCAST_CHANNELS","lastId","maybePromise","chooseMethods","useMethod","_iL","_onML","_addEL","internal","_uMP","_befC","_prepP","_state","_post","broadcastChannel","sendPromise","_hasMessageListeners","_addListenerObject","listenerFn","listenerObject","hundredMsInMicro","minMessageTime","_startListening","_removeListenerObject","_stopListening","postInternal","listenObj","awaitPrepare","isClosed","LeaderElection","_options","isLeader","hasLeader","isDead","_aplQ","_aplQC","_unl","_lstns","_dpL","_dpLC","hasLeaderListener","action","_sendMessage","leaderElector","msgJson","createLeaderElection","_leaderElector","responseTime","elector","die","pact","observer","applyOnce","isFromFallbackInterval","_this2","applyRun","stopCriteriaPromiseResolve","stopCriteria","stopCriteriaPromise","recieved","handleMessage","waitForAnswerTime","race","unloadFn","isLeaderListener","beLeader","awaitLeadership","_aLP","resolved","whenDeathListener","tryOnFallBack","_awaitLeadershipOnce","onduplicate","_this3","uFn","onFulfilled","onRejected","thenable","mustUseLocalState","instanceClosed","databaseName","internals","localState","waitUntilHasLeader","createLokiLocalState","schema","multiInstance","body","shouldContinue","updateValue","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","requestRemoteInstance","messageType","LOKI_BROADCAST_CHANNEL_MESSAGE_TYPE","LOKI_KEY_OBJECT_BROADCAST_CHANNEL_MESSAGE_TYPE","responseListener","leaderDeadPromise","retry","requestId","responsePromise","_rej","response","isError","firstResolved","stripLokiKey","docData","$lastWriteAt","OPEN_LOKIJS_STORAGE_INSTANCES","LOKIJS_COLLECTION_DEFAULT_OPTIONS","LOKI_DATABASE_STATE_BY_NAME","getLokiDatabase","databaseState","hasPersistence","unloads","unloadAdd","lokiSaveQueue","database","useSettings","lokijs","loadDatabasePromise","getLokiSortComparator","_schema","sortOptions","compareResult","sortPart","fieldName","directionMultiplier","valueA","valueB","getPrimaryFieldOfPrimaryKey","primaryKey","getUniqueDeterministicEventKey","storageInstance","writeRow","docId","binary","previous","_deleted","_rev","createLokiStorageInstance","storage","RxStorageInstanceLoki","electorState","leaderElectorByLokiDbName","intancesCount","getLokiLeaderElector","lokiCollectionName","collectionOptions","instanceId","changes$","lastChangefeedSequence","recover","handleRemoteRequest","bulkWrite","documentWrites","docsInDb","docsInDbWithLokiKey","documentInDb","categorized","bulkWriteRows","bulkInsertDocs","bulkUpdateDocs","changedDocumentIds","eventBulk","startTime","revInDb","status","documentId","writeDoc","eventId","endTime","insertedIsDeleted","categorizeBulkWriteRows","documentInDbWithLokiKey","findDocumentsById","ids","deleted","preparedQuery","selector","skip","documents","lokiDoc","getAttachmentData","_documentId","_attachmentId","getChangedDocumentsSince","checkpoint","sinceLwt","changedDocs","changeStream","cleanup","minimumDeletedTime","maxDeletionTime","foundDocuments","removeLokiLeaderElectorReference","dbState","u","closeLokiCollections","thisBtoa","btoa","setImmediateShim","setImmediate","appendBlob","blob","webkitSlice","sliceBlob","reader","FileReader","onloadend","readAsArrayBuffer","arrayBuffer","appendString","string","binaryMd5","inputIsString","ceil","currentChunk","loadNextChunk","base64","rawToBase64","RxStorageLokiStatics","digest","hashKey","doesBroadcastChangestream","prepareQuery","mutateableQuery","getSortComparator","getQueryMatcher","docWithResetDeleted","fakeCollection","fakeResultSet","RxStorageLoki","statics","createStorageInstance","nextId","instanceById","exposeMe","getRxStorageLoki","require","attachmentId","minDeletedTime"],"sourceRoot":""}